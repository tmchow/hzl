<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Design Exploration</title>

  <!-- Tailwind Play CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js" defer></script>
  <!-- Google Fonts: Shell (DM Sans, JetBrains Mono) + Variation families -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <!-- Exploration metadata (agent-readable) -->
  <script type="application/json" id="exploration-metadata">
  {
  "project": "HZL Agent Operations Center",
  "topic": "agent-ops-center",
  "round": 2,
  "date": "2026-03-01",
  "previousRound": "v1.html",
  "sourceDirectory": "docs/design-explorations/2026-03-01-agent-ops-center-2",
  "families": [
    {
      "letter": "D",
      "name": "Triage Strips",
      "approach": "What if agent monitoring was a dense expandable list with inline sparklines — combining A2's expandable triage rows with C2's activity visualization, where ANY agent can be expanded in-place for full timeline + task detail?"
    },
    {
      "letter": "E",
      "name": "Explorer Split",
      "approach": "What if agent monitoring was a persistent two-panel layout — a compact roster list with sparklines on the left and a rich combined timeline + task detail view on the right, optimized for quick agent-by-agent flipping?"
    }
  ],
  "previousVariations": [
    {"family": "A", "familyName": "Incident Board", "name": "Alert Queue", "layoutType": "Incident Cards + Modal Detail", "aesthetic": "Professional Dark"},
    {"family": "A", "familyName": "Incident Board", "name": "Inline Triage", "layoutType": "Expandable Incident Rows", "aesthetic": "Professional Dark"},
    {"family": "A", "familyName": "Incident Board", "name": "Split Focus", "layoutType": "List + Detail Split", "aesthetic": "Professional Dark"},
    {"family": "B", "familyName": "Live Feed", "name": "Chronicle", "layoutType": "Full-Width Feed + Floating Sidebar", "aesthetic": "Professional Dark"},
    {"family": "B", "familyName": "Live Feed", "name": "Lane View", "layoutType": "Parallel Agent Columns", "aesthetic": "Professional Dark"},
    {"family": "B", "familyName": "Live Feed", "name": "Filtered Stream", "layoutType": "Tabbed Feed + Inline Detail", "aesthetic": "Professional Dark"},
    {"family": "C", "familyName": "Switchboard", "name": "Panel Grid", "layoutType": "Fixed Agent Grid", "aesthetic": "Professional Dark"},
    {"family": "C", "familyName": "Switchboard", "name": "Status Strips", "layoutType": "Horizontal Strip Rows", "aesthetic": "Professional Dark"},
    {"family": "C", "familyName": "Switchboard", "name": "Mission Dashboard", "layoutType": "Metrics Header + Agent Tiles", "aesthetic": "Professional Dark"}
  ],
  "variations": [
    {
      "id": "D1",
      "family": "D",
      "familyName": "Triage Strips",
      "name": "Flat Roster",
      "layoutType": "Expandable Row List",
      "aesthetic": "Professional Dark",
      "description": "All agents in a single flat list with sparklines. Stuck agents have red accent but same row format as others. Any agent expandable inline with full timeline + task detail. Activity sparklines designed for intermittent usage patterns."
    },
    {
      "id": "D2",
      "family": "D",
      "familyName": "Triage Strips",
      "name": "Incident Banner + Roster",
      "layoutType": "Alert Banner + Expandable Rows",
      "aesthetic": "Professional Dark",
      "description": "Compact stuck-agent alert banner at top summarizing incidents. Below: full agent roster as expandable strips with sparklines. Banner draws attention to problems, roster provides full detail for all agents."
    },
    {
      "id": "D3",
      "family": "D",
      "familyName": "Triage Strips",
      "name": "Sortable Table",
      "layoutType": "Sortable Table + Inline Expansion",
      "aesthetic": "Professional Dark",
      "description": "Full table with sortable column headers, inline sparklines, keyboard navigation. Click any row to expand rich inline detail. Maximum information density, power-user oriented. Most htop-like."
    },
    {
      "id": "E1",
      "family": "E",
      "familyName": "Explorer Split",
      "name": "Compact List + Rich Detail",
      "layoutType": "Narrow List + Combined Detail Panel",
      "aesthetic": "Professional Dark",
      "description": "Narrow left list with status dots, agent names, mini sparklines. Right panel shows unified view combining timeline events with inline task context — each event shows the task it belongs to. Easy agent flipping."
    },
    {
      "id": "E2",
      "family": "E",
      "familyName": "Explorer Split",
      "name": "Data List + Agent Profile",
      "layoutType": "Wide List + Profile Detail Panel",
      "aesthetic": "Professional Dark",
      "description": "Wider left list showing C2-style strip data per agent with sparklines. Right panel is an agent profile page merging timeline, task context, and metrics into a unified narrative view."
    },
    {
      "id": "E3",
      "family": "E",
      "familyName": "Explorer Split",
      "name": "Collapsible Navigator",
      "layoutType": "Collapsible List + Maximized Detail",
      "aesthetic": "Professional Dark",
      "description": "Left list can collapse to icon-only mode (status dots + initials), giving detail panel maximum width. Toggle between overview mode (wide list) and investigation mode (collapsed list + wide detail)."
    }
  ]
}

  </script>

  <style>
    /* === Shell Design Tokens (FIXED — identical in every file) === */
    :root {
      --shell-bg: #0c0c0d;
      --shell-bg-raised: #17191a;
      --shell-bg-hover: #232527;
      --shell-bg-active: #2f3233;
      --shell-border: rgba(255,255,255,0.06);
      --shell-border-hover: rgba(255,255,255,0.1);
      --shell-text: #708a9e;
      --shell-text-bright: #dbe2e7;
      --shell-text-dim: #445664;
      --shell-accent: #62929e;
      --shell-accent-hover: #81a8b1;
      --shell-accent-glow: rgba(98,146,158,0.15);
      --shell-star-filled: #d4a853;
      --shell-star-empty: #445664;
      --shell-radius: 8px;
      --shell-radius-sm: 5px;
      --shell-font-mono: 'JetBrains Mono', monospace;
      --shell-font-ui: 'DM Sans', sans-serif;
      --shell-sidebar-width: 240px;
      --shell-topbar-height: 48px;
    }

    [x-cloak] { display: none !important; }

    /* === Shell Atmosphere === */
    body {
      background: var(--shell-bg);
      background-image:
        radial-gradient(ellipse at 20% 0%, rgba(98,146,158,0.03) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(84,106,123,0.03) 0%, transparent 50%);
      color: #708a9e;
      margin: 0;
      padding: 0;
    }

  </style>
</head>
<body x-data="explorer()" @keydown.window="handleKey($event)"
      class="h-screen overflow-hidden flex" style="font-family: var(--shell-font-ui)">

  <!-- ==================== SIDEBAR ==================== -->
  <aside class="flex flex-col h-full flex-shrink-0"
         style="width: var(--shell-sidebar-width); background: var(--shell-bg-raised); border-right: 1px solid var(--shell-border)">

    <!-- Header (matches topbar height so borders align) -->
    <div class="px-4 flex items-center gap-3 flex-shrink-0"
         style="height: var(--shell-topbar-height); border-bottom: 1px solid var(--shell-border)">
      <span style="color: var(--shell-accent); font-size: 16px; line-height: 1">&#9670;</span>
      <div class="flex flex-col justify-center min-w-0" style="gap: 3px">
        <span style="color: var(--shell-text-bright); font-size: 13px; font-weight: 600; line-height: 1">Design Exploration</span>
        <span style="color: #c6c5b9; font-size: 11px; line-height: 1" class="truncate"
              x-text="meta.project || ''"></span>
      </div>
    </div>

    <!-- Variation List -->
    <div class="flex-1 overflow-y-auto py-3 px-2">
      <template x-for="fam in families" :key="fam.letter">
        <div class="mb-4">
          <!-- Family header — small label, uses silver for legibility -->
          <div class="flex items-center gap-1.5 px-3 mb-1.5 mt-1">
            <span style="font-family: var(--shell-font-mono); font-size: 10px; color: #c6c5b9; font-weight: 500; opacity: 0.6"
                  x-text="fam.letter"></span>
            <span style="font-size: 10px; color: #c6c5b9; text-transform: uppercase; letter-spacing: 0.06em; font-weight: 500; opacity: 0.6"
                  x-text="fam.name"></span>
          </div>
          <!-- Variation items — prominent, indented under family -->
          <template x-for="v in fam.variations" :key="v.id">
            <button @click="selectVariation(v.id)"
                    class="w-full text-left rounded group"
                    style="display: grid; grid-template-columns: auto 1fr; column-gap: 10px; padding: 8px 10px 8px 16px; transition: all 150ms ease; border: none; cursor: pointer"
                    :style="current.id === v.id
                      ? 'background: #2f3233; border-left: 3px solid #62929e; box-shadow: inset 3px 0 12px rgba(98,146,158,0.15); margin-left: 0; padding-left: 13px'
                      : 'border-left: 3px solid transparent; margin-left: 0; padding-left: 13px'"
                    :class="current.id === v.id ? '' : 'hover:bg-[#232527]'">
              <span style="grid-row: 1 / 3; align-self: baseline; font-family: var(--shell-font-mono); font-size: 11px; line-height: 1.4"
                    :style="current.id === v.id ? 'color: #62929e' : 'color: #445664'"
                    x-text="v.id"></span>
              <div class="truncate" style="font-size: 13px; font-weight: 500; line-height: 1.4"
                   :style="current.id === v.id ? 'color: #dbe2e7' : 'color: #708a9e'"
                   x-text="v.name"></div>
              <div class="flex items-center gap-0.5" style="grid-column: 2; min-height: 16px">
                <template x-if="ratings[v.id]?.stars === 0">
                  <span style="color: #ef4444; font-size: 10px">&#10007;</span>
                </template>
                <template x-if="ratings[v.id]?.stars > 0">
                  <span class="flex gap-0.5">
                    <template x-for="s in (ratings[v.id]?.stars || 0)" :key="s">
                      <span style="color: #d4a853; font-size: 9px">&#9733;</span>
                    </template>
                  </span>
                </template>
              </div>
            </button>
          </template>
        </div>
      </template>
    </div>

    <!-- Footer -->
    <div class="px-3 py-3" style="border-top: 1px solid var(--shell-border)">
      <div class="flex items-center gap-1 mb-2 justify-center">
        <template x-for="v in variations" :key="v.id">
          <span class="rounded-full" style="width: 8px; height: 8px"
                :style="ratings[v.id]?.stars == null ? 'background: #33404b'
                  : ratings[v.id].stars === 0 ? 'background: #ef4444'
                  : ratings[v.id].stars >= 4 ? 'background: #d4a853'
                  : ratings[v.id].stars >= 2 ? 'background: #facc15'
                  : 'background: #ef4444'"></span>
        </template>
      </div>
      <div class="text-center mb-2" style="font-size: 12px; color: #445664"
           x-text="reviewedCount + '/' + variations.length + ' reviewed'"></div>
      <button @click="showExport = true"
              class="w-full py-2.5 rounded text-center"
              style="background: #62929e; color: white; font-size: 13px; font-weight: 600; border: none; border-radius: 5px; cursor: pointer; transition: background 150ms"
              @mouseover="$el.style.background='#81a8b1'"
              @mouseout="$el.style.background='#62929e'">Next Round<span x-text="' (' + reviewedCount + '/' + variations.length + ')'"></span></button>
    </div>
  </aside>

  <!-- ==================== MAIN AREA ==================== -->
  <div class="flex-1 flex flex-col min-w-0">

    <!-- TOP BAR -->
    <div class="flex items-center px-4 flex-shrink-0"
         style="height: var(--shell-topbar-height); background: var(--shell-bg-raised); border-bottom: 1px solid var(--shell-border)">
      <!-- Nav arrows -->
      <div class="flex items-center gap-1">
        <button @click="prev()" class="w-8 h-8 flex items-center justify-center rounded"
                style="color: #708a9e; font-family: var(--shell-font-mono); font-size: 16px; background: transparent; border: none; cursor: pointer; transition: all 150ms"
                @mouseover="$el.style.background='#232527';$el.style.color='#dbe2e7'"
                @mouseout="$el.style.background='transparent';$el.style.color='#708a9e'">&larr;</button>
        <button @click="next()" class="w-8 h-8 flex items-center justify-center rounded"
                style="color: #708a9e; font-family: var(--shell-font-mono); font-size: 16px; background: transparent; border: none; cursor: pointer; transition: all 150ms"
                @mouseover="$el.style.background='#232527';$el.style.color='#dbe2e7'"
                @mouseout="$el.style.background='transparent';$el.style.color='#708a9e'">&rarr;</button>
      </div>
      <!-- Current variation info -->
      <div class="flex-1 flex items-center justify-center gap-3">
        <span style="font-family: var(--shell-font-mono); color: var(--shell-accent); font-size: 14px; font-weight: 500"
              x-text="current.id"></span>
        <span style="color: var(--shell-text-bright); font-size: 14px; font-weight: 500"
              x-text="current.name"></span>
        <span class="hidden sm:inline-flex items-center gap-2">
          <span class="rounded-full px-2.5 py-0.5"
                style="background: var(--shell-bg-hover); color: #c6c5b9; font-size: 11px; font-family: var(--shell-font-mono); opacity: 0.7"
                x-text="current.layoutType"></span>
          <span style="color: #c6c5b9; font-size: 11px; opacity: 0.4">&middot;</span>
          <span class="rounded-full px-2.5 py-0.5"
                style="background: var(--shell-bg-hover); color: #c6c5b9; font-size: 11px; font-family: var(--shell-font-mono); opacity: 0.7"
                x-text="current.aesthetic"></span>
        </span>
      </div>
      <!-- Toggles -->
      <div class="flex items-center gap-1">
        <button @click="showShortcuts = !showShortcuts"
                class="w-8 h-8 flex items-center justify-center rounded"
                :style="showShortcuts ? 'background: rgba(98,146,158,0.15); color: #62929e' : 'color: #708a9e'"
                style="font-family: var(--shell-font-mono); font-size: 13px; color: #708a9e; background: transparent; border: none; cursor: pointer; transition: all 150ms; font-weight: 500"
                @mouseover="if(!showShortcuts){$el.style.background='#232527';$el.style.color='#dbe2e7'}"
                @mouseout="if(!showShortcuts){$el.style.background='transparent';$el.style.color='#708a9e'}">?</button>
      </div>
    </div>

    <!-- PREVIEW + TUNE PANEL (side by side) -->
    <div class="flex-1 flex min-h-0">
      <!-- PREVIEW STAGE -->
      <div id="preview-stage"
           class="flex-1 overflow-hidden relative"
           :class="[isTransitioning ? 'opacity-0' : 'opacity-100']"
           style="transition: opacity 150ms ease">
        <iframe x-ref="iframe" @load="onIframeLoad()"
                style="width: 100%; height: 100%; border: none"></iframe>
      </div>

      <!-- TUNE PANEL (right side) -->
      <div x-show="showControls && current.controls.length" x-cloak
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 w-0"
           x-transition:enter-end="opacity-100"
           x-transition:leave="transition ease-in duration-150"
           x-transition:leave-start="opacity-100"
           x-transition:leave-end="opacity-0 w-0"
           class="flex-shrink-0 flex flex-col overflow-hidden"
           style="width: 260px; background: var(--shell-bg-raised); border-left: 1px solid var(--shell-border)">
        <!-- Header -->
        <div class="flex items-center justify-between px-3 flex-shrink-0"
             style="height: var(--shell-topbar-height); border-bottom: 1px solid var(--shell-border)">
          <span style="font-family: var(--shell-font-mono); font-size: 12px; color: var(--shell-text)">Tune</span>
          <button @click="showControls = false"
                  style="color: var(--shell-text-dim); font-size: 16px; transition: color 150ms; background: none; border: none; cursor: pointer"
                  @mouseover="$el.style.color='var(--shell-text-bright)'"
                  @mouseout="$el.style.color='var(--shell-text-dim)'">&times;</button>
        </div>
        <!-- Controls body -->
        <div class="flex-1 p-3 overflow-y-auto">
          <template x-for="control in current.controls" :key="control.id">
            <div class="mb-4">
              <div class="flex justify-between items-center mb-1.5">
                <label style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: var(--shell-text); font-family: var(--shell-font-mono)"
                       x-text="control.label"></label>
                <span x-show="control.type === 'range' && control.value != null"
                      style="font-size: 11px; color: var(--shell-text); font-family: var(--shell-font-mono); font-variant-numeric: tabular-nums"
                      x-text="control.value + (control._displayUnit || control.unit || '')"></span>
              </div>
              <!-- Range -->
              <template x-if="control.type === 'range'">
                <input type="range" :min="control.min" :max="control.max" :step="control.step"
                       :value="control.value"
                       @input="updateControl(control.id, +$event.target.value)"
                       class="w-full h-1.5 rounded-full appearance-none cursor-pointer"
                       style="background: var(--shell-bg); accent-color: var(--shell-accent)">
              </template>
              <!-- Select (segmented) -->
              <template x-if="control.type === 'select'">
                <div class="flex rounded-md overflow-hidden" style="border: 1px solid var(--shell-border)">
                  <template x-for="opt in control.options" :key="opt">
                    <button @click="updateControl(control.id, opt)"
                            class="flex-1 px-2 py-1.5 transition-all duration-150"
                            :style="(control.value === opt
                              ? 'background: var(--shell-accent); color: white'
                              : 'color: var(--shell-text)')
                              + '; font-family: var(--shell-font-mono); font-size: 12px'"
                            x-text="opt"></button>
                  </template>
                </div>
              </template>
              <!-- Toggle -->
              <template x-if="control.type === 'toggle'">
                <div>
                  <button @click="updateControl(control.id, !control.value)"
                          class="rounded-full relative transition-colors duration-200"
                          style="width: 36px; height: 20px; border: none; cursor: pointer; padding: 0; flex-shrink: 0"
                          :style="control.value ? 'background: var(--shell-accent)' : 'background: var(--shell-bg-active)'">
                    <span class="absolute rounded-full transition-all duration-200"
                          style="top: 2px; left: 2px; width: 16px; height: 16px; background: var(--shell-text-bright)"
                          :style="control.value ? 'transform: translateX(16px)' : 'transform: translateX(0)'"></span>
                  </button>
                </div>
              </template>
            </div>
          </template>
        </div>
        <!-- Footer -->
        <div class="px-3 py-2 flex items-center justify-between flex-shrink-0" style="border-top: 1px solid var(--shell-border)">
          <button @click="replayVariation()"
                  class="flex items-center gap-1"
                  style="font-size: 11px; color: var(--shell-text-dim); transition: color 150ms; background: none; border: none; cursor: pointer"
                  @mouseover="$el.style.color='var(--shell-text-bright)'"
                  @mouseout="$el.style.color='var(--shell-text-dim)'">
            <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M1 4v5h5"/><path d="M3.51 10a6 6 0 1 0 .49-5.5L1 9"/>
            </svg>
            Reload
          </button>
          <button @click="resetControls()"
                  style="font-size: 11px; color: var(--shell-text-dim); transition: color 150ms; background: none; border: none; cursor: pointer"
                  @mouseover="$el.style.color='var(--shell-text-bright)'"
                  @mouseout="$el.style.color='var(--shell-text-dim)'">Reset to defaults</button>
        </div>
      </div>
    </div>

    <!-- RATING BAR -->
    <div class="flex items-center gap-5 px-6 flex-shrink-0"
         style="height: 64px; background: #17191a; border-top: 1px solid rgba(255,255,255,0.06)">
      <!-- Skip -->
      <button @click="rate(0)" class="flex items-center justify-center"
              title="Skip — exclude from next round (0)"
              style="width: 32px; height: 32px; font-size: 18px; color: #445664; cursor: pointer; background: none; border: none; padding: 0; transition: all 200ms ease"
              :style="currentRating.stars === 0 ? 'color: #ef4444' : 'color: #445664'"
              @mouseover="$el.style.transform = 'scale(1.15)'"
              @mouseout="$el.style.transform = 'scale(1)'">&#10007;</button>
      <!-- Stars -->
      <div class="flex items-center gap-0.5">
        <template x-for="s in 5" :key="s">
          <button @click="rate(s)" class="flex items-center justify-center"
                  :title="s + ' star' + (s > 1 ? 's' : '') + ' (' + s + ')'"
                  style="width: 32px; height: 32px; font-size: 22px; color: #445664; transition: transform 200ms ease; cursor: pointer; background: none; border: none; padding: 0; line-height: 1"
                  :style="s <= (currentRating.stars || 0) ? 'color: #d4a853' : 'color: #445664'"
                  @mouseover="$el.style.transform = 'scale(1.15)'"
                  @mouseout="$el.style.transform = 'scale(1)'">&#9733;</button>
        </template>
      </div>
      <!-- Divider -->
      <div style="width: 1px; height: 24px; background: rgba(255,255,255,0.08)"></div>
      <!-- Tune -->
      <button x-show="current.controls.length" @click="showControls = !showControls"
              class="flex items-center gap-1.5 rounded flex-shrink-0"
              style="padding: 6px 10px; font-family: var(--shell-font-mono); font-size: 12px; border: 1px solid var(--shell-border); cursor: pointer; transition: all 150ms"
              :style="showControls
                ? 'background: rgba(98,146,158,0.15); color: var(--shell-accent); border-color: rgba(98,146,158,0.3)'
                : 'background: transparent; color: var(--shell-text)'"
              @mouseover="if(!showControls){$el.style.background='var(--shell-bg-hover)';$el.style.color='var(--shell-text-bright)'}"
              @mouseout="if(!showControls){$el.style.background='transparent';$el.style.color='var(--shell-text)'}">
        <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
          <line x1="2" y1="4" x2="14" y2="4"/><circle cx="5" cy="4" r="1.5" fill="currentColor" stroke="none"/>
          <line x1="2" y1="8" x2="14" y2="8"/><circle cx="11" cy="8" r="1.5" fill="currentColor" stroke="none"/>
          <line x1="2" y1="12" x2="14" y2="12"/><circle cx="7" cy="12" r="1.5" fill="currentColor" stroke="none"/>
        </svg>
        Tune
      </button>
      <!-- Notes -->
      <input type="text" class="flex-1"
             :value="currentRating.notes"
             @input="updateNotes($event.target.value)"
             placeholder="Add a note about this variation..."
             style="background: #0c0c0d; border: 1px solid rgba(255,255,255,0.1); color: #dbe2e7; font-family: var(--shell-font-ui); font-size: 13px; padding: 8px 14px; border-radius: 5px; outline: none; transition: border-color 150ms"
             onfocus="this.style.borderColor='rgba(255,255,255,0.18)'"
             onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
      <!-- Ship It -->
      <button @click="openFinalize()"
              class="flex items-center gap-1.5 flex-shrink-0 rounded"
              style="padding: 8px 14px; font-size: 13px; font-weight: 600; border: none; cursor: pointer; transition: all 150ms; background: transparent; color: var(--shell-accent); border: 1px solid rgba(98,146,158,0.3)"
              @mouseover="$el.style.background='rgba(98,146,158,0.15)'"
              @mouseout="$el.style.background='transparent'">Ship It ⛵</button>
    </div>
  </div>

  <!-- ==================== EXPORT MODAL ==================== -->
  <div x-show="showExport" class="fixed inset-0 z-50 flex items-center justify-center"
       x-transition:enter="transition ease-out duration-200"
       x-transition:enter-start="opacity-0"
       x-transition:enter-end="opacity-100"
       x-transition:leave="transition ease-in duration-150"
       x-transition:leave-start="opacity-100"
       x-transition:leave-end="opacity-0">
    <div class="absolute inset-0" style="background: rgba(0,0,0,0.6); backdrop-filter: blur(8px)" @click="showExport = false"></div>
    <div class="relative flex flex-col"
         style="width: 640px; max-height: 80vh; background: var(--shell-bg-raised); border: 1px solid var(--shell-border); border-radius: var(--shell-radius); box-shadow: 0 4px 24px rgba(0,0,0,0.4), 0 1px 4px rgba(0,0,0,0.3)"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100">
      <!-- Header -->
      <div class="flex items-center justify-between px-5 py-3" style="border-bottom: 1px solid var(--shell-border)">
        <span style="color: var(--shell-text-bright); font-size: 15px; font-weight: 600">Export Feedback</span>
        <button @click="showExport = false"
                style="color: var(--shell-text-dim); font-size: 20px; background: none; border: none; cursor: pointer; transition: color 150ms"
                @mouseover="$el.style.color='var(--shell-text-bright)'"
                @mouseout="$el.style.color='var(--shell-text-dim)'">&times;</button>
      </div>
      <!-- Body -->
      <div class="flex-1 overflow-y-auto p-5">
        <pre class="p-4 rounded overflow-x-auto whitespace-pre-wrap mb-4"
             style="background: var(--shell-bg); border: 1px solid var(--shell-border); border-radius: var(--shell-radius-sm); font-family: var(--shell-font-mono); font-size: 13px; color: var(--shell-text-bright); user-select: all"
             x-text="generateFeedback()"></pre>
        <label style="display: block; font-size: 12px; color: var(--shell-text-dim); margin-bottom: 6px; font-weight: 500">Direction for Next Round</label>
        <textarea x-model="directionText"
                  rows="5"
                  placeholder="What should the next round focus on? Which directions to keep, drop, or explore further..."
                  style="width: 100%; background: var(--shell-bg); border: 1px solid var(--shell-border); color: var(--shell-text-bright); font-family: var(--shell-font-ui); font-size: 13px; padding: 12px; border-radius: var(--shell-radius-sm); outline: none; resize: vertical; transition: border-color 150ms"
                  onfocus="this.style.borderColor='rgba(255,255,255,0.1)'"
                  onblur="this.style.borderColor='rgba(255,255,255,0.06)'"></textarea>
      </div>
      <!-- Footer -->
      <div class="px-5 py-3 flex-shrink-0" style="border-top: 1px solid var(--shell-border)">
        <button @click="copyFeedback()"
                class="w-full py-2.5 rounded text-white text-center"
                style="background: var(--shell-accent); font-size: 13px; font-weight: 600; border-radius: var(--shell-radius-sm); transition: background 150ms"
                @mouseover="$el.style.background='var(--shell-accent-hover)'"
                @mouseout="$el.style.background='var(--shell-accent)'"
                x-text="copiedFeedback ? '&#10003; Copied!' : 'Copy to Clipboard'"></button>
      </div>
    </div>
  </div>

  <!-- ==================== FINALIZE MODAL ==================== -->
  <div x-show="showFinalize" class="fixed inset-0 z-50 flex items-center justify-center"
       x-transition:enter="transition ease-out duration-200"
       x-transition:enter-start="opacity-0"
       x-transition:enter-end="opacity-100"
       x-transition:leave="transition ease-in duration-150"
       x-transition:leave-start="opacity-100"
       x-transition:leave-end="opacity-0">
    <div class="absolute inset-0" style="background: rgba(0,0,0,0.6); backdrop-filter: blur(8px)" @click="showFinalize = false"></div>
    <div class="relative flex flex-col"
         style="width: 640px; max-height: 80vh; background: var(--shell-bg-raised); border: 1px solid var(--shell-border); border-radius: var(--shell-radius); box-shadow: 0 4px 24px rgba(0,0,0,0.4), 0 1px 4px rgba(0,0,0,0.3)"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100">
      <!-- Header -->
      <div class="flex items-center justify-between px-5 py-3" style="border-bottom: 1px solid var(--shell-border)">
        <div class="flex items-center gap-3">
          <span style="color: var(--shell-text-bright); font-size: 15px; font-weight: 600">Go With This</span>
          <span style="color: var(--shell-accent); font-family: var(--shell-font-mono); font-size: 13px" x-text="current.id"></span>
          <span style="color: var(--shell-text); font-size: 13px" x-text="current.name"></span>
        </div>
        <button @click="showFinalize = false"
                style="color: var(--shell-text-dim); font-size: 20px; background: none; border: none; cursor: pointer; transition: color 150ms"
                @mouseover="$el.style.color='var(--shell-text-bright)'"
                @mouseout="$el.style.color='var(--shell-text-dim)'">&times;</button>
      </div>
      <!-- Body -->
      <div class="flex-1 overflow-y-auto p-5">
        <pre class="p-4 rounded overflow-x-auto whitespace-pre-wrap mb-4"
             style="background: var(--shell-bg); border: 1px solid var(--shell-border); border-radius: var(--shell-radius-sm); font-family: var(--shell-font-mono); font-size: 13px; color: var(--shell-text-bright); user-select: all"
             x-text="generateDirection()"></pre>
        <label style="display: block; font-size: 12px; color: var(--shell-text-dim); margin-bottom: 6px; font-weight: 500">Notes</label>
        <textarea x-model="finalizeNotes"
                  rows="5"
                  placeholder="What matters most about this direction? Any elements to borrow from other variations? Constraints for implementation..."
                  style="width: 100%; background: var(--shell-bg); border: 1px solid var(--shell-border); color: var(--shell-text-bright); font-family: var(--shell-font-ui); font-size: 13px; padding: 12px; border-radius: var(--shell-radius-sm); outline: none; resize: vertical; transition: border-color 150ms"
                  onfocus="this.style.borderColor='rgba(255,255,255,0.1)'"
                  onblur="this.style.borderColor='rgba(255,255,255,0.06)'"></textarea>
      </div>
      <!-- Footer -->
      <div class="px-5 py-3 flex-shrink-0" style="border-top: 1px solid var(--shell-border)">
        <button @click="copyDirection()"
                class="w-full py-2.5 rounded text-white text-center"
                style="background: var(--shell-accent); font-size: 13px; font-weight: 600; border-radius: var(--shell-radius-sm); transition: background 150ms"
                @mouseover="$el.style.background='var(--shell-accent-hover)'"
                @mouseout="$el.style.background='var(--shell-accent)'"
                x-text="copiedDirection ? '&#10003; Copied!' : 'Copy Direction'"></button>
      </div>
    </div>
  </div>

  <!-- ==================== KEYBOARD SHORTCUTS OVERLAY ==================== -->
  <div x-show="showShortcuts" class="fixed inset-0 z-50 flex items-center justify-center"
       x-transition:enter="transition ease-out duration-200"
       x-transition:enter-start="opacity-0"
       x-transition:enter-end="opacity-100"
       x-transition:leave="transition ease-in duration-150"
       x-transition:leave-start="opacity-100"
       x-transition:leave-end="opacity-0">
    <div class="absolute inset-0" style="background: rgba(0,0,0,0.5); backdrop-filter: blur(4px)" @click="showShortcuts = false"></div>
    <div class="relative p-5" style="width: 420px; background: var(--shell-bg-raised); border: 1px solid var(--shell-border); border-radius: var(--shell-radius); box-shadow: 0 4px 24px rgba(0,0,0,0.4)">
      <div class="flex items-center justify-between mb-4">
        <span style="color: var(--shell-text-bright); font-size: 15px; font-weight: 600">Keyboard Shortcuts</span>
        <button @click="showShortcuts = false"
                style="color: var(--shell-text-dim); font-size: 20px; background: none; border: none; cursor: pointer">&times;</button>
      </div>
      <div class="grid grid-cols-2 gap-3" style="font-size: 13px">
        <template x-for="s in [
          ['\u2190 \u2192', 'Previous / Next'],
          ['0', 'Skip (mark as skip)'],
          ['1-5', 'Rate (stars)'],
          ['L', 'Toggle Tune'],
          ['R', 'Reload Variation'],
          ['E', 'Open Export'],
          ['?', 'Show Shortcuts'],
          ['Esc', 'Close Panels']
        ]" :key="s[0]">
          <div class="flex items-center gap-3">
            <kbd class="inline-flex items-center justify-center px-2 py-1 rounded"
                 style="background: var(--shell-bg); border: 1px solid var(--shell-border); font-family: var(--shell-font-mono); font-size: 12px; color: var(--shell-text-bright); min-width: 32px; box-shadow: 0 1px 2px rgba(0,0,0,0.2)"
                 x-text="s[0]"></kbd>
            <span style="color: var(--shell-text)" x-text="s[1]"></span>
          </div>
        </template>
      </div>
    </div>
  </div>

  <!-- ==================== VARIATION TEMPLATES ==================== -->
    <template id="tpl-d1">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script type="application/json" id="variation-meta">
  {
    "id": "D1",
    "family": "D",
    "familyName": "Triage Strips",
    "name": "Flat Roster",
    "layoutType": "Expandable Row List",
    "aesthetic": "Professional Dark",
    "description": "All agents in a flat list with inline sparklines. Stuck agents sorted to top with red left border. Any agent expands inline to show full session timeline and task context.",
    "controls": [
      {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["5 min", "10 min", "15 min", "30 min"],
        "cssValues": { "5 min": "5", "10 min": "10", "15 min": "15", "30 min": "30" },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
      },
      {
        "id": "row-density",
        "label": "Row Density",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["compact", "standard", "spacious"],
        "cssValues": {
          "compact":  { "--row-height": "44px", "--row-gap": "2px", "--row-font": "12px" },
          "standard": { "--row-height": "56px", "--row-gap": "4px", "--row-font": "13px" },
          "spacious": { "--row-height": "68px", "--row-gap": "8px", "--row-font": "14px" }
        },
        "value": "standard",
        "defaultValue": "standard",
        "unit": "",
        "cssVar": null
      },
      {
        "id": "sparkline-style",
        "label": "Sparkline Style",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["session blocks", "tick marks", "area fill"],
        "cssValues": { "session blocks": "blocks", "tick marks": "ticks", "area fill": "area" },
        "value": "session blocks",
        "defaultValue": "session blocks",
        "unit": "",
        "cssVar": "--sparkline-style",
        "event": true
      },
      {
        "id": "expand-anim",
        "label": "Expand Animation",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["slide", "fade", "instant"],
        "cssValues": { "slide": "slide", "fade": "fade", "instant": "instant" },
        "value": "slide",
        "defaultValue": "slide",
        "unit": "",
        "cssVar": "--expand-anim",
        "event": true
      },
      {
        "id": "detail-depth",
        "label": "Detail Depth",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["summary", "timeline", "full"],
        "cssValues": { "summary": "summary", "timeline": "timeline", "full": "full" },
        "value": "full",
        "defaultValue": "full",
        "unit": "",
        "cssVar": "--detail-depth",
        "event": true
      },
      {
        "id": "show-idle",
        "label": "Show Idle",
        "type": "toggle",
        "min": null, "max": null, "step": null,
        "options": null,
        "cssValues": { "true": "flex", "false": "none" },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--idle-display"
      }
    ]
  }
  </script>
  <style>
    :root {
      --bg: #0f1117;
      --card: #1a1d27;
      --border: #2a2d3a;
      --text: #e2e4e9;
      --text-dim: #8b8fa3;
      --stuck: #ef4444;
      --active: #3b82f6;
      --idle: #6b7280;
      --healthy: #22c55e;
      --radius: 8px;

      --row-height: 56px;
      --row-gap: 4px;
      --row-font: 13px;

      --stuck-threshold: 5;
      --sparkline-style: blocks;
      --expand-anim: slide;
      --detail-depth: full;
      --idle-display: flex;
    }

    :root * {
      transition: color 0.3s ease, background-color 0.3s ease,
                  border-color 0.3s ease, padding 0.3s ease,
                  gap 0.3s ease, font-size 0.3s ease,
                  border-radius 0.3s ease, box-shadow 0.3s ease,
                  max-width 0.3s ease, width 0.3s ease;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: var(--row-font);
      overflow: hidden;
      height: 100vh;
    }

    .mono { font-family: 'JetBrains Mono', monospace; }

    /* Agent row */
    .agent-row {
      display: flex;
      flex-direction: column;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: var(--row-gap);
      overflow: hidden;
      cursor: pointer;
    }

    .agent-row.stuck {
      border-left: 3px solid var(--stuck);
    }

    .agent-row-header {
      display: flex;
      align-items: center;
      min-height: var(--row-height);
      padding: 0 14px;
      gap: 12px;
      transition: background 0.15s ease;
    }

    .agent-row-header:hover {
      background: color-mix(in srgb, var(--text) 4%, transparent);
    }

    /* Status dot */
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .status-dot.stuck { background: var(--stuck); box-shadow: 0 0 6px color-mix(in srgb, var(--stuck) 60%, transparent); }
    .status-dot.active { background: var(--active); box-shadow: 0 0 6px color-mix(in srgb, var(--active) 40%, transparent); }
    .status-dot.idle { background: var(--idle); }

    /* Agent name */
    .agent-name {
      font-family: 'JetBrains Mono', monospace;
      font-size: calc(var(--row-font) - 1px);
      font-weight: 500;
      color: var(--text);
      min-width: 130px;
      flex-shrink: 0;
    }

    /* Task info */
    .task-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
      min-width: 0;
    }

    .task-name {
      font-size: var(--row-font);
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 500;
    }

    .task-meta {
      font-size: calc(var(--row-font) - 1px);
      color: var(--text-dim);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .project-badge {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      padding: 1px 5px;
      border-radius: 3px;
      background: color-mix(in srgb, var(--text-dim) 12%, transparent);
      color: var(--text-dim);
    }

    /* Progress bar */
    .progress-wrap {
      width: 80px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .progress-bar {
      height: 3px;
      background: color-mix(in srgb, var(--border) 80%, transparent);
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.4s ease;
    }

    .progress-fill.active { background: var(--active); }
    .progress-fill.stuck { background: var(--stuck); }
    .progress-fill.idle { background: var(--idle); }

    .progress-label {
      font-size: 10px;
      color: var(--text-dim);
      font-family: 'JetBrains Mono', monospace;
      text-align: right;
    }

    /* Silence timer */
    .silence-timer {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-dim);
      min-width: 50px;
      text-align: right;
      flex-shrink: 0;
    }

    .silence-timer.alarming {
      color: var(--stuck);
      font-weight: 600;
    }

    /* Sparkline */
    .sparkline-wrap {
      width: 120px;
      height: 32px;
      flex-shrink: 0;
    }

    sparkline-wrap svg {
      width: 100%;
      height: 100%;
    }

    /* Expand chevron */
    .chevron {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      color: var(--text-dim);
      transition: transform 0.2s ease;
    }

    .agent-row.expanded .chevron {
      transform: rotate(180deg);
    }

    /* Expanded detail panel */
    .detail-panel {
      border-top: 1px solid var(--border);
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.35s ease, padding 0.35s ease;
    }

    .agent-row.expanded .detail-panel {
      max-height: 600px;
      padding: 16px;
    }

    .agent-row.anim-fade .detail-panel {
      opacity: 0;
      transition: max-height 0.35s ease, padding 0.35s ease, opacity 0.25s ease;
    }
    .agent-row.anim-fade.expanded .detail-panel {
      opacity: 1;
    }

    .agent-row.anim-instant .detail-panel {
      transition: none;
    }

    /* Metrics row */
    .metrics-row {
      display: flex;
      gap: 20px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .metric {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .metric-label {
      font-size: 10px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 600;
    }

    .metric-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      color: var(--text);
      font-weight: 500;
    }

    .metric-value.alarming { color: var(--stuck); }
    .metric-value.good { color: var(--healthy); }

    /* Detail sections */
    .detail-sections {
      display: flex;
      gap: 20px;
    }

    .timeline-section {
      flex: 0 0 280px;
    }

    .task-context-section {
      flex: 1;
    }

    .section-label {
      font-size: 10px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 600;
      margin-bottom: 10px;
    }

    /* Timeline events */
    .timeline-events {
      display: flex;
      flex-direction: column;
      gap: 0;
      position: relative;
    }

    .timeline-events::before {
      content: '';
      position: absolute;
      left: 6px;
      top: 0;
      bottom: 0;
      width: 1px;
      background: var(--border);
    }

    .tl-event {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 4px 0;
      position: relative;
    }

    .tl-dot {
      width: 13px;
      height: 13px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: var(--card);
      flex-shrink: 0;
      margin-top: 2px;
      position: relative;
      z-index: 1;
    }

    .tl-dot.claimed { border-color: var(--active); background: color-mix(in srgb, var(--active) 20%, var(--card)); }
    .tl-dot.checkpoint { border-color: var(--text-dim); background: var(--card); }
    .tl-dot.completed { border-color: var(--healthy); background: color-mix(in srgb, var(--healthy) 20%, var(--card)); }

    .tl-content {
      flex: 1;
    }

    .tl-type {
      font-size: 10px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-weight: 600;
    }

    .tl-desc {
      font-size: 12px;
      color: var(--text);
      margin-top: 1px;
    }

    .tl-time {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: var(--text-dim);
      flex-shrink: 0;
      margin-top: 3px;
    }

    /* Task context */
    .task-context-card {
      background: color-mix(in srgb, var(--border) 30%, transparent);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
    }

    .task-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }

    .task-proj {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-dim);
      margin-bottom: 10px;
    }

    .task-desc {
      font-size: 12px;
      color: var(--text-dim);
      line-height: 1.5;
    }

    /* Fleet summary bar */
    .fleet-bar {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 12px;
    }

    .fleet-stat {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 500;
    }

    .fleet-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .idle-row { display: var(--idle-display); }

    /* Entrance animation */
    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .agent-row {
      animation: fadeSlideIn 0.4s ease both;
    }

    .agent-row:nth-child(1) { animation-delay: 0.05s; }
    .agent-row:nth-child(2) { animation-delay: 0.10s; }
    .agent-row:nth-child(3) { animation-delay: 0.15s; }
    .agent-row:nth-child(4) { animation-delay: 0.20s; }
    .agent-row:nth-child(5) { animation-delay: 0.25s; }
    .agent-row:nth-child(6) { animation-delay: 0.30s; }
    .agent-row:nth-child(7) { animation-delay: 0.35s; }
    .agent-row:nth-child(8) { animation-delay: 0.40s; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* Detail depth visibility */
    .detail-timeline { }
    .detail-task-context { }

    .depth-summary .detail-timeline,
    .depth-summary .detail-task-context { display: none; }

    .depth-timeline .detail-task-context { display: none; }

    .depth-full .detail-timeline,
    .depth-full .detail-task-context { display: block; }
  </style>
</head>
<body>

<div class="flex flex-col h-screen overflow-hidden p-4">

  <!-- Header -->
  <div class="flex items-center justify-between mb-3">
    <div>
      <h1 class="text-base font-semibold text-[var(--text)]">Agent Operations</h1>
      <p class="text-xs text-[var(--text-dim)] mt-0.5">Click any agent to inspect session details</p>
    </div>
    <div class="flex items-center gap-2 text-xs text-[var(--text-dim)]">
      <span class="w-2 h-2 rounded-full bg-[var(--healthy)] inline-block"></span>
      <span>Live</span>
    </div>
  </div>

  <!-- Fleet Summary Bar -->
  <div class="fleet-bar">
    <div class="fleet-stat">
      <span class="fleet-dot" style="background: var(--stuck);"></span>
      <span id="stuck-count" class="text-[var(--stuck)] font-semibold">2</span>
      <span class="text-[var(--text-dim)]">stuck</span>
    </div>
    <div class="w-px h-4 bg-[var(--border)]"></div>
    <div class="fleet-stat">
      <span class="fleet-dot" style="background: var(--active);"></span>
      <span class="text-[var(--active)] font-semibold">4</span>
      <span class="text-[var(--text-dim)]">active</span>
    </div>
    <div class="w-px h-4 bg-[var(--border)]"></div>
    <div class="fleet-stat">
      <span class="fleet-dot" style="background: var(--idle);"></span>
      <span class="text-[var(--text-dim)] font-semibold">2</span>
      <span class="text-[var(--text-dim)]">idle</span>
    </div>
    <div class="ml-auto text-xs text-[var(--text-dim)]">
      8 agents · updated just now
    </div>
  </div>

  <!-- Agent List -->
  <div class="flex-1 overflow-auto" id="agent-list" style="gap: var(--row-gap); display: flex; flex-direction: column;">

    <!-- STUCK: claude-sonnet-8 -->
    <div class="agent-row stuck expanded" id="row-claude-sonnet-8" data-status="stuck" data-silence="22" onclick="toggleRow(this)">
      <div class="agent-row-header">
        <span class="status-dot stuck"></span>
        <span class="agent-name mono">claude-sonnet-8</span>
        <div class="task-info">
          <span class="task-name">Fix pagination bug</span>
          <div class="task-meta">
            <span class="project-badge">web</span>
            <span>silent 22m · claimed 30m ago</span>
          </div>
        </div>
        <div class="progress-wrap">
          <div class="progress-bar"><div class="progress-fill stuck" style="width:20%"></div></div>
          <div class="progress-label">20%</div>
        </div>
        <span class="silence-timer alarming">22m silent</span>
        <div class="sparkline-wrap" id="spark-claude-sonnet-8">
          <!-- sparkline rendered by JS -->
        </div>
        <svg class="chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="4,6 8,10 12,6"/>
        </svg>
      </div>
      <div class="detail-panel" onclick="event.stopPropagation()">
        <div class="metrics-row">
          <div class="metric">
            <span class="metric-label">Elapsed</span>
            <span class="metric-value">30m</span>
          </div>
          <div class="metric">
            <span class="metric-label">Silence</span>
            <span class="metric-value alarming">22m</span>
          </div>
          <div class="metric">
            <span class="metric-label">Progress</span>
            <span class="metric-value">20%</span>
          </div>
          <div class="metric">
            <span class="metric-label">Events</span>
            <span class="metric-value">3</span>
          </div>
        </div>
        <div class="detail-sections">
          <div class="timeline-section detail-timeline">
            <div class="section-label">Session Timeline</div>
            <div class="timeline-events">
              <div class="tl-event">
                <div class="tl-dot claimed"></div>
                <div class="tl-content">
                  <div class="tl-type">Claimed</div>
                  <div class="tl-desc">Fix pagination bug</div>
                </div>
                <span class="tl-time">30m ago</span>
              </div>
              <div class="tl-event">
                <div class="tl-dot checkpoint"></div>
                <div class="tl-content">
                  <div class="tl-type">Checkpoint</div>
                  <div class="tl-desc">Reading cursor implementation</div>
                </div>
                <span class="tl-time">25m ago</span>
              </div>
              <div class="tl-event">
                <div class="tl-dot checkpoint"></div>
                <div class="tl-content">
                  <div class="tl-type">Checkpoint</div>
                  <div class="tl-desc">Investigating offset calculation</div>
                </div>
                <span class="tl-time">22m ago</span>
              </div>
            </div>
          </div>
          <div class="task-context-section detail-task-context">
            <div class="section-label">Task Context</div>
            <div class="task-context-card">
              <div class="task-title">Fix pagination bug</div>
              <div class="task-proj">project: web</div>
              <div class="task-desc">Agent made 3 checkpoints in the first 8m then went silent. Last known position: investigating offset calculation. No activity for 22m — may be stuck on a complex cursor edge case or waiting for external context.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- STUCK: claude-opus-7 -->
    <div class="agent-row stuck expanded" id="row-claude-opus-7" data-status="stuck" data-silence="12" onclick="toggleRow(this)">
      <div class="agent-row-header">
        <span class="status-dot stuck"></span>
        <span class="agent-name mono">claude-opus-7</span>
        <div class="task-info">
          <span class="task-name">Implement auth middleware</span>
          <div class="task-meta">
            <span class="project-badge">api-v2</span>
            <span>silent 12m · claimed 18m ago</span>
          </div>
        </div>
        <div class="progress-wrap">
          <div class="progress-bar"><div class="progress-fill stuck" style="width:35%"></div></div>
          <div class="progress-label">35%</div>
        </div>
        <span class="silence-timer alarming">12m silent</span>
        <div class="sparkline-wrap" id="spark-claude-opus-7"></div>
        <svg class="chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="4,6 8,10 12,6"/>
        </svg>
      </div>
      <div class="detail-panel" onclick="event.stopPropagation()">
        <div class="metrics-row">
          <div class="metric">
            <span class="metric-label">Elapsed</span>
            <span class="metric-value">25m</span>
          </div>
          <div class="metric">
            <span class="metric-label">Silence</span>
            <span class="metric-value alarming">12m</span>
          </div>
          <div class="metric">
            <span class="metric-label">Progress</span>
            <span class="metric-value">35%</span>
          </div>
          <div class="metric">
            <span class="metric-label">Events</span>
            <span class="metric-value">5</span>
          </div>
        </div>
        <div class="detail-sections">
          <div class="timeline-section detail-timeline">
            <div class="section-label">Session Timeline</div>
            <div class="timeline-events">
              <div class="tl-event">
                <div class="tl-dot checkpoint"></div>
                <div class="tl-content">
                  <div class="tl-type">Checkpoint</div>
                  <div class="tl-desc">Generated folder structure</div>
                </div>
                <span class="tl-time">25m ago</span>
              </div>
              <div class="tl-event">
                <div class="tl-dot completed"></div>
                <div class="tl-content">
                  <div class="tl-type">Completed</div>
                  <div class="tl-desc">Set up project scaffolding</div>
                </div>
                <span class="tl-time">20m ago</span>
              </div>
              <div class="tl-event">
                <div class="tl-dot claimed"></div>
                <div class="tl-content">
                  <div class="tl-type">Claimed</div>
                  <div class="tl-desc">Implement auth middleware</div>
                </div>
                <span class="tl-time">18m ago</span>
              </div>
              <div class="tl-event">
                <div class="tl-dot checkpoint"></div>
                <div class="tl-content">
                  <div class="tl-type">Checkpoint</div>
                  <div class="tl-desc">Reading existing auth code</div>
                </div>
                <span class="tl-time">15m ago</span>
              </div>
              <div class="tl-event">
                <div class="tl-dot checkpoint"></div>
                <div class="tl-content">
                  <div class="tl-type">Checkpoint</div>
                  <div class="tl-desc">Analyzing JWT library options</div>
                </div>
                <span class="tl-time">12m ago</span>
              </div>
            </div>
          </div>
          <div class="task-context-section detail-task-context">
            <div class="section-label">Task Context</div>
            <div class="task-context-card">
              <div class="task-title">Implement auth middleware</div>
              <div class="task-proj">project: api-v2</div>
              <div class="task-desc">Agent completed scaffolding task, then claimed this one. Made 3 checkpoints in 6m then went silent 12m ago. Last known position: analyzing JWT library options. May be stuck on dependency selection or token strategy.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ACTIVE: gemini-pro-1 -->
    <div class="agent-row" id="row-gemini-pro-1" data-status="active" data-silence="0" onclick="toggleRow(this)">
      <div class="agent-row-header">
        <span class="status-dot active"></span>
        <span class="agent-name mono">gemini-pro-1</span>
        <div class="task-info">
          <span class="task-name">Refactor database queries</span>
          <div class="task-meta">
            <span class="project-badge">core</span>
            <span>last event 30s ago</span>
          </div>
        </div>
        <div class="progress-wrap">
          <div class="progress-bar"><div class="progress-fill active" style="width:75%"></div></div>
          <div class="progress-label">75%</div>
        </div>
        <span class="silence-timer">30s</span>
        <div class="sparkline-wrap" id="spark-gemini-pro-1"></div>
        <svg class="chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="4,6 8,10 12,6"/>
        </svg>
      </div>
      <div class="detail-panel" onclick="event.stopPropagation()">
        <div class="metrics-row">
          <div class="metric">
            <span class="metric-label">Elapsed</span>
            <span class="metric-value">15m</span>
          </div>
          <div class="metric">
            <span class="metric-label">Last Event</span>
            <span class="metric-value good">30s ago</span>
          </div>
          <div class="metric">
            <span class="metric-label">Progress</span>
            <span class="metric-value">75%</span>
          </div>
          <div class="metric">
            <span class="metric-label">Events</span>
            <span class="metric-value">6</span>
          </div>
        </div>
        <div class="detail-sections">
          <div class="timeline-section detail-timeline">
            <div class="section-label">Session Timeline — Dense &amp; Accelerating</div>
            <div class="timeline-events">
              <div class="tl-event">
                <div class="tl-dot claimed"></div>
                <div class="tl-content">
                  <div class="tl-type">Claimed</div>
                  <div class="tl-desc">Refactor database queries</div>
                </div>
                <span class="tl-time">15m ago</span>
              </div>
              <div class="tl-event">
                <div class="tl-dot checkpoint"></div>
                <div class="tl-content"><div class="tl-type">Checkpoint</div><div class="tl-desc">Identified slow N+1 patterns</div></div>
                <span class="tl-time">12m ago</span>
              </div>
              <div class="tl-event">
                <div class="tl-dot checkpoint"></div>
                <div class="tl-content"><div class="tl-type">Checkpoint</div><div class="tl-desc">Rewrote task list query with JOIN</div></div>
                <span class="tl-time">9m ago</span>
              </div>
              <div class="tl-event">
                <div class="tl-dot checkpoint"></div>
                <div class="tl-content"><div class="tl-type">Checkpoint</div><div class="tl-desc">Added query result caching layer</div></div>
                <span class="tl-time">6m ago</span>
              </div>
              <div class="tl-event">
                <div class="tl-dot checkpoint"></div>
                <div class="tl-content"><div class="tl-type">Checkpoint</div><div class="tl-desc">Benchmarking — 4x speedup confirmed</div></div>
                <span class="tl-time">3m ago</span>
              </div>
              <div class="tl-event">
                <div class="tl-dot checkpoint"></div>
                <div class="tl-content"><div class="tl-type">Checkpoint</div><div class="tl-desc">Running final test suite</div></div>
                <span class="tl-time">30s ago</span>
              </div>
            </div>
          </div>
          <div class="task-context-section detail-task-context">
            <div class="section-label">Task Context</div>
            <div class="task-context-card">
              <div class="task-title">Refactor database queries</div>
              <div class="task-proj">project: core</div>
              <div class="task-desc">Active and accelerating. 6 events in 15m with increasing cadence — final benchmarking and test run in progress. On track to complete soon.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ACTIVE: claude-sonnet-3 (auto-expanded) -->
    <div class="agent-row expanded" id="row-claude-sonnet-3" data-status="active" data-silence="1" onclick="toggleRow(this)">
      <div class="agent-row-header">
        <span class="status-dot active"></span>
        <span class="agent-name mono">claude-sonnet-3</span>
        <div class="task-info">
          <span class="task-name">Add search API endpoint</span>
          <div class="task-meta">
            <span class="project-badge">api-v2</span>
            <span>last event 1m ago</span>
          </div>
        </div>
        <div class="progress-wrap">
          <div class="progress-bar"><div class="progress-fill active" style="width:60%"></div></div>
          <div class="progress-label">60%</div>
        </div>
        <span class="silence-timer">1m</span>
        <div class="sparkline-wrap" id="spark-claude-sonnet-3"></div>
        <svg class="chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="4,6 8,10 12,6"/>
        </svg>
      </div>
      <div class="detail-panel" onclick="event.stopPropagation()">
        <div class="metrics-row">
          <div class="metric">
            <span class="metric-label">Elapsed</span>
            <span class="metric-value">12m</span>
          </div>
          <div class="metric">
            <span class="metric-label">Last Event</span>
            <span class="metric-value good">1m ago</span>
          </div>
          <div class="metric">
            <span class="metric-label">Progress</span>
            <span class="metric-value">60%</span>
          </div>
          <div class="metric">
            <span class="metric-label">Events</span>
            <span class="metric-value">6</span>
          </div>
        </div>
        <div class="detail-sections">
          <div class="timeline-section detail-timeline">
            <div class="section-label">Session Timeline</div>
            <div class="timeline-events">
              <div class="tl-event">
                <div class="tl-dot checkpoint"></div>
                <div class="tl-content"><div class="tl-type">Checkpoint</div><div class="tl-desc">Finalized FTS5 index design</div></div>
                <span class="tl-time">12m ago</span>
              </div>
              <div class="tl-event">
                <div class="tl-dot claimed"></div>
                <div class="tl-content"><div class="tl-type">Claimed</div><div class="tl-desc">Add search API endpoint</div></div>
                <span class="tl-time">8m ago</span>
              </div>
              <div class="tl-event">
                <div class="tl-dot checkpoint"></div>
                <div class="tl-content"><div class="tl-type">Checkpoint</div><div class="tl-desc">Designing search schema</div></div>
                <span class="tl-time">5m ago</span>
              </div>
              <div class="tl-event">
                <div class="tl-dot completed"></div>
                <div class="tl-content"><div class="tl-type">Completed</div><div class="tl-desc">Design search schema</div></div>
                <span class="tl-time">10m ago</span>
              </div>
              <div class="tl-event">
                <div class="tl-dot checkpoint"></div>
                <div class="tl-content"><div class="tl-type">Checkpoint</div><div class="tl-desc">Added search route handler</div></div>
                <span class="tl-time">3m ago</span>
              </div>
              <div class="tl-event">
                <div class="tl-dot checkpoint"></div>
                <div class="tl-content"><div class="tl-type">Checkpoint</div><div class="tl-desc">Implementing full-text search</div></div>
                <span class="tl-time">1m ago</span>
              </div>
            </div>
          </div>
          <div class="task-context-section detail-task-context">
            <div class="section-label">Task Context</div>
            <div class="task-context-card">
              <div class="task-title">Add search API endpoint</div>
              <div class="task-proj">project: api-v2</div>
              <div class="task-desc">Regular 2-3m event cadence. Agent designed schema, completed it as a sub-task, and is now implementing full-text search route. Healthy progression with consistent output.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ACTIVE: claude-haiku-2 -->
    <div class="agent-row" id="row-claude-haiku-2" data-status="active" data-silence="3" onclick="toggleRow(this)">
      <div class="agent-row-header">
        <span class="status-dot active"></span>
        <span class="agent-name mono">claude-haiku-2</span>
        <div class="task-info">
          <span class="task-name">Write unit tests for TaskService</span>
          <div class="task-meta">
            <span class="project-badge">core</span>
            <span>last event 3m ago</span>
          </div>
        </div>
        <div class="progress-wrap">
          <div class="progress-bar"><div class="progress-fill active" style="width:40%"></div></div>
          <div class="progress-label">40%</div>
        </div>
        <span class="silence-timer">3m</span>
        <div class="sparkline-wrap" id="spark-claude-haiku-2"></div>
        <svg class="chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="4,6 8,10 12,6"/>
        </svg>
      </div>
      <div class="detail-panel" onclick="event.stopPropagation()">
        <div class="metrics-row">
          <div class="metric"><span class="metric-label">Elapsed</span><span class="metric-value">12m</span></div>
          <div class="metric"><span class="metric-label">Last Event</span><span class="metric-value good">3m ago</span></div>
          <div class="metric"><span class="metric-label">Progress</span><span class="metric-value">40%</span></div>
          <div class="metric"><span class="metric-label">Events</span><span class="metric-value">4</span></div>
        </div>
        <div class="detail-sections">
          <div class="timeline-section detail-timeline">
            <div class="section-label">Session Timeline</div>
            <div class="timeline-events">
              <div class="tl-event"><div class="tl-dot claimed"></div><div class="tl-content"><div class="tl-type">Claimed</div><div class="tl-desc">Write unit tests for TaskService</div></div><span class="tl-time">12m ago</span></div>
              <div class="tl-event"><div class="tl-dot checkpoint"></div><div class="tl-content"><div class="tl-type">Checkpoint</div><div class="tl-desc">Scaffolded test file structure</div></div><span class="tl-time">9m ago</span></div>
              <div class="tl-event"><div class="tl-dot checkpoint"></div><div class="tl-content"><div class="tl-type">Checkpoint</div><div class="tl-desc">Added create/claim test cases</div></div><span class="tl-time">6m ago</span></div>
              <div class="tl-event"><div class="tl-dot checkpoint"></div><div class="tl-content"><div class="tl-type">Checkpoint</div><div class="tl-desc">Writing concurrency test scenarios</div></div><span class="tl-time">3m ago</span></div>
            </div>
          </div>
          <div class="task-context-section detail-task-context">
            <div class="section-label">Task Context</div>
            <div class="task-context-card">
              <div class="task-title">Write unit tests for TaskService</div>
              <div class="task-proj">project: core</div>
              <div class="task-desc">Steady 3m cadence. Currently working on concurrency test scenarios for atomic claiming. Normal intermittent usage pattern.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ACTIVE: gpt-4o-agent -->
    <div class="agent-row" id="row-gpt-4o-agent" data-status="active" data-silence="2" onclick="toggleRow(this)">
      <div class="agent-row-header">
        <span class="status-dot active"></span>
        <span class="agent-name mono">gpt-4o-agent</span>
        <div class="task-info">
          <span class="task-name">Update API documentation</span>
          <div class="task-meta">
            <span class="project-badge">docs</span>
            <span>last event 2m ago · just started</span>
          </div>
        </div>
        <div class="progress-wrap">
          <div class="progress-bar"><div class="progress-fill active" style="width:25%"></div></div>
          <div class="progress-label">25%</div>
        </div>
        <span class="silence-timer">2m</span>
        <div class="sparkline-wrap" id="spark-gpt-4o-agent"></div>
        <svg class="chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="4,6 8,10 12,6"/>
        </svg>
      </div>
      <div class="detail-panel" onclick="event.stopPropagation()">
        <div class="metrics-row">
          <div class="metric"><span class="metric-label">Elapsed</span><span class="metric-value">5m</span></div>
          <div class="metric"><span class="metric-label">Last Event</span><span class="metric-value good">2m ago</span></div>
          <div class="metric"><span class="metric-label">Progress</span><span class="metric-value">25%</span></div>
          <div class="metric"><span class="metric-label">Events</span><span class="metric-value">3</span></div>
        </div>
        <div class="detail-sections">
          <div class="timeline-section detail-timeline">
            <div class="section-label">Session Timeline</div>
            <div class="timeline-events">
              <div class="tl-event"><div class="tl-dot claimed"></div><div class="tl-content"><div class="tl-type">Claimed</div><div class="tl-desc">Update API documentation</div></div><span class="tl-time">5m ago</span></div>
              <div class="tl-event"><div class="tl-dot checkpoint"></div><div class="tl-content"><div class="tl-type">Checkpoint</div><div class="tl-desc">Reviewed existing endpoint docs</div></div><span class="tl-time">4m ago</span></div>
              <div class="tl-event"><div class="tl-dot checkpoint"></div><div class="tl-content"><div class="tl-type">Checkpoint</div><div class="tl-desc">Drafting search endpoint docs</div></div><span class="tl-time">2m ago</span></div>
            </div>
          </div>
          <div class="task-context-section detail-task-context">
            <div class="section-label">Task Context</div>
            <div class="task-context-card">
              <div class="task-title">Update API documentation</div>
              <div class="task-proj">project: docs</div>
              <div class="task-desc">Just getting started. 3 events in 5m — reviewing existing docs and starting to draft new search endpoint documentation. Normal startup pattern.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- IDLE: claude-opus-5 -->
    <div class="agent-row idle-row" id="row-claude-opus-5" data-status="idle" data-silence="0" onclick="toggleRow(this)" style="display: var(--idle-display);">
      <div class="agent-row-header">
        <span class="status-dot idle"></span>
        <span class="agent-name mono">claude-opus-5</span>
        <div class="task-info">
          <span class="task-name" style="color: var(--text-dim);">Idle since 8m ago</span>
          <div class="task-meta">
            <span>completed "Set up CI pipeline"</span>
            <span class="project-badge">infra</span>
          </div>
        </div>
        <div class="progress-wrap">
          <div class="progress-bar"><div class="progress-fill idle" style="width:100%"></div></div>
          <div class="progress-label" style="color: var(--healthy);">done</div>
        </div>
        <span class="silence-timer">idle 8m</span>
        <div class="sparkline-wrap" id="spark-claude-opus-5"></div>
        <svg class="chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="4,6 8,10 12,6"/>
        </svg>
      </div>
      <div class="detail-panel" onclick="event.stopPropagation()">
        <div class="metrics-row">
          <div class="metric"><span class="metric-label">Status</span><span class="metric-value">Idle</span></div>
          <div class="metric"><span class="metric-label">Last Task</span><span class="metric-value">Set up CI pipeline</span></div>
          <div class="metric"><span class="metric-label">Session Dur.</span><span class="metric-value">7m</span></div>
          <div class="metric"><span class="metric-label">Events</span><span class="metric-value">3</span></div>
        </div>
        <div class="detail-sections">
          <div class="timeline-section detail-timeline">
            <div class="section-label">Last Session (8m ago)</div>
            <div class="timeline-events">
              <div class="tl-event"><div class="tl-dot claimed"></div><div class="tl-content"><div class="tl-type">Claimed</div><div class="tl-desc">Set up CI pipeline</div></div><span class="tl-time">15m ago</span></div>
              <div class="tl-event"><div class="tl-dot checkpoint"></div><div class="tl-content"><div class="tl-type">Checkpoint</div><div class="tl-desc">Configured GitHub Actions workflow</div></div><span class="tl-time">11m ago</span></div>
              <div class="tl-event"><div class="tl-dot completed"></div><div class="tl-content"><div class="tl-type">Completed</div><div class="tl-desc">Set up CI pipeline</div></div><span class="tl-time">8m ago</span></div>
            </div>
          </div>
          <div class="task-context-section detail-task-context">
            <div class="section-label">Status</div>
            <div class="task-context-card">
              <div class="task-title" style="color: var(--text-dim);">Awaiting next task</div>
              <div class="task-proj">last project: infra</div>
              <div class="task-desc">Completed last task 8m ago. Silence here is NORMAL — the agent finished its work and is idle between assignments. Sparkline shows the session block ending cleanly.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- IDLE: claude-haiku-9 -->
    <div class="agent-row idle-row" id="row-claude-haiku-9" data-status="idle" data-silence="0" onclick="toggleRow(this)" style="display: var(--idle-display);">
      <div class="agent-row-header">
        <span class="status-dot idle"></span>
        <span class="agent-name mono">claude-haiku-9</span>
        <div class="task-info">
          <span class="task-name" style="color: var(--text-dim);">Idle since 3m ago</span>
          <div class="task-meta">
            <span>completed "Add input validation"</span>
            <span class="project-badge">api-v2</span>
          </div>
        </div>
        <div class="progress-wrap">
          <div class="progress-bar"><div class="progress-fill idle" style="width:100%"></div></div>
          <div class="progress-label" style="color: var(--healthy);">done</div>
        </div>
        <span class="silence-timer">idle 3m</span>
        <div class="sparkline-wrap" id="spark-claude-haiku-9"></div>
        <svg class="chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="4,6 8,10 12,6"/>
        </svg>
      </div>
      <div class="detail-panel" onclick="event.stopPropagation()">
        <div class="metrics-row">
          <div class="metric"><span class="metric-label">Status</span><span class="metric-value">Idle</span></div>
          <div class="metric"><span class="metric-label">Last Task</span><span class="metric-value">Add input validation</span></div>
          <div class="metric"><span class="metric-label">Session Dur.</span><span class="metric-value">5m</span></div>
          <div class="metric"><span class="metric-label">Events</span><span class="metric-value">3</span></div>
        </div>
        <div class="detail-sections">
          <div class="timeline-section detail-timeline">
            <div class="section-label">Last Session (3m ago)</div>
            <div class="timeline-events">
              <div class="tl-event"><div class="tl-dot claimed"></div><div class="tl-content"><div class="tl-type">Claimed</div><div class="tl-desc">Add input validation</div></div><span class="tl-time">8m ago</span></div>
              <div class="tl-event"><div class="tl-dot checkpoint"></div><div class="tl-content"><div class="tl-type">Checkpoint</div><div class="tl-desc">Implemented Zod schemas for routes</div></div><span class="tl-time">5m ago</span></div>
              <div class="tl-event"><div class="tl-dot completed"></div><div class="tl-content"><div class="tl-type">Completed</div><div class="tl-desc">Add input validation</div></div><span class="tl-time">3m ago</span></div>
            </div>
          </div>
          <div class="task-context-section detail-task-context">
            <div class="section-label">Status</div>
            <div class="task-context-card">
              <div class="task-title" style="color: var(--text-dim);">Awaiting next task</div>
              <div class="task-proj">last project: api-v2</div>
              <div class="task-desc">Completed 3m ago. Recently finished and awaiting queue assignment. Sparkline shows a clean, short session ending 3m ago — healthy completion pattern.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  // ─── Sparkline drawing ────────────────────────────────────────────
  // Each agent has a data model: sessionBlocks and eventTicks within the last ~35 minutes
  // Time is expressed as minutes-ago (higher = older)
  // sessionBlocks: [{start, end}] where start > end (start is more minutes ago)
  // events: [minutesAgo, ...]

  const WINDOW = 35; // minutes visible in sparkline

  const agentSparkData = {
    'claude-sonnet-8': {
      status: 'stuck',
      // session started 30m ago, last event 22m ago
      sessions: [{ start: 30, end: 22 }], // ends at silence point
      events: [30, 27, 25, 22],            // last at 22m (then silence)
      silenceGap: 22,                       // silence extends from 22m to now (0)
    },
    'claude-opus-7': {
      status: 'stuck',
      // prior session ended ~20m ago, current session 18m–12m ago then silence
      sessions: [{ start: 25, end: 20 }, { start: 18, end: 12 }],
      events: [25, 20, 18, 15, 12],
      silenceGap: 12,
    },
    'gemini-pro-1': {
      status: 'active',
      sessions: [{ start: 15, end: 0 }],
      events: [15, 12.5, 10, 7, 4, 1.5, 0.5],
    },
    'claude-sonnet-3': {
      status: 'active',
      sessions: [{ start: 12, end: 0 }],
      events: [12, 10, 8, 5, 3, 1],
    },
    'claude-haiku-2': {
      status: 'active',
      sessions: [{ start: 12, end: 0 }],
      events: [12, 9, 6, 3],
    },
    'gpt-4o-agent': {
      status: 'active',
      sessions: [{ start: 5, end: 0 }],
      events: [5, 4, 2],
    },
    'claude-opus-5': {
      status: 'idle',
      // session was 15m to 8m ago, then done
      sessions: [{ start: 15, end: 8 }],
      events: [15, 11, 8],
      silenceGap: null, // idle is fine — no alarming gap
    },
    'claude-haiku-9': {
      status: 'idle',
      sessions: [{ start: 8, end: 3 }],
      events: [8, 5, 3],
      silenceGap: null,
    },
  };

  function minutesToX(minutesAgo, width) {
    // 0 minutes ago = right edge, WINDOW minutes ago = left edge
    return width - (minutesAgo / WINDOW) * width;
  }

  function drawSparklineBlocks(svgEl, data, width, height) {
    const { status, sessions, events, silenceGap } = data;
    svgEl.setAttribute('width', width);
    svgEl.setAttribute('height', height);
    svgEl.innerHTML = '';

    const mid = height / 2;
    const blockH = height * 0.45;
    const blockY = (height - blockH) / 2;

    // Draw session blocks
    sessions.forEach(({ start, end }) => {
      const x1 = minutesToX(start, width);
      const x2 = minutesToX(end, width);
      const blockW = Math.max(x2 - x1, 2);

      const color = status === 'stuck' ? 'rgba(59,130,246,0.25)' :
                    status === 'idle' ? 'rgba(107,114,128,0.2)' :
                    'rgba(59,130,246,0.2)';

      const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      rect.setAttribute('x', x1);
      rect.setAttribute('y', blockY);
      rect.setAttribute('width', blockW);
      rect.setAttribute('height', blockH);
      rect.setAttribute('rx', '2');
      rect.setAttribute('fill', color);
      svgEl.appendChild(rect);
    });

    // If stuck: draw silence gap as a faded red region from last event to now
    if (status === 'stuck' && silenceGap != null) {
      const x1 = minutesToX(silenceGap, width);
      const x2 = minutesToX(0, width);
      const gapW = Math.max(x2 - x1, 4);

      const gapRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      gapRect.setAttribute('x', x1);
      gapRect.setAttribute('y', blockY);
      gapRect.setAttribute('width', gapW);
      gapRect.setAttribute('height', blockH);
      gapRect.setAttribute('rx', '2');
      gapRect.setAttribute('fill', 'rgba(239,68,68,0.18)');
      svgEl.appendChild(gapRect);

      // Red right-edge marker
      const edgeLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      edgeLine.setAttribute('x1', x2 - 1);
      edgeLine.setAttribute('y1', blockY);
      edgeLine.setAttribute('x2', x2 - 1);
      edgeLine.setAttribute('y2', blockY + blockH);
      edgeLine.setAttribute('stroke', 'rgba(239,68,68,0.5)');
      edgeLine.setAttribute('stroke-width', '1.5');
      svgEl.appendChild(edgeLine);
    }

    // Draw event ticks
    events.forEach(minutesAgo => {
      const x = minutesToX(minutesAgo, width);
      const isInSilenceGap = status === 'stuck' && silenceGap != null && minutesAgo <= silenceGap;
      const tickColor = isInSilenceGap ? 'rgba(239,68,68,0.7)' :
                        status === 'idle' ? 'rgba(107,114,128,0.6)' :
                        'rgba(59,130,246,0.9)';

      const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line.setAttribute('x1', x);
      line.setAttribute('y1', blockY + 2);
      line.setAttribute('x2', x);
      line.setAttribute('y2', blockY + blockH - 2);
      line.setAttribute('stroke', tickColor);
      line.setAttribute('stroke-width', '1.5');
      svgEl.appendChild(line);
    });

    // Baseline
    const baseline = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    baseline.setAttribute('x1', 0);
    baseline.setAttribute('y1', height - 1);
    baseline.setAttribute('x2', width);
    baseline.setAttribute('y2', height - 1);
    baseline.setAttribute('stroke', 'rgba(42,45,58,0.8)');
    baseline.setAttribute('stroke-width', '1');
    svgEl.appendChild(baseline);
  }

  function drawSparklineTicks(svgEl, data, width, height) {
    const { status, events, silenceGap } = data;
    svgEl.setAttribute('width', width);
    svgEl.setAttribute('height', height);
    svgEl.innerHTML = '';

    const mid = height / 2;

    // Baseline
    const baseline = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    baseline.setAttribute('x1', 0);
    baseline.setAttribute('y1', height - 1);
    baseline.setAttribute('x2', width);
    baseline.setAttribute('y2', height - 1);
    baseline.setAttribute('stroke', 'rgba(42,45,58,0.8)');
    baseline.setAttribute('stroke-width', '1');
    svgEl.appendChild(baseline);

    // Ticks for each event
    events.forEach(minutesAgo => {
      const x = minutesToX(minutesAgo, width);
      const isInSilenceGap = status === 'stuck' && silenceGap != null && minutesAgo <= silenceGap;
      const tickColor = isInSilenceGap ? 'rgba(239,68,68,0.8)' :
                        status === 'idle' ? 'rgba(107,114,128,0.7)' :
                        'rgba(59,130,246,1.0)';
      const tickH = 14 + Math.random() * 8; // slight variation

      const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line.setAttribute('x1', x);
      line.setAttribute('y1', height - 1 - tickH);
      line.setAttribute('x2', x);
      line.setAttribute('y2', height - 1);
      line.setAttribute('stroke', tickColor);
      line.setAttribute('stroke-width', '2');
      svgEl.appendChild(line);
    });

    // If stuck, show silence indicator
    if (status === 'stuck' && silenceGap != null) {
      const x = minutesToX(silenceGap, width);
      const xEnd = minutesToX(0, width);
      const ellipsis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      ellipsis.setAttribute('x1', x + 4);
      ellipsis.setAttribute('y1', height - 6);
      ellipsis.setAttribute('x2', xEnd - 2);
      ellipsis.setAttribute('y2', height - 6);
      ellipsis.setAttribute('stroke', 'rgba(239,68,68,0.3)');
      ellipsis.setAttribute('stroke-width', '1.5');
      ellipsis.setAttribute('stroke-dasharray', '2,3');
      svgEl.appendChild(ellipsis);
    }
  }

  function drawSparklineArea(svgEl, data, width, height) {
    const { status, sessions, events, silenceGap } = data;
    svgEl.setAttribute('width', width);
    svgEl.setAttribute('height', height);
    svgEl.innerHTML = '';

    if (events.length === 0) return;

    // Build value points: events map to height, gaps map to 0
    // Create a series: for each session, ramp up, for gaps, go to 0
    const allMins = [...events].sort((a, b) => b - a); // oldest first
    if (allMins.length === 0) return;

    const pts = [];
    const oldest = allMins[0];

    // Start at baseline on left
    pts.push([minutesToX(WINDOW, width), height - 1]);

    allMins.forEach((m, i) => {
      const x = minutesToX(m, width);
      const nextM = i < allMins.length - 1 ? allMins[i + 1] : null;
      const yVal = height * 0.15; // event height

      pts.push([x, height - 1 - (height - yVal)]);

      // Check gap to next event
      if (nextM !== null) {
        const gap = m - nextM;
        if (gap > 4) {
          pts.push([x + 2, height - 1]);
          pts.push([minutesToX(nextM, width) - 2, height - 1]);
        }
      }
    });

    // End point (now = right edge)
    const rightEdge = minutesToX(0, width);
    if (status === 'idle' || (status === 'stuck' && silenceGap != null)) {
      // Drop to baseline before end
      const dropX = status === 'stuck' ? minutesToX(silenceGap, width) : minutesToX(allMins[allMins.length - 1], width);
      pts.push([dropX + 2, height - 1]);
      pts.push([rightEdge, height - 1]);
    } else {
      pts.push([rightEdge, height - 1]);
    }

    const pathD = pts.map((p, i) => `${i === 0 ? 'M' : 'L'}${p[0].toFixed(1)},${p[1].toFixed(1)}`).join(' ') + ' Z';

    const areaColor = status === 'stuck' ? 'rgba(239,68,68,0.25)' :
                      status === 'idle' ? 'rgba(107,114,128,0.2)' :
                      'rgba(59,130,246,0.25)';
    const strokeColor = status === 'stuck' ? 'rgba(239,68,68,0.6)' :
                        status === 'idle' ? 'rgba(107,114,128,0.5)' :
                        'rgba(59,130,246,0.7)';

    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', pathD);
    path.setAttribute('fill', areaColor);
    path.setAttribute('stroke', strokeColor);
    path.setAttribute('stroke-width', '1');
    svgEl.appendChild(path);

    // Baseline
    const baseline = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    baseline.setAttribute('x1', 0);
    baseline.setAttribute('y1', height - 1);
    baseline.setAttribute('x2', width);
    baseline.setAttribute('y2', height - 1);
    baseline.setAttribute('stroke', 'rgba(42,45,58,0.8)');
    baseline.setAttribute('stroke-width', '1');
    svgEl.appendChild(baseline);
  }

  function renderAllSparklines(style) {
    Object.entries(agentSparkData).forEach(([agentId, data]) => {
      const wrap = document.getElementById('spark-' + agentId);
      if (!wrap) return;

      let svg = wrap.querySelector('svg');
      if (!svg) {
        svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        wrap.appendChild(svg);
      }

      const w = wrap.offsetWidth || 120;
      const h = wrap.offsetHeight || 32;

      if (style === 'ticks') {
        drawSparklineTicks(svg, data, w, h);
      } else if (style === 'area') {
        drawSparklineArea(svg, data, w, h);
      } else {
        drawSparklineBlocks(svg, data, w, h);
      }
    });
  }

  // ─── Row toggle ─────────────────────────────────────────────────
  let currentAnim = 'slide';
  let currentDepth = 'full';

  function toggleRow(rowEl) {
    const wasExpanded = rowEl.classList.contains('expanded');

    if (currentAnim === 'fade') {
      rowEl.classList.add('anim-fade');
      rowEl.classList.remove('anim-instant');
    } else if (currentAnim === 'instant') {
      rowEl.classList.add('anim-instant');
      rowEl.classList.remove('anim-fade');
    } else {
      rowEl.classList.remove('anim-fade', 'anim-instant');
    }

    if (wasExpanded) {
      rowEl.classList.remove('expanded');
    } else {
      rowEl.classList.add('expanded');
    }

    applyDepth(rowEl, currentDepth);
  }

  function applyDepth(rowEl, depth) {
    rowEl.classList.remove('depth-summary', 'depth-timeline', 'depth-full');
    rowEl.classList.add('depth-' + depth);
  }

  function applyDepthAll(depth) {
    document.querySelectorAll('.agent-row').forEach(row => {
      applyDepth(row, depth);
    });
  }

  // ─── Stuck threshold ────────────────────────────────────────────
  function updateStuckThreshold(thresholdMin) {
    const rows = document.querySelectorAll('.agent-row');
    let stuckCount = 0;

    rows.forEach(row => {
      const silence = parseInt(row.dataset.silence, 10) || 0;
      const status = row.dataset.status;

      if (status === 'active' && silence >= thresholdMin) {
        row.classList.add('stuck');
        row.querySelector('.status-dot').className = 'status-dot stuck';
        row.querySelector('.silence-timer').classList.add('alarming');
        stuckCount++;
      } else if (status === 'stuck') {
        stuckCount++;
      }
    });

    document.getElementById('stuck-count').textContent = stuckCount;
  }

  // ─── Control event listeners ─────────────────────────────────────
  document.addEventListener('control-change', (e) => {
    const { id, value } = e.detail;

    if (id === 'sparkline-style') {
      renderAllSparklines(value);
    }

    if (id === 'expand-anim') {
      currentAnim = value;
    }

    if (id === 'detail-depth') {
      currentDepth = value;
      applyDepthAll(value);
    }

    if (id === 'stuck-threshold') {
      updateStuckThreshold(parseInt(value, 10));
    }
  });

  document.addEventListener('controls-ready', () => {
    const style = getComputedStyle(document.documentElement)
      .getPropertyValue('--sparkline-style').trim() || 'blocks';
    renderAllSparklines(style);

    const depth = getComputedStyle(document.documentElement)
      .getPropertyValue('--detail-depth').trim() || 'full';
    currentDepth = depth;
    applyDepthAll(depth);

    const anim = getComputedStyle(document.documentElement)
      .getPropertyValue('--expand-anim').trim() || 'slide';
    currentAnim = anim;
  });

  // ─── Init ────────────────────────────────────────────────────────
  window.addEventListener('load', () => {
    // Apply initial depth to all rows
    applyDepthAll('full');

    // Small delay to let layout settle, then draw sparklines
    setTimeout(() => {
      renderAllSparklines('blocks');
    }, 80);

    // Re-draw on resize
    window.addEventListener('resize', () => {
      const style = getComputedStyle(document.documentElement)
        .getPropertyValue('--sparkline-style').trim() || 'blocks';
      renderAllSparklines(style);
    });
  });
</script>
</body>
</html>

  </template>
  <template id="tpl-d2" data-body-class="h-screen overflow-hidden flex flex-col">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script type="application/json" id="variation-meta">
  {
    "id": "D2",
    "family": "D",
    "familyName": "Triage Strips",
    "name": "Incident Banner + Roster",
    "layoutType": "Alert Banner + Expandable Rows",
    "aesthetic": "Professional Dark",
    "description": "Compact incident banner for stuck agents above a full expandable agent roster with inline sparklines.",
    "controls": [
      {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["5 min", "10 min", "15 min", "30 min"],
        "cssValues": { "5 min": "5", "10 min": "10", "15 min": "15", "30 min": "30" },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
      },
      {
        "id": "banner-height",
        "label": "Banner Height",
        "type": "range",
        "min": 56, "max": 140, "step": 12,
        "options": null,
        "value": 80,
        "defaultValue": 80,
        "unit": "px",
        "cssVar": "--banner-height"
      },
      {
        "id": "banner-style",
        "label": "Banner Style",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["minimal", "detailed", "expanded"],
        "cssValues": { "minimal": "minimal", "detailed": "detailed", "expanded": "expanded" },
        "value": "detailed",
        "defaultValue": "detailed",
        "unit": "",
        "cssVar": "--banner-style",
        "event": true
      },
      {
        "id": "row-height",
        "label": "Row Height",
        "type": "range",
        "min": 44, "max": 68, "step": 4,
        "options": null,
        "value": 52,
        "defaultValue": 52,
        "unit": "px",
        "cssVar": "--row-height"
      },
      {
        "id": "sparkline-width",
        "label": "Sparkline Width",
        "type": "range",
        "min": 80, "max": 200, "step": 20,
        "options": null,
        "value": 140,
        "defaultValue": 140,
        "unit": "px",
        "cssVar": "--sparkline-width"
      },
      {
        "id": "group-status",
        "label": "Group By Status",
        "type": "toggle",
        "min": null, "max": null, "step": null,
        "options": null,
        "cssValues": { "true": "1", "false": "0" },
        "value": false,
        "defaultValue": false,
        "unit": "",
        "cssVar": "--group-status",
        "event": true
      }
    ]
  }
  </script>
  <style>
    :root {
      --bg: #0f1117;
      --card: #1a1d27;
      --border: #2a2d3a;
      --text: #e2e4e9;
      --text-dim: #8b8fa3;
      --stuck: #ef4444;
      --active: #3b82f6;
      --idle: #6b7280;
      --healthy: #22c55e;
      --font-sans: 'Inter', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --radius: 8px;
      --banner-height: 80px;
      --row-height: 52px;
      --sparkline-width: 140px;
      --group-status: 0;
      --stuck-threshold: 5;
      --banner-style: detailed;
    }

    :root * {
      transition: color 0.3s ease, background-color 0.3s ease,
                  border-color 0.3s ease, padding 0.3s ease,
                  gap 0.3s ease, font-size 0.3s ease,
                  border-radius 0.3s ease, box-shadow 0.3s ease,
                  max-width 0.3s ease, width 0.3s ease,
                  height 0.3s ease, min-height 0.3s ease,
                  opacity 0.3s ease;
    }

    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
    }

    .mono {
      font-family: var(--font-mono);
    }

    /* Banner */
    .incident-banner {
      min-height: var(--banner-height);
      background: linear-gradient(135deg, rgba(239,68,68,0.12) 0%, rgba(239,68,68,0.06) 100%);
      border-bottom: 1px solid rgba(239,68,68,0.3);
      border-left: 3px solid var(--stuck);
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 0 20px;
      overflow: hidden;
      animation: slideDown 0.4s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Roster rows */
    .roster-row {
      height: var(--row-height);
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 20px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: background 0.2s ease, height 0.3s ease;
    }

    .roster-row:hover {
      background: rgba(255,255,255,0.03);
    }

    .roster-row.expanded {
      height: auto;
      min-height: var(--row-height);
    }

    .roster-row.stuck-row {
      background: rgba(239,68,68,0.04);
    }

    .roster-row.stuck-row:hover {
      background: rgba(239,68,68,0.08);
    }

    /* Sparkline container */
    .sparkline-container {
      width: var(--sparkline-width);
      min-width: var(--sparkline-width);
      max-width: var(--sparkline-width);
      flex-shrink: 0;
    }

    .sparkline-container svg {
      width: 100%;
    }

    /* Progress bar */
    .progress-bar {
      background: rgba(255,255,255,0.08);
      border-radius: 2px;
      overflow: hidden;
    }

    /* Entrance animations */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .roster-row {
      animation: fadeInUp 0.3s ease both;
    }

    .roster-row:nth-child(1) { animation-delay: 0.05s; }
    .roster-row:nth-child(2) { animation-delay: 0.10s; }
    .roster-row:nth-child(3) { animation-delay: 0.15s; }
    .roster-row:nth-child(4) { animation-delay: 0.20s; }
    .roster-row:nth-child(5) { animation-delay: 0.25s; }
    .roster-row:nth-child(6) { animation-delay: 0.30s; }
    .roster-row:nth-child(7) { animation-delay: 0.35s; }
    .roster-row:nth-child(8) { animation-delay: 0.40s; }

    .section-header {
      animation: fadeInUp 0.3s ease both;
    }

    /* Expanded content */
    .expanded-content {
      display: none;
      padding: 12px 20px 16px;
      border-top: 1px solid var(--border);
    }

    .roster-row.expanded .expanded-content {
      display: block;
    }

    .roster-row-inner {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      height: var(--row-height);
      flex-shrink: 0;
    }

    /* Banner stuck agent chips */
    .stuck-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.25);
      border-radius: 6px;
      padding: 5px 10px;
      flex-shrink: 0;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .group-header {
      padding: 8px 20px 6px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-dim);
      background: var(--bg);
      border-bottom: 1px solid var(--border);
    }

    .group-header.hidden-header { display: none; }

    .chevron {
      transition: transform 0.2s ease;
      flex-shrink: 0;
    }

    .roster-row.expanded .chevron {
      transform: rotate(90deg);
    }

    .timeline-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }
  </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

  <!-- Top bar -->
  <div class="flex items-center justify-between px-5 py-3 border-b" style="border-color: var(--border); flex-shrink: 0;">
    <div class="flex items-center gap-3">
      <span class="mono text-sm font-medium" style="color: var(--text);">Agent Operations Center</span>
      <span class="text-xs px-2 py-0.5 rounded" style="background: rgba(59,130,246,0.15); color: var(--active); font-family: var(--font-mono);">LIVE</span>
    </div>
    <div class="flex items-center gap-4 text-xs" style="color: var(--text-dim);">
      <span>Updated just now</span>
    </div>
  </div>

  <!-- Incident Banner -->
  <div id="incident-banner" class="incident-banner" style="flex-shrink: 0;">
    <!-- Alert icon + count -->
    <div class="flex items-center gap-2 flex-shrink-0">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
        <path d="M8 2L14 13H2L8 2Z" stroke="#ef4444" stroke-width="1.5" stroke-linejoin="round"/>
        <path d="M8 6V9" stroke="#ef4444" stroke-width="1.5" stroke-linecap="round"/>
        <circle cx="8" cy="11" r="0.5" fill="#ef4444" stroke="#ef4444" stroke-width="0.5"/>
      </svg>
      <span class="text-sm font-semibold" style="color: var(--stuck); font-family: var(--font-mono);">2 agents stuck</span>
    </div>

    <!-- Separator -->
    <div class="h-6 w-px flex-shrink-0" style="background: rgba(239,68,68,0.25);"></div>

    <!-- Stuck agent chips — content varies by banner-style -->
    <div id="banner-chips" class="flex items-center gap-3 flex-1 overflow-hidden">
      <!-- Populated by JS -->
    </div>

    <!-- Dismiss feel element -->
    <div class="flex items-center gap-2 flex-shrink-0 ml-auto">
      <span class="text-xs" style="color: rgba(239,68,68,0.6);">threshold: <span id="threshold-display" class="mono">5m</span></span>
    </div>
  </div>

  <!-- Fleet summary bar -->
  <div class="flex items-center gap-6 px-5 py-2 text-xs border-b" style="border-color: var(--border); flex-shrink: 0; background: rgba(26,29,39,0.5);">
    <span style="color: var(--text-dim);">Fleet</span>
    <div class="flex items-center gap-1">
      <span class="w-2 h-2 rounded-full inline-block" style="background: var(--active);"></span>
      <span style="color: var(--text);">4 active</span>
    </div>
    <div class="flex items-center gap-1">
      <span class="w-2 h-2 rounded-full inline-block" style="background: var(--stuck);"></span>
      <span style="color: var(--text);">2 stuck</span>
    </div>
    <div class="flex items-center gap-1">
      <span class="w-2 h-2 rounded-full inline-block" style="background: var(--idle);"></span>
      <span style="color: var(--text);">2 idle</span>
    </div>
  </div>

  <!-- Roster -->
  <div id="roster" class="flex-1 overflow-auto">
    <!-- Populated by JS -->
  </div>

  <script>
    // ── Data ──────────────────────────────────────────────────────────────────
    const agents = [
      {
        id: 'claude-sonnet-8',
        status: 'stuck',
        task: 'Fix pagination bug',
        project: 'web',
        progress: 20,
        claimedAgo: 30,
        silenceMin: 22,
        lastEventLabel: 'silent 22m',
        sparkline: 'stuck',
        sparkEvents: [30, 25, 22], // minutes ago, then silence
        silenceStart: 22,
        timeline: [
          { time: '30m ago', event: 'claimed task' },
          { time: '25m ago', event: 'checkpoint: Reading cursor implementation' },
          { time: '22m ago', event: 'checkpoint: Investigating offset calculation' },
          { time: 'now', event: '— silent —', dim: true },
        ]
      },
      {
        id: 'claude-opus-7',
        status: 'stuck',
        task: 'Implement auth middleware',
        project: 'api-v2',
        progress: 35,
        claimedAgo: 18,
        silenceMin: 12,
        lastEventLabel: 'silent 12m',
        sparkline: 'stuck',
        sparkEvents: [25, 20, 18, 15, 12],
        silenceStart: 12,
        timeline: [
          { time: '25m ago', event: 'checkpoint: Generated folder structure' },
          { time: '20m ago', event: 'completed: Set up project scaffolding' },
          { time: '18m ago', event: 'claimed task' },
          { time: '15m ago', event: 'checkpoint: Reading existing auth code' },
          { time: '12m ago', event: 'checkpoint: Analyzing JWT library options' },
          { time: 'now', event: '— silent —', dim: true },
        ]
      },
      {
        id: 'gemini-pro-1',
        status: 'active',
        task: 'Refactor database queries',
        project: 'core',
        progress: 75,
        claimedAgo: 15,
        silenceMin: null,
        lastEventLabel: '30s ago',
        sparkline: 'active-dense',
        sparkEvents: [15, 10, 7, 4, 2, 0.5],
        timeline: []
      },
      {
        id: 'claude-sonnet-3',
        status: 'active',
        task: 'Add search API endpoint',
        project: 'api-v2',
        progress: 60,
        claimedAgo: 8,
        silenceMin: null,
        lastEventLabel: '1m ago',
        sparkline: 'active-regular',
        sparkEvents: [12, 10, 8, 5, 3, 1],
        timeline: [
          { time: '10m ago', event: 'completed: Design search schema' },
          { time: '8m ago', event: 'claimed task' },
          { time: '5m ago', event: 'checkpoint: Designing search schema' },
          { time: '3m ago', event: 'checkpoint: Added search route handler' },
          { time: '1m ago', event: 'checkpoint: Implementing full-text search' },
        ]
      },
      {
        id: 'claude-haiku-2',
        status: 'active',
        task: 'Write unit tests for TaskService',
        project: 'core',
        progress: 40,
        claimedAgo: 12,
        silenceMin: null,
        lastEventLabel: '3m ago',
        sparkline: 'active-regular',
        sparkEvents: [12, 9, 6, 3],
        timeline: []
      },
      {
        id: 'gpt-4o-agent',
        status: 'active',
        task: 'Update API documentation',
        project: 'docs',
        progress: 25,
        claimedAgo: 5,
        silenceMin: null,
        lastEventLabel: '2m ago',
        sparkline: 'active-recent',
        sparkEvents: [5, 4, 2],
        timeline: []
      },
      {
        id: 'claude-opus-5',
        status: 'idle',
        task: 'Set up CI pipeline',
        project: 'infra',
        progress: 100,
        claimedAgo: null,
        silenceMin: null,
        lastEventLabel: 'done 8m ago',
        sparkline: 'idle',
        sparkEvents: [15, 12, 8],
        timeline: []
      },
      {
        id: 'claude-haiku-9',
        status: 'idle',
        task: 'Add input validation',
        project: 'api-v2',
        progress: 100,
        claimedAgo: null,
        silenceMin: null,
        lastEventLabel: 'done 3m ago',
        sparkline: 'idle',
        sparkEvents: [8, 5, 3],
        timeline: []
      }
    ];

    // ── Sparkline SVG generators ──────────────────────────────────────────────
    function makeSparklineSVG(agent, widthRef) {
      const W = 140; // internal reference; CSS scales via container
      const H = 28;
      const maxTime = 30; // minutes window
      const barH = 10;
      const barY = (H - barH) / 2;

      function tx(minAgo) {
        return W - (minAgo / maxTime) * W;
      }

      let svgParts = [];

      // Session block
      const oldest = Math.min(...agent.sparkEvents);
      const sessionStart = tx(oldest);
      const sessionEnd = agent.status === 'stuck'
        ? tx(agent.silenceStart)
        : (agent.status === 'idle' ? tx(Math.min(...agent.sparkEvents)) : W);

      // Session bar
      const sessionBarEnd = agent.status === 'stuck' ? tx(agent.silenceStart) : W;
      svgParts.push(
        `<rect x="${sessionStart}" y="${barY}" width="${Math.max(0, sessionBarEnd - sessionStart)}" height="${barH}" rx="2" fill="${agent.status === 'stuck' ? 'rgba(59,130,246,0.25)' : agent.status === 'idle' ? 'rgba(107,114,128,0.2)' : 'rgba(59,130,246,0.2)'}" />`
      );

      // Silence gap for stuck
      if (agent.status === 'stuck') {
        const silX = tx(agent.silenceStart);
        svgParts.push(
          `<rect x="${silX}" y="${barY}" width="${W - silX}" height="${barH}" rx="2" fill="rgba(239,68,68,0.2)" />`
        );
        // Pulsing dot at end
        svgParts.push(
          `<circle cx="${W - 4}" cy="${H / 2}" r="3" fill="rgba(239,68,68,0.6)"><animate attributeName="opacity" values="0.6;1;0.6" dur="2s" repeatCount="indefinite"/></circle>`
        );
      }

      // Event ticks
      agent.sparkEvents.forEach(minAgo => {
        const x = tx(minAgo);
        const color = agent.status === 'stuck' && minAgo <= agent.silenceStart
          ? 'rgba(239,68,68,0.9)'
          : agent.status === 'stuck'
          ? '#3b82f6'
          : agent.status === 'idle'
          ? '#6b7280'
          : '#3b82f6';
        svgParts.push(
          `<line x1="${x}" y1="${barY - 2}" x2="${x}" y2="${barY + barH + 2}" stroke="${color}" stroke-width="1.5" stroke-linecap="round" />`
        );
      });

      return `<svg viewBox="0 0 ${W} ${H}" height="${H}" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none">${svgParts.join('')}</svg>`;
    }

    // ── Status helpers ────────────────────────────────────────────────────────
    function statusColor(s) {
      return s === 'stuck' ? 'var(--stuck)' : s === 'active' ? 'var(--active)' : 'var(--idle)';
    }

    function statusLabel(s) {
      return s.toUpperCase();
    }

    function projectBadge(p) {
      const colors = {
        web: 'rgba(139,92,246,0.2)',
        'api-v2': 'rgba(59,130,246,0.2)',
        core: 'rgba(34,197,94,0.2)',
        docs: 'rgba(245,158,11,0.2)',
        infra: 'rgba(107,114,128,0.2)',
      };
      const textColors = {
        web: '#a78bfa',
        'api-v2': '#60a5fa',
        core: '#4ade80',
        docs: '#fbbf24',
        infra: '#9ca3af',
      };
      return `<span class="mono text-xs px-1.5 py-0.5 rounded" style="background:${colors[p]||'rgba(255,255,255,0.1)'};color:${textColors[p]||'#e2e4e9'}">${p}</span>`;
    }

    // ── Render banner chips ───────────────────────────────────────────────────
    function renderBannerChips(style) {
      const stuck = agents.filter(a => a.status === 'stuck');
      const container = document.getElementById('banner-chips');
      if (!container) return;

      if (style === 'minimal') {
        container.innerHTML = stuck.map(a =>
          `<div class="stuck-chip">
            <span class="mono text-xs font-medium" style="color:var(--stuck)">${a.id}</span>
          </div>`
        ).join('');
      } else if (style === 'detailed') {
        container.innerHTML = stuck.map(a =>
          `<div class="stuck-chip">
            <span class="mono text-xs font-semibold" style="color:var(--stuck)">${a.id}</span>
            <span class="text-xs" style="color:rgba(239,68,68,0.7);">·</span>
            <span class="text-xs" style="color:rgba(239,68,68,0.85)">silent ${a.silenceMin}m</span>
            <span class="text-xs" style="color:rgba(239,68,68,0.5);">·</span>
            <span class="text-xs truncate" style="color:rgba(226,228,233,0.7);max-width:160px;">"${a.task}"</span>
          </div>`
        ).join('');
      } else if (style === 'expanded') {
        container.innerHTML = stuck.map(a =>
          `<div class="stuck-chip flex-col items-start gap-1" style="padding:8px 12px;">
            <div class="flex items-center gap-2">
              <span class="mono text-xs font-semibold" style="color:var(--stuck)">${a.id}</span>
              <span class="text-xs" style="color:rgba(239,68,68,0.8)">silent ${a.silenceMin}m</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs" style="color:rgba(226,228,233,0.65)">"${a.task}"</span>
            </div>
            <div class="sparkline-container" style="width:100px;min-width:100px;max-width:100px;">
              ${makeSparklineSVG(a)}
            </div>
          </div>`
        ).join('');
      }
    }

    // ── Render roster rows ────────────────────────────────────────────────────
    function renderRoster(groupByStatus) {
      const roster = document.getElementById('roster');
      roster.innerHTML = '';

      let orderedAgents;
      if (groupByStatus) {
        const stuck = agents.filter(a => a.status === 'stuck');
        const active = agents.filter(a => a.status === 'active');
        const idle = agents.filter(a => a.status === 'idle');

        const makeSection = (label, list, color) => {
          if (list.length === 0) return '';
          const header = document.createElement('div');
          header.className = 'group-header section-header';
          header.style.color = color;
          header.textContent = `${label} · ${list.length}`;
          roster.appendChild(header);
          list.forEach(a => renderAgentRow(a, roster));
        };

        makeSection('Stuck', stuck, 'var(--stuck)');
        makeSection('Active', active, 'var(--active)');
        makeSection('Idle', idle, 'var(--idle)');
        return;
      } else {
        orderedAgents = [
          ...agents.filter(a => a.status === 'stuck'),
          ...agents.filter(a => a.status === 'active'),
          ...agents.filter(a => a.status === 'idle'),
        ];
        orderedAgents.forEach(a => renderAgentRow(a, roster));
      }
    }

    function renderAgentRow(agent, container) {
      const row = document.createElement('div');
      row.className = `roster-row${agent.status === 'stuck' ? ' stuck-row' : ''}`;
      row.setAttribute('data-agent-id', agent.id);

      const isExpanded = agent.id === 'claude-sonnet-8';
      if (isExpanded) row.classList.add('expanded');

      const progressColor = agent.status === 'stuck' ? 'var(--stuck)' : agent.status === 'active' ? 'var(--active)' : 'var(--idle)';
      const silenceEl = agent.status === 'stuck'
        ? `<span class="mono text-xs font-medium" style="color:var(--stuck);min-width:60px;text-align:right">silent ${agent.silenceMin}m</span>`
        : agent.status === 'idle'
        ? `<span class="mono text-xs" style="color:var(--idle);min-width:60px;text-align:right">${agent.lastEventLabel}</span>`
        : `<span class="mono text-xs" style="color:var(--text-dim);min-width:60px;text-align:right">${agent.lastEventLabel}</span>`;

      const timelineHTML = agent.timeline && agent.timeline.length > 0
        ? `<div class="mt-3 space-y-1.5">
            <div class="text-xs font-semibold mb-2" style="color:var(--text-dim);letter-spacing:0.06em;text-transform:uppercase;">Session Timeline</div>
            ${agent.timeline.map(t => `
              <div class="flex items-start gap-2.5">
                <span class="mono text-xs flex-shrink-0 mt-0.5" style="color:var(--text-dim);min-width:52px;">${t.time}</span>
                <div class="timeline-dot mt-1" style="background:${t.dim ? 'rgba(239,68,68,0.4)' : 'rgba(59,130,246,0.6)'}"></div>
                <span class="text-xs ${t.dim ? 'italic' : ''}" style="color:${t.dim ? 'rgba(239,68,68,0.6)' : 'var(--text-dim)'}">${t.event}</span>
              </div>
            `).join('')}
          </div>`
        : '';

      const expandedMetrics = `
        <div class="flex gap-6 mt-1 mb-1">
          <div>
            <div class="text-xs" style="color:var(--text-dim)">Progress</div>
            <div class="mono text-sm font-semibold mt-0.5" style="color:var(--text)">${agent.progress}%</div>
          </div>
          ${agent.claimedAgo ? `<div>
            <div class="text-xs" style="color:var(--text-dim)">Claimed</div>
            <div class="mono text-sm font-semibold mt-0.5" style="color:var(--text)">${agent.claimedAgo}m ago</div>
          </div>` : ''}
          <div>
            <div class="text-xs" style="color:var(--text-dim)">Project</div>
            <div class="text-sm font-medium mt-0.5 mono" style="color:var(--text)">${agent.project}</div>
          </div>
          ${agent.status === 'stuck' ? `<div>
            <div class="text-xs" style="color:var(--stuck)">Silence</div>
            <div class="mono text-sm font-semibold mt-0.5" style="color:var(--stuck)">${agent.silenceMin}m</div>
          </div>` : ''}
        </div>
      `;

      row.innerHTML = `
        <div class="roster-row-inner w-full">
          <!-- Chevron -->
          <svg class="chevron" width="12" height="12" viewBox="0 0 12 12" fill="none" style="color:var(--text-dim)">
            <path d="M4 2L8 6L4 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>

          <!-- Status dot -->
          <div class="w-2 h-2 rounded-full flex-shrink-0" style="background:${statusColor(agent.status)};${agent.status === 'stuck' ? 'box-shadow:0 0 6px rgba(239,68,68,0.6)' : agent.status === 'active' ? 'box-shadow:0 0 4px rgba(59,130,246,0.4)' : ''}"></div>

          <!-- Agent name -->
          <span class="mono text-xs font-medium flex-shrink-0" style="color:var(--text);min-width:128px;">${agent.id}</span>

          <!-- Task title -->
          <span class="text-xs flex-1 truncate" style="color:var(--text-dim)">"${agent.task}"</span>

          <!-- Project badge -->
          <div class="flex-shrink-0">${projectBadge(agent.project)}</div>

          <!-- Progress bar -->
          <div class="progress-bar flex-shrink-0" style="width:60px;height:4px;">
            <div style="width:${agent.progress}%;height:100%;background:${progressColor};border-radius:2px;"></div>
          </div>

          <!-- Silence / last event -->
          ${silenceEl}

          <!-- Sparkline -->
          <div class="sparkline-container">
            ${makeSparklineSVG(agent)}
          </div>
        </div>

        <!-- Expanded content -->
        <div class="expanded-content w-full">
          ${expandedMetrics}
          ${timelineHTML}
        </div>
      `;

      row.addEventListener('click', () => {
        row.classList.toggle('expanded');
      });

      container.appendChild(row);
    }

    // ── Control event handling ────────────────────────────────────────────────
    let currentBannerStyle = 'detailed';
    let currentGroupStatus = false;
    let currentThreshold = 5;

    function applyStuckThreshold(threshold) {
      currentThreshold = parseInt(threshold, 10);
      document.getElementById('threshold-display').textContent = threshold + 'm';

      // Recompute which agents are "stuck" visually based on threshold
      // In this demo, agents with silenceMin >= threshold are stuck
      agents.forEach(a => {
        const wasStuck = a.status === 'stuck';
        // We'll just update visual state on roster rows
        const row = document.querySelector(`[data-agent-id="${a.id}"]`);
        if (row) {
          if (a.silenceMin && a.silenceMin >= currentThreshold) {
            row.classList.add('stuck-row');
          } else if (a.status !== 'stuck') {
            row.classList.remove('stuck-row');
          }
        }
      });

      // Update banner stuck count
      const stuckCount = agents.filter(a => a.silenceMin && a.silenceMin >= currentThreshold).length;
      const bannerEl = document.getElementById('incident-banner');
      if (stuckCount === 0) {
        bannerEl.style.display = 'none';
      } else {
        bannerEl.style.display = 'flex';
        bannerEl.querySelector('.mono').textContent = stuckCount + ' agent' + (stuckCount > 1 ? 's' : '') + ' stuck';
      }
    }

    document.addEventListener('control-change', (e) => {
      const { id, value } = e.detail;
      if (id === 'banner-style') {
        currentBannerStyle = value;
        renderBannerChips(value);
      } else if (id === 'group-status') {
        currentGroupStatus = value === '1';
        renderRoster(currentGroupStatus);
      } else if (id === 'stuck-threshold') {
        applyStuckThreshold(value);
      }
    });

    document.addEventListener('controls-ready', () => {
      const style = getComputedStyle(document.documentElement).getPropertyValue('--banner-style').trim();
      if (style) {
        currentBannerStyle = style;
        renderBannerChips(style);
      }
      const group = getComputedStyle(document.documentElement).getPropertyValue('--group-status').trim();
      currentGroupStatus = group === '1';
      renderRoster(currentGroupStatus);

      const thresh = getComputedStyle(document.documentElement).getPropertyValue('--stuck-threshold').trim();
      if (thresh) applyStuckThreshold(thresh);
    });

    // ── Initial render ────────────────────────────────────────────────────────
    renderBannerChips('detailed');
    renderRoster(false);
  </script>
</body>
</html>

  </template>
  <template id="tpl-d3" data-body-class="flex flex-col">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script type="application/json" id="variation-meta">
  {
    "id": "D3",
    "family": "D",
    "familyName": "Triage Strips",
    "name": "Sortable Table",
    "layoutType": "Sortable Table + Inline Expansion",
    "aesthetic": "Professional Dark",
    "description": "Full-featured data table with sortable columns, inline sparklines, and keyboard navigation. Maximum information density for power users.",
    "controls": [
      {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["5 min", "10 min", "15 min", "30 min"],
        "cssValues": { "5 min": "5", "10 min": "10", "15 min": "15", "30 min": "30" },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
      },
      {
        "id": "columns",
        "label": "Columns",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["essential", "standard", "full"],
        "cssValues": { "essential": "essential", "standard": "standard", "full": "full" },
        "value": "standard",
        "defaultValue": "standard",
        "unit": "",
        "cssVar": "--columns",
        "event": true
      },
      {
        "id": "sort-col",
        "label": "Sort Column",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["status", "agent", "silence", "progress", "activity"],
        "cssValues": { "status": "status", "agent": "agent", "silence": "silence", "progress": "progress", "activity": "activity" },
        "value": "status",
        "defaultValue": "status",
        "unit": "",
        "cssVar": "--sort-col",
        "event": true
      },
      {
        "id": "row-height",
        "label": "Row Height",
        "type": "range",
        "min": 40, "max": 64, "step": 4,
        "options": null,
        "value": 48,
        "defaultValue": 48,
        "unit": "px",
        "cssVar": "--row-height"
      },
      {
        "id": "sparkline-width",
        "label": "Sparkline Width",
        "type": "range",
        "min": 80, "max": 200, "step": 20,
        "options": null,
        "value": 140,
        "defaultValue": 140,
        "unit": "px",
        "cssVar": "--sparkline-width"
      },
      {
        "id": "expand-style",
        "label": "Expand Style",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["inline panel", "slide drawer", "overlay card"],
        "cssValues": { "inline panel": "inline", "slide drawer": "drawer", "overlay card": "overlay" },
        "value": "inline panel",
        "defaultValue": "inline panel",
        "unit": "",
        "cssVar": "--expand-style",
        "event": true
      }
    ]
  }
  </script>
  <style>
    :root {
      --bg: #0f1117;
      --panel: #1a1d27;
      --border: #2a2d3a;
      --text: #e2e4e9;
      --text-dim: #8b8fa3;
      --stuck: #ef4444;
      --active: #3b82f6;
      --idle: #6b7280;
      --healthy: #22c55e;
      --font-sans: 'Inter', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --row-height: 48px;
      --sparkline-width: 140px;
      --stuck-threshold: 5;
      --columns: standard;
      --sort-col: status;
      --expand-style: inline;
    }

    :root * {
      transition: color 0.3s ease, background-color 0.3s ease,
                  border-color 0.3s ease, padding 0.3s ease,
                  gap 0.3s ease, font-size 0.3s ease,
                  border-radius 0.3s ease, box-shadow 0.3s ease,
                  max-width 0.3s ease, width 0.3s ease,
                  height 0.25s ease, opacity 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-sans);
      font-size: 13px;
      line-height: 1.4;
    }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #3a3d4a; }

    /* Fleet summary bar */
    .fleet-bar {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .fleet-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-dim);
    }

    .fleet-stat {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 500;
    }

    .fleet-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
    }

    .fleet-sep {
      color: var(--border);
      font-size: 16px;
    }

    /* Table area */
    .table-container {
      overflow-x: auto;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    thead th {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 0 12px;
      height: 36px;
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-dim);
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    thead th:hover {
      color: var(--text);
      background: color-mix(in srgb, var(--panel) 80%, var(--active) 20%);
    }

    thead th.sort-active {
      color: var(--active);
    }

    .sort-arrow {
      display: inline-block;
      margin-left: 4px;
      font-size: 10px;
    }

    /* Data rows */
    tbody tr.data-row {
      border-bottom: 1px solid color-mix(in srgb, var(--border) 60%, transparent);
      cursor: pointer;
      height: var(--row-height);
    }

    tbody tr.data-row:hover {
      background: color-mix(in srgb, var(--panel) 60%, transparent);
    }

    tbody tr.data-row.focused {
      background: color-mix(in srgb, var(--active) 8%, var(--panel) 60%);
      outline: none;
    }

    tbody tr.data-row.focused td:first-child {
      border-left: 2px solid var(--active);
    }

    tbody tr.data-row.expanded {
      background: color-mix(in srgb, var(--active) 5%, var(--panel) 50%);
    }

    tbody td {
      padding: 0 12px;
      vertical-align: middle;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Column widths */
    col.col-status  { width: 110px; }
    col.col-agent   { width: 160px; }
    col.col-task    { width: 220px; }
    col.col-project { width: 90px; }
    col.col-progress{ width: 120px; }
    col.col-silence { width: 90px; }
    col.col-activity{ width: var(--sparkline-width); }
    col.col-elapsed { width: 80px; }

    /* Status cell */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .status-stuck  .status-dot { background: var(--stuck); box-shadow: 0 0 5px color-mix(in srgb, var(--stuck) 60%, transparent); }
    .status-active .status-dot { background: var(--active); box-shadow: 0 0 5px color-mix(in srgb, var(--active) 50%, transparent); }
    .status-idle   .status-dot { background: var(--idle); }

    .status-stuck  { color: var(--stuck); }
    .status-active { color: var(--active); }
    .status-idle   { color: var(--idle); }

    /* Agent name */
    .agent-name {
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 500;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Task title */
    .task-title {
      font-size: 12px;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .task-dash {
      color: var(--text-dim);
    }

    /* Project badge */
    .project-badge {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      background: color-mix(in srgb, var(--active) 15%, transparent);
      color: color-mix(in srgb, var(--active) 80%, var(--text));
      border: 1px solid color-mix(in srgb, var(--active) 25%, transparent);
    }

    /* Progress bar */
    .progress-wrap {
      display: flex;
      align-items: center;
      gap: 7px;
    }

    .progress-track {
      flex: 1;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.4s ease;
    }

    .progress-pct {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-dim);
      width: 28px;
      text-align: right;
      flex-shrink: 0;
    }

    /* Silence timer */
    .silence-val {
      font-family: var(--font-mono);
      font-size: 11px;
    }

    .silence-stuck  { color: var(--stuck); }
    .silence-idle   { color: var(--idle); }
    .silence-recent { color: var(--healthy); }

    /* Sparkline */
    .sparkline-cell {
      width: var(--sparkline-width);
    }

    .sparkline-svg {
      width: var(--sparkline-width);
      height: 28px;
      display: block;
    }

    /* Expanded detail row */
    tr.detail-row td {
      padding: 0;
      background: color-mix(in srgb, var(--panel) 90%, var(--active) 10%);
      border-bottom: 1px solid var(--border);
      border-left: 2px solid var(--active);
    }

    tr.detail-row.hidden {
      display: none;
    }

    .detail-panel {
      padding: 16px 20px;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 16px;
    }

    .detail-metrics {
      display: contents;
    }

    .detail-metric-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 14px;
    }

    .detail-metric-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-dim);
      margin-bottom: 4px;
    }

    .detail-metric-value {
      font-family: var(--font-mono);
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
    }

    .detail-metric-value.val-stuck {
      color: var(--stuck);
    }

    .detail-timeline {
      grid-column: 1 / -1;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 14px;
    }

    .detail-timeline-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-dim);
      margin-bottom: 10px;
    }

    .timeline-events {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .timeline-event {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .timeline-time {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-dim);
      width: 52px;
      flex-shrink: 0;
      padding-top: 1px;
    }

    .timeline-dot-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0;
      flex-shrink: 0;
    }

    .timeline-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--active);
      flex-shrink: 0;
      margin-top: 3px;
    }

    .timeline-line {
      width: 1px;
      height: 16px;
      background: var(--border);
    }

    .timeline-desc {
      font-size: 12px;
      color: var(--text);
    }

    .timeline-type {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-dim);
      letter-spacing: 0.04em;
    }

    /* Column visibility driven by columns control */
    .col-project-cell,
    th.col-project-cell {
      display: table-cell;
    }

    .col-elapsed-cell,
    th.col-elapsed-cell {
      display: none;
    }

    /* Keyboard hint */
    .kbd-hint {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-dim);
      padding: 2px 5px;
      border: 1px solid var(--border);
      border-radius: 3px;
      background: var(--panel);
    }

    /* Drawer expand style */
    .drawer-overlay {
      display: none;
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: 380px;
      background: var(--panel);
      border-left: 1px solid var(--border);
      z-index: 100;
      overflow-y: auto;
      animation: slideIn 0.25s ease;
    }

    .drawer-overlay.active {
      display: block;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to   { transform: translateX(0); opacity: 1; }
    }

    /* Overlay card expand style */
    .overlay-card {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 560px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      z-index: 100;
      box-shadow: 0 24px 60px rgba(0,0,0,0.6);
      overflow: hidden;
      animation: popIn 0.2s ease;
    }

    .overlay-card.active {
      display: block;
    }

    @keyframes popIn {
      from { transform: translate(-50%, -48%); opacity: 0; }
      to   { transform: translate(-50%, -50%); opacity: 1; }
    }

    .overlay-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 99;
    }

    .overlay-backdrop.active {
      display: block;
    }

    /* Row entrance animation */
    @keyframes rowFadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    tbody tr.data-row {
      animation: rowFadeIn 0.3s ease both;
    }

    tbody tr.data-row:nth-child(1)  { animation-delay: 0.03s; }
    tbody tr.data-row:nth-child(2)  { animation-delay: 0.06s; }
    tbody tr.data-row:nth-child(3)  { animation-delay: 0.09s; }
    tbody tr.data-row:nth-child(4)  { animation-delay: 0.12s; }
    tbody tr.data-row:nth-child(5)  { animation-delay: 0.15s; }
    tbody tr.data-row:nth-child(6)  { animation-delay: 0.18s; }
    tbody tr.data-row:nth-child(7)  { animation-delay: 0.21s; }
    tbody tr.data-row:nth-child(8)  { animation-delay: 0.24s; }
  </style>
</head>
<body class="flex flex-col" style="height: 100vh; overflow: hidden;">

  <!-- Fleet summary bar -->
  <div class="fleet-bar flex-shrink-0">
    <span class="fleet-label">Fleet</span>
    <div class="fleet-stat">
      <div class="fleet-dot" style="background: var(--active);"></div>
      <span style="color: var(--active); font-weight: 600;">4</span>
      <span style="color: var(--text-dim);">active</span>
    </div>
    <span class="fleet-sep">·</span>
    <div class="fleet-stat">
      <div class="fleet-dot" style="background: var(--stuck);"></div>
      <span style="color: var(--stuck); font-weight: 600;">2</span>
      <span style="color: var(--text-dim);">stuck</span>
    </div>
    <span class="fleet-sep">·</span>
    <div class="fleet-stat">
      <div class="fleet-dot" style="background: var(--idle);"></div>
      <span style="color: var(--idle); font-weight: 600;">2</span>
      <span style="color: var(--text-dim);">idle</span>
    </div>
    <div style="flex: 1;"></div>
    <div style="display: flex; gap: 8px; align-items: center; color: var(--text-dim); font-size: 11px;">
      <span class="kbd-hint">↑↓</span><span>navigate</span>
      <span class="kbd-hint">Enter</span><span>expand</span>
      <span class="kbd-hint">Esc</span><span>collapse</span>
    </div>
  </div>

  <!-- Table -->
  <div class="table-container" style="flex: 1; overflow-y: auto; overflow-x: auto;" id="table-container">
    <table id="agent-table">
      <colgroup>
        <col class="col-status">
        <col class="col-agent">
        <col class="col-task">
        <col class="col-project col-project-cell" id="col-project">
        <col class="col-progress" id="col-progress-col">
        <col class="col-silence" id="col-silence-col">
        <col class="col-activity">
        <col class="col-elapsed col-elapsed-cell" id="col-elapsed">
      </colgroup>
      <thead>
        <tr>
          <th data-col="status" class="sort-active">
            Status <span class="sort-arrow">▼</span>
          </th>
          <th data-col="agent">Agent</th>
          <th data-col="task" style="cursor: default;">Task</th>
          <th data-col="project" class="col-project-cell" id="th-project">Project</th>
          <th data-col="progress" id="th-progress">Progress</th>
          <th data-col="silence" id="th-silence">Silence</th>
          <th data-col="activity">Activity</th>
          <th data-col="elapsed" class="col-elapsed-cell" id="th-elapsed">Elapsed</th>
        </tr>
      </thead>
      <tbody id="table-body">
        <!-- Rows rendered by JS -->
      </tbody>
    </table>
  </div>

  <!-- Drawer (slide drawer expand style) -->
  <div class="drawer-overlay" id="drawer-panel">
    <div style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between;">
      <span style="font-weight: 600; font-size: 14px; color: var(--text);" id="drawer-title">Agent Detail</span>
      <button onclick="closeAllExpanded()" style="background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 18px; line-height: 1;">&times;</button>
    </div>
    <div id="drawer-content" style="padding: 16px;"></div>
  </div>

  <!-- Overlay card (overlay expand style) -->
  <div class="overlay-backdrop" id="overlay-backdrop" onclick="closeAllExpanded()"></div>
  <div class="overlay-card" id="overlay-card">
    <div style="padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between;">
      <span style="font-weight: 600; font-size: 14px; color: var(--text);" id="overlay-title">Agent Detail</span>
      <button onclick="closeAllExpanded()" style="background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 18px; line-height: 1;">&times;</button>
    </div>
    <div id="overlay-content" style="padding: 0;"></div>
  </div>

  <script>
    // ─── Data ───────────────────────────────────────────────────────────────
    const AGENTS = [
      {
        id: 'claude-sonnet-8',
        status: 'stuck',
        agent: 'claude-sonnet-8',
        task: 'Fix pagination bug',
        project: 'web',
        progress: 20,
        silenceMin: 22,
        silenceLabel: '22m',
        activityEvents: [30, 25, 22], // minutes ago
        hasGap: true,
        sessionEnded: false,
        elapsed: '30m',
        eventCount: 3,
        detail: {
          events: [
            { time: '22m ago', type: 'checkpoint', desc: 'Investigating offset calculation — Fix pagination bug' },
            { time: '25m ago', type: 'checkpoint', desc: 'Reading cursor implementation — Fix pagination bug' },
            { time: '30m ago', type: 'claimed',    desc: 'Fix pagination bug' },
          ],
          context: 'Fix pagination bug in project "web", progress 20%, claimed 30m ago'
        }
      },
      {
        id: 'claude-opus-7',
        status: 'stuck',
        agent: 'claude-opus-7',
        task: 'Implement auth middleware',
        project: 'api-v2',
        progress: 35,
        silenceMin: 12,
        silenceLabel: '12m',
        activityEvents: [25, 20, 18, 15, 12],
        hasGap: true,
        sessionEnded: false,
        elapsed: '25m',
        eventCount: 5,
        detail: {
          events: [
            { time: '12m ago', type: 'checkpoint', desc: 'Implementing token validation — Implement auth middleware' },
            { time: '15m ago', type: 'checkpoint', desc: 'Reviewing JWT library — Implement auth middleware' },
            { time: '18m ago', type: 'checkpoint', desc: 'Scaffolding middleware layer — Implement auth middleware' },
            { time: '25m ago', type: 'claimed',    desc: 'Implement auth middleware' },
          ],
          context: 'Implement auth middleware in project "api-v2", progress 35%, claimed 25m ago'
        }
      },
      {
        id: 'gemini-pro-1',
        status: 'active',
        agent: 'gemini-pro-1',
        task: 'Refactor database queries',
        project: 'core',
        progress: 75,
        silenceMin: 0.5,
        silenceLabel: '30s',
        activityEvents: [15, 10, 7, 4, 2, 0.5],
        hasGap: false,
        sessionEnded: false,
        elapsed: '15m',
        eventCount: 6,
        detail: {
          events: [
            { time: '30s ago', type: 'checkpoint', desc: 'Optimizing index usage — Refactor database queries' },
            { time: '2m ago',  type: 'checkpoint', desc: 'Rewriting join queries — Refactor database queries' },
            { time: '4m ago',  type: 'checkpoint', desc: 'Analyzing slow query log — Refactor database queries' },
            { time: '7m ago',  type: 'checkpoint', desc: 'Setting up query profiling — Refactor database queries' },
          ],
          context: 'Refactor database queries in project "core", progress 75%, very recent activity'
        }
      },
      {
        id: 'claude-sonnet-3',
        status: 'active',
        agent: 'claude-sonnet-3',
        task: 'Add search API endpoint',
        project: 'api-v2',
        progress: 60,
        silenceMin: 1,
        silenceLabel: '1m',
        activityEvents: [12, 10, 8, 5, 3, 1],
        hasGap: false,
        sessionEnded: false,
        elapsed: '12m',
        eventCount: 6,
        detail: {
          events: [
            { time: '1m ago',  type: 'checkpoint', desc: 'Writing query parser — Add search API endpoint' },
            { time: '3m ago',  type: 'checkpoint', desc: 'Implementing FTS handler — Add search API endpoint' },
            { time: '5m ago',  type: 'checkpoint', desc: 'Designing response schema — Add search API endpoint' },
          ],
          context: 'Add search API endpoint in project "api-v2", progress 60%'
        }
      },
      {
        id: 'claude-haiku-2',
        status: 'active',
        agent: 'claude-haiku-2',
        task: 'Write unit tests',
        project: 'core',
        progress: 40,
        silenceMin: 3,
        silenceLabel: '3m',
        activityEvents: [12, 9, 6, 3],
        hasGap: false,
        sessionEnded: false,
        elapsed: '12m',
        eventCount: 4,
        detail: {
          events: [
            { time: '3m ago',  type: 'checkpoint', desc: 'Writing edge case tests — Write unit tests' },
            { time: '6m ago',  type: 'checkpoint', desc: 'Setting up test fixtures — Write unit tests' },
            { time: '9m ago',  type: 'checkpoint', desc: 'Scaffolding test suite — Write unit tests' },
          ],
          context: 'Write unit tests in project "core", progress 40%'
        }
      },
      {
        id: 'gpt-4o-agent',
        status: 'active',
        agent: 'gpt-4o-agent',
        task: 'Update API docs',
        project: 'docs',
        progress: 25,
        silenceMin: 2,
        silenceLabel: '2m',
        activityEvents: [5, 4, 2],
        hasGap: false,
        sessionEnded: false,
        elapsed: '5m',
        eventCount: 3,
        detail: {
          events: [
            { time: '2m ago', type: 'checkpoint', desc: 'Updating endpoint descriptions — Update API docs' },
            { time: '4m ago', type: 'checkpoint', desc: 'Adding request examples — Update API docs' },
            { time: '5m ago', type: 'claimed',    desc: 'Update API docs' },
          ],
          context: 'Update API docs in project "docs", progress 25%'
        }
      },
      {
        id: 'claude-opus-5',
        status: 'idle',
        agent: 'claude-opus-5',
        task: '—',
        project: 'infra',
        progress: null,
        silenceMin: 8,
        silenceLabel: '8m idle',
        activityEvents: [15, 12, 8],
        hasGap: false,
        sessionEnded: true,
        elapsed: '15m',
        eventCount: 3,
        detail: {
          events: [
            { time: '8m ago',  type: 'completed', desc: 'Session ended' },
            { time: '12m ago', type: 'checkpoint', desc: 'Final cleanup — last task' },
            { time: '15m ago', type: 'claimed',    desc: 'Previous task completed' },
          ],
          context: 'Idle in project "infra", session ended 8m ago'
        }
      },
      {
        id: 'claude-haiku-9',
        status: 'idle',
        agent: 'claude-haiku-9',
        task: '—',
        project: 'api-v2',
        progress: null,
        silenceMin: 3,
        silenceLabel: '3m idle',
        activityEvents: [8, 5, 3],
        hasGap: false,
        sessionEnded: true,
        elapsed: '8m',
        eventCount: 3,
        detail: {
          events: [
            { time: '3m ago', type: 'completed', desc: 'Session ended' },
            { time: '5m ago', type: 'checkpoint', desc: 'Finalizing output — last task' },
            { time: '8m ago', type: 'claimed',    desc: 'Previous task completed' },
          ],
          context: 'Idle in project "api-v2", session ended 3m ago'
        }
      }
    ];

    // ─── State ───────────────────────────────────────────────────────────────
    let currentSort = 'status';
    let sortDir = 'desc'; // desc = stuck-first for status
    let focusedIndex = 0;
    let expandedId = 'claude-sonnet-8'; // expanded by default
    let expandStyle = 'inline';
    let columnsMode = 'standard';
    let stuckThreshold = 5;
    let sortedAgents = [];

    // ─── Sparkline SVG ───────────────────────────────────────────────────────
    function buildSparkline(agent) {
      const W = 140; // will be overridden by CSS var but layout needs a number
      const H = 28;
      const maxMin = Math.max(...agent.activityEvents, 1);
      const svgNs = 'http://www.w3.org/2000/svg';

      // Map minutes-ago to x positions (recent = right)
      const toX = (minAgo) => {
        return W - (minAgo / (maxMin * 1.1)) * (W - 4) - 2;
      };

      let paths = '';
      let rects = '';
      let dots = '';

      // Session background shading
      if (agent.sessionEnded) {
        // Fade from left (old) to where session ended
        const endX = toX(agent.activityEvents[agent.activityEvents.length - 1]);
        rects += `<rect x="2" y="4" width="${endX}" height="${H - 8}" fill="rgba(107,114,128,0.08)" rx="2"/>`;
      } else if (!agent.hasGap) {
        // Active session — subtle blue shade
        const startX = toX(agent.activityEvents[0]);
        rects += `<rect x="${startX}" y="4" width="${W - startX - 2}" height="${H - 8}" fill="rgba(59,130,246,0.07)" rx="2"/>`;
      }

      // Gap region for stuck agents
      if (agent.hasGap) {
        const gapStart = toX(agent.activityEvents[agent.activityEvents.length - 1]);
        rects += `<rect x="${gapStart}" y="4" width="${W - gapStart - 2}" height="${H - 8}" fill="rgba(239,68,68,0.1)" rx="2"/>`;
      }

      // Connect events with a baseline line
      if (agent.activityEvents.length > 1) {
        const sorted = [...agent.activityEvents].sort((a, b) => b - a);
        const pts = sorted.map(m => `${toX(m)},${H / 2}`).join(' ');
        const color = agent.status === 'stuck' ? 'rgba(239,68,68,0.3)'
                    : agent.status === 'idle'  ? 'rgba(107,114,128,0.3)'
                    : 'rgba(59,130,246,0.3)';
        paths += `<polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1"/>`;
      }

      // Draw tick marks for each event
      const dotColor = agent.status === 'stuck' ? '#ef4444'
                     : agent.status === 'idle'  ? '#6b7280'
                     : '#3b82f6';

      const sorted = [...agent.activityEvents].sort((a, b) => b - a);
      sorted.forEach((minAgo, i) => {
        const x = toX(minAgo);
        const isLast = i === sorted.length - 1;
        const opacity = isLast && agent.sessionEnded ? 0.4 : 1;
        dots += `<line x1="${x}" y1="${H/2 - 5}" x2="${x}" y2="${H/2 + 5}" stroke="${dotColor}" stroke-width="1.5" opacity="${opacity}"/>`;
        if (i === 0 && !agent.sessionEnded) {
          // Brightest dot for most recent
          dots += `<circle cx="${x}" cy="${H/2}" r="2.5" fill="${dotColor}" opacity="0.9"/>`;
        }
      });

      // Gap indicator arrow for stuck
      if (agent.hasGap) {
        const gapX = toX(agent.activityEvents[agent.activityEvents.length - 1]) + 6;
        dots += `<text x="${gapX}" y="${H/2 + 4}" font-size="8" fill="rgba(239,68,68,0.7)" font-family="sans-serif">→</text>`;
      }

      return `<svg viewBox="0 0 ${W} ${H}" preserveAspectRatio="none" class="sparkline-svg" style="width:var(--sparkline-width)">
        ${rects}${paths}${dots}
      </svg>`;
    }

    // ─── Sorting ──────────────────────────────────────────────────────────────
    function statusPriority(s) {
      return s === 'stuck' ? 0 : s === 'active' ? 1 : 2;
    }

    function sortAgents(col, toggleDir) {
      currentSort = col;
      if (toggleDir) {
        sortDir = sortDir === 'asc' ? 'desc' : 'asc';
      }

      sortedAgents = [...AGENTS].sort((a, b) => {
        let diff = 0;
        if (col === 'status') {
          diff = statusPriority(a.status) - statusPriority(b.status);
          if (diff === 0) diff = b.silenceMin - a.silenceMin;
        } else if (col === 'agent') {
          diff = a.agent.localeCompare(b.agent);
        } else if (col === 'silence') {
          diff = b.silenceMin - a.silenceMin;
        } else if (col === 'progress') {
          const ap = a.progress ?? -1;
          const bp = b.progress ?? -1;
          diff = bp - ap;
        } else if (col === 'activity') {
          // Sort by most recent event (smallest minAgo = most recent)
          const aRecent = Math.min(...a.activityEvents);
          const bRecent = Math.min(...b.activityEvents);
          diff = aRecent - bRecent;
        }
        if (col !== 'status') {
          diff = sortDir === 'asc' ? diff : -diff;
        }
        return diff;
      });

      renderTable();
      updateSortHeaders();
    }

    function updateSortHeaders() {
      document.querySelectorAll('thead th').forEach(th => {
        const col = th.dataset.col;
        const arrow = th.querySelector('.sort-arrow');
        th.classList.toggle('sort-active', col === currentSort);
        if (arrow) {
          if (col === currentSort) {
            arrow.textContent = sortDir === 'asc' ? '▲' : '▼';
            arrow.style.display = 'inline';
          } else {
            arrow.style.display = 'none';
          }
        }
      });
    }

    // ─── Column visibility ────────────────────────────────────────────────────
    function applyColumns(mode) {
      columnsMode = mode;
      const showProject = mode === 'standard' || mode === 'full';
      const showProgress = mode === 'standard' || mode === 'full';
      const showSilence  = mode === 'standard' || mode === 'full';
      const showElapsed  = mode === 'full';

      // Toggle visibility using display
      const toggle = (ids, visible) => {
        ids.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.style.display = visible ? '' : 'none';
        });
      };

      toggle(['col-project', 'th-project'], showProject);
      toggle(['col-progress-col', 'th-progress'], showProgress);
      toggle(['col-silence-col', 'th-silence'], showSilence);
      toggle(['col-elapsed', 'th-elapsed'], showElapsed);

      // Also toggle td cells
      document.querySelectorAll('.col-project-td').forEach(td => {
        td.style.display = showProject ? '' : 'none';
      });
      document.querySelectorAll('.col-progress-td').forEach(td => {
        td.style.display = showProgress ? '' : 'none';
      });
      document.querySelectorAll('.col-silence-td').forEach(td => {
        td.style.display = showSilence ? '' : 'none';
      });
      document.querySelectorAll('.col-elapsed-td').forEach(td => {
        td.style.display = showElapsed ? '' : 'none';
      });
    }

    // ─── Detail panel HTML ────────────────────────────────────────────────────
    function buildDetailHTML(agent) {
      const silClass = agent.status === 'stuck' ? 'val-stuck' : '';
      const eventsHTML = agent.detail.events.map((ev, i) => {
        const isLast = i === agent.detail.events.length - 1;
        return `
          <div class="timeline-event">
            <div class="timeline-time">${ev.time}</div>
            <div class="timeline-dot-wrap">
              <div class="timeline-dot" style="background: ${
                ev.type === 'claimed' ? 'var(--healthy)' :
                ev.type === 'completed' ? 'var(--idle)' :
                'var(--active)'
              };"></div>
              ${!isLast ? '<div class="timeline-line"></div>' : ''}
            </div>
            <div>
              <div class="timeline-type">${ev.type}</div>
              <div class="timeline-desc">${ev.desc}</div>
            </div>
          </div>
        `;
      }).join('');

      return `
        <div class="detail-panel">
          <div class="detail-metric-card">
            <div class="detail-metric-label">Elapsed</div>
            <div class="detail-metric-value">${agent.elapsed}</div>
          </div>
          <div class="detail-metric-card">
            <div class="detail-metric-label">Silence</div>
            <div class="detail-metric-value ${silClass}">${agent.silenceLabel}</div>
          </div>
          <div class="detail-metric-card">
            <div class="detail-metric-label">Progress</div>
            <div class="detail-metric-value">${agent.progress !== null ? agent.progress + '%' : '—'}</div>
          </div>
          <div class="detail-metric-card">
            <div class="detail-metric-label">Events</div>
            <div class="detail-metric-value">${agent.eventCount}</div>
          </div>
          <div class="detail-timeline">
            <div class="detail-timeline-label">Session Timeline — ${agent.detail.context}</div>
            <div class="timeline-events">${eventsHTML}</div>
          </div>
        </div>
      `;
    }

    // ─── Close all expanded ───────────────────────────────────────────────────
    function closeAllExpanded() {
      expandedId = null;

      // Close inline detail rows
      document.querySelectorAll('tr.detail-row').forEach(tr => {
        tr.classList.add('hidden');
      });
      document.querySelectorAll('tr.data-row').forEach(tr => {
        tr.classList.remove('expanded');
      });

      // Close drawer
      document.getElementById('drawer-panel').classList.remove('active');
      // Close overlay
      document.getElementById('overlay-card').classList.remove('active');
      document.getElementById('overlay-backdrop').classList.remove('active');
    }

    // ─── Expand agent ─────────────────────────────────────────────────────────
    function expandAgent(agentId) {
      const agent = AGENTS.find(a => a.id === agentId);
      if (!agent) return;

      if (expandStyle === 'inline') {
        // Close previously expanded
        document.querySelectorAll('tr.detail-row').forEach(tr => tr.classList.add('hidden'));
        document.querySelectorAll('tr.data-row').forEach(tr => tr.classList.remove('expanded'));

        if (expandedId === agentId) {
          expandedId = null;
          return;
        }
        expandedId = agentId;

        const detailRow = document.getElementById(`detail-${agentId}`);
        if (detailRow) {
          detailRow.classList.remove('hidden');
          detailRow.querySelector('td').innerHTML = buildDetailHTML(agent);
          const dataRow = document.getElementById(`row-${agentId}`);
          if (dataRow) dataRow.classList.add('expanded');
        }

      } else if (expandStyle === 'drawer') {
        expandedId = agentId;
        const panel = document.getElementById('drawer-panel');
        document.getElementById('drawer-title').textContent = agent.agent;
        document.getElementById('drawer-content').innerHTML = buildDetailHTML(agent);
        panel.classList.add('active');

      } else if (expandStyle === 'overlay') {
        expandedId = agentId;
        const card = document.getElementById('overlay-card');
        const backdrop = document.getElementById('overlay-backdrop');
        document.getElementById('overlay-title').textContent = agent.agent;
        document.getElementById('overlay-content').innerHTML = buildDetailHTML(agent);
        card.classList.add('active');
        backdrop.classList.add('active');
      }
    }

    // ─── Render table ─────────────────────────────────────────────────────────
    function renderTable() {
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';

      sortedAgents.forEach((agent, idx) => {
        const isStuck = agent.status === 'stuck';
        const isActive = agent.status === 'active';
        const isIdle = agent.status === 'idle';

        const statusClass = isStuck ? 'status-stuck' : isActive ? 'status-active' : 'status-idle';
        const statusLabel = isStuck ? 'STUCK' : isActive ? 'ACTIVE' : 'IDLE';

        // Progress fill color
        const progColor = agent.progress !== null
          ? (agent.progress >= 75 ? 'var(--healthy)' : agent.progress >= 40 ? 'var(--active)' : 'var(--idle)')
          : 'var(--idle)';

        // Silence class
        const silClass = isStuck ? 'silence-stuck' : isIdle ? 'silence-idle' : agent.silenceMin <= 1 ? 'silence-recent' : '';

        const sparkHTML = buildSparkline(agent);

        // Data row
        const tr = document.createElement('tr');
        tr.className = 'data-row' + (agent.id === expandedId ? ' expanded' : '');
        tr.id = `row-${agent.id}`;
        tr.setAttribute('tabindex', '0');
        tr.dataset.idx = idx;
        tr.dataset.id = agent.id;

        tr.innerHTML = `
          <td>
            <div class="status-badge ${statusClass}">
              <div class="status-dot"></div>
              ${statusLabel}
            </div>
          </td>
          <td>
            <div class="agent-name" title="${agent.agent}">${agent.agent}</div>
          </td>
          <td>
            <div class="task-title ${agent.task === '—' ? 'task-dash' : ''}" title="${agent.task}">${agent.task}</div>
          </td>
          <td class="col-project-td" style="${columnsMode === 'essential' ? 'display:none' : ''}">
            <span class="project-badge">${agent.project}</span>
          </td>
          <td class="col-progress-td" style="${columnsMode === 'essential' ? 'display:none' : ''}">
            ${agent.progress !== null ? `
              <div class="progress-wrap">
                <div class="progress-track">
                  <div class="progress-fill" style="width: ${agent.progress}%; background: ${progColor};"></div>
                </div>
                <div class="progress-pct">${agent.progress}%</div>
              </div>
            ` : '<span style="color: var(--text-dim); font-size: 11px;">—</span>'}
          </td>
          <td class="col-silence-td" style="${columnsMode === 'essential' ? 'display:none' : ''}">
            <span class="silence-val ${silClass}">${agent.silenceLabel}</span>
          </td>
          <td class="sparkline-cell">
            ${sparkHTML}
          </td>
          <td class="col-elapsed-td" style="${columnsMode !== 'full' ? 'display:none' : ''}">
            <span style="font-family: var(--font-mono); font-size: 11px; color: var(--text-dim);">${agent.elapsed}</span>
          </td>
        `;

        tr.addEventListener('click', () => {
          focusRow(idx);
          expandAgent(agent.id);
        });

        tr.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            expandAgent(agent.id);
          }
        });

        tbody.appendChild(tr);

        // Detail row (inline only)
        const detailTr = document.createElement('tr');
        detailTr.className = 'detail-row' + (agent.id === expandedId && expandStyle === 'inline' ? '' : ' hidden');
        detailTr.id = `detail-${agent.id}`;

        const detailTd = document.createElement('td');
        detailTd.setAttribute('colspan', '8');

        if (agent.id === expandedId && expandStyle === 'inline') {
          detailTd.innerHTML = buildDetailHTML(agent);
        }

        detailTr.appendChild(detailTd);
        tbody.appendChild(detailTr);
      });

      // Focus initial row
      const rows = document.querySelectorAll('tr.data-row');
      if (rows.length > 0) {
        const clampedIdx = Math.min(focusedIndex, rows.length - 1);
        rows[clampedIdx]?.classList.add('focused');
      }

      // Apply columns visibility
      applyColumns(columnsMode);
    }

    // ─── Focus management ─────────────────────────────────────────────────────
    function focusRow(idx) {
      document.querySelectorAll('tr.data-row').forEach(tr => tr.classList.remove('focused'));
      const rows = document.querySelectorAll('tr.data-row');
      if (rows[idx]) {
        rows[idx].classList.add('focused');
        rows[idx].focus({ preventScroll: false });
        focusedIndex = idx;
      }
    }

    // ─── Keyboard navigation ──────────────────────────────────────────────────
    document.addEventListener('keydown', (e) => {
      const rows = document.querySelectorAll('tr.data-row');
      if (!rows.length) return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        focusedIndex = Math.min(focusedIndex + 1, rows.length - 1);
        focusRow(focusedIndex);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        focusedIndex = Math.max(focusedIndex - 1, 0);
        focusRow(focusedIndex);
      } else if (e.key === 'Enter') {
        const focusedRow = rows[focusedIndex];
        if (focusedRow) {
          const agentId = focusedRow.dataset.id;
          expandAgent(agentId);
        }
      } else if (e.key === 'Escape') {
        closeAllExpanded();
      }
    });

    // ─── Column header sort click ─────────────────────────────────────────────
    document.querySelectorAll('thead th[data-col]').forEach(th => {
      const col = th.dataset.col;
      if (col === 'task') return; // task not sortable
      th.addEventListener('click', () => {
        if (col === currentSort) {
          sortDir = sortDir === 'asc' ? 'desc' : 'asc';
        } else {
          sortDir = 'desc';
        }
        sortAgents(col, false);
      });
    });

    // ─── Control event listeners ──────────────────────────────────────────────
    document.addEventListener('control-change', (e) => {
      const { id, value } = e.detail;

      if (id === 'stuck-threshold') {
        stuckThreshold = parseInt(value, 10);
        // Re-evaluate stuck status visually (could re-render; for demo keep data as-is)
        renderTable();
      }

      if (id === 'columns') {
        columnsMode = value;
        applyColumns(value);
      }

      if (id === 'sort-col') {
        sortDir = 'desc';
        sortAgents(value, false);
      }

      if (id === 'expand-style') {
        expandStyle = value;
        closeAllExpanded();
        // Re-open if something was expanded
        if (expandedId) {
          expandAgent(expandedId);
        }
      }
    });

    document.addEventListener('controls-ready', () => {
      const style = getComputedStyle(document.documentElement);
      const es = style.getPropertyValue('--expand-style').trim();
      if (es) expandStyle = es;

      const col = style.getPropertyValue('--sort-col').trim();
      if (col) currentSort = col;

      const cm = style.getPropertyValue('--columns').trim();
      if (cm) columnsMode = cm;

      const st = style.getPropertyValue('--stuck-threshold').trim();
      if (st) stuckThreshold = parseInt(st, 10);

      // Re-render with initial state
      sortAgents(currentSort, false);

      // Expand default after render
      if (expandedId) {
        requestAnimationFrame(() => expandAgent(expandedId));
      }
    });

    // ─── Initial render ───────────────────────────────────────────────────────
    sortedAgents = [...AGENTS];
    sortAgents('status', false);

    // Expand default after first render
    requestAnimationFrame(() => {
      expandAgent('claude-sonnet-8');
    });
  </script>
</body>
</html>

  </template>
  <template id="tpl-e1">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script type="application/json" id="variation-meta">
  {
    "id": "E1",
    "family": "E",
    "familyName": "Explorer Split",
    "name": "Compact List + Rich Detail",
    "layoutType": "Narrow List + Combined Detail Panel",
    "aesthetic": "Professional Dark",
    "description": "Persistent two-panel layout with a narrow agent list and a unified timeline+task detail panel. Click any agent to see their full narrative without switching tabs.",
    "controls": [
      {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["5 min", "10 min", "15 min", "30 min"],
        "cssValues": { "5 min": "5", "10 min": "10", "15 min": "15", "30 min": "30" },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
      },
      {
        "id": "list-width",
        "label": "List Width",
        "type": "range",
        "min": 220, "max": 380, "step": 20,
        "options": null,
        "cssValues": null,
        "value": 280,
        "defaultValue": 280,
        "unit": "px",
        "cssVar": "--list-width"
      },
      {
        "id": "detail-view",
        "label": "Detail View",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["unified", "tabbed"],
        "cssValues": { "unified": "unified", "tabbed": "tabbed" },
        "value": "unified",
        "defaultValue": "unified",
        "unit": "",
        "cssVar": "--detail-view",
        "event": true
      },
      {
        "id": "timeline-density",
        "label": "Timeline Density",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["compact", "standard", "verbose"],
        "cssValues": {
          "compact":  { "--event-padding": "8px 12px",  "--event-gap": "4px",  "--task-context-display": "none" },
          "standard": { "--event-padding": "12px 16px", "--event-gap": "8px",  "--task-context-display": "block" },
          "verbose":  { "--event-padding": "16px 20px", "--event-gap": "12px", "--task-context-display": "block" }
        },
        "value": "standard",
        "defaultValue": "standard",
        "unit": "",
        "cssVar": null
      },
      {
        "id": "task-inline",
        "label": "Show Task Inline",
        "type": "toggle",
        "min": null, "max": null, "step": null,
        "options": null,
        "cssValues": { "true": "block", "false": "none" },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--task-context-display"
      },
      {
        "id": "activity-indicator",
        "label": "Activity Indicator",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["sparkline", "status dot", "session bar"],
        "cssValues": { "sparkline": "sparkline", "status dot": "dot", "session bar": "bar" },
        "value": "sparkline",
        "defaultValue": "sparkline",
        "unit": "",
        "cssVar": "--activity-indicator",
        "event": true
      }
    ]
  }
  </script>
  <style>
    :root {
      --bg: #0f1117;
      --panel: #1a1d27;
      --border: #2a2d3a;
      --text: #e2e4e9;
      --text-dim: #8b8fa3;
      --status-stuck: #ef4444;
      --status-active: #3b82f6;
      --status-idle: #6b7280;
      --status-healthy: #22c55e;
      --font-sans: 'Inter', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --radius: 8px;
      --list-width: 280px;
      --stuck-threshold: 5;
      --detail-view: unified;
      --event-padding: 12px 16px;
      --event-gap: 8px;
      --task-context-display: block;
      --activity-indicator: sparkline;
    }

    :root * {
      transition: color 0.3s ease, background-color 0.3s ease,
                  border-color 0.3s ease, padding 0.3s ease,
                  gap 0.3s ease, font-size 0.3s ease,
                  border-radius 0.3s ease, box-shadow 0.3s ease,
                  max-width 0.3s ease, width 0.3s ease,
                  opacity 0.3s ease;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Scrollbars */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

    /* Fleet summary */
    .fleet-bar {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 24px;
      flex-shrink: 0;
    }

    .fleet-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-dim);
      font-family: var(--font-mono);
    }

    .fleet-stat {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-family: var(--font-mono);
    }

    .fleet-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .fleet-stat.stuck .fleet-dot { background: var(--status-stuck); }
    .fleet-stat.active .fleet-dot { background: var(--status-active); }
    .fleet-stat.idle .fleet-dot { background: var(--status-idle); }

    /* Two-panel layout */
    .main-layout {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Left list */
    .agent-list {
      width: var(--list-width);
      min-width: var(--list-width);
      max-width: var(--list-width);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      overflow-x: hidden;
      background: var(--panel);
      flex-shrink: 0;
    }

    .list-header {
      padding: 10px 12px 8px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-dim);
      font-family: var(--font-mono);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--panel);
      z-index: 1;
    }

    .agent-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 12px;
      cursor: pointer;
      border-left: 3px solid transparent;
      border-bottom: 1px solid var(--border);
      position: relative;
      transition: background 0.15s ease, border-color 0.15s ease;
    }

    .agent-row:hover { background: rgba(255,255,255,0.04); }

    .agent-row.selected.stuck {
      border-left-color: var(--status-stuck);
      background: rgba(239,68,68,0.06);
    }
    .agent-row.selected.active {
      border-left-color: var(--status-active);
      background: rgba(59,130,246,0.06);
    }
    .agent-row.selected.idle {
      border-left-color: var(--status-idle);
      background: rgba(107,114,128,0.06);
    }

    /* Status dot */
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
      position: relative;
    }

    .status-dot.stuck {
      background: var(--status-stuck);
      animation: pulse-stuck 1.5s ease-in-out infinite;
    }
    .status-dot.active { background: var(--status-active); }
    .status-dot.idle   { background: var(--status-idle); }

    @keyframes pulse-stuck {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.6); }
      50%       { box-shadow: 0 0 0 4px rgba(239,68,68,0); }
    }

    .agent-name {
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 500;
      color: var(--text);
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Activity indicator area */
    .activity-indicator-wrap {
      flex-shrink: 0;
      width: 44px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Sparkline SVG */
    .sparkline-svg { display: block; }

    /* Status-only indicator (dot mode) */
    .indicator-dot-large {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    /* Session bar indicator */
    .session-bar {
      width: 40px;
      height: 8px;
      border-radius: 2px;
      background: var(--border);
      overflow: hidden;
      position: relative;
    }
    .session-bar-fill {
      height: 100%;
      border-radius: 2px;
    }

    /* Right panel */
    .detail-panel {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      background: var(--bg);
      display: flex;
      flex-direction: column;
    }

    .detail-header {
      padding: 16px 24px 14px;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      flex-shrink: 0;
    }

    .detail-agent-name {
      font-family: var(--font-mono);
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      font-family: var(--font-mono);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .status-badge.stuck  { background: rgba(239,68,68,0.15);  color: var(--status-stuck); }
    .status-badge.active { background: rgba(59,130,246,0.15); color: var(--status-active); }
    .status-badge.idle   { background: rgba(107,114,128,0.15); color: var(--status-idle); }

    .current-task-summary {
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 6px;
      font-family: var(--font-sans);
    }

    .current-task-summary span {
      color: var(--text);
      font-weight: 500;
    }

    /* Metrics row */
    .metrics-row {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      flex-shrink: 0;
    }

    .metric {
      flex: 1;
      padding: 10px 16px;
      border-right: 1px solid var(--border);
    }
    .metric:last-child { border-right: none; }

    .metric-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-dim);
      font-family: var(--font-mono);
      margin-bottom: 3px;
    }

    .metric-value {
      font-size: 14px;
      font-weight: 600;
      font-family: var(--font-mono);
      color: var(--text);
    }

    .metric-value.danger  { color: var(--status-stuck); }
    .metric-value.healthy { color: var(--status-healthy); }
    .metric-value.muted   { color: var(--text-dim); }

    /* Tab bar (tabbed mode) */
    .tab-bar {
      display: none;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      flex-shrink: 0;
    }

    .tab-bar.visible { display: flex; }

    .tab-btn {
      padding: 10px 20px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-dim);
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
      font-family: var(--font-sans);
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
    }

    .tab-btn:hover { color: var(--text); }
    .tab-btn.active { color: var(--text); border-bottom-color: var(--status-active); }

    /* Tab content panels */
    .tab-content { display: none; flex: 1; overflow-y: auto; }
    .tab-content.active { display: block; }
    .tab-content.always-unified { display: block; flex: 1; overflow-y: auto; }

    /* Timeline */
    .timeline {
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      gap: var(--event-gap);
    }

    /* Silence gap */
    .silence-gap {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
    }

    .silence-line {
      flex: 1;
      height: 1px;
      background: rgba(239,68,68,0.3);
    }

    .silence-label {
      font-size: 11px;
      font-family: var(--font-mono);
      font-weight: 600;
      color: var(--status-stuck);
      padding: 4px 10px;
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.25);
      border-radius: 4px;
      white-space: nowrap;
    }

    /* Event card */
    .event-card {
      display: flex;
      gap: 16px;
      padding: var(--event-padding);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      animation: fadeSlideIn 0.25s ease both;
    }

    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .event-card:nth-child(2) { animation-delay: 0.04s; }
    .event-card:nth-child(3) { animation-delay: 0.08s; }
    .event-card:nth-child(4) { animation-delay: 0.12s; }
    .event-card:nth-child(5) { animation-delay: 0.16s; }
    .event-card:nth-child(6) { animation-delay: 0.20s; }

    .event-time {
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--text-dim);
      width: 52px;
      flex-shrink: 0;
      padding-top: 1px;
      text-align: right;
    }

    .event-body { flex: 1; }

    .event-type-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      font-family: var(--font-mono);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 5px;
    }

    .event-type-tag.checkpoint { background: rgba(59,130,246,0.12); color: #60a5fa; }
    .event-type-tag.claimed    { background: rgba(168,85,247,0.12); color: #c084fc; }
    .event-type-tag.completed  { background: rgba(34,197,94,0.12);  color: #4ade80; }

    .event-description {
      font-size: 13px;
      color: var(--text);
      font-weight: 500;
      margin-bottom: 4px;
      line-height: 1.4;
    }

    .event-task-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--text-dim);
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 2px 6px;
    }

    /* Inline task context (claimed event) */
    .task-context {
      display: var(--task-context-display);
      margin-top: 10px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 6px;
    }

    .task-context-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
      line-height: 1.3;
    }

    .task-context-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--text-dim);
    }

    .task-context-project {
      background: rgba(59,130,246,0.12);
      color: #60a5fa;
      padding: 1px 6px;
      border-radius: 3px;
      font-weight: 600;
    }

    .progress-bar-wrap {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      border-radius: 2px;
      background: var(--status-active);
      transition: width 0.4s ease;
    }

    .task-separator {
      margin: 6px 0;
      height: 1px;
      background: rgba(255,255,255,0.04);
    }

    /* Tabbed: task detail pane */
    .task-detail-pane {
      padding: 20px 24px;
    }

    .task-detail-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px 20px;
      margin-bottom: 12px;
    }

    /* Metrics tab */
    .metrics-detail-grid {
      padding: 20px 24px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .metric-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 16px;
    }

    /* Stuck warning banner */
    .stuck-banner {
      margin: 0 24px;
      margin-top: 16px;
      padding: 10px 14px;
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.25);
      border-radius: 6px;
      font-size: 12px;
      color: var(--status-stuck);
      font-family: var(--font-mono);
      font-weight: 500;
    }

    .stuck-banner.hidden { display: none; }
  </style>
</head>
<body>

  <!-- Fleet Summary Bar -->
  <div class="fleet-bar">
    <span class="fleet-label">Fleet</span>
    <div style="display:flex;align-items:center;gap:6px;font-size:13px;font-weight:600;color:var(--text);">
      8 agents
    </div>
    <div style="width:1px;height:16px;background:var(--border);"></div>
    <div class="fleet-stat stuck">
      <div class="fleet-dot"></div>
      <span style="color:var(--status-stuck);font-weight:600;">2 stuck</span>
    </div>
    <div class="fleet-stat active">
      <div class="fleet-dot"></div>
      <span style="color:var(--status-active);font-weight:600;">4 active</span>
    </div>
    <div class="fleet-stat idle">
      <div class="fleet-dot"></div>
      <span style="color:var(--status-idle);font-weight:600;">2 idle</span>
    </div>
    <div style="flex:1;"></div>
    <div style="font-size:11px;font-family:var(--font-mono);color:var(--text-dim);">
      Stuck threshold: <span id="threshold-display" style="color:var(--text);font-weight:600;">5 min</span>
    </div>
  </div>

  <!-- Main Two-Panel Layout -->
  <div class="main-layout">

    <!-- LEFT: Narrow Agent List -->
    <div class="agent-list" id="agent-list">
      <div class="list-header">Agents</div>

      <!-- STUCK agents first -->
      <div class="agent-row selected stuck" data-agent="sonnet-8" data-status="stuck" onclick="selectAgent('sonnet-8', this)">
        <div class="status-dot stuck"></div>
        <div class="agent-name">claude-sonnet-8</div>
        <div class="activity-indicator-wrap" data-sparkline-type="stuck-short">
          <!-- sparkline injected by JS -->
        </div>
      </div>

      <div class="agent-row stuck" data-agent="opus-7" data-status="stuck" onclick="selectAgent('opus-7', this)">
        <div class="status-dot stuck"></div>
        <div class="agent-name">claude-opus-7</div>
        <div class="activity-indicator-wrap" data-sparkline-type="stuck-long">
        </div>
      </div>

      <!-- ACTIVE agents -->
      <div class="agent-row active" data-agent="gemini-1" data-status="active" onclick="selectAgent('gemini-1', this)">
        <div class="status-dot active"></div>
        <div class="agent-name">gemini-pro-1</div>
        <div class="activity-indicator-wrap" data-sparkline-type="active-dense">
        </div>
      </div>

      <div class="agent-row active" data-agent="sonnet-3" data-status="active" onclick="selectAgent('sonnet-3', this)">
        <div class="status-dot active"></div>
        <div class="agent-name">claude-sonnet-3</div>
        <div class="activity-indicator-wrap" data-sparkline-type="active-regular">
        </div>
      </div>

      <div class="agent-row active" data-agent="haiku-2" data-status="active" onclick="selectAgent('haiku-2', this)">
        <div class="status-dot active"></div>
        <div class="agent-name">claude-haiku-2</div>
        <div class="activity-indicator-wrap" data-sparkline-type="active-regular2">
        </div>
      </div>

      <div class="agent-row active" data-agent="gpt4o" data-status="active" onclick="selectAgent('gpt4o', this)">
        <div class="status-dot active"></div>
        <div class="agent-name">gpt-4o-agent</div>
        <div class="activity-indicator-wrap" data-sparkline-type="active-recent">
        </div>
      </div>

      <!-- IDLE agents -->
      <div class="agent-row idle" data-agent="opus-5" data-status="idle" onclick="selectAgent('opus-5', this)">
        <div class="status-dot idle"></div>
        <div class="agent-name">claude-opus-5</div>
        <div class="activity-indicator-wrap" data-sparkline-type="idle-early">
        </div>
      </div>

      <div class="agent-row idle" data-agent="haiku-9" data-status="idle" onclick="selectAgent('haiku-9', this)">
        <div class="status-dot idle"></div>
        <div class="agent-name">claude-haiku-9</div>
        <div class="activity-indicator-wrap" data-sparkline-type="idle-mid">
        </div>
      </div>
    </div>

    <!-- RIGHT: Detail Panel -->
    <div class="detail-panel" id="detail-panel">

      <!-- Agent Header -->
      <div class="detail-header" id="detail-header">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
          <div class="detail-agent-name" id="detail-agent-name">claude-sonnet-8</div>
          <div class="status-badge stuck" id="detail-status-badge">
            <div style="width:6px;height:6px;border-radius:50%;background:currentColor;animation:pulse-stuck 1.5s ease-in-out infinite;"></div>
            STUCK
          </div>
        </div>
        <div class="current-task-summary" id="detail-task-summary">
          Current task: <span>Fix pagination bug</span> &middot; project <span>web</span> &middot; <span style="color:var(--status-stuck);">22m silence</span>
        </div>
      </div>

      <!-- Metrics Row -->
      <div class="metrics-row" id="detail-metrics">
        <div class="metric">
          <div class="metric-label">Elapsed</div>
          <div class="metric-value danger" id="metric-elapsed">30m</div>
        </div>
        <div class="metric">
          <div class="metric-label">Silence</div>
          <div class="metric-value danger" id="metric-silence">22m</div>
        </div>
        <div class="metric">
          <div class="metric-label">Progress</div>
          <div class="metric-value" id="metric-progress">20%</div>
        </div>
        <div class="metric">
          <div class="metric-label">Session</div>
          <div class="metric-value muted" id="metric-session">30m</div>
        </div>
      </div>

      <!-- Stuck banner -->
      <div class="stuck-banner hidden" id="stuck-banner">
        Agent has been silent for 22 min — exceeds stuck threshold. Last activity: checkpoint 22m ago.
      </div>

      <!-- Tab Bar (tabbed mode) -->
      <div class="tab-bar" id="tab-bar">
        <button class="tab-btn active" data-tab="timeline" onclick="switchTab('timeline', this)">Timeline</button>
        <button class="tab-btn" data-tab="task" onclick="switchTab('task', this)">Current Task</button>
        <button class="tab-btn" data-tab="metrics" onclick="switchTab('metrics', this)">Metrics</button>
      </div>

      <!-- Unified Timeline (default) -->
      <div class="tab-content always-unified" id="unified-view">
        <div class="timeline" id="unified-timeline">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- Tabbed: Timeline Tab -->
      <div class="tab-content" id="tab-timeline">
        <div class="timeline" id="tabbed-timeline">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- Tabbed: Task Tab -->
      <div class="tab-content" id="tab-task">
        <div class="task-detail-pane" id="tabbed-task">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- Tabbed: Metrics Tab -->
      <div class="tab-content" id="tab-metrics">
        <div class="metrics-detail-grid" id="tabbed-metrics">
          <!-- Populated by JS -->
        </div>
      </div>

    </div>
  </div>

  <script>
    // ─── Data ───────────────────────────────────────────────────────────────

    const AGENTS = {
      'sonnet-8': {
        name: 'claude-sonnet-8',
        status: 'stuck',
        currentTask: 'Fix pagination bug',
        project: 'web',
        progress: 20,
        silence: '22m',
        elapsed: '30m',
        session: '30m',
        silenceMin: 22,
        timeline: [
          {
            type: 'gap',
            label: '22m silence — no activity',
          },
          {
            type: 'checkpoint',
            time: '22m ago',
            description: 'Investigating offset calculation',
            task: 'Fix pagination bug',
            project: 'web',
          },
          {
            type: 'checkpoint',
            time: '25m ago',
            description: 'Reading cursor implementation',
            task: 'Fix pagination bug',
            project: 'web',
          },
          {
            type: 'claimed',
            time: '30m ago',
            description: 'Claimed task',
            task: 'Fix pagination bug',
            project: 'web',
            progress: 20,
            taskDesc: 'Fix the off-by-one error in the cursor-based pagination endpoint causing duplicate records on page boundaries.',
          },
        ]
      },
      'opus-7': {
        name: 'claude-opus-7',
        status: 'stuck',
        currentTask: 'Implement auth middleware',
        project: 'api-v2',
        progress: 35,
        silence: '12m',
        elapsed: '25m',
        session: '25m',
        silenceMin: 12,
        timeline: [
          {
            type: 'gap',
            label: '12m silence — no activity',
          },
          {
            type: 'checkpoint',
            time: '12m ago',
            description: 'Analyzing JWT library options',
            task: 'Implement auth middleware',
            project: 'api-v2',
          },
          {
            type: 'checkpoint',
            time: '15m ago',
            description: 'Reading existing auth code',
            task: 'Implement auth middleware',
            project: 'api-v2',
          },
          {
            type: 'claimed',
            time: '18m ago',
            description: 'Claimed task',
            task: 'Implement auth middleware',
            project: 'api-v2',
            progress: 35,
            taskDesc: 'Build JWT-based authentication middleware for the API v2 service, including token validation, refresh, and role-based access control.',
          },
          {
            type: 'separator',
          },
          {
            type: 'completed',
            time: '20m ago',
            task: 'Set up project scaffolding',
            project: 'api-v2',
          },
          {
            type: 'checkpoint',
            time: '25m ago',
            description: 'Generated folder structure',
            task: 'Set up project scaffolding',
            project: 'api-v2',
          },
        ]
      },
      'gemini-1': {
        name: 'gemini-pro-1',
        status: 'active',
        currentTask: 'Optimize DB queries',
        project: 'core',
        progress: 55,
        silence: '30s',
        elapsed: '15m',
        session: '15m',
        silenceMin: 0,
        timeline: [
          {
            type: 'checkpoint',
            time: '30s ago',
            description: 'Benchmarking query performance',
            task: 'Optimize DB queries',
            project: 'core',
          },
          {
            type: 'checkpoint',
            time: '3m ago',
            description: 'Added index on events table',
            task: 'Optimize DB queries',
            project: 'core',
          },
          {
            type: 'checkpoint',
            time: '7m ago',
            description: 'Profiling slow queries',
            task: 'Optimize DB queries',
            project: 'core',
          },
          {
            type: 'claimed',
            time: '15m ago',
            description: 'Claimed task',
            task: 'Optimize DB queries',
            project: 'core',
            progress: 55,
            taskDesc: 'Identify and optimize the slowest database queries in the projection engine using EXPLAIN QUERY PLAN and strategic indexes.',
          },
        ]
      },
      'sonnet-3': {
        name: 'claude-sonnet-3',
        status: 'active',
        currentTask: 'Add search API endpoint',
        project: 'api-v2',
        progress: 60,
        silence: '1m',
        elapsed: '12m',
        session: '12m',
        silenceMin: 1,
        timeline: [
          {
            type: 'checkpoint',
            time: '1m ago',
            description: 'Implementing full-text search',
            task: 'Add search API endpoint',
            project: 'api-v2',
          },
          {
            type: 'checkpoint',
            time: '3m ago',
            description: 'Added search route handler',
            task: 'Add search API endpoint',
            project: 'api-v2',
          },
          {
            type: 'checkpoint',
            time: '5m ago',
            description: 'Designing search schema',
            task: 'Add search API endpoint',
            project: 'api-v2',
          },
          {
            type: 'claimed',
            time: '8m ago',
            description: 'Claimed task',
            task: 'Add search API endpoint',
            project: 'api-v2',
            progress: 60,
            taskDesc: 'Implement a full-text search endpoint using SQLite FTS5 for the task and event data, supporting pagination and relevance ranking.',
          },
          {
            type: 'separator',
          },
          {
            type: 'completed',
            time: '10m ago',
            task: 'Design search schema',
            project: 'api-v2',
          },
          {
            type: 'checkpoint',
            time: '12m ago',
            description: 'Finalized FTS5 index design',
            task: 'Design search schema',
            project: 'api-v2',
          },
        ]
      },
      'haiku-2': {
        name: 'claude-haiku-2',
        status: 'active',
        currentTask: 'Write unit tests for TaskService',
        project: 'core',
        progress: 45,
        silence: '3m',
        elapsed: '12m',
        session: '12m',
        silenceMin: 3,
        timeline: [
          {
            type: 'checkpoint',
            time: '3m ago',
            description: 'Writing claimNext test cases',
            task: 'Write unit tests for TaskService',
            project: 'core',
          },
          {
            type: 'checkpoint',
            time: '7m ago',
            description: 'Set up test fixtures',
            task: 'Write unit tests for TaskService',
            project: 'core',
          },
          {
            type: 'claimed',
            time: '12m ago',
            description: 'Claimed task',
            task: 'Write unit tests for TaskService',
            project: 'core',
            progress: 45,
            taskDesc: 'Add comprehensive unit tests for the TaskService, covering claim, complete, archive, and dependency resolution logic.',
          },
        ]
      },
      'gpt4o': {
        name: 'gpt-4o-agent',
        status: 'active',
        currentTask: 'Update CLI reference docs',
        project: 'docs',
        progress: 70,
        silence: '2m',
        elapsed: '5m',
        session: '5m',
        silenceMin: 2,
        timeline: [
          {
            type: 'checkpoint',
            time: '2m ago',
            description: 'Updating flag descriptions',
            task: 'Update CLI reference docs',
            project: 'docs',
          },
          {
            type: 'claimed',
            time: '5m ago',
            description: 'Claimed task',
            task: 'Update CLI reference docs',
            project: 'docs',
            progress: 70,
            taskDesc: 'Update docs-site/reference/cli.md to match the current CLI manifest after recent command additions.',
          },
        ]
      },
      'opus-5': {
        name: 'claude-opus-5',
        status: 'idle',
        currentTask: null,
        project: null,
        progress: 0,
        silence: '8m',
        elapsed: '15m',
        session: '7m',
        silenceMin: 8,
        timeline: [
          {
            type: 'completed',
            time: '8m ago',
            task: 'Refactor event types',
            project: 'core',
          },
          {
            type: 'checkpoint',
            time: '10m ago',
            description: 'Cleaned up legacy event schemas',
            task: 'Refactor event types',
            project: 'core',
          },
          {
            type: 'checkpoint',
            time: '13m ago',
            description: 'Migrated to new discriminated union',
            task: 'Refactor event types',
            project: 'core',
          },
          {
            type: 'claimed',
            time: '15m ago',
            description: 'Claimed task',
            task: 'Refactor event types',
            project: 'core',
            progress: 100,
            taskDesc: 'Refactor the event type system to use a Zod discriminated union for safer event parsing and better TypeScript inference.',
          },
        ]
      },
      'haiku-9': {
        name: 'claude-haiku-9',
        status: 'idle',
        currentTask: null,
        project: null,
        progress: 0,
        silence: '3m',
        elapsed: '8m',
        session: '5m',
        silenceMin: 3,
        timeline: [
          {
            type: 'completed',
            time: '3m ago',
            task: 'Add --available flag to task list',
            project: 'cli',
          },
          {
            type: 'checkpoint',
            time: '5m ago',
            description: 'Added filter logic to task list command',
            task: 'Add --available flag to task list',
            project: 'cli',
          },
          {
            type: 'claimed',
            time: '8m ago',
            description: 'Claimed task',
            task: 'Add --available flag to task list',
            project: 'cli',
            progress: 100,
            taskDesc: 'Add --available flag that filters tasks to only those claimable (status=ready, all deps done).',
          },
        ]
      },
    };

    // ─── Sparkline data ──────────────────────────────────────────────────────

    const SPARKLINE_DEFS = {
      'stuck-short':   { points: [2,10,6,8],       gap: true,  status: 'stuck'  },
      'stuck-long':    { points: [2,8,10,6,4,5],   gap: true,  status: 'stuck'  },
      'active-dense':  { points: [3,7,9,5,8,10,6,9,8], gap: false, status: 'active' },
      'active-regular':{ points: [4,8,6,9,7,10],   gap: false, status: 'active' },
      'active-regular2':{ points: [5,9,7,8,10,6],  gap: false, status: 'active' },
      'active-recent': { points: [8,6,9,10],        gap: false, status: 'active' },
      'idle-early':    { points: [3,8,10,7,5],      gap: true,  status: 'idle'   },
      'idle-mid':      { points: [5,9,7,8,6],       gap: true,  status: 'idle'   },
    };

    function buildSparklineSVG(def) {
      const W = 40, H = 20, pts = def.points;
      if (!pts || pts.length === 0) return '';
      const n = pts.length;
      const xs = pts.map((_, i) => (i / Math.max(n - 1, 1)) * W);
      const maxY = Math.max(...pts);
      const minY = Math.min(...pts);
      const range = maxY - minY || 1;
      const ys = pts.map(p => H - 2 - ((p - minY) / range) * (H - 4));
      const color = def.status === 'stuck' ? '#ef4444' : def.status === 'active' ? '#3b82f6' : '#6b7280';
      const gapColor = '#ef4444';

      let d = `M ${xs[0]} ${ys[0]}`;
      for (let i = 1; i < n; i++) d += ` L ${xs[i]} ${ys[i]}`;

      let svg = `<svg class="sparkline-svg" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}" fill="none">`;

      if (def.gap) {
        // Draw active portion (first 70%), then gap
        const split = Math.floor(n * 0.7);
        let d1 = `M ${xs[0]} ${ys[0]}`;
        for (let i = 1; i < split; i++) d1 += ` L ${xs[i]} ${ys[i]}`;
        svg += `<path d="${d1}" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.7"/>`;
        // Gap line
        svg += `<line x1="${xs[split]}" y1="${H/2}" x2="${W}" y2="${H/2}" stroke="${gapColor}" stroke-width="1" stroke-dasharray="2,2" opacity="0.5"/>`;
        // Red dot at end
        svg += `<circle cx="${W}" cy="${H/2}" r="2" fill="${gapColor}" opacity="0.8"/>`;
      } else {
        svg += `<path d="${d}" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.8"/>`;
        // Latest dot
        svg += `<circle cx="${xs[n-1]}" cy="${ys[n-1]}" r="2" fill="${color}"/>`;
      }

      svg += '</svg>';
      return svg;
    }

    function buildStatusDot(status) {
      const colors = { stuck: '#ef4444', active: '#3b82f6', idle: '#6b7280' };
      const c = colors[status] || '#6b7280';
      const anim = status === 'stuck' ? 'animation:pulse-stuck 1.5s ease-in-out infinite;' : '';
      return `<div style="width:10px;height:10px;border-radius:50%;background:${c};${anim}"></div>`;
    }

    function buildSessionBar(agentId, status) {
      const agent = AGENTS[agentId];
      if (!agent) return '';
      const colors = { stuck: '#ef4444', active: '#3b82f6', idle: '#6b7280' };
      const c = colors[status] || '#6b7280';
      const pct = status === 'idle' ? 100 : Math.min(100, (agent.silenceMin / 30) * 100);
      return `<div class="session-bar"><div class="session-bar-fill" style="width:${100-pct}%;background:${c};"></div></div>`;
    }

    // ─── Current activity indicator mode ────────────────────────────────────

    let currentIndicatorMode = 'sparkline';

    function updateAllIndicators(mode) {
      currentIndicatorMode = mode;
      document.querySelectorAll('.agent-row').forEach(row => {
        const wrap = row.querySelector('.activity-indicator-wrap');
        const sparkType = wrap.getAttribute('data-sparkline-type');
        const status = row.getAttribute('data-status');
        const agentId = row.getAttribute('data-agent');
        wrap.innerHTML = buildIndicator(mode, sparkType, status, agentId);
      });
    }

    function buildIndicator(mode, sparkType, status, agentId) {
      if (mode === 'dot') {
        return buildStatusDot(status);
      } else if (mode === 'bar') {
        return buildSessionBar(agentId, status);
      } else {
        // sparkline (default)
        const def = SPARKLINE_DEFS[sparkType];
        return def ? buildSparklineSVG(def) : '';
      }
    }

    // ─── Timeline rendering ──────────────────────────────────────────────────

    function renderEventCard(event, idx) {
      if (event.type === 'gap') {
        return `
          <div class="silence-gap" style="animation:fadeSlideIn 0.25s ease ${idx * 0.04}s both;">
            <div class="silence-line"></div>
            <div class="silence-label">&#9679; ${event.label}</div>
            <div class="silence-line"></div>
          </div>`;
      }

      if (event.type === 'separator') {
        return `<div class="task-separator"></div>`;
      }

      if (event.type === 'completed') {
        return `
          <div class="event-card" style="animation-delay:${idx * 0.04}s;">
            <div class="event-time">${event.time}</div>
            <div class="event-body">
              <div class="event-type-tag completed">&#10003; completed</div>
              <div class="event-description" style="color:var(--text-dim);">
                <span style="color:#4ade80;">&#10003;</span> ${event.task}
              </div>
              <div class="event-task-tag">${event.project}</div>
            </div>
          </div>`;
      }

      if (event.type === 'checkpoint') {
        return `
          <div class="event-card" style="animation-delay:${idx * 0.04}s;">
            <div class="event-time">${event.time}</div>
            <div class="event-body">
              <div class="event-type-tag checkpoint">&#11044; checkpoint</div>
              <div class="event-description">&ldquo;${event.description}&rdquo;</div>
              <div class="event-task-tag">&#9656; ${event.task} &middot; ${event.project}</div>
            </div>
          </div>`;
      }

      if (event.type === 'claimed') {
        return `
          <div class="event-card" style="animation-delay:${idx * 0.04}s;">
            <div class="event-time">${event.time}</div>
            <div class="event-body">
              <div class="event-type-tag claimed">&#9654; claimed</div>
              <div class="event-description">Task assigned to agent</div>
              <div class="task-context">
                <div class="task-context-title">${event.task}</div>
                <div class="task-context-meta">
                  <span class="task-context-project">${event.project}</span>
                  <span>progress ${event.progress}%</span>
                </div>
                <div class="progress-bar-wrap">
                  <div class="progress-bar-fill" style="width:${event.progress}%;"></div>
                </div>
                ${event.taskDesc ? `<div style="font-size:12px;color:var(--text-dim);margin-top:8px;line-height:1.5;">${event.taskDesc}</div>` : ''}
              </div>
            </div>
          </div>`;
      }

      return '';
    }

    function renderTimeline(agentId) {
      const agent = AGENTS[agentId];
      if (!agent) return '';
      return agent.timeline.map((ev, i) => renderEventCard(ev, i)).join('');
    }

    // ─── Tabbed task pane ────────────────────────────────────────────────────

    function renderTabbedTask(agentId) {
      const agent = AGENTS[agentId];
      if (!agent || !agent.currentTask) {
        return `<div style="padding:20px 24px;color:var(--text-dim);font-size:13px;">No active task.</div>`;
      }
      return `
        <div class="task-detail-card">
          <div style="font-size:15px;font-weight:600;color:var(--text);margin-bottom:8px;">${agent.currentTask}</div>
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;font-size:12px;font-family:var(--font-mono);color:var(--text-dim);">
            <span class="task-context-project">${agent.project}</span>
            <span>Progress: ${agent.progress}%</span>
          </div>
          <div class="progress-bar-wrap" style="margin-bottom:12px;">
            <div class="progress-bar-fill" style="width:${agent.progress}%;"></div>
          </div>
          <div style="font-size:12px;color:var(--text-dim);line-height:1.6;">
            ${agent.timeline.find(e => e.type === 'claimed')?.taskDesc || ''}
          </div>
        </div>`;
    }

    function renderTabbedMetrics(agentId) {
      const agent = AGENTS[agentId];
      if (!agent) return '';
      const silenceColor = agent.status === 'stuck' ? 'var(--status-stuck)' : 'var(--text)';
      return `
        <div class="metric-card">
          <div class="metric-label">Elapsed</div>
          <div class="metric-value">${agent.elapsed}</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Silence</div>
          <div class="metric-value" style="color:${silenceColor};">${agent.silence}</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Progress</div>
          <div class="metric-value">${agent.progress}%</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Session</div>
          <div class="metric-value muted">${agent.session}</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Status</div>
          <div class="metric-value" style="color:var(--status-${agent.status});">${agent.status.toUpperCase()}</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Project</div>
          <div class="metric-value muted">${agent.project || '—'}</div>
        </div>`;
    }

    // ─── Detail view mode ────────────────────────────────────────────────────

    let currentDetailView = 'unified';
    let currentTab = 'timeline';

    function applyDetailView(mode) {
      currentDetailView = mode;
      const unifiedEl = document.getElementById('unified-view');
      const tabBar = document.getElementById('tab-bar');
      const tabTimeline = document.getElementById('tab-timeline');
      const tabTask = document.getElementById('tab-task');
      const tabMetrics = document.getElementById('tab-metrics');

      if (mode === 'unified') {
        unifiedEl.style.display = 'block';
        tabBar.classList.remove('visible');
        tabTimeline.classList.remove('active');
        tabTask.classList.remove('active');
        tabMetrics.classList.remove('active');
      } else {
        // tabbed
        unifiedEl.style.display = 'none';
        tabBar.classList.add('visible');
        // Show whichever tab was active
        switchTab(currentTab, document.querySelector(`.tab-btn[data-tab="${currentTab}"]`));
      }
    }

    function switchTab(tabId, btn) {
      currentTab = tabId;
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');

      const tabs = ['timeline', 'task', 'metrics'];
      tabs.forEach(t => {
        const el = document.getElementById(`tab-${t}`);
        if (el) el.classList.toggle('active', t === tabId);
      });
    }

    // ─── Agent selection ─────────────────────────────────────────────────────

    let selectedAgentId = 'sonnet-8';

    function selectAgent(agentId, rowEl) {
      // Update list selection
      document.querySelectorAll('.agent-row').forEach(r => r.classList.remove('selected'));
      rowEl.classList.add('selected');
      selectedAgentId = agentId;

      const agent = AGENTS[agentId];
      if (!agent) return;

      // Update header
      document.getElementById('detail-agent-name').textContent = agent.name;

      const badge = document.getElementById('detail-status-badge');
      badge.className = `status-badge ${agent.status}`;
      badge.innerHTML = `<div style="width:6px;height:6px;border-radius:50%;background:currentColor;${agent.status === 'stuck' ? 'animation:pulse-stuck 1.5s ease-in-out infinite;' : ''}"></div> ${agent.status.toUpperCase()}`;

      const summary = document.getElementById('detail-task-summary');
      if (agent.currentTask) {
        const silenceColor = agent.status === 'stuck' ? 'var(--status-stuck)' : 'var(--text-dim)';
        summary.innerHTML = `Current task: <span>${agent.currentTask}</span> &middot; project <span>${agent.project}</span> &middot; <span style="color:${silenceColor};">${agent.silence} silence</span>`;
      } else {
        summary.innerHTML = `<span style="color:var(--text-dim);">Session ended &middot; last activity ${agent.silence} ago</span>`;
      }

      // Update metrics
      const silColor = agent.status === 'stuck' ? 'danger' : agent.status === 'idle' ? 'muted' : '';
      document.getElementById('metric-elapsed').textContent = agent.elapsed;
      document.getElementById('metric-elapsed').className = `metric-value ${agent.status === 'stuck' ? 'danger' : ''}`;
      document.getElementById('metric-silence').textContent = agent.silence;
      document.getElementById('metric-silence').className = `metric-value ${agent.status === 'stuck' ? 'danger' : agent.status === 'idle' ? 'muted' : ''}`;
      document.getElementById('metric-progress').textContent = agent.progress + '%';
      document.getElementById('metric-session').textContent = agent.session;

      // Stuck banner
      updateStuckBanner(agent);

      // Timelines
      const timelineHtml = renderTimeline(agentId);
      document.getElementById('unified-timeline').innerHTML = timelineHtml;
      document.getElementById('tabbed-timeline').innerHTML = timelineHtml;
      document.getElementById('tabbed-task').innerHTML = renderTabbedTask(agentId);
      document.getElementById('tabbed-metrics').innerHTML = renderTabbedMetrics(agentId);
    }

    function updateStuckBanner(agent) {
      const banner = document.getElementById('stuck-banner');
      const threshold = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--stuck-threshold').trim()) || 5;
      if (agent.status === 'stuck' && agent.silenceMin >= threshold) {
        banner.classList.remove('hidden');
        banner.textContent = `Agent has been silent for ${agent.silence} — exceeds stuck threshold (${threshold}m). Last activity: checkpoint ${agent.silence} ago.`;
      } else {
        banner.classList.add('hidden');
      }
    }

    // ─── Init ────────────────────────────────────────────────────────────────

    function init() {
      // Build sparklines
      updateAllIndicators('sparkline');

      // Render default selection
      const defaultRow = document.querySelector('[data-agent="sonnet-8"]');
      if (defaultRow) selectAgent('sonnet-8', defaultRow);

      // Apply default detail view
      applyDetailView('unified');
    }

    // ─── Control event handlers ──────────────────────────────────────────────

    document.addEventListener('control-change', (e) => {
      const { id, value } = e.detail;

      if (id === 'stuck-threshold') {
        document.getElementById('threshold-display').textContent = value + ' min';
        // Re-check stuck banner for current agent
        const agent = AGENTS[selectedAgentId];
        if (agent) updateStuckBanner(agent);
      }

      if (id === 'detail-view') {
        applyDetailView(value);
      }

      if (id === 'activity-indicator') {
        updateAllIndicators(value);
      }
    });

    document.addEventListener('controls-ready', () => {
      const root = document.documentElement;

      const threshold = root.style.getPropertyValue('--stuck-threshold').trim();
      if (threshold) {
        document.getElementById('threshold-display').textContent = threshold + ' min';
        const agent = AGENTS[selectedAgentId];
        if (agent) updateStuckBanner(agent);
      }

      const detailView = root.style.getPropertyValue('--detail-view').trim();
      if (detailView) applyDetailView(detailView);

      const actInd = root.style.getPropertyValue('--activity-indicator').trim();
      if (actInd) updateAllIndicators(actInd);
    });

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

  </template>
  <template id="tpl-e2">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script type="application/json" id="variation-meta">
  {
    "id": "E2",
    "family": "E",
    "familyName": "Explorer Split",
    "name": "Data List + Agent Profile",
    "layoutType": "Wide List + Profile Detail Panel",
    "aesthetic": "Professional Dark",
    "description": "Persistent two-panel layout with a wide left list and a structured agent profile detail panel. The list provides C2-level density; the profile gives a readable narrative when you need it.",
    "controls": [
      {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["5 min", "10 min", "15 min", "30 min"],
        "cssValues": { "5 min": "5", "10 min": "10", "15 min": "15", "30 min": "30" },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
      },
      {
        "id": "list-width",
        "label": "List Width",
        "type": "range",
        "min": 340, "max": 520, "step": 20,
        "options": null,
        "value": 400,
        "defaultValue": 400,
        "unit": "px",
        "cssVar": "--list-width"
      },
      {
        "id": "profile-layout",
        "label": "Profile Layout",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["narrative", "sections", "dashboard"],
        "cssValues": { "narrative": "narrative", "sections": "sections", "dashboard": "dashboard" },
        "value": "sections",
        "defaultValue": "sections",
        "unit": "",
        "cssVar": "--profile-layout",
        "event": true
      },
      {
        "id": "sparkline-width",
        "label": "List Sparkline Width",
        "type": "range",
        "min": 60, "max": 160, "step": 20,
        "options": null,
        "value": 100,
        "defaultValue": 100,
        "unit": "px",
        "cssVar": "--sparkline-width"
      },
      {
        "id": "show-progress",
        "label": "Show Progress",
        "type": "toggle",
        "min": null, "max": null, "step": null,
        "options": null,
        "cssValues": { "true": "flex", "false": "none" },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--progress-display"
      },
      {
        "id": "stats-panel",
        "label": "Stats Panel",
        "type": "toggle",
        "min": null, "max": null, "step": null,
        "options": null,
        "cssValues": { "true": "grid", "false": "none" },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--stats-display"
      }
    ]
  }
  </script>
  <style>
    :root {
      --bg: #0f1117;
      --panel: #1a1d27;
      --border: #2a2d3a;
      --text: #e2e4e9;
      --text-dim: #8b8fa3;
      --accent: #3b82f6;
      --stuck: #ef4444;
      --active: #3b82f6;
      --idle: #6b7280;
      --healthy: #22c55e;
      --font-sans: 'Inter', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --radius: 8px;
      --list-width: 400px;
      --sparkline-width: 100px;
      --progress-display: flex;
      --stats-display: grid;
      --profile-layout: sections;
      --stuck-threshold: 5;
    }
    :root * {
      transition: color 0.3s ease, background-color 0.3s ease,
                  border-color 0.3s ease, padding 0.3s ease,
                  gap 0.3s ease, font-size 0.3s ease,
                  border-radius 0.3s ease, box-shadow 0.3s ease,
                  max-width 0.3s ease, width 0.3s ease;
    }
    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
    }
    .mono { font-family: var(--font-mono); }

    /* Scrollbars */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

    /* Agent list */
    #agent-list { width: var(--list-width); flex-shrink: 0; }

    /* Sparkline container */
    .sparkline-wrap { width: var(--sparkline-width); flex-shrink: 0; }

    /* Progress bar row */
    .progress-row { display: var(--progress-display); }

    /* Stats section */
    #stats-section { display: var(--stats-display); }

    /* Agent strip */
    .agent-strip {
      border-left: 2px solid transparent;
      cursor: pointer;
    }
    .agent-strip:hover {
      background: color-mix(in srgb, var(--accent) 6%, var(--panel));
    }
    .agent-strip.selected {
      border-left-color: var(--accent);
      background: color-mix(in srgb, var(--accent) 10%, var(--panel));
    }
    .agent-strip.stuck-strip { border-left-color: var(--stuck); }
    .agent-strip.stuck-strip.selected { border-left-color: var(--stuck); background: color-mix(in srgb, var(--stuck) 10%, var(--panel)); }

    /* Status dot */
    .dot-stuck { background: var(--stuck); box-shadow: 0 0 6px var(--stuck); }
    .dot-active { background: var(--active); box-shadow: 0 0 6px var(--active); }
    .dot-idle { background: var(--idle); }

    /* Profile layout modes */
    .profile-narrative .profile-section {
      border: none;
      background: transparent;
      padding: 0;
      margin-bottom: 1.5rem;
    }
    .profile-sections .profile-section {
      border: 1px solid var(--border);
      background: var(--panel);
      border-radius: var(--radius);
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .profile-dashboard .profile-section {
      border: 1px solid var(--border);
      background: var(--panel);
      border-radius: var(--radius);
      padding: 0.75rem;
      margin-bottom: 0.5rem;
    }
    .profile-dashboard #profile-timeline .timeline-item {
      padding: 0.25rem 0;
      font-size: 0.75rem;
    }
    .profile-dashboard #profile-timeline .timeline-item .tl-desc {
      font-size: 0.7rem;
    }

    /* Timeline */
    .timeline-line {
      width: 1px;
      background: var(--border);
      flex-shrink: 0;
    }

    /* Fleet bar entrance */
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fleet-bar { animation: slideDown 0.4s ease forwards; }
    .agent-strip { animation: fadeIn 0.35s ease forwards; opacity: 0; }
    .agent-strip:nth-child(1) { animation-delay: 0.05s; }
    .agent-strip:nth-child(2) { animation-delay: 0.10s; }
    .agent-strip:nth-child(3) { animation-delay: 0.15s; }
    .agent-strip:nth-child(4) { animation-delay: 0.20s; }
    .agent-strip:nth-child(5) { animation-delay: 0.25s; }
    .agent-strip:nth-child(6) { animation-delay: 0.30s; }
    .agent-strip:nth-child(7) { animation-delay: 0.35s; }
    .agent-strip:nth-child(8) { animation-delay: 0.40s; }
    #profile-panel { animation: fadeIn 0.45s ease 0.2s forwards; opacity: 0; }

    /* Silence timer colors */
    .silence-stuck { color: var(--stuck); }
    .silence-warn { color: #f59e0b; }
    .silence-ok { color: var(--healthy); }
    .silence-idle { color: var(--idle); }

    /* Profile status bar */
    .status-bar-stuck { background: var(--stuck); opacity: 0.7; }
    .status-bar-active { background: var(--active); opacity: 0.7; }
    .status-bar-idle { background: var(--idle); opacity: 0.5; }

    /* Hidden profiles */
    .agent-profile { display: none; }
    .agent-profile.active { display: block; }
  </style>
</head>
<body>
<div id="root" class="flex flex-col h-screen overflow-hidden" style="background: var(--bg);">

  <!-- Fleet Summary Bar -->
  <div class="fleet-bar flex items-center gap-6 px-5 py-2.5 border-b" style="border-color: var(--border); background: var(--panel); flex-shrink: 0;">
    <span class="text-xs font-semibold uppercase tracking-widest" style="color: var(--text-dim);">Fleet</span>
    <div class="flex items-center gap-5">
      <div class="flex items-center gap-1.5">
        <span class="inline-block w-2 h-2 rounded-full dot-active"></span>
        <span class="text-sm font-medium" style="color: var(--text);">4 active</span>
      </div>
      <div class="flex items-center gap-1.5">
        <span class="inline-block w-2 h-2 rounded-full dot-stuck"></span>
        <span class="text-sm font-medium" style="color: var(--stuck);">2 stuck</span>
      </div>
      <div class="flex items-center gap-1.5">
        <span class="inline-block w-2 h-2 rounded-full dot-idle"></span>
        <span class="text-sm font-medium" style="color: var(--text-dim);">2 idle</span>
      </div>
    </div>
    <div class="flex-1"></div>
    <div class="flex items-center gap-2">
      <span id="stuck-label" class="text-xs px-2 py-0.5 rounded-full" style="background: color-mix(in srgb, var(--stuck) 15%, transparent); color: var(--stuck);">Stuck &gt; <span id="threshold-display">5</span>m silence</span>
    </div>
  </div>

  <!-- Main Split -->
  <div class="flex flex-1 overflow-hidden">

    <!-- LEFT: Agent List -->
    <div id="agent-list" class="flex flex-col border-r overflow-hidden" style="border-color: var(--border); background: var(--panel);">
      <div class="px-4 py-2 border-b flex items-center" style="border-color: var(--border); flex-shrink: 0;">
        <span class="text-xs font-semibold uppercase tracking-widest" style="color: var(--text-dim);">Agents</span>
        <span class="ml-auto text-xs mono" style="color: var(--text-dim);">8 agents</span>
      </div>
      <div class="flex-1 overflow-y-auto" id="agent-list-scroll">

        <!-- claude-opus-7 | STUCK -->
        <div class="agent-strip stuck-strip selected px-3 py-2.5" data-agent="claude-opus-7" onclick="selectAgent('claude-opus-7', this)">
          <div class="flex items-center gap-2.5">
            <span class="w-2 h-2 rounded-full flex-shrink-0 dot-stuck"></span>
            <span class="mono text-xs font-semibold flex-1 truncate" style="color: var(--stuck);">claude-opus-7</span>
            <span class="text-xs mono silence-stuck font-medium flex-shrink-0">12m ago</span>
          </div>
          <div class="mt-1 pl-4">
            <div class="text-xs truncate mb-1.5" style="color: var(--text);">Implement auth middleware</div>
            <div class="progress-row items-center gap-2 mb-1.5">
              <div class="flex-1 h-1 rounded-full" style="background: var(--border);">
                <div class="h-1 rounded-full" style="background: var(--stuck); width: 35%;"></div>
              </div>
              <span class="mono text-xs flex-shrink-0" style="color: var(--text-dim);">35%</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs px-1.5 py-0.5 rounded" style="background: color-mix(in srgb, var(--text-dim) 12%, transparent); color: var(--text-dim);">api-v2</span>
              <div class="sparkline-wrap flex-shrink-0 ml-auto">
                <svg width="100%" height="22" viewBox="0 0 100 22" preserveAspectRatio="none">
                  <!-- Events at 30m, 25m, 22m ago, then gap -->
                  <rect x="0" y="6" width="8" height="10" rx="1" fill="#ef4444" opacity="0.5"/>
                  <rect x="29" y="6" width="8" height="10" rx="1" fill="#ef4444" opacity="0.6"/>
                  <rect x="44" y="6" width="8" height="10" rx="1" fill="#ef4444" opacity="0.7"/>
                  <!-- silence gap -->
                  <rect x="52" y="9" width="48" height="4" rx="1" fill="#2a2d3a"/>
                  <line x1="52" y1="11" x2="100" y2="11" stroke="#ef4444" stroke-width="0.5" stroke-dasharray="2,3" opacity="0.4"/>
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- claude-sonnet-8 | STUCK -->
        <div class="agent-strip stuck-strip px-3 py-2.5" data-agent="claude-sonnet-8" onclick="selectAgent('claude-sonnet-8', this)">
          <div class="flex items-center gap-2.5">
            <span class="w-2 h-2 rounded-full flex-shrink-0 dot-stuck"></span>
            <span class="mono text-xs font-semibold flex-1 truncate" style="color: var(--stuck);">claude-sonnet-8</span>
            <span class="text-xs mono silence-stuck font-medium flex-shrink-0">22m ago</span>
          </div>
          <div class="mt-1 pl-4">
            <div class="text-xs truncate mb-1.5" style="color: var(--text);">Fix pagination bug</div>
            <div class="progress-row items-center gap-2 mb-1.5">
              <div class="flex-1 h-1 rounded-full" style="background: var(--border);">
                <div class="h-1 rounded-full" style="background: var(--stuck); width: 20%;"></div>
              </div>
              <span class="mono text-xs flex-shrink-0" style="color: var(--text-dim);">20%</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs px-1.5 py-0.5 rounded" style="background: color-mix(in srgb, var(--text-dim) 12%, transparent); color: var(--text-dim);">web</span>
              <div class="sparkline-wrap flex-shrink-0 ml-auto">
                <svg width="100%" height="22" viewBox="0 0 100 22" preserveAspectRatio="none">
                  <rect x="0" y="6" width="8" height="10" rx="1" fill="#ef4444" opacity="0.5"/>
                  <rect x="16" y="6" width="8" height="10" rx="1" fill="#ef4444" opacity="0.6"/>
                  <rect x="26" y="6" width="8" height="10" rx="1" fill="#ef4444" opacity="0.7"/>
                  <rect x="34" y="9" width="66" height="4" rx="1" fill="#2a2d3a"/>
                  <line x1="34" y1="11" x2="100" y2="11" stroke="#ef4444" stroke-width="0.5" stroke-dasharray="2,3" opacity="0.4"/>
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- gemini-pro-1 | ACTIVE -->
        <div class="agent-strip px-3 py-2.5" data-agent="gemini-pro-1" onclick="selectAgent('gemini-pro-1', this)">
          <div class="flex items-center gap-2.5">
            <span class="w-2 h-2 rounded-full flex-shrink-0 dot-active" style="animation: pulse 2s infinite;"></span>
            <span class="mono text-xs font-semibold flex-1 truncate" style="color: var(--text);">gemini-pro-1</span>
            <span class="text-xs mono silence-ok font-medium flex-shrink-0">30s ago</span>
          </div>
          <div class="mt-1 pl-4">
            <div class="text-xs truncate mb-1.5" style="color: var(--text);">Refactor database queries</div>
            <div class="progress-row items-center gap-2 mb-1.5">
              <div class="flex-1 h-1 rounded-full" style="background: var(--border);">
                <div class="h-1 rounded-full" style="background: var(--active); width: 75%;"></div>
              </div>
              <span class="mono text-xs flex-shrink-0" style="color: var(--text-dim);">75%</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs px-1.5 py-0.5 rounded" style="background: color-mix(in srgb, var(--text-dim) 12%, transparent); color: var(--text-dim);">core</span>
              <div class="sparkline-wrap flex-shrink-0 ml-auto">
                <svg width="100%" height="22" viewBox="0 0 100 22" preserveAspectRatio="none">
                  <rect x="0" y="8" width="6" height="8" rx="1" fill="#3b82f6" opacity="0.5"/>
                  <rect x="33" y="6" width="6" height="10" rx="1" fill="#3b82f6" opacity="0.6"/>
                  <rect x="53" y="5" width="6" height="12" rx="1" fill="#3b82f6" opacity="0.7"/>
                  <rect x="73" y="4" width="6" height="14" rx="1" fill="#3b82f6" opacity="0.8"/>
                  <rect x="86" y="3" width="6" height="16" rx="1" fill="#3b82f6" opacity="0.9"/>
                  <rect x="96" y="2" width="6" height="18" rx="1" fill="#3b82f6" opacity="1"/>
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- claude-sonnet-3 | ACTIVE -->
        <div class="agent-strip px-3 py-2.5" data-agent="claude-sonnet-3" onclick="selectAgent('claude-sonnet-3', this)">
          <div class="flex items-center gap-2.5">
            <span class="w-2 h-2 rounded-full flex-shrink-0 dot-active"></span>
            <span class="mono text-xs font-semibold flex-1 truncate" style="color: var(--text);">claude-sonnet-3</span>
            <span class="text-xs mono silence-ok font-medium flex-shrink-0">1m ago</span>
          </div>
          <div class="mt-1 pl-4">
            <div class="text-xs truncate mb-1.5" style="color: var(--text);">Add search API endpoint</div>
            <div class="progress-row items-center gap-2 mb-1.5">
              <div class="flex-1 h-1 rounded-full" style="background: var(--border);">
                <div class="h-1 rounded-full" style="background: var(--active); width: 60%;"></div>
              </div>
              <span class="mono text-xs flex-shrink-0" style="color: var(--text-dim);">60%</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs px-1.5 py-0.5 rounded" style="background: color-mix(in srgb, var(--text-dim) 12%, transparent); color: var(--text-dim);">api-v2</span>
              <div class="sparkline-wrap flex-shrink-0 ml-auto">
                <svg width="100%" height="22" viewBox="0 0 100 22" preserveAspectRatio="none">
                  <rect x="0" y="8" width="6" height="8" rx="1" fill="#3b82f6" opacity="0.5"/>
                  <rect x="16" y="7" width="6" height="10" rx="1" fill="#3b82f6" opacity="0.6"/>
                  <rect x="33" y="6" width="6" height="11" rx="1" fill="#3b82f6" opacity="0.7"/>
                  <rect x="58" y="5" width="6" height="13" rx="1" fill="#3b82f6" opacity="0.8"/>
                  <rect x="75" y="4" width="6" height="14" rx="1" fill="#3b82f6" opacity="0.9"/>
                  <rect x="91" y="3" width="6" height="16" rx="1" fill="#3b82f6" opacity="1"/>
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- claude-haiku-2 | ACTIVE -->
        <div class="agent-strip px-3 py-2.5" data-agent="claude-haiku-2" onclick="selectAgent('claude-haiku-2', this)">
          <div class="flex items-center gap-2.5">
            <span class="w-2 h-2 rounded-full flex-shrink-0 dot-active"></span>
            <span class="mono text-xs font-semibold flex-1 truncate" style="color: var(--text);">claude-haiku-2</span>
            <span class="text-xs mono silence-ok font-medium flex-shrink-0">3m ago</span>
          </div>
          <div class="mt-1 pl-4">
            <div class="text-xs truncate mb-1.5" style="color: var(--text);">Write unit tests</div>
            <div class="progress-row items-center gap-2 mb-1.5">
              <div class="flex-1 h-1 rounded-full" style="background: var(--border);">
                <div class="h-1 rounded-full" style="background: var(--active); width: 40%;"></div>
              </div>
              <span class="mono text-xs flex-shrink-0" style="color: var(--text-dim);">40%</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs px-1.5 py-0.5 rounded" style="background: color-mix(in srgb, var(--text-dim) 12%, transparent); color: var(--text-dim);">core</span>
              <div class="sparkline-wrap flex-shrink-0 ml-auto">
                <svg width="100%" height="22" viewBox="0 0 100 22" preserveAspectRatio="none">
                  <rect x="0" y="8" width="7" height="8" rx="1" fill="#3b82f6" opacity="0.5"/>
                  <rect x="25" y="7" width="7" height="10" rx="1" fill="#3b82f6" opacity="0.7"/>
                  <rect x="50" y="5" width="7" height="12" rx="1" fill="#3b82f6" opacity="0.85"/>
                  <rect x="75" y="4" width="7" height="14" rx="1" fill="#3b82f6" opacity="1"/>
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- gpt-4o-agent | ACTIVE -->
        <div class="agent-strip px-3 py-2.5" data-agent="gpt-4o-agent" onclick="selectAgent('gpt-4o-agent', this)">
          <div class="flex items-center gap-2.5">
            <span class="w-2 h-2 rounded-full flex-shrink-0 dot-active"></span>
            <span class="mono text-xs font-semibold flex-1 truncate" style="color: var(--text);">gpt-4o-agent</span>
            <span class="text-xs mono silence-ok font-medium flex-shrink-0">2m ago</span>
          </div>
          <div class="mt-1 pl-4">
            <div class="text-xs truncate mb-1.5" style="color: var(--text);">Update API docs</div>
            <div class="progress-row items-center gap-2 mb-1.5">
              <div class="flex-1 h-1 rounded-full" style="background: var(--border);">
                <div class="h-1 rounded-full" style="background: var(--active); width: 25%;"></div>
              </div>
              <span class="mono text-xs flex-shrink-0" style="color: var(--text-dim);">25%</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs px-1.5 py-0.5 rounded" style="background: color-mix(in srgb, var(--text-dim) 12%, transparent); color: var(--text-dim);">docs</span>
              <div class="sparkline-wrap flex-shrink-0 ml-auto">
                <svg width="100%" height="22" viewBox="0 0 100 22" preserveAspectRatio="none">
                  <rect x="0" y="8" width="7" height="8" rx="1" fill="#3b82f6" opacity="0.5"/>
                  <rect x="20" y="7" width="7" height="10" rx="1" fill="#3b82f6" opacity="0.75"/>
                  <rect x="60" y="5" width="7" height="14" rx="1" fill="#3b82f6" opacity="1"/>
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- claude-opus-5 | IDLE -->
        <div class="agent-strip px-3 py-2.5" data-agent="claude-opus-5" onclick="selectAgent('claude-opus-5', this)">
          <div class="flex items-center gap-2.5">
            <span class="w-2 h-2 rounded-full flex-shrink-0 dot-idle"></span>
            <span class="mono text-xs font-semibold flex-1 truncate" style="color: var(--text-dim);">claude-opus-5</span>
            <span class="text-xs mono silence-idle font-medium flex-shrink-0">idle 8m</span>
          </div>
          <div class="mt-1 pl-4">
            <div class="text-xs truncate mb-1.5 italic" style="color: var(--text-dim);">Last: Set up CI pipeline</div>
            <div class="progress-row items-center gap-2 mb-1.5" style="display: none !important;"><!-- no progress for idle --></div>
            <div class="flex items-center gap-2">
              <span class="text-xs px-1.5 py-0.5 rounded" style="background: color-mix(in srgb, var(--text-dim) 8%, transparent); color: var(--idle);">idle</span>
              <div class="sparkline-wrap flex-shrink-0 ml-auto">
                <svg width="100%" height="22" viewBox="0 0 100 22" preserveAspectRatio="none">
                  <rect x="0" y="8" width="7" height="8" rx="1" fill="#6b7280" opacity="0.5"/>
                  <rect x="20" y="7" width="7" height="10" rx="1" fill="#6b7280" opacity="0.65"/>
                  <rect x="46" y="6" width="7" height="12" rx="1" fill="#6b7280" opacity="0.8"/>
                  <!-- ended -->
                  <line x1="53" y1="11" x2="100" y2="11" stroke="#2a2d3a" stroke-width="1.5"/>
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- claude-haiku-9 | IDLE -->
        <div class="agent-strip px-3 py-2.5" data-agent="claude-haiku-9" onclick="selectAgent('claude-haiku-9', this)">
          <div class="flex items-center gap-2.5">
            <span class="w-2 h-2 rounded-full flex-shrink-0 dot-idle"></span>
            <span class="mono text-xs font-semibold flex-1 truncate" style="color: var(--text-dim);">claude-haiku-9</span>
            <span class="text-xs mono silence-idle font-medium flex-shrink-0">idle 3m</span>
          </div>
          <div class="mt-1 pl-4">
            <div class="text-xs truncate mb-1.5 italic" style="color: var(--text-dim);">Last: Add input validation</div>
            <div class="progress-row items-center gap-2 mb-1.5" style="display: none !important;"><!-- no progress for idle --></div>
            <div class="flex items-center gap-2">
              <span class="text-xs px-1.5 py-0.5 rounded" style="background: color-mix(in srgb, var(--text-dim) 8%, transparent); color: var(--idle);">idle</span>
              <div class="sparkline-wrap flex-shrink-0 ml-auto">
                <svg width="100%" height="22" viewBox="0 0 100 22" preserveAspectRatio="none">
                  <rect x="0" y="8" width="7" height="8" rx="1" fill="#6b7280" opacity="0.5"/>
                  <rect x="37" y="7" width="7" height="10" rx="1" fill="#6b7280" opacity="0.7"/>
                  <rect x="62" y="5" width="7" height="12" rx="1" fill="#6b7280" opacity="0.85"/>
                  <line x1="69" y1="11" x2="100" y2="11" stroke="#2a2d3a" stroke-width="1.5"/>
                </svg>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- RIGHT: Agent Profile Panel -->
    <div id="profile-panel" class="flex-1 overflow-y-auto" style="background: var(--bg);">

      <!-- Profile: claude-opus-7 -->
      <div id="profile-claude-opus-7" class="agent-profile active p-5">

        <!-- Status Header -->
        <div class="mb-4">
          <div class="flex items-center gap-3 mb-2">
            <span class="mono text-base font-semibold" style="color: var(--text);">claude-opus-7</span>
            <span class="px-2.5 py-0.5 rounded-full text-xs font-semibold" style="background: color-mix(in srgb, var(--stuck) 15%, transparent); color: var(--stuck);">STUCK</span>
            <span class="text-xs" style="color: var(--text-dim);">12m silence</span>
          </div>
          <div class="w-full h-0.5 rounded-full status-bar-stuck mb-1"></div>
          <p class="text-xs" style="color: var(--text-dim);">Agent has been silent for 12 minutes. Last activity was a checkpoint event.</p>
        </div>

        <div id="profile-opus-7-content" class="profile-sections">

          <!-- Current Task Section -->
          <div class="profile-section">
            <div class="text-xs font-semibold uppercase tracking-widest mb-3" style="color: var(--text-dim);">Current Task</div>
            <div class="flex items-start justify-between gap-3 mb-2">
              <div>
                <div class="text-sm font-semibold mb-0.5" style="color: var(--text);">Implement auth middleware</div>
                <div class="flex items-center gap-2 text-xs" style="color: var(--text-dim);">
                  <span class="mono">api-v2</span>
                  <span>·</span>
                  <span>Claimed 18m ago</span>
                </div>
              </div>
              <span class="text-xs px-2 py-0.5 rounded-full flex-shrink-0" style="background: color-mix(in srgb, var(--stuck) 15%, transparent); color: var(--stuck);">35%</span>
            </div>
            <div class="mb-2">
              <div class="flex items-center justify-between text-xs mb-1" style="color: var(--text-dim);">
                <span>Progress</span>
                <span class="mono">35 / 100</span>
              </div>
              <div class="w-full h-1.5 rounded-full" style="background: var(--border);">
                <div class="h-1.5 rounded-full" style="background: var(--stuck); width: 35%; transition: width 0.5s ease;"></div>
              </div>
            </div>
            <p class="text-xs leading-relaxed" style="color: var(--text-dim);">Agent is implementing JWT-based authentication middleware for the api-v2 service. Currently analyzing library options but has gone silent — may need attention.</p>
          </div>

          <!-- Session Timeline Section -->
          <div class="profile-section">
            <div class="text-xs font-semibold uppercase tracking-widest mb-3" style="color: var(--text-dim);">Session Timeline</div>
            <div class="flex flex-col gap-0" id="profile-timeline">

              <div class="timeline-item flex gap-3 pb-3">
                <div class="flex flex-col items-center flex-shrink-0">
                  <div class="w-2 h-2 rounded-full mt-0.5" style="background: var(--stuck);"></div>
                  <div class="timeline-line flex-1 mt-1"></div>
                </div>
                <div class="flex-1 pb-1">
                  <div class="flex items-center gap-2 mb-0.5">
                    <span class="text-xs font-medium" style="color: var(--text);">Checkpoint</span>
                    <span class="mono text-xs" style="color: var(--text-dim);">12m ago</span>
                    <span class="ml-auto text-xs px-1.5 rounded" style="background: color-mix(in srgb, var(--stuck) 15%, transparent); color: var(--stuck);">silent since</span>
                  </div>
                  <div class="tl-desc text-xs" style="color: var(--text-dim);">Analyzing JWT library options</div>
                </div>
              </div>

              <div class="timeline-item flex gap-3 pb-3">
                <div class="flex flex-col items-center flex-shrink-0">
                  <div class="w-2 h-2 rounded-full mt-0.5" style="background: var(--text-dim);"></div>
                  <div class="timeline-line flex-1 mt-1"></div>
                </div>
                <div class="flex-1 pb-1">
                  <div class="flex items-center gap-2 mb-0.5">
                    <span class="text-xs font-medium" style="color: var(--text);">Checkpoint</span>
                    <span class="mono text-xs" style="color: var(--text-dim);">15m ago</span>
                  </div>
                  <div class="tl-desc text-xs" style="color: var(--text-dim);">Reading existing auth code</div>
                </div>
              </div>

              <div class="timeline-item flex gap-3 pb-3">
                <div class="flex flex-col items-center flex-shrink-0">
                  <div class="w-2 h-2 rounded-full mt-0.5" style="background: var(--active);"></div>
                  <div class="timeline-line flex-1 mt-1"></div>
                </div>
                <div class="flex-1 pb-1">
                  <div class="flex items-center gap-2 mb-0.5">
                    <span class="text-xs font-medium" style="color: var(--text);">Task Claimed</span>
                    <span class="mono text-xs" style="color: var(--text-dim);">18m ago</span>
                  </div>
                  <div class="tl-desc text-xs" style="color: var(--text-dim);">Implement auth middleware</div>
                </div>
              </div>

              <!-- Divider between tasks -->
              <div class="flex items-center gap-2 my-1 pb-2">
                <div class="flex-1 h-px" style="background: var(--border);"></div>
                <span class="text-xs" style="color: var(--text-dim);">previous task</span>
                <div class="flex-1 h-px" style="background: var(--border);"></div>
              </div>

              <div class="timeline-item flex gap-3 pb-3">
                <div class="flex flex-col items-center flex-shrink-0">
                  <div class="w-2 h-2 rounded-full mt-0.5" style="background: var(--healthy);"></div>
                  <div class="timeline-line flex-1 mt-1"></div>
                </div>
                <div class="flex-1 pb-1">
                  <div class="flex items-center gap-2 mb-0.5">
                    <span class="text-xs font-medium" style="color: var(--text);">Completed</span>
                    <span class="mono text-xs" style="color: var(--text-dim);">20m ago</span>
                  </div>
                  <div class="tl-desc text-xs" style="color: var(--healthy);">Set up project scaffolding</div>
                </div>
              </div>

              <div class="timeline-item flex gap-3">
                <div class="flex flex-col items-center flex-shrink-0">
                  <div class="w-2 h-2 rounded-full mt-0.5" style="background: var(--text-dim);"></div>
                </div>
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-0.5">
                    <span class="text-xs font-medium" style="color: var(--text);">Checkpoint</span>
                    <span class="mono text-xs" style="color: var(--text-dim);">25m ago</span>
                  </div>
                  <div class="tl-desc text-xs" style="color: var(--text-dim);">Generated folder structure</div>
                </div>
              </div>

            </div>
          </div>

          <!-- Session Stats Section -->
          <div class="profile-section">
            <div class="text-xs font-semibold uppercase tracking-widest mb-3" style="color: var(--text-dim);">Session Stats</div>
            <div id="stats-section" style="grid-template-columns: 1fr 1fr; gap: 0.75rem;">
              <div class="p-3 rounded-lg" style="background: color-mix(in srgb, var(--text-dim) 8%, transparent);">
                <div class="mono text-lg font-semibold" style="color: var(--text);">5</div>
                <div class="text-xs" style="color: var(--text-dim);">Total Events</div>
              </div>
              <div class="p-3 rounded-lg" style="background: color-mix(in srgb, var(--text-dim) 8%, transparent);">
                <div class="mono text-lg font-semibold" style="color: var(--text);">25m</div>
                <div class="text-xs" style="color: var(--text-dim);">Session Duration</div>
              </div>
              <div class="p-3 rounded-lg" style="background: color-mix(in srgb, var(--text-dim) 8%, transparent);">
                <div class="mono text-lg font-semibold" style="color: var(--text);">3.3m</div>
                <div class="text-xs" style="color: var(--text-dim);">Avg Interval</div>
              </div>
              <div class="p-3 rounded-lg" style="background: color-mix(in srgb, var(--text-dim) 8%, transparent);">
                <div class="mono text-lg font-semibold" style="color: var(--healthy);">1</div>
                <div class="text-xs" style="color: var(--text-dim);">Tasks Completed</div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Profile: claude-sonnet-3 -->
      <div id="profile-claude-sonnet-3" class="agent-profile p-5">

        <div class="mb-4">
          <div class="flex items-center gap-3 mb-2">
            <span class="mono text-base font-semibold" style="color: var(--text);">claude-sonnet-3</span>
            <span class="px-2.5 py-0.5 rounded-full text-xs font-semibold" style="background: color-mix(in srgb, var(--active) 15%, transparent); color: var(--active);">ACTIVE</span>
            <span class="text-xs" style="color: var(--text-dim);">last event 1m ago</span>
          </div>
          <div class="w-full h-0.5 rounded-full status-bar-active mb-1"></div>
          <p class="text-xs" style="color: var(--text-dim);">Agent is actively working. Last checkpoint recorded 1 minute ago.</p>
        </div>

        <div id="profile-sonnet-3-content" class="profile-sections">

          <div class="profile-section">
            <div class="text-xs font-semibold uppercase tracking-widest mb-3" style="color: var(--text-dim);">Current Task</div>
            <div class="flex items-start justify-between gap-3 mb-2">
              <div>
                <div class="text-sm font-semibold mb-0.5" style="color: var(--text);">Add search API endpoint</div>
                <div class="flex items-center gap-2 text-xs" style="color: var(--text-dim);">
                  <span class="mono">api-v2</span>
                  <span>·</span>
                  <span>Claimed 8m ago</span>
                </div>
              </div>
              <span class="text-xs px-2 py-0.5 rounded-full flex-shrink-0" style="background: color-mix(in srgb, var(--active) 15%, transparent); color: var(--active);">60%</span>
            </div>
            <div class="mb-2">
              <div class="flex items-center justify-between text-xs mb-1" style="color: var(--text-dim);">
                <span>Progress</span>
                <span class="mono">60 / 100</span>
              </div>
              <div class="w-full h-1.5 rounded-full" style="background: var(--border);">
                <div class="h-1.5 rounded-full" style="background: var(--active); width: 60%; transition: width 0.5s ease;"></div>
              </div>
            </div>
            <p class="text-xs leading-relaxed" style="color: var(--text-dim);">Agent is implementing full-text search for the API, currently working on the search route handler with FTS5 integration.</p>
          </div>

          <div class="profile-section">
            <div class="text-xs font-semibold uppercase tracking-widest mb-3" style="color: var(--text-dim);">Session Timeline</div>
            <div class="flex flex-col gap-0" id="profile-timeline">

              <div class="timeline-item flex gap-3 pb-3">
                <div class="flex flex-col items-center flex-shrink-0">
                  <div class="w-2 h-2 rounded-full mt-0.5" style="background: var(--active);"></div>
                  <div class="timeline-line flex-1 mt-1"></div>
                </div>
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-0.5">
                    <span class="text-xs font-medium" style="color: var(--text);">Checkpoint</span>
                    <span class="mono text-xs" style="color: var(--text-dim);">1m ago</span>
                    <span class="ml-auto text-xs px-1.5 rounded" style="background: color-mix(in srgb, var(--active) 15%, transparent); color: var(--active);">latest</span>
                  </div>
                  <div class="tl-desc text-xs" style="color: var(--text-dim);">Implementing full-text search</div>
                </div>
              </div>

              <div class="timeline-item flex gap-3 pb-3">
                <div class="flex flex-col items-center flex-shrink-0">
                  <div class="w-2 h-2 rounded-full mt-0.5" style="background: var(--text-dim);"></div>
                  <div class="timeline-line flex-1 mt-1"></div>
                </div>
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-0.5">
                    <span class="text-xs font-medium" style="color: var(--text);">Checkpoint</span>
                    <span class="mono text-xs" style="color: var(--text-dim);">3m ago</span>
                  </div>
                  <div class="tl-desc text-xs" style="color: var(--text-dim);">Added search route handler</div>
                </div>
              </div>

              <div class="timeline-item flex gap-3 pb-3">
                <div class="flex flex-col items-center flex-shrink-0">
                  <div class="w-2 h-2 rounded-full mt-0.5" style="background: var(--text-dim);"></div>
                  <div class="timeline-line flex-1 mt-1"></div>
                </div>
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-0.5">
                    <span class="text-xs font-medium" style="color: var(--text);">Checkpoint</span>
                    <span class="mono text-xs" style="color: var(--text-dim);">5m ago</span>
                  </div>
                  <div class="tl-desc text-xs" style="color: var(--text-dim);">Designing search schema</div>
                </div>
              </div>

              <div class="timeline-item flex gap-3 pb-3">
                <div class="flex flex-col items-center flex-shrink-0">
                  <div class="w-2 h-2 rounded-full mt-0.5" style="background: var(--active);"></div>
                  <div class="timeline-line flex-1 mt-1"></div>
                </div>
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-0.5">
                    <span class="text-xs font-medium" style="color: var(--text);">Task Claimed</span>
                    <span class="mono text-xs" style="color: var(--text-dim);">8m ago</span>
                  </div>
                  <div class="tl-desc text-xs" style="color: var(--text-dim);">Add search API endpoint</div>
                </div>
              </div>

              <div class="flex items-center gap-2 my-1 pb-2">
                <div class="flex-1 h-px" style="background: var(--border);"></div>
                <span class="text-xs" style="color: var(--text-dim);">previous task</span>
                <div class="flex-1 h-px" style="background: var(--border);"></div>
              </div>

              <div class="timeline-item flex gap-3 pb-3">
                <div class="flex flex-col items-center flex-shrink-0">
                  <div class="w-2 h-2 rounded-full mt-0.5" style="background: var(--healthy);"></div>
                  <div class="timeline-line flex-1 mt-1"></div>
                </div>
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-0.5">
                    <span class="text-xs font-medium" style="color: var(--text);">Completed</span>
                    <span class="mono text-xs" style="color: var(--text-dim);">10m ago</span>
                  </div>
                  <div class="tl-desc text-xs" style="color: var(--healthy);">Design search schema</div>
                </div>
              </div>

              <div class="timeline-item flex gap-3">
                <div class="flex flex-col items-center flex-shrink-0">
                  <div class="w-2 h-2 rounded-full mt-0.5" style="background: var(--text-dim);"></div>
                </div>
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-0.5">
                    <span class="text-xs font-medium" style="color: var(--text);">Checkpoint</span>
                    <span class="mono text-xs" style="color: var(--text-dim);">12m ago</span>
                  </div>
                  <div class="tl-desc text-xs" style="color: var(--text-dim);">Finalized FTS5 index design</div>
                </div>
              </div>

            </div>
          </div>

          <div class="profile-section">
            <div class="text-xs font-semibold uppercase tracking-widest mb-3" style="color: var(--text-dim);">Session Stats</div>
            <div id="stats-section" style="grid-template-columns: 1fr 1fr; gap: 0.75rem;">
              <div class="p-3 rounded-lg" style="background: color-mix(in srgb, var(--text-dim) 8%, transparent);">
                <div class="mono text-lg font-semibold" style="color: var(--text);">6</div>
                <div class="text-xs" style="color: var(--text-dim);">Total Events</div>
              </div>
              <div class="p-3 rounded-lg" style="background: color-mix(in srgb, var(--text-dim) 8%, transparent);">
                <div class="mono text-lg font-semibold" style="color: var(--text);">12m</div>
                <div class="text-xs" style="color: var(--text-dim);">Session Duration</div>
              </div>
              <div class="p-3 rounded-lg" style="background: color-mix(in srgb, var(--text-dim) 8%, transparent);">
                <div class="mono text-lg font-semibold" style="color: var(--text);">2.2m</div>
                <div class="text-xs" style="color: var(--text-dim);">Avg Interval</div>
              </div>
              <div class="p-3 rounded-lg" style="background: color-mix(in srgb, var(--text-dim) 8%, transparent);">
                <div class="mono text-lg font-semibold" style="color: var(--healthy);">1</div>
                <div class="text-xs" style="color: var(--text-dim);">Tasks Completed</div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Profile: generic fallback for other agents -->
      <div id="profile-generic" class="agent-profile p-5">
        <div class="mb-4">
          <div class="flex items-center gap-3 mb-2">
            <span class="mono text-base font-semibold" id="generic-name" style="color: var(--text);">—</span>
            <span id="generic-badge" class="px-2.5 py-0.5 rounded-full text-xs font-semibold"></span>
          </div>
          <div id="generic-status-bar" class="w-full h-0.5 rounded-full mb-1"></div>
          <p id="generic-desc" class="text-xs" style="color: var(--text-dim);"></p>
        </div>
        <div class="profile-sections">
          <div class="profile-section">
            <div class="text-xs font-semibold uppercase tracking-widest mb-2" style="color: var(--text-dim);">Current Task</div>
            <div class="text-sm" id="generic-task" style="color: var(--text);"></div>
          </div>
          <div class="profile-section">
            <div class="text-xs" style="color: var(--text-dim);">Select claude-opus-7 or claude-sonnet-3 for full timeline detail.</div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  // Agent data for generic profiles
  const agentData = {
    'claude-sonnet-8': {
      name: 'claude-sonnet-8', status: 'STUCK', silenceDesc: '22m silence',
      task: 'Fix pagination bug', project: 'web', progress: 20,
      desc: 'Agent has been silent for 22 minutes — significantly overdue for a checkpoint.'
    },
    'gemini-pro-1': {
      name: 'gemini-pro-1', status: 'ACTIVE', silenceDesc: 'last event 30s ago',
      task: 'Refactor database queries', project: 'core', progress: 75,
      desc: 'Agent is actively refactoring database queries. High progress, frequent events.'
    },
    'claude-haiku-2': {
      name: 'claude-haiku-2', status: 'ACTIVE', silenceDesc: 'last event 3m ago',
      task: 'Write unit tests', project: 'core', progress: 40,
      desc: 'Agent is writing unit tests for core package. Regular event cadence.'
    },
    'gpt-4o-agent': {
      name: 'gpt-4o-agent', status: 'ACTIVE', silenceDesc: 'last event 2m ago',
      task: 'Update API docs', project: 'docs', progress: 25,
      desc: 'Agent is updating API documentation. Recently started task.'
    },
    'claude-opus-5': {
      name: 'claude-opus-5', status: 'IDLE', silenceDesc: 'idle 8m',
      task: 'Last: Set up CI pipeline', project: 'ops', progress: null,
      desc: 'Agent completed its last task and is now idle. Available for new work.'
    },
    'claude-haiku-9': {
      name: 'claude-haiku-9', status: 'IDLE', silenceDesc: 'idle 3m',
      task: 'Last: Add input validation', project: 'api-v2', progress: null,
      desc: 'Agent recently finished its task and is now idle. Available for new work.'
    }
  };

  function getStatusColor(status) {
    if (status === 'STUCK') return 'var(--stuck)';
    if (status === 'ACTIVE') return 'var(--active)';
    return 'var(--idle)';
  }

  function getStatusBarClass(status) {
    if (status === 'STUCK') return 'status-bar-stuck';
    if (status === 'ACTIVE') return 'status-bar-active';
    return 'status-bar-idle';
  }

  function selectAgent(agentId, el) {
    // Update list selection
    document.querySelectorAll('.agent-strip').forEach(s => s.classList.remove('selected'));
    el.classList.add('selected');

    // Show correct profile
    document.querySelectorAll('.agent-profile').forEach(p => p.classList.remove('active'));

    const profileId = 'profile-' + agentId;
    const existing = document.getElementById(profileId);
    if (existing) {
      existing.classList.add('active');
    } else {
      // Generic profile
      const data = agentData[agentId];
      if (data) {
        const gn = document.getElementById('generic-name');
        const gb = document.getElementById('generic-badge');
        const gsb = document.getElementById('generic-status-bar');
        const gd = document.getElementById('generic-desc');
        const gt = document.getElementById('generic-task');

        gn.textContent = data.name;
        const sc = getStatusColor(data.status);
        gb.textContent = data.status;
        gb.style.background = `color-mix(in srgb, ${sc} 15%, transparent)`;
        gb.style.color = sc;

        gsb.className = 'w-full h-0.5 rounded-full mb-1 ' + getStatusBarClass(data.status);
        gd.textContent = data.desc;
        gt.textContent = data.task;

        document.getElementById('profile-generic').classList.add('active');
      }
    }

    // Apply profile layout mode
    applyProfileLayout(currentLayout);
  }

  // Profile layout
  let currentLayout = 'sections';

  function applyProfileLayout(mode) {
    currentLayout = mode;
    document.querySelectorAll('.agent-profile.active [id$="-content"], #profile-claude-opus-7 > div:nth-child(2), #profile-claude-sonnet-3 > div:nth-child(2), #profile-generic .profile-sections').forEach(el => {
      el.className = el.className.replace(/profile-(narrative|sections|dashboard)/g, '');
      el.classList.add('profile-' + mode);
    });
    // Also update all visible profile content divs
    const activeProfile = document.querySelector('.agent-profile.active');
    if (activeProfile) {
      activeProfile.querySelectorAll('.profile-sections, .profile-narrative, .profile-dashboard').forEach(el => {
        el.className = el.className.replace(/profile-(narrative|sections|dashboard)/g, 'profile-' + mode);
      });
    }
  }

  // Stuck threshold — update which agents show as "stuck" based on silence duration
  const agentSilence = {
    'claude-opus-7': 12,
    'claude-sonnet-8': 22,
    'gemini-pro-1': 0.5,
    'claude-sonnet-3': 1,
    'claude-haiku-2': 3,
    'gpt-4o-agent': 2,
    'claude-opus-5': null, // idle
    'claude-haiku-9': null  // idle
  };

  function applyStuckThreshold(threshold) {
    const t = parseInt(threshold, 10);
    document.getElementById('threshold-display').textContent = t;

    document.querySelectorAll('.agent-strip').forEach(strip => {
      const agentId = strip.dataset.agent;
      const silence = agentSilence[agentId];
      if (silence === null) return; // idle agents unchanged

      const dot = strip.querySelector('.w-2.h-2');
      const nameEl = strip.querySelector('.mono.text-xs.font-semibold');
      const silenceEl = strip.querySelector('.mono.font-medium.flex-shrink-0');
      const progressBar = strip.querySelector('.h-1.rounded-full:last-child');

      if (silence >= t) {
        // Mark as stuck
        strip.classList.add('stuck-strip');
        if (dot) { dot.className = 'w-2 h-2 rounded-full flex-shrink-0 dot-stuck'; }
        if (nameEl) { nameEl.style.color = 'var(--stuck)'; }
        if (silenceEl) { silenceEl.className = silenceEl.className.replace(/silence-\w+/g, 'silence-stuck'); }
        if (progressBar) { progressBar.style.background = 'var(--stuck)'; }
      } else {
        strip.classList.remove('stuck-strip');
        if (dot) { dot.className = 'w-2 h-2 rounded-full flex-shrink-0 dot-active'; }
        if (nameEl) { nameEl.style.color = 'var(--text)'; }
        if (silenceEl) {
          silenceEl.className = silenceEl.className.replace(/silence-\w+/g, '');
          silenceEl.classList.add(silence <= 1 ? 'silence-ok' : silence <= 5 ? 'silence-ok' : 'silence-warn');
        }
        if (progressBar) { progressBar.style.background = 'var(--active)'; }
      }
    });

    // Update fleet summary
    let stuckCount = 0;
    let activeCount = 0;
    Object.entries(agentSilence).forEach(([id, silence]) => {
      if (silence === null) return;
      if (silence >= t) stuckCount++;
      else activeCount++;
    });
    const fleetItems = document.querySelectorAll('.fleet-bar .flex.items-center.gap-1\\.5');
    if (fleetItems[0]) fleetItems[0].querySelector('span:last-child').textContent = activeCount + ' active';
    if (fleetItems[1]) fleetItems[1].querySelector('span:last-child').textContent = stuckCount + ' stuck';
  }

  // Listen for control changes from shell
  document.addEventListener('control-change', (e) => {
    const { id, value } = e.detail;
    if (id === 'stuck-threshold') {
      applyStuckThreshold(value);
    }
    if (id === 'profile-layout') {
      applyProfileLayout(value);
    }
  });

  document.addEventListener('controls-ready', () => {
    const threshold = getComputedStyle(document.documentElement).getPropertyValue('--stuck-threshold').trim();
    if (threshold) applyStuckThreshold(threshold);

    const layout = getComputedStyle(document.documentElement).getPropertyValue('--profile-layout').trim();
    if (layout) applyProfileLayout(layout);
  });

  // Initial setup: apply default layout
  applyProfileLayout('sections');
</script>
</body>
</html>

  </template>
  <template id="tpl-e3">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script type="application/json" id="variation-meta">
  {
    "id": "E3",
    "family": "E",
    "familyName": "Explorer Split",
    "name": "Collapsible Navigator",
    "layoutType": "Collapsible List + Maximized Detail",
    "aesthetic": "Professional Dark",
    "description": "Left panel toggles between EXPANDED, COMPACT, and ICON-ONLY modes. Collapsing the list maximizes the detail panel for deep investigation of stuck agents.",
    "controls": [
      {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["5 min", "10 min", "15 min", "30 min"],
        "cssValues": { "5 min": "5", "10 min": "10", "15 min": "15", "30 min": "30" },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
      },
      {
        "id": "list-mode",
        "label": "List Mode",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["expanded", "compact", "icon only"],
        "cssValues": { "expanded": "expanded", "compact": "compact", "icon only": "icon" },
        "value": "expanded",
        "defaultValue": "expanded",
        "unit": "",
        "cssVar": "--list-mode",
        "event": true
      },
      {
        "id": "expanded-width",
        "label": "Expanded Width",
        "type": "range",
        "min": 280, "max": 440, "step": 20,
        "options": null,
        "value": 360,
        "defaultValue": 360,
        "unit": "px",
        "cssVar": "--expanded-width"
      },
      {
        "id": "icon-size",
        "label": "Icon Size",
        "type": "range",
        "min": 32, "max": 56, "step": 4,
        "options": null,
        "value": 40,
        "defaultValue": 40,
        "unit": "px",
        "cssVar": "--icon-size"
      },
      {
        "id": "detail-layout",
        "label": "Detail Layout",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["timeline first", "metrics first", "combined"],
        "cssValues": { "timeline first": "timeline", "metrics first": "metrics", "combined": "combined" },
        "value": "combined",
        "defaultValue": "combined",
        "unit": "",
        "cssVar": "--detail-layout",
        "event": true
      },
      {
        "id": "auto-collapse",
        "label": "Auto-Collapse",
        "type": "toggle",
        "min": null, "max": null, "step": null,
        "options": null,
        "cssValues": { "true": "1", "false": "0" },
        "value": false,
        "defaultValue": false,
        "unit": "",
        "cssVar": "--auto-collapse",
        "event": true
      }
    ]
  }
  </script>
  <style>
    :root {
      --bg: #0f1117;
      --panel: #1a1d27;
      --border: #2a2d3a;
      --text: #e2e4e9;
      --text-dim: #8b8fa3;
      --stuck: #ef4444;
      --active: #3b82f6;
      --idle: #6b7280;
      --healthy: #22c55e;
      --font-sans: 'Inter', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --radius: 8px;
      --expanded-width: 360px;
      --icon-size: 40px;
      --stuck-threshold: 5;
      --list-mode: expanded;
      --detail-layout: combined;
      --auto-collapse: 0;
    }

    :root * {
      transition: color 0.3s ease, background-color 0.3s ease,
                  border-color 0.3s ease, padding 0.3s ease,
                  gap 0.3s ease, font-size 0.3s ease,
                  border-radius 0.3s ease, box-shadow 0.3s ease,
                  max-width 0.3s ease, width 0.3s ease,
                  opacity 0.25s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* Fleet bar */
    #fleet-bar {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 24px;
      flex-shrink: 0;
    }

    /* Main layout */
    #main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* List panel */
    #list-panel {
      background: var(--panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow: hidden;
      transition: width 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #list-panel.mode-expanded {
      width: var(--expanded-width);
    }

    #list-panel.mode-compact {
      width: 160px;
    }

    #list-panel.mode-icon {
      width: 56px;
    }

    /* List header */
    #list-header {
      padding: 10px 10px 10px 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .list-header-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      white-space: nowrap;
      overflow: hidden;
      transition: opacity 0.2s ease, max-width 0.35s ease;
    }

    .mode-compact .list-header-title,
    .mode-icon .list-header-title {
      opacity: 0;
      max-width: 0;
    }

    .mode-expanded .list-header-title {
      opacity: 1;
      max-width: 200px;
    }

    /* Mode toggle button */
    #mode-toggle {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-dim);
      cursor: pointer;
      padding: 4px 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }

    #mode-toggle:hover {
      background: color-mix(in srgb, var(--text) 8%, transparent);
      color: var(--text);
      border-color: var(--text-dim);
    }

    /* Agent list */
    #agent-list {
      overflow-y: auto;
      flex: 1;
      padding: 6px 0;
    }

    .agent-row {
      cursor: pointer;
      position: relative;
      transition: background 0.15s ease;
    }

    .agent-row:hover {
      background: color-mix(in srgb, var(--text) 5%, transparent);
    }

    .agent-row.selected {
      background: color-mix(in srgb, var(--active) 12%, transparent);
    }

    .agent-row.selected::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--active);
      border-radius: 0 2px 2px 0;
    }

    /* EXPANDED row */
    .row-expanded {
      padding: 8px 10px 8px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: opacity 0.2s ease;
    }

    .row-expanded-top {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .row-expanded-task {
      font-size: 11px;
      color: var(--text-dim);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-left: 16px;
    }

    .row-expanded-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-left: 16px;
    }

    /* COMPACT row */
    .row-compact {
      padding: 8px 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: opacity 0.2s ease;
    }

    /* ICON row */
    .row-icon {
      padding: 6px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s ease;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .agent-name-mono {
      font-family: var(--font-mono);
      font-size: 11.5px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .silence-badge {
      font-size: 10px;
      font-family: var(--font-mono);
      color: var(--text-dim);
      white-space: nowrap;
    }

    /* Sparkline */
    .sparkline {
      height: 16px;
      display: flex;
      align-items: flex-end;
      gap: 1.5px;
    }

    .spark-bar {
      width: 3px;
      border-radius: 1px;
      min-height: 2px;
    }

    /* Icon circle */
    .agent-icon-circle {
      width: var(--icon-size);
      height: var(--icon-size);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-mono);
      font-size: calc(var(--icon-size) * 0.3);
      font-weight: 600;
      color: #fff;
      border: 2px solid transparent;
      transition: width 0.35s ease, height 0.35s ease, font-size 0.35s ease;
    }

    /* Mode display */
    .mode-expanded .row-expanded { display: flex; }
    .mode-expanded .row-compact { display: none; }
    .mode-expanded .row-icon { display: none; }

    .mode-compact .row-expanded { display: none; }
    .mode-compact .row-compact { display: flex; }
    .mode-compact .row-icon { display: none; }

    .mode-icon .row-expanded { display: none; }
    .mode-icon .row-compact { display: none; }
    .mode-icon .row-icon { display: flex; }

    /* Detail panel */
    #detail-panel {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .detail-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .detail-card-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .section-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-dim);
    }

    /* Agent header card */
    #agent-header-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .agent-header-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-mono);
      font-size: 15px;
      font-weight: 600;
      color: #fff;
      flex-shrink: 0;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.05em;
    }

    /* Metrics row */
    .metrics-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    .metric-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 14px;
    }

    .metric-value {
      font-family: var(--font-mono);
      font-size: 20px;
      font-weight: 600;
      line-height: 1;
      margin-bottom: 4px;
    }

    .metric-label {
      font-size: 11px;
      color: var(--text-dim);
    }

    /* Timeline */
    .timeline-list {
      padding: 0 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .timeline-item {
      display: flex;
      gap: 12px;
      padding: 10px 0;
      position: relative;
    }

    .timeline-item:not(:last-child)::after {
      content: '';
      position: absolute;
      left: 6px;
      top: 28px;
      bottom: -2px;
      width: 1px;
      background: var(--border);
    }

    .timeline-dot {
      width: 13px;
      height: 13px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 2px;
      border: 2px solid var(--bg);
    }

    .timeline-content {
      flex: 1;
    }

    .timeline-top {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 2px;
    }

    .timeline-event-type {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .timeline-time {
      font-size: 10.5px;
      font-family: var(--font-mono);
      color: var(--text-dim);
    }

    .timeline-desc {
      font-size: 12.5px;
      color: var(--text);
      line-height: 1.4;
    }

    .timeline-task-context {
      margin-top: 6px;
      padding: 6px 10px;
      background: color-mix(in srgb, var(--active) 8%, transparent);
      border: 1px solid color-mix(in srgb, var(--active) 25%, transparent);
      border-radius: 6px;
      font-size: 11px;
      color: var(--text-dim);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .timeline-task-name {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text);
    }

    /* Session activity chart */
    .session-chart {
      padding: 12px 16px;
      height: 60px;
      display: flex;
      align-items: flex-end;
      gap: 2px;
    }

    .session-bar {
      flex: 1;
      border-radius: 2px 2px 0 0;
      min-height: 3px;
    }

    /* Entrance animation */
    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .animate-in {
      animation: fadeSlideIn 0.3s ease forwards;
    }

    /* Mode indicator pill */
    .mode-pill {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 7px;
      border-radius: 10px;
      background: color-mix(in srgb, var(--active) 15%, transparent);
      color: var(--active);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      white-space: nowrap;
      overflow: hidden;
      transition: max-width 0.35s ease, opacity 0.2s ease, padding 0.2s ease;
    }

    .mode-icon .mode-pill,
    .mode-compact .mode-pill {
      max-width: 0;
      opacity: 0;
      padding-left: 0;
      padding-right: 0;
    }

    .mode-expanded .mode-pill {
      max-width: 80px;
      opacity: 1;
    }
  </style>
</head>
<body>

  <!-- Fleet summary bar -->
  <div id="fleet-bar">
    <div style="display:flex;align-items:center;gap:6px;">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-dim)" stroke-width="2">
        <rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/>
      </svg>
      <span style="font-size:12px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.08em;">Fleet</span>
    </div>
    <div style="display:flex;align-items:center;gap:20px;">
      <div style="display:flex;align-items:center;gap:6px;">
        <span style="width:8px;height:8px;border-radius:50%;background:var(--active);display:inline-block;"></span>
        <span style="font-size:12px;color:var(--text);font-weight:500;">4 active</span>
      </div>
      <div style="display:flex;align-items:center;gap:6px;">
        <span style="width:8px;height:8px;border-radius:50%;background:var(--stuck);display:inline-block;"></span>
        <span style="font-size:12px;color:var(--text);font-weight:500;">2 stuck</span>
      </div>
      <div style="display:flex;align-items:center;gap:6px;">
        <span style="width:8px;height:8px;border-radius:50%;background:var(--idle);display:inline-block;"></span>
        <span style="font-size:12px;color:var(--text);font-weight:500;">2 idle</span>
      </div>
    </div>
    <div style="margin-left:auto;font-size:11px;color:var(--text-dim);font-family:var(--font-mono);">
      Stuck &gt; <span id="threshold-display">5</span>m silence
    </div>
  </div>

  <!-- Main content -->
  <div id="main">

    <!-- List panel -->
    <div id="list-panel" class="mode-expanded">

      <!-- List header -->
      <div id="list-header">
        <span class="list-header-title">Agents</span>
        <div style="display:flex;align-items:center;gap:6px;">
          <span class="mode-pill" id="mode-pill-label">EXPANDED</span>
          <button id="mode-toggle" title="Toggle list mode">
            <svg id="toggle-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="18" rx="1"/><rect x="14" y="3" width="7" height="10" rx="1"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Agent list -->
      <div id="agent-list">

        <!-- claude-sonnet-8 | STUCK -->
        <div class="agent-row" data-agent="claude-sonnet-8" data-status="stuck">
          <!-- EXPANDED -->
          <div class="row-expanded">
            <div class="row-expanded-top">
              <span class="status-dot" style="background:var(--stuck);"></span>
              <span class="agent-name-mono">claude-sonnet-8</span>
            </div>
            <div class="row-expanded-task">Fix pagination bug (web)</div>
            <div class="row-expanded-meta">
              <span class="silence-badge" style="color:var(--stuck);">22m silent</span>
              <div class="sparkline">
                <div class="spark-bar" style="background:var(--stuck);opacity:0.5;height:60%;"></div>
                <div class="spark-bar" style="background:var(--stuck);opacity:0.6;height:70%;"></div>
                <div class="spark-bar" style="background:var(--stuck);opacity:0.8;height:80%;"></div>
                <div class="spark-bar" style="background:var(--border);height:20%;"></div>
                <div class="spark-bar" style="background:var(--border);height:10%;"></div>
              </div>
            </div>
          </div>
          <!-- COMPACT -->
          <div class="row-compact">
            <span class="status-dot" style="background:var(--stuck);"></span>
            <span class="agent-name-mono" style="font-size:11px;">claude-sonnet-8</span>
          </div>
          <!-- ICON -->
          <div class="row-icon">
            <div class="agent-icon-circle" style="background:var(--stuck);" title="claude-sonnet-8 — STUCK 22m">CS</div>
          </div>
        </div>

        <!-- claude-opus-7 | STUCK | DEFAULT SELECTED -->
        <div class="agent-row selected" data-agent="claude-opus-7" data-status="stuck">
          <!-- EXPANDED -->
          <div class="row-expanded">
            <div class="row-expanded-top">
              <span class="status-dot" style="background:var(--stuck);"></span>
              <span class="agent-name-mono">claude-opus-7</span>
            </div>
            <div class="row-expanded-task">Implement auth middleware (api-v2)</div>
            <div class="row-expanded-meta">
              <span class="silence-badge" style="color:var(--stuck);">12m silent</span>
              <div class="sparkline">
                <div class="spark-bar" style="background:var(--stuck);opacity:0.4;height:50%;"></div>
                <div class="spark-bar" style="background:var(--stuck);opacity:0.5;height:60%;"></div>
                <div class="spark-bar" style="background:var(--stuck);opacity:0.65;height:75%;"></div>
                <div class="spark-bar" style="background:var(--stuck);opacity:0.8;height:85%;"></div>
                <div class="spark-bar" style="background:var(--stuck);height:95%;"></div>
                <div class="spark-bar" style="background:var(--border);height:20%;"></div>
                <div class="spark-bar" style="background:var(--border);height:10%;"></div>
              </div>
            </div>
          </div>
          <!-- COMPACT -->
          <div class="row-compact">
            <span class="status-dot" style="background:var(--stuck);"></span>
            <span class="agent-name-mono" style="font-size:11px;">claude-opus-7</span>
          </div>
          <!-- ICON -->
          <div class="row-icon">
            <div class="agent-icon-circle" style="background:var(--stuck);" title="claude-opus-7 — STUCK 12m">CO</div>
          </div>
        </div>

        <!-- gemini-pro-1 | ACTIVE -->
        <div class="agent-row" data-agent="gemini-pro-1" data-status="active">
          <div class="row-expanded">
            <div class="row-expanded-top">
              <span class="status-dot" style="background:var(--active);"></span>
              <span class="agent-name-mono">gemini-pro-1</span>
            </div>
            <div class="row-expanded-task">Refactor database queries (core)</div>
            <div class="row-expanded-meta">
              <span class="silence-badge">30s silent</span>
              <div class="sparkline">
                <div class="spark-bar" style="background:var(--active);opacity:0.4;height:40%;"></div>
                <div class="spark-bar" style="background:var(--active);opacity:0.5;height:50%;"></div>
                <div class="spark-bar" style="background:var(--active);opacity:0.6;height:65%;"></div>
                <div class="spark-bar" style="background:var(--active);opacity:0.75;height:75%;"></div>
                <div class="spark-bar" style="background:var(--active);opacity:0.9;height:90%;"></div>
                <div class="spark-bar" style="background:var(--active);height:100%;"></div>
              </div>
            </div>
          </div>
          <div class="row-compact">
            <span class="status-dot" style="background:var(--active);"></span>
            <span class="agent-name-mono" style="font-size:11px;">gemini-pro-1</span>
          </div>
          <div class="row-icon">
            <div class="agent-icon-circle" style="background:var(--active);" title="gemini-pro-1 — ACTIVE 30s">GP</div>
          </div>
        </div>

        <!-- claude-sonnet-3 | ACTIVE -->
        <div class="agent-row" data-agent="claude-sonnet-3" data-status="active">
          <div class="row-expanded">
            <div class="row-expanded-top">
              <span class="status-dot" style="background:var(--active);"></span>
              <span class="agent-name-mono">claude-sonnet-3</span>
            </div>
            <div class="row-expanded-task">Add search API endpoint (api-v2)</div>
            <div class="row-expanded-meta">
              <span class="silence-badge">1m silent</span>
              <div class="sparkline">
                <div class="spark-bar" style="background:var(--active);opacity:0.5;height:55%;"></div>
                <div class="spark-bar" style="background:var(--active);opacity:0.65;height:70%;"></div>
                <div class="spark-bar" style="background:var(--active);opacity:0.8;height:85%;"></div>
                <div class="spark-bar" style="background:var(--active);opacity:0.9;height:90%;"></div>
                <div class="spark-bar" style="background:var(--active);height:100%;"></div>
                <div class="spark-bar" style="background:var(--active);opacity:0.85;height:88%;"></div>
              </div>
            </div>
          </div>
          <div class="row-compact">
            <span class="status-dot" style="background:var(--active);"></span>
            <span class="agent-name-mono" style="font-size:11px;">claude-sonnet-3</span>
          </div>
          <div class="row-icon">
            <div class="agent-icon-circle" style="background:var(--active);" title="claude-sonnet-3 — ACTIVE 1m">CS</div>
          </div>
        </div>

        <!-- claude-haiku-2 | ACTIVE -->
        <div class="agent-row" data-agent="claude-haiku-2" data-status="active">
          <div class="row-expanded">
            <div class="row-expanded-top">
              <span class="status-dot" style="background:var(--active);"></span>
              <span class="agent-name-mono">claude-haiku-2</span>
            </div>
            <div class="row-expanded-task">Write unit tests (core)</div>
            <div class="row-expanded-meta">
              <span class="silence-badge">3m silent</span>
              <div class="sparkline">
                <div class="spark-bar" style="background:var(--active);opacity:0.5;height:50%;"></div>
                <div class="spark-bar" style="background:var(--active);opacity:0.7;height:70%;"></div>
                <div class="spark-bar" style="background:var(--active);opacity:0.9;height:88%;"></div>
                <div class="spark-bar" style="background:var(--active);height:100%;"></div>
              </div>
            </div>
          </div>
          <div class="row-compact">
            <span class="status-dot" style="background:var(--active);"></span>
            <span class="agent-name-mono" style="font-size:11px;">claude-haiku-2</span>
          </div>
          <div class="row-icon">
            <div class="agent-icon-circle" style="background:var(--active);" title="claude-haiku-2 — ACTIVE 3m">CH</div>
          </div>
        </div>

        <!-- gpt-4o-agent | ACTIVE -->
        <div class="agent-row" data-agent="gpt-4o-agent" data-status="active">
          <div class="row-expanded">
            <div class="row-expanded-top">
              <span class="status-dot" style="background:var(--active);"></span>
              <span class="agent-name-mono">gpt-4o-agent</span>
            </div>
            <div class="row-expanded-task">Update API docs (docs)</div>
            <div class="row-expanded-meta">
              <span class="silence-badge">2m silent</span>
              <div class="sparkline">
                <div class="spark-bar" style="background:var(--active);opacity:0.6;height:60%;"></div>
                <div class="spark-bar" style="background:var(--active);opacity:0.8;height:80%;"></div>
                <div class="spark-bar" style="background:var(--active);height:100%;"></div>
              </div>
            </div>
          </div>
          <div class="row-compact">
            <span class="status-dot" style="background:var(--active);"></span>
            <span class="agent-name-mono" style="font-size:11px;">gpt-4o-agent</span>
          </div>
          <div class="row-icon">
            <div class="agent-icon-circle" style="background:var(--active);" title="gpt-4o-agent — ACTIVE 2m">G4</div>
          </div>
        </div>

        <!-- claude-opus-5 | IDLE -->
        <div class="agent-row" data-agent="claude-opus-5" data-status="idle">
          <div class="row-expanded">
            <div class="row-expanded-top">
              <span class="status-dot" style="background:var(--idle);"></span>
              <span class="agent-name-mono" style="color:var(--text-dim);">claude-opus-5</span>
            </div>
            <div class="row-expanded-task" style="color:color-mix(in srgb, var(--text-dim) 70%, transparent);">— idle 8m</div>
            <div class="row-expanded-meta">
              <span class="silence-badge">8m silent</span>
              <div class="sparkline">
                <div class="spark-bar" style="background:var(--idle);opacity:0.5;height:50%;"></div>
                <div class="spark-bar" style="background:var(--idle);opacity:0.7;height:70%;"></div>
                <div class="spark-bar" style="background:var(--idle);height:85%;"></div>
                <div class="spark-bar" style="background:var(--border);height:15%;"></div>
              </div>
            </div>
          </div>
          <div class="row-compact">
            <span class="status-dot" style="background:var(--idle);"></span>
            <span class="agent-name-mono" style="font-size:11px;color:var(--text-dim);">claude-opus-5</span>
          </div>
          <div class="row-icon">
            <div class="agent-icon-circle" style="background:var(--idle);" title="claude-opus-5 — IDLE 8m">CO</div>
          </div>
        </div>

        <!-- claude-haiku-9 | IDLE -->
        <div class="agent-row" data-agent="claude-haiku-9" data-status="idle">
          <div class="row-expanded">
            <div class="row-expanded-top">
              <span class="status-dot" style="background:var(--idle);"></span>
              <span class="agent-name-mono" style="color:var(--text-dim);">claude-haiku-9</span>
            </div>
            <div class="row-expanded-task" style="color:color-mix(in srgb, var(--text-dim) 70%, transparent);">— idle 3m</div>
            <div class="row-expanded-meta">
              <span class="silence-badge">3m silent</span>
              <div class="sparkline">
                <div class="spark-bar" style="background:var(--idle);opacity:0.6;height:60%;"></div>
                <div class="spark-bar" style="background:var(--idle);opacity:0.8;height:75%;"></div>
                <div class="spark-bar" style="background:var(--idle);height:80%;"></div>
                <div class="spark-bar" style="background:var(--border);height:15%;"></div>
              </div>
            </div>
          </div>
          <div class="row-compact">
            <span class="status-dot" style="background:var(--idle);"></span>
            <span class="agent-name-mono" style="font-size:11px;color:var(--text-dim);">claude-haiku-9</span>
          </div>
          <div class="row-icon">
            <div class="agent-icon-circle" style="background:var(--idle);" title="claude-haiku-9 — IDLE 3m">CH</div>
          </div>
        </div>

      </div><!-- /agent-list -->
    </div><!-- /list-panel -->

    <!-- Detail panel -->
    <div id="detail-panel">
      <!-- Content rendered by JS -->
    </div>

  </div><!-- /main -->

  <script>
    // ─── Data ───────────────────────────────────────────────────────────────
    const agents = {
      'claude-opus-7': {
        initials: 'CO',
        status: 'STUCK',
        statusColor: 'var(--stuck)',
        task: 'Implement auth middleware',
        project: 'api-v2',
        silence: '12m',
        silenceMin: 12,
        metrics: {
          session: '25m',
          silence: '12m',
          progress: '35%',
          events: '5'
        },
        timeline: [
          { time: '12m ago', type: 'checkpoint', typeColor: 'var(--active)', desc: 'Analyzing JWT library options', task: 'Implement auth middleware', taskContext: null },
          { time: '15m ago', type: 'checkpoint', typeColor: 'var(--active)', desc: 'Reading existing auth code', task: 'Implement auth middleware', taskContext: null },
          { time: '18m ago', type: 'claimed', typeColor: 'var(--healthy)', desc: 'Claimed task', task: 'Implement auth middleware (api-v2)', taskContext: { progress: '35%', project: 'api-v2' } },
          { time: '20m ago', type: 'completed', typeColor: 'var(--healthy)', desc: 'Completed task', task: 'Set up project scaffolding (api-v2)', taskContext: null },
          { time: '25m ago', type: 'checkpoint', typeColor: 'var(--active)', desc: 'Generated folder structure', task: 'Set up project scaffolding', taskContext: null }
        ],
        sessionBars: [8, 15, 35, 60, 85, 90, 95, 95, 88, 75, 60, 40]
      },
      'claude-sonnet-3': {
        initials: 'CS',
        status: 'ACTIVE',
        statusColor: 'var(--active)',
        task: 'Add search API endpoint',
        project: 'api-v2',
        silence: '1m',
        silenceMin: 1,
        metrics: {
          session: '12m',
          silence: '1m',
          progress: '60%',
          events: '6'
        },
        timeline: [
          { time: '1m ago', type: 'checkpoint', typeColor: 'var(--active)', desc: 'Implementing full-text search', task: 'Add search API endpoint', taskContext: null },
          { time: '3m ago', type: 'checkpoint', typeColor: 'var(--active)', desc: 'Added search route handler', task: 'Add search API endpoint', taskContext: null },
          { time: '5m ago', type: 'checkpoint', typeColor: 'var(--active)', desc: 'Designing search schema', task: 'Add search API endpoint', taskContext: null },
          { time: '8m ago', type: 'claimed', typeColor: 'var(--healthy)', desc: 'Claimed task', task: 'Add search API endpoint (api-v2)', taskContext: { progress: '60%', project: 'api-v2' } },
          { time: '10m ago', type: 'completed', typeColor: 'var(--healthy)', desc: 'Completed task', task: 'Design search schema', taskContext: null },
          { time: '12m ago', type: 'checkpoint', typeColor: 'var(--active)', desc: 'Finalized FTS5 index design', task: 'Design search schema', taskContext: null }
        ],
        sessionBars: [20, 40, 55, 70, 80, 88, 92, 95, 90, 88, 85, 88]
      }
    };

    // ─── State ───────────────────────────────────────────────────────────────
    let selectedAgent = 'claude-opus-7';
    let listMode = 'expanded'; // expanded | compact | icon
    let detailLayout = 'combined'; // timeline | metrics | combined
    let autoCollapse = false;
    let stuckThreshold = 5;

    const modes = ['expanded', 'compact', 'icon'];
    const modeIcons = {
      expanded: `<rect x="3" y="3" width="7" height="18" rx="1"/><rect x="14" y="3" width="7" height="10" rx="1"/>`,
      compact: `<rect x="3" y="3" width="7" height="18" rx="1"/><rect x="14" y="3" width="7" height="5" rx="1"/>`,
      icon: `<circle cx="6" cy="12" r="3"/><circle cx="14" cy="12" r="3"/><circle cx="22" cy="12" r="3"/>`
    };
    const modeLabels = { expanded: 'EXPANDED', compact: 'COMPACT', icon: 'ICON' };

    // ─── DOM refs ────────────────────────────────────────────────────────────
    const listPanel = document.getElementById('list-panel');
    const modeToggle = document.getElementById('mode-toggle');
    const toggleIcon = document.getElementById('toggle-icon');
    const modePill = document.getElementById('mode-pill-label');
    const detailPanel = document.getElementById('detail-panel');
    const thresholdDisplay = document.getElementById('threshold-display');

    // ─── Apply list mode ──────────────────────────────────────────────────────
    function applyListMode(mode) {
      listMode = mode;
      listPanel.className = `mode-${mode}`;
      toggleIcon.innerHTML = modeIcons[mode];
      modePill.textContent = modeLabels[mode];
    }

    // ─── Toggle mode (cycles through 3) ──────────────────────────────────────
    modeToggle.addEventListener('click', () => {
      const idx = modes.indexOf(listMode);
      const next = modes[(idx + 1) % modes.length];
      applyListMode(next);
      // Sync the CSS var for the control system
      document.documentElement.style.setProperty('--list-mode', next);
    });

    // ─── Agent row click ──────────────────────────────────────────────────────
    document.querySelectorAll('.agent-row').forEach(row => {
      row.addEventListener('click', () => {
        document.querySelectorAll('.agent-row').forEach(r => r.classList.remove('selected'));
        row.classList.add('selected');
        selectedAgent = row.dataset.agent;
        renderDetail();

        // Auto-collapse if enabled
        if (autoCollapse && listMode === 'expanded') {
          applyListMode('compact');
        }
      });
    });

    // ─── Render detail panel ──────────────────────────────────────────────────
    function renderDetail() {
      const data = agents[selectedAgent];
      if (!data) {
        renderGenericDetail(selectedAgent);
        return;
      }

      const isStuck = data.status === 'STUCK';
      const statusBg = isStuck
        ? 'color-mix(in srgb, var(--stuck) 15%, transparent)'
        : data.status === 'ACTIVE'
          ? 'color-mix(in srgb, var(--active) 15%, transparent)'
          : 'color-mix(in srgb, var(--idle) 15%, transparent)';

      const headerCard = `
        <div id="agent-header-card" class="animate-in" style="animation-delay:0ms">
          <div class="agent-header-icon" style="background:${data.statusColor};">${data.initials}</div>
          <div style="flex:1;">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px;">
              <span style="font-family:var(--font-mono);font-size:15px;font-weight:600;">${selectedAgent}</span>
              <span class="status-badge" style="background:${statusBg};color:${data.statusColor};">
                <span style="width:6px;height:6px;border-radius:50%;background:${data.statusColor};display:inline-block;"></span>
                ${data.status}${isStuck ? ' — ' + data.silence + ' silence' : ''}
              </span>
            </div>
            <div style="font-size:12px;color:var(--text-dim);">
              <span style="font-family:var(--font-mono);color:var(--text);">${data.task}</span>
              <span style="margin:0 6px;">·</span>
              <span style="background:color-mix(in srgb, var(--text-dim) 15%, transparent);padding:1px 6px;border-radius:4px;font-size:11px;">${data.project}</span>
            </div>
          </div>
        </div>`;

      const metricsCard = `
        <div class="animate-in" style="animation-delay:60ms">
          <div class="metrics-row">
            <div class="metric-card">
              <div class="metric-value">${data.metrics.session}</div>
              <div class="metric-label">Session</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" style="color:${isStuck ? 'var(--stuck)' : 'var(--text)'};">${data.metrics.silence}</div>
              <div class="metric-label">Silence</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" style="color:var(--healthy);">${data.metrics.progress}</div>
              <div class="metric-label">Progress</div>
            </div>
            <div class="metric-card">
              <div class="metric-value">${data.metrics.events}</div>
              <div class="metric-label">Events</div>
            </div>
          </div>
        </div>`;

      const timelineItems = data.timeline.map((item, i) => {
        const taskCtx = item.taskContext ? `
          <div class="timeline-task-context">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="var(--active)" stroke-width="2.5"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
            <span class="timeline-task-name">${item.task}</span>
            <span style="color:var(--text-dim);">·</span>
            <span>progress ${item.taskContext.progress}</span>
            <span style="margin-left:auto;background:color-mix(in srgb,var(--text-dim) 15%,transparent);padding:1px 6px;border-radius:4px;font-size:10px;">${item.taskContext.project}</span>
          </div>` : '';
        return `
          <div class="timeline-item">
            <div class="timeline-dot" style="background:${item.typeColor};margin-top:3px;"></div>
            <div class="timeline-content">
              <div class="timeline-top">
                <span class="timeline-event-type" style="color:${item.typeColor};">${item.type}</span>
                <span class="timeline-time">${item.time}</span>
              </div>
              <div class="timeline-desc">${item.desc}</div>
              ${!item.taskContext ? `<div style="font-size:11px;color:var(--text-dim);margin-top:2px;font-family:var(--font-mono);">${item.task}</div>` : ''}
              ${taskCtx}
            </div>
          </div>`;
      }).join('');

      const timelineCard = `
        <div class="detail-card animate-in" style="animation-delay:120ms">
          <div class="detail-card-header">
            <span class="section-label">Session Timeline</span>
            <span style="font-size:11px;color:var(--text-dim);font-family:var(--font-mono);">${data.metrics.events} events</span>
          </div>
          <div class="timeline-list">${timelineItems}</div>
        </div>`;

      const maxBar = Math.max(...data.sessionBars);
      const sessionBars = data.sessionBars.map((v, i) => {
        const pct = (v / maxBar) * 100;
        const isRecent = i >= data.sessionBars.length - 3;
        const color = isStuck ? 'var(--stuck)' : 'var(--active)';
        const opacity = isRecent ? 1 : 0.4 + (i / data.sessionBars.length) * 0.5;
        return `<div class="session-bar" style="height:${pct}%;background:${color};opacity:${opacity};"></div>`;
      }).join('');

      const activityCard = `
        <div class="detail-card animate-in" style="animation-delay:180ms">
          <div class="detail-card-header">
            <span class="section-label">Session Activity</span>
            <span style="font-size:11px;color:var(--text-dim);">Last 25 minutes</span>
          </div>
          <div class="session-chart">${sessionBars}</div>
        </div>`;

      // Layout order based on detailLayout
      let sections;
      if (detailLayout === 'timeline') {
        sections = headerCard + timelineCard + metricsCard + activityCard;
      } else if (detailLayout === 'metrics') {
        sections = headerCard + metricsCard + activityCard + timelineCard;
      } else {
        // combined: header + metrics + timeline + activity
        sections = headerCard + metricsCard + timelineCard + activityCard;
      }

      detailPanel.innerHTML = sections;
    }

    function renderGenericDetail(agentId) {
      const row = document.querySelector(`.agent-row[data-agent="${agentId}"]`);
      const status = row ? row.dataset.status : 'unknown';
      const colorMap = { stuck: 'var(--stuck)', active: 'var(--active)', idle: 'var(--idle)' };
      const color = colorMap[status] || 'var(--text-dim)';
      const initials = agentId.split('-').slice(0,2).map(s => s[0].toUpperCase()).join('');

      detailPanel.innerHTML = `
        <div id="agent-header-card" class="animate-in">
          <div class="agent-header-icon" style="background:${color};">${initials}</div>
          <div>
            <div style="font-family:var(--font-mono);font-size:15px;font-weight:600;margin-bottom:4px;">${agentId}</div>
            <div style="font-size:12px;color:var(--text-dim);">Status: <span style="color:${color};font-weight:600;text-transform:uppercase;">${status}</span></div>
          </div>
        </div>
        <div class="detail-card animate-in" style="animation-delay:60ms;padding:24px;text-align:center;color:var(--text-dim);font-size:13px;">
          No detailed session data available for this agent.
        </div>`;
    }

    // ─── Control event listener ───────────────────────────────────────────────
    document.addEventListener('control-change', (e) => {
      const { id, value } = e.detail;

      if (id === 'list-mode') {
        const modeMap = { expanded: 'expanded', compact: 'compact', 'icon only': 'icon', icon: 'icon' };
        const mapped = modeMap[value] || value;
        applyListMode(mapped);
      }

      if (id === 'detail-layout') {
        detailLayout = value;
        renderDetail();
      }

      if (id === 'auto-collapse') {
        autoCollapse = value === '1' || value === true || value === 'true';
      }

      if (id === 'stuck-threshold') {
        stuckThreshold = parseInt(value, 10) || 5;
        thresholdDisplay.textContent = stuckThreshold;
        // Update stuck styling based on threshold
        document.querySelectorAll('.agent-row').forEach(row => {
          const agent = agents[row.dataset.agent];
          if (!agent) return;
          const silMin = agent.silenceMin || 0;
          const isNowStuck = silMin >= stuckThreshold;
          // update silence badge colors in expanded view
          const badge = row.querySelector('.silence-badge');
          if (badge) {
            badge.style.color = isNowStuck ? 'var(--stuck)' : 'var(--text-dim)';
          }
        });
      }
    });

    document.addEventListener('controls-ready', () => {
      // Read initial CSS var values
      const cs = getComputedStyle(document.documentElement);

      const modeVal = cs.getPropertyValue('--list-mode').trim();
      if (modeVal && modes.includes(modeVal)) {
        applyListMode(modeVal);
      }

      const layoutVal = cs.getPropertyValue('--detail-layout').trim();
      if (layoutVal) detailLayout = layoutVal;

      const acVal = cs.getPropertyValue('--auto-collapse').trim();
      autoCollapse = acVal === '1';

      const threshVal = cs.getPropertyValue('--stuck-threshold').trim();
      if (threshVal) {
        stuckThreshold = parseInt(threshVal, 10) || 5;
        thresholdDisplay.textContent = stuckThreshold;
      }

      renderDetail();
    });

    // ─── Initial render ───────────────────────────────────────────────────────
    renderDetail();

    // Stagger entrance animations on agent rows
    document.querySelectorAll('.agent-row').forEach((row, i) => {
      row.style.opacity = '0';
      row.style.transform = 'translateX(-8px)';
      setTimeout(() => {
        row.style.transition = 'opacity 0.25s ease, transform 0.25s ease, background 0.15s ease';
        row.style.opacity = '1';
        row.style.transform = 'translateX(0)';
      }, i * 40 + 50);
    });
  </script>
</body>
</html>

  </template>

  <!-- ==================== ALPINE.JS DATA MODEL ==================== -->
  <script>
    function explorer() {
      return {
        // --- State ---
        variations: [{
  id: 'D1',
  family: 'D',
  familyName: 'Triage Strips',
  name: 'Flat Roster',
  layoutType: 'Expandable Row List',
  aesthetic: 'Professional Dark',
  description: 'All agents in a flat list with inline sparklines. Stuck agents sorted to top with red left border. Any agent expands inline to show full session timeline and task context.',
  controls: [
    {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "5 min",
            "10 min",
            "15 min",
            "30 min"
        ],
        "cssValues": {
            "5 min": "5",
            "10 min": "10",
            "15 min": "15",
            "30 min": "30"
        },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
    },
    {
        "id": "row-density",
        "label": "Row Density",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "compact",
            "standard",
            "spacious"
        ],
        "cssValues": {
            "compact": {
                "--row-height": "44px",
                "--row-gap": "2px",
                "--row-font": "12px"
            },
            "standard": {
                "--row-height": "56px",
                "--row-gap": "4px",
                "--row-font": "13px"
            },
            "spacious": {
                "--row-height": "68px",
                "--row-gap": "8px",
                "--row-font": "14px"
            }
        },
        "value": "standard",
        "defaultValue": "standard",
        "unit": "",
        "cssVar": null
    },
    {
        "id": "sparkline-style",
        "label": "Sparkline Style",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "session blocks",
            "tick marks",
            "area fill"
        ],
        "cssValues": {
            "session blocks": "blocks",
            "tick marks": "ticks",
            "area fill": "area"
        },
        "value": "session blocks",
        "defaultValue": "session blocks",
        "unit": "",
        "cssVar": "--sparkline-style",
        "event": true
    },
    {
        "id": "expand-anim",
        "label": "Expand Animation",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "slide",
            "fade",
            "instant"
        ],
        "cssValues": {
            "slide": "slide",
            "fade": "fade",
            "instant": "instant"
        },
        "value": "slide",
        "defaultValue": "slide",
        "unit": "",
        "cssVar": "--expand-anim",
        "event": true
    },
    {
        "id": "detail-depth",
        "label": "Detail Depth",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "summary",
            "timeline",
            "full"
        ],
        "cssValues": {
            "summary": "summary",
            "timeline": "timeline",
            "full": "full"
        },
        "value": "full",
        "defaultValue": "full",
        "unit": "",
        "cssVar": "--detail-depth",
        "event": true
    },
    {
        "id": "show-idle",
        "label": "Show Idle",
        "type": "toggle",
        "min": null,
        "max": null,
        "step": null,
        "options": null,
        "cssValues": {
            "true": "flex",
            "false": "none"
        },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--idle-display"
    }
]
},
{
  id: 'D2',
  family: 'D',
  familyName: 'Triage Strips',
  name: 'Incident Banner + Roster',
  layoutType: 'Alert Banner + Expandable Rows',
  aesthetic: 'Professional Dark',
  description: 'Compact incident banner for stuck agents above a full expandable agent roster with inline sparklines.',
  controls: [
    {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "5 min",
            "10 min",
            "15 min",
            "30 min"
        ],
        "cssValues": {
            "5 min": "5",
            "10 min": "10",
            "15 min": "15",
            "30 min": "30"
        },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
    },
    {
        "id": "banner-height",
        "label": "Banner Height",
        "type": "range",
        "min": 56,
        "max": 140,
        "step": 12,
        "options": null,
        "value": 80,
        "defaultValue": 80,
        "unit": "px",
        "cssVar": "--banner-height"
    },
    {
        "id": "banner-style",
        "label": "Banner Style",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "minimal",
            "detailed",
            "expanded"
        ],
        "cssValues": {
            "minimal": "minimal",
            "detailed": "detailed",
            "expanded": "expanded"
        },
        "value": "detailed",
        "defaultValue": "detailed",
        "unit": "",
        "cssVar": "--banner-style",
        "event": true
    },
    {
        "id": "row-height",
        "label": "Row Height",
        "type": "range",
        "min": 44,
        "max": 68,
        "step": 4,
        "options": null,
        "value": 52,
        "defaultValue": 52,
        "unit": "px",
        "cssVar": "--row-height"
    },
    {
        "id": "sparkline-width",
        "label": "Sparkline Width",
        "type": "range",
        "min": 80,
        "max": 200,
        "step": 20,
        "options": null,
        "value": 140,
        "defaultValue": 140,
        "unit": "px",
        "cssVar": "--sparkline-width"
    },
    {
        "id": "group-status",
        "label": "Group By Status",
        "type": "toggle",
        "min": null,
        "max": null,
        "step": null,
        "options": null,
        "cssValues": {
            "true": "1",
            "false": "0"
        },
        "value": false,
        "defaultValue": false,
        "unit": "",
        "cssVar": "--group-status",
        "event": true
    }
]
},
{
  id: 'D3',
  family: 'D',
  familyName: 'Triage Strips',
  name: 'Sortable Table',
  layoutType: 'Sortable Table + Inline Expansion',
  aesthetic: 'Professional Dark',
  description: 'Full-featured data table with sortable columns, inline sparklines, and keyboard navigation. Maximum information density for power users.',
  controls: [
    {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "5 min",
            "10 min",
            "15 min",
            "30 min"
        ],
        "cssValues": {
            "5 min": "5",
            "10 min": "10",
            "15 min": "15",
            "30 min": "30"
        },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
    },
    {
        "id": "columns",
        "label": "Columns",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "essential",
            "standard",
            "full"
        ],
        "cssValues": {
            "essential": "essential",
            "standard": "standard",
            "full": "full"
        },
        "value": "standard",
        "defaultValue": "standard",
        "unit": "",
        "cssVar": "--columns",
        "event": true
    },
    {
        "id": "sort-col",
        "label": "Sort Column",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "status",
            "agent",
            "silence",
            "progress",
            "activity"
        ],
        "cssValues": {
            "status": "status",
            "agent": "agent",
            "silence": "silence",
            "progress": "progress",
            "activity": "activity"
        },
        "value": "status",
        "defaultValue": "status",
        "unit": "",
        "cssVar": "--sort-col",
        "event": true
    },
    {
        "id": "row-height",
        "label": "Row Height",
        "type": "range",
        "min": 40,
        "max": 64,
        "step": 4,
        "options": null,
        "value": 48,
        "defaultValue": 48,
        "unit": "px",
        "cssVar": "--row-height"
    },
    {
        "id": "sparkline-width",
        "label": "Sparkline Width",
        "type": "range",
        "min": 80,
        "max": 200,
        "step": 20,
        "options": null,
        "value": 140,
        "defaultValue": 140,
        "unit": "px",
        "cssVar": "--sparkline-width"
    },
    {
        "id": "expand-style",
        "label": "Expand Style",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "inline panel",
            "slide drawer",
            "overlay card"
        ],
        "cssValues": {
            "inline panel": "inline",
            "slide drawer": "drawer",
            "overlay card": "overlay"
        },
        "value": "inline panel",
        "defaultValue": "inline panel",
        "unit": "",
        "cssVar": "--expand-style",
        "event": true
    }
]
},
{
  id: 'E1',
  family: 'E',
  familyName: 'Explorer Split',
  name: 'Compact List + Rich Detail',
  layoutType: 'Narrow List + Combined Detail Panel',
  aesthetic: 'Professional Dark',
  description: 'Persistent two-panel layout with a narrow agent list and a unified timeline+task detail panel. Click any agent to see their full narrative without switching tabs.',
  controls: [
    {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "5 min",
            "10 min",
            "15 min",
            "30 min"
        ],
        "cssValues": {
            "5 min": "5",
            "10 min": "10",
            "15 min": "15",
            "30 min": "30"
        },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
    },
    {
        "id": "list-width",
        "label": "List Width",
        "type": "range",
        "min": 220,
        "max": 380,
        "step": 20,
        "options": null,
        "cssValues": null,
        "value": 280,
        "defaultValue": 280,
        "unit": "px",
        "cssVar": "--list-width"
    },
    {
        "id": "detail-view",
        "label": "Detail View",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "unified",
            "tabbed"
        ],
        "cssValues": {
            "unified": "unified",
            "tabbed": "tabbed"
        },
        "value": "unified",
        "defaultValue": "unified",
        "unit": "",
        "cssVar": "--detail-view",
        "event": true
    },
    {
        "id": "timeline-density",
        "label": "Timeline Density",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "compact",
            "standard",
            "verbose"
        ],
        "cssValues": {
            "compact": {
                "--event-padding": "8px 12px",
                "--event-gap": "4px",
                "--task-context-display": "none"
            },
            "standard": {
                "--event-padding": "12px 16px",
                "--event-gap": "8px",
                "--task-context-display": "block"
            },
            "verbose": {
                "--event-padding": "16px 20px",
                "--event-gap": "12px",
                "--task-context-display": "block"
            }
        },
        "value": "standard",
        "defaultValue": "standard",
        "unit": "",
        "cssVar": null
    },
    {
        "id": "task-inline",
        "label": "Show Task Inline",
        "type": "toggle",
        "min": null,
        "max": null,
        "step": null,
        "options": null,
        "cssValues": {
            "true": "block",
            "false": "none"
        },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--task-context-display"
    },
    {
        "id": "activity-indicator",
        "label": "Activity Indicator",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "sparkline",
            "status dot",
            "session bar"
        ],
        "cssValues": {
            "sparkline": "sparkline",
            "status dot": "dot",
            "session bar": "bar"
        },
        "value": "sparkline",
        "defaultValue": "sparkline",
        "unit": "",
        "cssVar": "--activity-indicator",
        "event": true
    }
]
},
{
  id: 'E2',
  family: 'E',
  familyName: 'Explorer Split',
  name: 'Data List + Agent Profile',
  layoutType: 'Wide List + Profile Detail Panel',
  aesthetic: 'Professional Dark',
  description: 'Persistent two-panel layout with a wide left list and a structured agent profile detail panel. The list provides C2-level density; the profile gives a readable narrative when you need it.',
  controls: [
    {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "5 min",
            "10 min",
            "15 min",
            "30 min"
        ],
        "cssValues": {
            "5 min": "5",
            "10 min": "10",
            "15 min": "15",
            "30 min": "30"
        },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
    },
    {
        "id": "list-width",
        "label": "List Width",
        "type": "range",
        "min": 340,
        "max": 520,
        "step": 20,
        "options": null,
        "value": 400,
        "defaultValue": 400,
        "unit": "px",
        "cssVar": "--list-width"
    },
    {
        "id": "profile-layout",
        "label": "Profile Layout",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "narrative",
            "sections",
            "dashboard"
        ],
        "cssValues": {
            "narrative": "narrative",
            "sections": "sections",
            "dashboard": "dashboard"
        },
        "value": "sections",
        "defaultValue": "sections",
        "unit": "",
        "cssVar": "--profile-layout",
        "event": true
    },
    {
        "id": "sparkline-width",
        "label": "List Sparkline Width",
        "type": "range",
        "min": 60,
        "max": 160,
        "step": 20,
        "options": null,
        "value": 100,
        "defaultValue": 100,
        "unit": "px",
        "cssVar": "--sparkline-width"
    },
    {
        "id": "show-progress",
        "label": "Show Progress",
        "type": "toggle",
        "min": null,
        "max": null,
        "step": null,
        "options": null,
        "cssValues": {
            "true": "flex",
            "false": "none"
        },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--progress-display"
    },
    {
        "id": "stats-panel",
        "label": "Stats Panel",
        "type": "toggle",
        "min": null,
        "max": null,
        "step": null,
        "options": null,
        "cssValues": {
            "true": "grid",
            "false": "none"
        },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--stats-display"
    }
]
},
{
  id: 'E3',
  family: 'E',
  familyName: 'Explorer Split',
  name: 'Collapsible Navigator',
  layoutType: 'Collapsible List + Maximized Detail',
  aesthetic: 'Professional Dark',
  description: 'Left panel toggles between EXPANDED, COMPACT, and ICON-ONLY modes. Collapsing the list maximizes the detail panel for deep investigation of stuck agents.',
  controls: [
    {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "5 min",
            "10 min",
            "15 min",
            "30 min"
        ],
        "cssValues": {
            "5 min": "5",
            "10 min": "10",
            "15 min": "15",
            "30 min": "30"
        },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
    },
    {
        "id": "list-mode",
        "label": "List Mode",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "expanded",
            "compact",
            "icon only"
        ],
        "cssValues": {
            "expanded": "expanded",
            "compact": "compact",
            "icon only": "icon"
        },
        "value": "expanded",
        "defaultValue": "expanded",
        "unit": "",
        "cssVar": "--list-mode",
        "event": true
    },
    {
        "id": "expanded-width",
        "label": "Expanded Width",
        "type": "range",
        "min": 280,
        "max": 440,
        "step": 20,
        "options": null,
        "value": 360,
        "defaultValue": 360,
        "unit": "px",
        "cssVar": "--expanded-width"
    },
    {
        "id": "icon-size",
        "label": "Icon Size",
        "type": "range",
        "min": 32,
        "max": 56,
        "step": 4,
        "options": null,
        "value": 40,
        "defaultValue": 40,
        "unit": "px",
        "cssVar": "--icon-size"
    },
    {
        "id": "detail-layout",
        "label": "Detail Layout",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "timeline first",
            "metrics first",
            "combined"
        ],
        "cssValues": {
            "timeline first": "timeline",
            "metrics first": "metrics",
            "combined": "combined"
        },
        "value": "combined",
        "defaultValue": "combined",
        "unit": "",
        "cssVar": "--detail-layout",
        "event": true
    },
    {
        "id": "auto-collapse",
        "label": "Auto-Collapse",
        "type": "toggle",
        "min": null,
        "max": null,
        "step": null,
        "options": null,
        "cssValues": {
            "true": "1",
            "false": "0"
        },
        "value": false,
        "defaultValue": false,
        "unit": "",
        "cssVar": "--auto-collapse",
        "event": true
    }
]
}],
        currentIndex: 0,
        meta: {},
        showControls: false,
        showExport: false,
        showFinalize: false,
        showShortcuts: false,
        isTransitioning: true,
        copiedFeedback: false,
        copiedDirection: false,
        finalizeNotes: '',
        directionText: '',
        ratings: {},

        // --- Computed ---
        get current() { return this.variations[this.currentIndex]; },
        get families() {
          const map = {};
          this.variations.forEach(v => {
            if (!map[v.family]) map[v.family] = { letter: v.family, name: v.familyName, variations: [] };
            map[v.family].variations.push(v);
          });
          return Object.values(map);
        },
        get currentRating() { return this.ratings[this.current.id] || { stars: null, notes: '' }; },
        get reviewedCount() { return Object.values(this.ratings).filter(r => r.stars != null).length; },

        // --- Init ---
        init() {
          this.meta = JSON.parse(document.getElementById('exploration-metadata').textContent);
          this.variations.forEach(v => { v.controls.forEach((c, i) => this.normalizeControl(c, i)); });
          this.loadState();
          this.directionText = this.defaultDirection();
          this.$nextTick(() => this.loadVariationInIframe());
        },
        // Fix common subagent deviations from the control schema
        normalizeControl(c, index) {
          // Auto-generate id if missing — most common subagent mistake
          if (!c.id && c.label) c.id = c.label.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-$/, '');
          if (!c.id) c.id = 'ctrl-' + index;
          // Normalize type — map alternates and infer from data shape
          const typeMap = { boolean: 'toggle', switch: 'toggle', checkbox: 'toggle', slider: 'range', dropdown: 'select', radio: 'select' };
          if (c.type) c.type = typeMap[c.type.toLowerCase()] || c.type.toLowerCase();
          if (!c.type || !['range', 'select', 'toggle'].includes(c.type)) {
            if (c.min != null || c.max != null) c.type = 'range';
            else if (Array.isArray(c.options) && c.options.length) c.type = 'select';
            else if (typeof c.value === 'boolean' || typeof c.default === 'boolean') c.type = 'toggle';
            else c.type = 'toggle'; // safe fallback
          }
          // cssValues as array → convert to object keyed by option labels
          if (Array.isArray(c.cssValues) && Array.isArray(c.options) && c.cssValues.length === c.options.length) {
            const obj = {};
            c.options.forEach((opt, i) => { obj[typeof opt === 'string' ? opt : (opt.label || String(opt))] = c.cssValues[i]; });
            c.cssValues = obj;
          }
          // Select with cssValues but no options → derive options from cssValues keys
          if (c.cssValues && typeof c.cssValues === 'object' && !Array.isArray(c.cssValues) &&
              (!Array.isArray(c.options) || c.options.length === 0)) {
            c.options = Object.keys(c.cssValues);
            if (!c.type) c.type = 'select';
          }
          // options as objects [{label,value}] → extract labels + build cssValues + valueToLabel map
          let valueToLabel = {};
          if (Array.isArray(c.options) && c.options.length && typeof c.options[0] === 'object') {
            if (!c.cssValues) c.cssValues = {};
            const labels = [];
            c.options.forEach(o => {
              const lbl = o.label || o.name || String(o.value);
              const val = o.value != null ? o.value : o.cssValue || lbl;
              labels.push(lbl);
              valueToLabel[val] = lbl;
              // Per-option cssValues object (multi-var) takes priority over scalar value
              if (!(lbl in c.cssValues)) {
                if (o.cssValues && typeof o.cssValues === 'object') {
                  c.cssValues[lbl] = o.cssValues;
                } else {
                  c.cssValues[lbl] = String(val);
                }
              }
            });
            c.options = labels;
          }
          // "default" → value/defaultValue (resolve via valueToLabel if needed)
          const resolve = v => valueToLabel[v] || v;
          if (c.value == null && c.default != null) c.value = resolve(c.default);
          if (c.value != null) c.value = resolve(c.value);
          if (c.defaultValue == null && c.default != null) c.defaultValue = resolve(c.default);
          if (c.defaultValue == null && c.value != null) c.defaultValue = c.value;
          if (c.value == null && c.defaultValue != null) c.value = c.defaultValue;
          // Range with string value containing unit (e.g. '0.5s') → parse to number
          if (c.type === 'range' && typeof c.value === 'string') {
            const parsed = parseFloat(c.value);
            if (!isNaN(parsed)) { c.value = parsed; c.defaultValue = parsed; }
          }
          // Range with unit '%' — keep unit for display label but strip for CSS
          // generation when it's a 0-100 scale. CSS vars should receive the raw
          // number (e.g., 50 not 50%) so calc() like 'calc(var(--x) / 100)' or
          // 'calc(var(--x) * 1%)' works correctly. Store display unit separately.
          if (c.type === 'range' && c.unit === '%') {
            c._displayUnit = '%';
            c.unit = '';
          }
          // Ensure value is in options for select
          if (c.type === 'select' && Array.isArray(c.options) && c.options.length && !c.options.includes(c.value)) {
            c.value = c.options[0];
            c.defaultValue = c.options[0];
          }
        },

        // --- Iframe ---
        loadVariationInIframe() {
          const tpl = document.getElementById('tpl-' + this.current.id.toLowerCase());
          if (!tpl) return;
          this.$refs.iframe.srcdoc = '<!DOCTYPE html>\n' + tpl.innerHTML;
        },
        onIframeLoad() {
          if (!this.$refs.iframe?.srcdoc) return;
          // Restore body class — <template> parser strips <body> attributes,
          // so assemble.py preserves them as data-body-class on the template element
          const tpl = document.getElementById('tpl-' + this.current.id.toLowerCase());
          if (tpl) {
            const bodyClass = tpl.getAttribute('data-body-class');
            if (bodyClass && this.$refs.iframe.contentDocument?.body) {
              this.$refs.iframe.contentDocument.body.className = bodyClass;
            }
          }
          this.applyControlsToIframe();
          this.isTransitioning = false;
        },
        applyControlsToIframe() {
          const doc = this.$refs.iframe?.contentDocument;
          if (!doc) return;
          this.current.controls.forEach(c => {
            if (c.value == null) return;
            const val = c.value;
            if (c.cssValues) {
              const mapped = c.cssValues[val] ?? c.cssValues[String(val)];
              if (mapped && typeof mapped === 'object') {
                Object.entries(mapped).forEach(([prop, v]) => doc.documentElement.style.setProperty(prop, v));
              } else if (mapped != null && c.cssVar) {
                doc.documentElement.style.setProperty(c.cssVar, mapped);
              }
            } else if (c.cssVar) {
              if (c.type === 'toggle') {
                doc.documentElement.style.setProperty(c.cssVar, val ? '1' : '0');
              } else {
                doc.documentElement.style.setProperty(c.cssVar, String(val) + (c.unit || ''));
              }
            }
            // Dispatch event for behavioral controls (and any variation listening)
            try { doc.dispatchEvent(new CustomEvent('control-change', { detail: { id: c.id, value: val } })); } catch(e) {}
          });
          // Signal that all controls have been applied (useful for initial load)
          try { doc.dispatchEvent(new CustomEvent('controls-ready')); } catch(e) {}
        },

        // --- Navigation ---
        goTo(index) {
          if (index === this.currentIndex) return;
          this.isTransitioning = true;
          setTimeout(() => {
            this.currentIndex = index;
            this.loadVariationInIframe();
          }, 150);
        },
        next() { this.goTo((this.currentIndex + 1) % this.variations.length); },
        prev() { this.goTo((this.currentIndex - 1 + this.variations.length) % this.variations.length); },
        selectVariation(id) {
          const idx = this.variations.findIndex(v => v.id === id);
          if (idx !== -1) this.goTo(idx);
        },

        // --- Controls ---
        updateControl(controlId, value) {
          const control = this.current.controls.find(c => c.id === controlId);
          if (control) { control.value = value; this.saveControlState(); this.applyControlsToIframe(); }
        },
        resetControls() {
          this.current.controls.forEach(c => { c.value = c.defaultValue; });
          this.saveControlState();
          this.applyControlsToIframe();
        },
        replayVariation() {
          this.isTransitioning = true;
          setTimeout(() => this.loadVariationInIframe(), 150);
        },

        // --- Rating ---
        rate(stars) {
          if (!this.ratings[this.current.id]) this.ratings[this.current.id] = { stars: null, notes: '' };
          // Clicking same rating clears it (back to unreviewed); otherwise set the new rating
          this.ratings[this.current.id].stars = this.ratings[this.current.id].stars === stars ? null : stars;
          this.saveState();
        },
        updateNotes(text) {
          if (!this.ratings[this.current.id]) this.ratings[this.current.id] = { stars: null, notes: '' };
          this.ratings[this.current.id].notes = text;
          this.saveState();
        },

        // --- Export ---
        generateFeedback() {
          const m = this.meta;
          const title = m.topic ? m.topic.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : m.project;
          let out = `## Design Exploration Feedback \u2014 ${title} (Round ${m.round})\n`;
          out += `Source: ${m.sourceDirectory}/v${m.round}.html (read exploration-metadata JSON from this file for full context)\n`;
          out += `Reviewed: ${this.reviewedCount}/${this.variations.length} variations\n`;
          const loved = this.variations.filter(v => (this.ratings[v.id]?.stars ?? -1) >= 4);
          const mixed = this.variations.filter(v => { const s = this.ratings[v.id]?.stars; return s != null && s >= 2 && s <= 3; });
          const low = this.variations.filter(v => this.ratings[v.id]?.stars === 1);
          const skipped = this.variations.filter(v => this.ratings[v.id]?.stars === 0);
          const unreviewed = this.variations.filter(v => this.ratings[v.id]?.stars == null);
          const fmtAdjusted = (v) => {
            const adjusted = v.controls.filter(c => {
              if (c.defaultValue == null) return false;
              return JSON.stringify(c.value) !== JSON.stringify(c.defaultValue);
            });
            if (!adjusted.length) return '';
            const parts = adjusted.map(c => {
              const d = c.defaultValue;
              const u = c.unit || '';
              if (c.type === 'toggle') return `${c.label}: ${d ? 'on' : 'off'} \u2192 ${c.value ? 'on' : 'off'}`;
              if (c.type === 'range') return `${c.label}: ${d}${u} \u2192 ${c.value}${u}`;
              return `${c.label}: ${d} \u2192 ${c.value}`;
            });
            return `  Adjusted: ${parts.join(', ')}\n`;
          };
          const famApproach = (v) => {
            const fam = m.families?.find(f => f.letter === v.family);
            return fam?.approach ? `  Approach: ${fam.approach}\n` : '';
          };
          const fmt = (v) => {
            const rt = this.ratings[v.id];
            let line = `- **${v.id} \u201C${v.name}\u201D** (${rt.stars}\u2605) \u2014 Family ${v.family} \u201C${v.familyName}\u201D\n`;
            line += famApproach(v);
            line += `  ${v.layoutType} / ${v.aesthetic}: ${v.description}\n`;
            if (rt.notes) line += `  Note: ${rt.notes}\n`;
            line += fmtAdjusted(v);
            return line;
          };
          if (loved.length) { out += `\n**Loved (4-5\u2605)**\n`; loved.forEach(v => out += fmt(v)); }
          if (mixed.length) { out += `\n**Mixed (2-3\u2605)**\n`; mixed.forEach(v => out += fmt(v)); }
          if (low.length) { out += `\n**Low (1\u2605)**\n`; low.forEach(v => out += fmt(v)); }
          if (skipped.length) {
            out += `\n**Skip (0\u2605)**\n`;
            skipped.forEach(v => {
              let line = `- **${v.id} \u201C${v.name}\u201D** \u2014 Family ${v.family} \u201C${v.familyName}\u201D\n`;
              line += famApproach(v);
              line += `  ${v.layoutType} / ${v.aesthetic}: ${v.description}\n`;
              const rt = this.ratings[v.id];
              if (rt?.notes) line += `  Note: ${rt.notes}\n`;
              line += fmtAdjusted(v);
              out += line;
            });
          }
          if (unreviewed.length) {
            out += `\n**Not reviewed**\n`;
            unreviewed.forEach(v => {
              let line = `- ${v.id} \u201C${v.name}\u201D \u2014 Family ${v.family} \u201C${v.familyName}\u201D\n`;
              line += famApproach(v);
              line += `  ${v.layoutType} / ${v.aesthetic}: ${v.description}\n`;
              out += line;
            });
          }
          return out;
        },
        defaultDirection() {
          const loved = this.variations.filter(v => (this.ratings[v.id]?.stars ?? -1) >= 4);
          const skipped = this.variations.filter(v => this.ratings[v.id]?.stars === 0);
          let d = '';
          if (loved.length) d += `Keep: ${loved.map(v => v.id + ' "' + v.name + '"').join(', ')}. `;
          if (skipped.length) d += `Drop: ${skipped.map(v => v.id + ' "' + v.name + '"').join(', ')}. `;
          return d;
        },
        copyFeedback() {
          const feedback = this.generateFeedback();
          const direction = this.directionText.trim() || '[No direction provided]';
          const full = feedback + '\n### Direction for Next Round\n' + direction;
          navigator.clipboard.writeText(full);
          this.copiedFeedback = true;
          setTimeout(() => { this.copiedFeedback = false; }, 2000);
        },

        // --- Finalize ---
        openFinalize() {
          this.finalizeNotes = this.currentRating.notes || '';
          this.copiedDirection = false;
          this.showFinalize = true;
        },
        generateDirection() {
          const v = this.current;
          const m = this.meta;
          const title = m.topic ? m.topic.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : m.project;
          let out = `## Design Direction — ${title}\n`;
          out += `Source: ${m.sourceDirectory}/v${m.round}.html (read exploration-metadata JSON from this file for full context)\n\n`;
          out += `**Chosen: ${v.id} "${v.name}"** — Family ${v.family} "${v.familyName}"\n`;
          const fam = m.families?.find(f => f.letter === v.family);
          if (fam?.approach) out += `Approach: ${fam.approach}\n`;
          out += `${v.layoutType} / ${v.aesthetic}: ${v.description}\n`;
          // Adjusted controls as absolute design specs
          const tuned = v.controls.filter(c => {
            if (c.defaultValue == null) return false;
            return JSON.stringify(c.value) !== JSON.stringify(c.defaultValue);
          });
          if (tuned.length) {
            out += `\nDesign specs (adjusted from defaults):\n`;
            tuned.forEach(c => {
              const u = c.unit || '';
              if (c.type === 'toggle') out += `- ${c.label}: ${c.value ? 'on' : 'off'}\n`;
              else out += `- ${c.label}: ${c.value}${u}\n`;
            });
          }
          return out;
        },
        copyDirection() {
          let full = this.generateDirection();
          const notes = this.finalizeNotes.trim();
          if (notes) full += `\n### Additional Notes\n${notes}\n`;
          navigator.clipboard.writeText(full);
          this.copiedDirection = true;
          setTimeout(() => { this.copiedDirection = false; }, 2000);
        },

        // --- Keyboard ---
        handleKey(e) {
          if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
          switch(e.key) {
            case 'ArrowRight': case 'ArrowDown': this.next(); break;
            case 'ArrowLeft': case 'ArrowUp': this.prev(); break;
            case '0': this.rate(0); break;
            case '1': case '2': case '3': case '4': case '5': this.rate(+e.key); break;
            case 'l': case 'L': this.showControls = !this.showControls; break;
            case 'e': case 'E': this.showExport = !this.showExport; break;
            case 'r': case 'R': this.replayVariation(); break;
            case '?': this.showShortcuts = !this.showShortcuts; break;
            case 'Escape': this.showControls = false; this.showExport = false; this.showFinalize = false; this.showShortcuts = false; break;
          }
        },

        // --- Persistence ---
        storageKey(suffix) {
          const dir = (this.meta.sourceDirectory || '').split('/').pop() || this.meta.topic;
          return `design-exploration-${dir}-r${this.meta.round}-${suffix}`;
        },
        saveState() {
          localStorage.setItem(this.storageKey('ratings'), JSON.stringify(this.ratings));
        },
        loadState() {
          try { this.ratings = JSON.parse(localStorage.getItem(this.storageKey('ratings')) || '{}'); } catch(e) {}
          try {
            const cs = JSON.parse(localStorage.getItem(this.storageKey('controls')) || 'null');
            if (cs) {
              this.variations.forEach(v => {
                if (cs[v.id]) v.controls.forEach(c => { if (cs[v.id][c.id] !== undefined) c.value = cs[v.id][c.id]; });
              });
            }
          } catch(e) {}
        },
        saveControlState() {
          const state = {};
          this.variations.forEach(v => {
            state[v.id] = {};
            v.controls.forEach(c => { state[v.id][c.id] = c.value; });
          });
          localStorage.setItem(this.storageKey('controls'), JSON.stringify(state));
        },
      }
    }
  </script>
</body>
</html>
