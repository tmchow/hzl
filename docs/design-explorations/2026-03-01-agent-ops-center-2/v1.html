<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Design Exploration</title>

  <!-- Tailwind Play CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js" defer></script>
  <!-- Google Fonts: Shell (DM Sans, JetBrains Mono) + Variation families -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <!-- Exploration metadata (agent-readable) -->
  <script type="application/json" id="exploration-metadata">
  {
  "project": "HZL Agent Operations Center",
  "topic": "agent-ops-center",
  "round": 1,
  "date": "2026-03-01",
  "previousRound": null,
  "sourceDirectory": "docs/design-explorations/2026-03-01-agent-ops-center-2",
  "families": [
    {
      "letter": "A",
      "name": "Incident Board",
      "approach": "What if stuck agents were treated as incidents requiring triage — problems bubble to the top as actionable alerts with context, healthy agents compress into a background roster?"
    },
    {
      "letter": "B",
      "name": "Live Feed",
      "approach": "What if the primary view was a real-time activity stream — all agent events flowing through time, where silence gaps become the most visible signal of trouble?"
    },
    {
      "letter": "C",
      "name": "Switchboard",
      "approach": "What if every agent had a persistent always-visible panel — no navigation, no expanding, everything on screen at once like a switchboard operator's console?"
    }
  ],
  "previousVariations": [],
  "variations": [
    {
      "id": "A1",
      "family": "A",
      "familyName": "Incident Board",
      "name": "Alert Queue",
      "layoutType": "Incident Cards + Modal Detail",
      "aesthetic": "Professional Dark",
      "description": "Stuck agents as incident cards at the top with pulsing urgency indicators. Active agents as compact roster below. Click incident to open modal with full session timeline."
    },
    {
      "id": "A2",
      "family": "A",
      "familyName": "Incident Board",
      "name": "Inline Triage",
      "layoutType": "Expandable Incident Rows",
      "aesthetic": "Professional Dark",
      "description": "Stuck agents as auto-expanded rows with inline timeline and context. Active agents as compact table rows. Triage happens in-place without context-switching."
    },
    {
      "id": "A3",
      "family": "A",
      "familyName": "Incident Board",
      "name": "Split Focus",
      "layoutType": "List + Detail Split",
      "aesthetic": "Professional Dark",
      "description": "Left panel: incident list sorted by severity. Right panel: selected agent's full context. Bottom: collapsed roster of healthy agents. Persistent spatial layout."
    },
    {
      "id": "B1",
      "family": "B",
      "familyName": "Live Feed",
      "name": "Chronicle",
      "layoutType": "Full-Width Feed + Floating Sidebar",
      "aesthetic": "Professional Dark",
      "description": "Unified chronological feed of all agent events. Floating sidebar shows agent status chips. Silence gaps rendered as explicit time-gap markers. Click events to highlight agent."
    },
    {
      "id": "B2",
      "family": "B",
      "familyName": "Live Feed",
      "name": "Lane View",
      "layoutType": "Parallel Agent Columns",
      "aesthetic": "Professional Dark",
      "description": "Each agent gets a vertical column showing their events over time. Silence gaps visible as empty space. Stuck lanes show red overlay. Fleet summary bar across top."
    },
    {
      "id": "B3",
      "family": "B",
      "familyName": "Live Feed",
      "name": "Filtered Stream",
      "layoutType": "Tabbed Feed + Inline Detail",
      "aesthetic": "Professional Dark",
      "description": "Agent filter tabs at top. Single unified feed below, filterable by agent. Selecting an agent tab filters and expands events inline. 'All' view interleaves events with agent labels."
    },
    {
      "id": "C1",
      "family": "C",
      "familyName": "Switchboard",
      "name": "Panel Grid",
      "layoutType": "Fixed Agent Grid",
      "aesthetic": "Professional Dark",
      "description": "Responsive grid of agent panels, all visible simultaneously. Each panel: status, task, timers, mini timeline. Stuck panels pulse. No expanding — everything shown."
    },
    {
      "id": "C2",
      "family": "C",
      "familyName": "Switchboard",
      "name": "Status Strips",
      "layoutType": "Horizontal Strip Rows",
      "aesthetic": "Professional Dark",
      "description": "Full-width horizontal strips per agent. Dense data: status, task, progress, timers, inline sparkline. Like htop for agents. Sortable, keyboard-navigable."
    },
    {
      "id": "C3",
      "family": "C",
      "familyName": "Switchboard",
      "name": "Mission Dashboard",
      "layoutType": "Metrics Header + Agent Tiles",
      "aesthetic": "Professional Dark",
      "description": "Top: fleet metrics (counts, avg silence, throughput). Below: agent tiles with embedded micro-charts of event cadence. Each tile is a self-contained monitoring widget."
    }
  ]
}

  </script>

  <style>
    /* === Shell Design Tokens (FIXED — identical in every file) === */
    :root {
      --shell-bg: #0c0c0d;
      --shell-bg-raised: #17191a;
      --shell-bg-hover: #232527;
      --shell-bg-active: #2f3233;
      --shell-border: rgba(255,255,255,0.06);
      --shell-border-hover: rgba(255,255,255,0.1);
      --shell-text: #708a9e;
      --shell-text-bright: #dbe2e7;
      --shell-text-dim: #445664;
      --shell-accent: #62929e;
      --shell-accent-hover: #81a8b1;
      --shell-accent-glow: rgba(98,146,158,0.15);
      --shell-star-filled: #d4a853;
      --shell-star-empty: #445664;
      --shell-radius: 8px;
      --shell-radius-sm: 5px;
      --shell-font-mono: 'JetBrains Mono', monospace;
      --shell-font-ui: 'DM Sans', sans-serif;
      --shell-sidebar-width: 240px;
      --shell-topbar-height: 48px;
    }

    [x-cloak] { display: none !important; }

    /* === Shell Atmosphere === */
    body {
      background: var(--shell-bg);
      background-image:
        radial-gradient(ellipse at 20% 0%, rgba(98,146,158,0.03) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(84,106,123,0.03) 0%, transparent 50%);
      color: #708a9e;
      margin: 0;
      padding: 0;
    }

  </style>
</head>
<body x-data="explorer()" @keydown.window="handleKey($event)"
      class="h-screen overflow-hidden flex" style="font-family: var(--shell-font-ui)">

  <!-- ==================== SIDEBAR ==================== -->
  <aside class="flex flex-col h-full flex-shrink-0"
         style="width: var(--shell-sidebar-width); background: var(--shell-bg-raised); border-right: 1px solid var(--shell-border)">

    <!-- Header (matches topbar height so borders align) -->
    <div class="px-4 flex items-center gap-3 flex-shrink-0"
         style="height: var(--shell-topbar-height); border-bottom: 1px solid var(--shell-border)">
      <span style="color: var(--shell-accent); font-size: 16px; line-height: 1">&#9670;</span>
      <div class="flex flex-col justify-center min-w-0" style="gap: 3px">
        <span style="color: var(--shell-text-bright); font-size: 13px; font-weight: 600; line-height: 1">Design Exploration</span>
        <span style="color: #c6c5b9; font-size: 11px; line-height: 1" class="truncate"
              x-text="meta.project || ''"></span>
      </div>
    </div>

    <!-- Variation List -->
    <div class="flex-1 overflow-y-auto py-3 px-2">
      <template x-for="fam in families" :key="fam.letter">
        <div class="mb-4">
          <!-- Family header — small label, uses silver for legibility -->
          <div class="flex items-center gap-1.5 px-3 mb-1.5 mt-1">
            <span style="font-family: var(--shell-font-mono); font-size: 10px; color: #c6c5b9; font-weight: 500; opacity: 0.6"
                  x-text="fam.letter"></span>
            <span style="font-size: 10px; color: #c6c5b9; text-transform: uppercase; letter-spacing: 0.06em; font-weight: 500; opacity: 0.6"
                  x-text="fam.name"></span>
          </div>
          <!-- Variation items — prominent, indented under family -->
          <template x-for="v in fam.variations" :key="v.id">
            <button @click="selectVariation(v.id)"
                    class="w-full text-left rounded group"
                    style="display: grid; grid-template-columns: auto 1fr; column-gap: 10px; padding: 8px 10px 8px 16px; transition: all 150ms ease; border: none; cursor: pointer"
                    :style="current.id === v.id
                      ? 'background: #2f3233; border-left: 3px solid #62929e; box-shadow: inset 3px 0 12px rgba(98,146,158,0.15); margin-left: 0; padding-left: 13px'
                      : 'border-left: 3px solid transparent; margin-left: 0; padding-left: 13px'"
                    :class="current.id === v.id ? '' : 'hover:bg-[#232527]'">
              <span style="grid-row: 1 / 3; align-self: baseline; font-family: var(--shell-font-mono); font-size: 11px; line-height: 1.4"
                    :style="current.id === v.id ? 'color: #62929e' : 'color: #445664'"
                    x-text="v.id"></span>
              <div class="truncate" style="font-size: 13px; font-weight: 500; line-height: 1.4"
                   :style="current.id === v.id ? 'color: #dbe2e7' : 'color: #708a9e'"
                   x-text="v.name"></div>
              <div class="flex items-center gap-0.5" style="grid-column: 2; min-height: 16px">
                <template x-if="ratings[v.id]?.stars === 0">
                  <span style="color: #ef4444; font-size: 10px">&#10007;</span>
                </template>
                <template x-if="ratings[v.id]?.stars > 0">
                  <span class="flex gap-0.5">
                    <template x-for="s in (ratings[v.id]?.stars || 0)" :key="s">
                      <span style="color: #d4a853; font-size: 9px">&#9733;</span>
                    </template>
                  </span>
                </template>
              </div>
            </button>
          </template>
        </div>
      </template>
    </div>

    <!-- Footer -->
    <div class="px-3 py-3" style="border-top: 1px solid var(--shell-border)">
      <div class="flex items-center gap-1 mb-2 justify-center">
        <template x-for="v in variations" :key="v.id">
          <span class="rounded-full" style="width: 8px; height: 8px"
                :style="ratings[v.id]?.stars == null ? 'background: #33404b'
                  : ratings[v.id].stars === 0 ? 'background: #ef4444'
                  : ratings[v.id].stars >= 4 ? 'background: #d4a853'
                  : ratings[v.id].stars >= 2 ? 'background: #facc15'
                  : 'background: #ef4444'"></span>
        </template>
      </div>
      <div class="text-center mb-2" style="font-size: 12px; color: #445664"
           x-text="reviewedCount + '/' + variations.length + ' reviewed'"></div>
      <button @click="showExport = true"
              class="w-full py-2.5 rounded text-center"
              style="background: #62929e; color: white; font-size: 13px; font-weight: 600; border: none; border-radius: 5px; cursor: pointer; transition: background 150ms"
              @mouseover="$el.style.background='#81a8b1'"
              @mouseout="$el.style.background='#62929e'">Next Round<span x-text="' (' + reviewedCount + '/' + variations.length + ')'"></span></button>
    </div>
  </aside>

  <!-- ==================== MAIN AREA ==================== -->
  <div class="flex-1 flex flex-col min-w-0">

    <!-- TOP BAR -->
    <div class="flex items-center px-4 flex-shrink-0"
         style="height: var(--shell-topbar-height); background: var(--shell-bg-raised); border-bottom: 1px solid var(--shell-border)">
      <!-- Nav arrows -->
      <div class="flex items-center gap-1">
        <button @click="prev()" class="w-8 h-8 flex items-center justify-center rounded"
                style="color: #708a9e; font-family: var(--shell-font-mono); font-size: 16px; background: transparent; border: none; cursor: pointer; transition: all 150ms"
                @mouseover="$el.style.background='#232527';$el.style.color='#dbe2e7'"
                @mouseout="$el.style.background='transparent';$el.style.color='#708a9e'">&larr;</button>
        <button @click="next()" class="w-8 h-8 flex items-center justify-center rounded"
                style="color: #708a9e; font-family: var(--shell-font-mono); font-size: 16px; background: transparent; border: none; cursor: pointer; transition: all 150ms"
                @mouseover="$el.style.background='#232527';$el.style.color='#dbe2e7'"
                @mouseout="$el.style.background='transparent';$el.style.color='#708a9e'">&rarr;</button>
      </div>
      <!-- Current variation info -->
      <div class="flex-1 flex items-center justify-center gap-3">
        <span style="font-family: var(--shell-font-mono); color: var(--shell-accent); font-size: 14px; font-weight: 500"
              x-text="current.id"></span>
        <span style="color: var(--shell-text-bright); font-size: 14px; font-weight: 500"
              x-text="current.name"></span>
        <span class="hidden sm:inline-flex items-center gap-2">
          <span class="rounded-full px-2.5 py-0.5"
                style="background: var(--shell-bg-hover); color: #c6c5b9; font-size: 11px; font-family: var(--shell-font-mono); opacity: 0.7"
                x-text="current.layoutType"></span>
          <span style="color: #c6c5b9; font-size: 11px; opacity: 0.4">&middot;</span>
          <span class="rounded-full px-2.5 py-0.5"
                style="background: var(--shell-bg-hover); color: #c6c5b9; font-size: 11px; font-family: var(--shell-font-mono); opacity: 0.7"
                x-text="current.aesthetic"></span>
        </span>
      </div>
      <!-- Toggles -->
      <div class="flex items-center gap-1">
        <button @click="showShortcuts = !showShortcuts"
                class="w-8 h-8 flex items-center justify-center rounded"
                :style="showShortcuts ? 'background: rgba(98,146,158,0.15); color: #62929e' : 'color: #708a9e'"
                style="font-family: var(--shell-font-mono); font-size: 13px; color: #708a9e; background: transparent; border: none; cursor: pointer; transition: all 150ms; font-weight: 500"
                @mouseover="if(!showShortcuts){$el.style.background='#232527';$el.style.color='#dbe2e7'}"
                @mouseout="if(!showShortcuts){$el.style.background='transparent';$el.style.color='#708a9e'}">?</button>
      </div>
    </div>

    <!-- PREVIEW + TUNE PANEL (side by side) -->
    <div class="flex-1 flex min-h-0">
      <!-- PREVIEW STAGE -->
      <div id="preview-stage"
           class="flex-1 overflow-hidden relative"
           :class="[isTransitioning ? 'opacity-0' : 'opacity-100']"
           style="transition: opacity 150ms ease">
        <iframe x-ref="iframe" @load="onIframeLoad()"
                style="width: 100%; height: 100%; border: none"></iframe>
      </div>

      <!-- TUNE PANEL (right side) -->
      <div x-show="showControls && current.controls.length" x-cloak
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 w-0"
           x-transition:enter-end="opacity-100"
           x-transition:leave="transition ease-in duration-150"
           x-transition:leave-start="opacity-100"
           x-transition:leave-end="opacity-0 w-0"
           class="flex-shrink-0 flex flex-col overflow-hidden"
           style="width: 260px; background: var(--shell-bg-raised); border-left: 1px solid var(--shell-border)">
        <!-- Header -->
        <div class="flex items-center justify-between px-3 flex-shrink-0"
             style="height: var(--shell-topbar-height); border-bottom: 1px solid var(--shell-border)">
          <span style="font-family: var(--shell-font-mono); font-size: 12px; color: var(--shell-text)">Tune</span>
          <button @click="showControls = false"
                  style="color: var(--shell-text-dim); font-size: 16px; transition: color 150ms; background: none; border: none; cursor: pointer"
                  @mouseover="$el.style.color='var(--shell-text-bright)'"
                  @mouseout="$el.style.color='var(--shell-text-dim)'">&times;</button>
        </div>
        <!-- Controls body -->
        <div class="flex-1 p-3 overflow-y-auto">
          <template x-for="control in current.controls" :key="control.id">
            <div class="mb-4">
              <div class="flex justify-between items-center mb-1.5">
                <label style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: var(--shell-text); font-family: var(--shell-font-mono)"
                       x-text="control.label"></label>
                <span x-show="control.type === 'range' && control.value != null"
                      style="font-size: 11px; color: var(--shell-text); font-family: var(--shell-font-mono); font-variant-numeric: tabular-nums"
                      x-text="control.value + (control._displayUnit || control.unit || '')"></span>
              </div>
              <!-- Range -->
              <template x-if="control.type === 'range'">
                <input type="range" :min="control.min" :max="control.max" :step="control.step"
                       :value="control.value"
                       @input="updateControl(control.id, +$event.target.value)"
                       class="w-full h-1.5 rounded-full appearance-none cursor-pointer"
                       style="background: var(--shell-bg); accent-color: var(--shell-accent)">
              </template>
              <!-- Select (segmented) -->
              <template x-if="control.type === 'select'">
                <div class="flex rounded-md overflow-hidden" style="border: 1px solid var(--shell-border)">
                  <template x-for="opt in control.options" :key="opt">
                    <button @click="updateControl(control.id, opt)"
                            class="flex-1 px-2 py-1.5 transition-all duration-150"
                            :style="(control.value === opt
                              ? 'background: var(--shell-accent); color: white'
                              : 'color: var(--shell-text)')
                              + '; font-family: var(--shell-font-mono); font-size: 12px'"
                            x-text="opt"></button>
                  </template>
                </div>
              </template>
              <!-- Toggle -->
              <template x-if="control.type === 'toggle'">
                <div>
                  <button @click="updateControl(control.id, !control.value)"
                          class="rounded-full relative transition-colors duration-200"
                          style="width: 36px; height: 20px; border: none; cursor: pointer; padding: 0; flex-shrink: 0"
                          :style="control.value ? 'background: var(--shell-accent)' : 'background: var(--shell-bg-active)'">
                    <span class="absolute rounded-full transition-all duration-200"
                          style="top: 2px; left: 2px; width: 16px; height: 16px; background: var(--shell-text-bright)"
                          :style="control.value ? 'transform: translateX(16px)' : 'transform: translateX(0)'"></span>
                  </button>
                </div>
              </template>
            </div>
          </template>
        </div>
        <!-- Footer -->
        <div class="px-3 py-2 flex items-center justify-between flex-shrink-0" style="border-top: 1px solid var(--shell-border)">
          <button @click="replayVariation()"
                  class="flex items-center gap-1"
                  style="font-size: 11px; color: var(--shell-text-dim); transition: color 150ms; background: none; border: none; cursor: pointer"
                  @mouseover="$el.style.color='var(--shell-text-bright)'"
                  @mouseout="$el.style.color='var(--shell-text-dim)'">
            <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M1 4v5h5"/><path d="M3.51 10a6 6 0 1 0 .49-5.5L1 9"/>
            </svg>
            Reload
          </button>
          <button @click="resetControls()"
                  style="font-size: 11px; color: var(--shell-text-dim); transition: color 150ms; background: none; border: none; cursor: pointer"
                  @mouseover="$el.style.color='var(--shell-text-bright)'"
                  @mouseout="$el.style.color='var(--shell-text-dim)'">Reset to defaults</button>
        </div>
      </div>
    </div>

    <!-- RATING BAR -->
    <div class="flex items-center gap-5 px-6 flex-shrink-0"
         style="height: 64px; background: #17191a; border-top: 1px solid rgba(255,255,255,0.06)">
      <!-- Skip -->
      <button @click="rate(0)" class="flex items-center justify-center"
              title="Skip — exclude from next round (0)"
              style="width: 32px; height: 32px; font-size: 18px; color: #445664; cursor: pointer; background: none; border: none; padding: 0; transition: all 200ms ease"
              :style="currentRating.stars === 0 ? 'color: #ef4444' : 'color: #445664'"
              @mouseover="$el.style.transform = 'scale(1.15)'"
              @mouseout="$el.style.transform = 'scale(1)'">&#10007;</button>
      <!-- Stars -->
      <div class="flex items-center gap-0.5">
        <template x-for="s in 5" :key="s">
          <button @click="rate(s)" class="flex items-center justify-center"
                  :title="s + ' star' + (s > 1 ? 's' : '') + ' (' + s + ')'"
                  style="width: 32px; height: 32px; font-size: 22px; color: #445664; transition: transform 200ms ease; cursor: pointer; background: none; border: none; padding: 0; line-height: 1"
                  :style="s <= (currentRating.stars || 0) ? 'color: #d4a853' : 'color: #445664'"
                  @mouseover="$el.style.transform = 'scale(1.15)'"
                  @mouseout="$el.style.transform = 'scale(1)'">&#9733;</button>
        </template>
      </div>
      <!-- Divider -->
      <div style="width: 1px; height: 24px; background: rgba(255,255,255,0.08)"></div>
      <!-- Tune -->
      <button x-show="current.controls.length" @click="showControls = !showControls"
              class="flex items-center gap-1.5 rounded flex-shrink-0"
              style="padding: 6px 10px; font-family: var(--shell-font-mono); font-size: 12px; border: 1px solid var(--shell-border); cursor: pointer; transition: all 150ms"
              :style="showControls
                ? 'background: rgba(98,146,158,0.15); color: var(--shell-accent); border-color: rgba(98,146,158,0.3)'
                : 'background: transparent; color: var(--shell-text)'"
              @mouseover="if(!showControls){$el.style.background='var(--shell-bg-hover)';$el.style.color='var(--shell-text-bright)'}"
              @mouseout="if(!showControls){$el.style.background='transparent';$el.style.color='var(--shell-text)'}">
        <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
          <line x1="2" y1="4" x2="14" y2="4"/><circle cx="5" cy="4" r="1.5" fill="currentColor" stroke="none"/>
          <line x1="2" y1="8" x2="14" y2="8"/><circle cx="11" cy="8" r="1.5" fill="currentColor" stroke="none"/>
          <line x1="2" y1="12" x2="14" y2="12"/><circle cx="7" cy="12" r="1.5" fill="currentColor" stroke="none"/>
        </svg>
        Tune
      </button>
      <!-- Notes -->
      <input type="text" class="flex-1"
             :value="currentRating.notes"
             @input="updateNotes($event.target.value)"
             placeholder="Add a note about this variation..."
             style="background: #0c0c0d; border: 1px solid rgba(255,255,255,0.1); color: #dbe2e7; font-family: var(--shell-font-ui); font-size: 13px; padding: 8px 14px; border-radius: 5px; outline: none; transition: border-color 150ms"
             onfocus="this.style.borderColor='rgba(255,255,255,0.18)'"
             onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
      <!-- Ship It -->
      <button @click="openFinalize()"
              class="flex items-center gap-1.5 flex-shrink-0 rounded"
              style="padding: 8px 14px; font-size: 13px; font-weight: 600; border: none; cursor: pointer; transition: all 150ms; background: transparent; color: var(--shell-accent); border: 1px solid rgba(98,146,158,0.3)"
              @mouseover="$el.style.background='rgba(98,146,158,0.15)'"
              @mouseout="$el.style.background='transparent'">Ship It ⛵</button>
    </div>
  </div>

  <!-- ==================== EXPORT MODAL ==================== -->
  <div x-show="showExport" class="fixed inset-0 z-50 flex items-center justify-center"
       x-transition:enter="transition ease-out duration-200"
       x-transition:enter-start="opacity-0"
       x-transition:enter-end="opacity-100"
       x-transition:leave="transition ease-in duration-150"
       x-transition:leave-start="opacity-100"
       x-transition:leave-end="opacity-0">
    <div class="absolute inset-0" style="background: rgba(0,0,0,0.6); backdrop-filter: blur(8px)" @click="showExport = false"></div>
    <div class="relative flex flex-col"
         style="width: 640px; max-height: 80vh; background: var(--shell-bg-raised); border: 1px solid var(--shell-border); border-radius: var(--shell-radius); box-shadow: 0 4px 24px rgba(0,0,0,0.4), 0 1px 4px rgba(0,0,0,0.3)"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100">
      <!-- Header -->
      <div class="flex items-center justify-between px-5 py-3" style="border-bottom: 1px solid var(--shell-border)">
        <span style="color: var(--shell-text-bright); font-size: 15px; font-weight: 600">Export Feedback</span>
        <button @click="showExport = false"
                style="color: var(--shell-text-dim); font-size: 20px; background: none; border: none; cursor: pointer; transition: color 150ms"
                @mouseover="$el.style.color='var(--shell-text-bright)'"
                @mouseout="$el.style.color='var(--shell-text-dim)'">&times;</button>
      </div>
      <!-- Body -->
      <div class="flex-1 overflow-y-auto p-5">
        <pre class="p-4 rounded overflow-x-auto whitespace-pre-wrap mb-4"
             style="background: var(--shell-bg); border: 1px solid var(--shell-border); border-radius: var(--shell-radius-sm); font-family: var(--shell-font-mono); font-size: 13px; color: var(--shell-text-bright); user-select: all"
             x-text="generateFeedback()"></pre>
        <label style="display: block; font-size: 12px; color: var(--shell-text-dim); margin-bottom: 6px; font-weight: 500">Direction for Next Round</label>
        <textarea x-model="directionText"
                  rows="5"
                  placeholder="What should the next round focus on? Which directions to keep, drop, or explore further..."
                  style="width: 100%; background: var(--shell-bg); border: 1px solid var(--shell-border); color: var(--shell-text-bright); font-family: var(--shell-font-ui); font-size: 13px; padding: 12px; border-radius: var(--shell-radius-sm); outline: none; resize: vertical; transition: border-color 150ms"
                  onfocus="this.style.borderColor='rgba(255,255,255,0.1)'"
                  onblur="this.style.borderColor='rgba(255,255,255,0.06)'"></textarea>
      </div>
      <!-- Footer -->
      <div class="px-5 py-3 flex-shrink-0" style="border-top: 1px solid var(--shell-border)">
        <button @click="copyFeedback()"
                class="w-full py-2.5 rounded text-white text-center"
                style="background: var(--shell-accent); font-size: 13px; font-weight: 600; border-radius: var(--shell-radius-sm); transition: background 150ms"
                @mouseover="$el.style.background='var(--shell-accent-hover)'"
                @mouseout="$el.style.background='var(--shell-accent)'"
                x-text="copiedFeedback ? '&#10003; Copied!' : 'Copy to Clipboard'"></button>
      </div>
    </div>
  </div>

  <!-- ==================== FINALIZE MODAL ==================== -->
  <div x-show="showFinalize" class="fixed inset-0 z-50 flex items-center justify-center"
       x-transition:enter="transition ease-out duration-200"
       x-transition:enter-start="opacity-0"
       x-transition:enter-end="opacity-100"
       x-transition:leave="transition ease-in duration-150"
       x-transition:leave-start="opacity-100"
       x-transition:leave-end="opacity-0">
    <div class="absolute inset-0" style="background: rgba(0,0,0,0.6); backdrop-filter: blur(8px)" @click="showFinalize = false"></div>
    <div class="relative flex flex-col"
         style="width: 640px; max-height: 80vh; background: var(--shell-bg-raised); border: 1px solid var(--shell-border); border-radius: var(--shell-radius); box-shadow: 0 4px 24px rgba(0,0,0,0.4), 0 1px 4px rgba(0,0,0,0.3)"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100">
      <!-- Header -->
      <div class="flex items-center justify-between px-5 py-3" style="border-bottom: 1px solid var(--shell-border)">
        <div class="flex items-center gap-3">
          <span style="color: var(--shell-text-bright); font-size: 15px; font-weight: 600">Go With This</span>
          <span style="color: var(--shell-accent); font-family: var(--shell-font-mono); font-size: 13px" x-text="current.id"></span>
          <span style="color: var(--shell-text); font-size: 13px" x-text="current.name"></span>
        </div>
        <button @click="showFinalize = false"
                style="color: var(--shell-text-dim); font-size: 20px; background: none; border: none; cursor: pointer; transition: color 150ms"
                @mouseover="$el.style.color='var(--shell-text-bright)'"
                @mouseout="$el.style.color='var(--shell-text-dim)'">&times;</button>
      </div>
      <!-- Body -->
      <div class="flex-1 overflow-y-auto p-5">
        <pre class="p-4 rounded overflow-x-auto whitespace-pre-wrap mb-4"
             style="background: var(--shell-bg); border: 1px solid var(--shell-border); border-radius: var(--shell-radius-sm); font-family: var(--shell-font-mono); font-size: 13px; color: var(--shell-text-bright); user-select: all"
             x-text="generateDirection()"></pre>
        <label style="display: block; font-size: 12px; color: var(--shell-text-dim); margin-bottom: 6px; font-weight: 500">Notes</label>
        <textarea x-model="finalizeNotes"
                  rows="5"
                  placeholder="What matters most about this direction? Any elements to borrow from other variations? Constraints for implementation..."
                  style="width: 100%; background: var(--shell-bg); border: 1px solid var(--shell-border); color: var(--shell-text-bright); font-family: var(--shell-font-ui); font-size: 13px; padding: 12px; border-radius: var(--shell-radius-sm); outline: none; resize: vertical; transition: border-color 150ms"
                  onfocus="this.style.borderColor='rgba(255,255,255,0.1)'"
                  onblur="this.style.borderColor='rgba(255,255,255,0.06)'"></textarea>
      </div>
      <!-- Footer -->
      <div class="px-5 py-3 flex-shrink-0" style="border-top: 1px solid var(--shell-border)">
        <button @click="copyDirection()"
                class="w-full py-2.5 rounded text-white text-center"
                style="background: var(--shell-accent); font-size: 13px; font-weight: 600; border-radius: var(--shell-radius-sm); transition: background 150ms"
                @mouseover="$el.style.background='var(--shell-accent-hover)'"
                @mouseout="$el.style.background='var(--shell-accent)'"
                x-text="copiedDirection ? '&#10003; Copied!' : 'Copy Direction'"></button>
      </div>
    </div>
  </div>

  <!-- ==================== KEYBOARD SHORTCUTS OVERLAY ==================== -->
  <div x-show="showShortcuts" class="fixed inset-0 z-50 flex items-center justify-center"
       x-transition:enter="transition ease-out duration-200"
       x-transition:enter-start="opacity-0"
       x-transition:enter-end="opacity-100"
       x-transition:leave="transition ease-in duration-150"
       x-transition:leave-start="opacity-100"
       x-transition:leave-end="opacity-0">
    <div class="absolute inset-0" style="background: rgba(0,0,0,0.5); backdrop-filter: blur(4px)" @click="showShortcuts = false"></div>
    <div class="relative p-5" style="width: 420px; background: var(--shell-bg-raised); border: 1px solid var(--shell-border); border-radius: var(--shell-radius); box-shadow: 0 4px 24px rgba(0,0,0,0.4)">
      <div class="flex items-center justify-between mb-4">
        <span style="color: var(--shell-text-bright); font-size: 15px; font-weight: 600">Keyboard Shortcuts</span>
        <button @click="showShortcuts = false"
                style="color: var(--shell-text-dim); font-size: 20px; background: none; border: none; cursor: pointer">&times;</button>
      </div>
      <div class="grid grid-cols-2 gap-3" style="font-size: 13px">
        <template x-for="s in [
          ['\u2190 \u2192', 'Previous / Next'],
          ['0', 'Skip (mark as skip)'],
          ['1-5', 'Rate (stars)'],
          ['L', 'Toggle Tune'],
          ['R', 'Reload Variation'],
          ['E', 'Open Export'],
          ['?', 'Show Shortcuts'],
          ['Esc', 'Close Panels']
        ]" :key="s[0]">
          <div class="flex items-center gap-3">
            <kbd class="inline-flex items-center justify-center px-2 py-1 rounded"
                 style="background: var(--shell-bg); border: 1px solid var(--shell-border); font-family: var(--shell-font-mono); font-size: 12px; color: var(--shell-text-bright); min-width: 32px; box-shadow: 0 1px 2px rgba(0,0,0,0.2)"
                 x-text="s[0]"></kbd>
            <span style="color: var(--shell-text)" x-text="s[1]"></span>
          </div>
        </template>
      </div>
    </div>
  </div>

  <!-- ==================== VARIATION TEMPLATES ==================== -->
    <template id="tpl-a1">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script type="application/json" id="variation-meta">
  {
    "id": "A1",
    "family": "A",
    "familyName": "Incident Board",
    "name": "Alert Queue",
    "layoutType": "Incident Cards + Modal Detail",
    "aesthetic": "Professional Dark",
    "description": "Stuck agents as dominant incident cards with pulsing red borders, active agents in a compact roster table, idle agents as chips. Clicking a card opens a rich diagnostic modal.",
    "controls": [
      {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["5 min", "10 min", "15 min", "30 min"],
        "cssValues": { "5 min": "5", "10 min": "10", "15 min": "15", "30 min": "30" },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
      },
      {
        "id": "card-height",
        "label": "Card Height",
        "type": "range",
        "min": 160, "max": 320, "step": 20,
        "options": null,
        "value": 220,
        "defaultValue": 220,
        "unit": "px",
        "cssVar": "--incident-card-height"
      },
      {
        "id": "alert-animation",
        "label": "Alert Animation",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["pulse", "glow", "static"],
        "cssValues": { "pulse": "pulse", "glow": "glow", "static": "none" },
        "value": "pulse",
        "defaultValue": "pulse",
        "unit": "",
        "cssVar": "--alert-animation",
        "event": true
      },
      {
        "id": "roster-density",
        "label": "Roster Density",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["compact", "comfortable"],
        "cssValues": { "compact": "36px", "comfortable": "52px" },
        "value": "comfortable",
        "defaultValue": "comfortable",
        "unit": "",
        "cssVar": "--roster-row-height"
      },
      {
        "id": "show-session",
        "label": "Show Session Preview",
        "type": "toggle",
        "min": null, "max": null, "step": null,
        "options": null,
        "cssValues": { "true": "block", "false": "none" },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--session-preview-display"
      },
      {
        "id": "idle-agents",
        "label": "Idle Agents",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["show", "count only", "hide"],
        "cssValues": { "show": "flex", "count only": "inline-flex", "hide": "none" },
        "value": "show",
        "defaultValue": "show",
        "unit": "",
        "cssVar": "--idle-display",
        "event": true
      }
    ]
  }
  </script>
  <style>
    :root {
      --bg: #0f1117;
      --panel: #1a1d27;
      --border: #2a2d3a;
      --text: #e2e4e9;
      --text-dim: #8b8fa3;
      --stuck: #ef4444;
      --active: #3b82f6;
      --idle: #6b7280;
      --healthy: #22c55e;
      --font-sans: 'Inter', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --radius: 8px;
      --incident-card-height: 220px;
      --roster-row-height: 52px;
      --session-preview-display: block;
      --idle-display: flex;
      --stuck-threshold: 5;
      --alert-animation: pulse;
    }

    :root * {
      transition: color 0.3s ease, background-color 0.3s ease,
                  border-color 0.3s ease, padding 0.3s ease,
                  gap 0.3s ease, font-size 0.3s ease,
                  border-radius 0.3s ease, box-shadow 0.3s ease,
                  max-width 0.3s ease, width 0.3s ease,
                  height 0.3s ease, min-height 0.3s ease;
    }

    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: var(--font-sans);
      margin: 0;
    }

    .font-mono {
      font-family: var(--font-mono);
    }

    /* Incident card height controlled via CSS var */
    .incident-card {
      min-height: var(--incident-card-height);
      border-radius: var(--radius);
      border: 2px solid var(--stuck);
      background: var(--panel);
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }

    /* Animation classes */
    .incident-card.anim-pulse {
      animation: borderPulse 2s ease-in-out infinite;
    }
    .incident-card.anim-glow {
      box-shadow: 0 0 20px color-mix(in srgb, var(--stuck) 40%, transparent),
                  0 0 40px color-mix(in srgb, var(--stuck) 20%, transparent);
      animation: glowPulse 2s ease-in-out infinite;
    }
    .incident-card.anim-static {
      /* no animation */
    }

    @keyframes borderPulse {
      0%, 100% { border-color: var(--stuck); opacity: 1; }
      50% { border-color: color-mix(in srgb, var(--stuck) 50%, transparent); opacity: 0.85; }
    }

    @keyframes glowPulse {
      0%, 100% {
        box-shadow: 0 0 20px color-mix(in srgb, var(--stuck) 40%, transparent),
                    0 0 40px color-mix(in srgb, var(--stuck) 20%, transparent);
      }
      50% {
        box-shadow: 0 0 30px color-mix(in srgb, var(--stuck) 60%, transparent),
                    0 0 60px color-mix(in srgb, var(--stuck) 30%, transparent);
      }
    }

    /* Roster row height */
    .roster-row {
      height: var(--roster-row-height);
    }

    /* Session preview display */
    .session-preview {
      display: var(--session-preview-display);
    }

    /* Incident badge pulse dot */
    .pulse-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--stuck);
      animation: dotPulse 1.5s ease-in-out infinite;
      flex-shrink: 0;
    }

    @keyframes dotPulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.4); opacity: 0.7; }
    }

    .active-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--active);
      flex-shrink: 0;
    }

    /* Progress bar */
    .progress-bar-track {
      background: color-mix(in srgb, var(--border) 80%, transparent);
      border-radius: 2px;
      height: 4px;
      overflow: hidden;
    }

    .progress-bar-fill-stuck {
      background: var(--stuck);
      height: 100%;
      border-radius: 2px;
    }

    .progress-bar-fill-active {
      background: var(--active);
      height: 100%;
      border-radius: 2px;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(4px);
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .modal-panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 100%;
      max-width: 680px;
      max-height: 85vh;
      overflow-y: auto;
    }

    /* Timeline */
    .timeline-line {
      position: absolute;
      left: 7px;
      top: 16px;
      bottom: 0;
      width: 2px;
      background: var(--border);
    }

    .timeline-dot-stuck {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: color-mix(in srgb, var(--stuck) 20%, var(--panel));
      border: 2px solid var(--stuck);
      flex-shrink: 0;
    }

    .timeline-dot-active {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: color-mix(in srgb, var(--active) 20%, var(--panel));
      border: 2px solid var(--active);
      flex-shrink: 0;
    }

    .timeline-dot-neutral {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: color-mix(in srgb, var(--text-dim) 20%, var(--panel));
      border: 2px solid var(--border);
      flex-shrink: 0;
    }

    /* Idle chips */
    .idle-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: color-mix(in srgb, var(--idle) 12%, var(--panel));
      border: 1px solid color-mix(in srgb, var(--idle) 30%, var(--border));
      border-radius: 20px;
      padding: 4px 12px;
      font-size: 12px;
      color: var(--text-dim);
      font-family: var(--font-mono);
    }

    /* Entrance animations */
    .fade-in {
      animation: fadeIn 0.4s ease forwards;
      opacity: 0;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in-1 { animation-delay: 0.05s; }
    .fade-in-2 { animation-delay: 0.1s; }
    .fade-in-3 { animation-delay: 0.15s; }
    .fade-in-4 { animation-delay: 0.2s; }
    .fade-in-5 { animation-delay: 0.25s; }
    .fade-in-6 { animation-delay: 0.3s; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

    /* Incident card hover */
    .incident-card:hover {
      border-color: color-mix(in srgb, var(--stuck) 80%, #fff);
      background: color-mix(in srgb, var(--panel) 95%, var(--stuck));
    }

    /* Roster row hover */
    .roster-row:hover {
      background: color-mix(in srgb, var(--active) 6%, var(--panel));
    }

    /* Tag chips */
    .tag-chip {
      font-family: var(--font-mono);
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 4px;
      background: color-mix(in srgb, var(--active) 15%, var(--panel));
      color: var(--active);
      border: 1px solid color-mix(in srgb, var(--active) 30%, transparent);
    }

    .tag-chip-stuck {
      font-family: var(--font-mono);
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 4px;
      background: color-mix(in srgb, var(--stuck) 15%, var(--panel));
      color: var(--stuck);
      border: 1px solid color-mix(in srgb, var(--stuck) 30%, transparent);
    }

    /* Silent counter */
    .silent-counter {
      font-family: var(--font-mono);
      font-size: 28px;
      font-weight: 600;
      color: var(--stuck);
      line-height: 1;
    }

    /* Section label */
    .section-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-dim);
    }

    /* Close button */
    .close-btn:hover {
      background: color-mix(in srgb, var(--text-dim) 20%, transparent);
    }
  </style>
</head>
<body>
  <div id="app" class="overflow-auto" style="min-height: 100vh; background: var(--bg);">

    <!-- Fleet Summary Bar -->
    <div class="fade-in fade-in-1 sticky top-0 z-40 border-b" style="background: color-mix(in srgb, var(--panel) 95%, var(--bg)); border-color: var(--border);">
      <div class="flex items-center justify-between px-6 py-3">
        <div class="flex items-center gap-6">
          <span class="font-semibold text-sm" style="color: var(--text);">Agent Operations</span>
          <div class="flex items-center gap-4 text-sm">
            <span class="flex items-center gap-2">
              <span class="w-2 h-2 rounded-full" style="background: var(--active);"></span>
              <span style="color: var(--text);" class="font-medium" id="active-count">4 active</span>
            </span>
            <span class="flex items-center gap-2">
              <span class="w-2 h-2 rounded-full" style="background: var(--stuck);"></span>
              <span style="color: var(--stuck);" class="font-medium" id="stuck-count">2 stuck</span>
            </span>
            <span class="flex items-center gap-2">
              <span class="w-2 h-2 rounded-full" style="background: var(--idle);"></span>
              <span style="color: var(--text-dim);" class="font-medium" id="idle-count">2 idle</span>
            </span>
          </div>
        </div>
        <div class="flex items-center gap-2 text-xs" style="color: var(--text-dim);">
          <span>8 agents total</span>
          <span style="color: var(--border);">·</span>
          <span>Threshold: <span id="threshold-label" class="font-mono" style="color: var(--text);">5 min</span></span>
        </div>
      </div>
    </div>

    <div class="px-6 py-5 max-w-6xl mx-auto">

      <!-- Incidents Section -->
      <div class="mb-6 fade-in fade-in-2">
        <div class="flex items-center gap-3 mb-4">
          <span class="pulse-dot"></span>
          <span class="section-label">Incidents</span>
          <span id="incident-count-badge" class="text-xs px-2 py-0.5 rounded-full font-medium" style="background: color-mix(in srgb, var(--stuck) 20%, var(--panel)); color: var(--stuck); border: 1px solid color-mix(in srgb, var(--stuck) 30%, transparent);">2 agents stuck</span>
        </div>

        <div id="incident-cards" class="grid gap-4" style="grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));">

          <!-- Incident Card: claude-opus-7 -->
          <div class="incident-card anim-pulse fade-in fade-in-2 p-5 flex flex-col gap-3"
               data-agent="claude-opus-7"
               data-silence="12"
               onclick="openModal('claude-opus-7')">
            <!-- Card Header -->
            <div class="flex items-start justify-between">
              <div class="flex flex-col gap-1">
                <div class="flex items-center gap-2">
                  <div class="pulse-dot"></div>
                  <span class="font-mono text-sm font-semibold" style="color: var(--stuck);">claude-opus-7</span>
                  <span class="tag-chip-stuck">STUCK</span>
                </div>
                <span class="text-xs" style="color: var(--text-dim);">Claimed 18m ago</span>
              </div>
              <div class="text-right">
                <div class="silent-counter">12m</div>
                <div class="text-xs mt-0.5" style="color: var(--text-dim);">silent</div>
              </div>
            </div>

            <!-- Task Info -->
            <div>
              <div class="text-sm font-medium mb-1" style="color: var(--text);">Implement auth middleware</div>
              <span class="tag-chip">api-v2</span>
            </div>

            <!-- Progress -->
            <div>
              <div class="flex items-center justify-between mb-1.5">
                <span class="text-xs" style="color: var(--text-dim);">Progress</span>
                <span class="font-mono text-xs font-medium" style="color: var(--stuck);">35%</span>
              </div>
              <div class="progress-bar-track">
                <div class="progress-bar-fill-stuck" style="width: 35%;"></div>
              </div>
            </div>

            <!-- Session Preview -->
            <div class="session-preview">
              <div class="text-xs mb-2" style="color: var(--text-dim);">Last events</div>
              <div class="flex flex-col gap-1.5">
                <div class="flex items-center gap-2 text-xs">
                  <span class="font-mono" style="color: var(--text-dim);">12m</span>
                  <span style="color: var(--text);">Analyzing JWT library options</span>
                </div>
                <div class="flex items-center gap-2 text-xs">
                  <span class="font-mono" style="color: var(--text-dim);">15m</span>
                  <span style="color: var(--text);">Reading existing auth code</span>
                </div>
                <div class="flex items-center gap-2 text-xs">
                  <span class="font-mono" style="color: var(--text-dim);">18m</span>
                  <span style="color: var(--text-dim);">Task claimed</span>
                </div>
              </div>
            </div>

            <!-- Click hint -->
            <div class="flex items-center justify-end mt-auto">
              <span class="text-xs" style="color: color-mix(in srgb, var(--stuck) 60%, transparent);">Click to investigate →</span>
            </div>
          </div>

          <!-- Incident Card: claude-sonnet-8 -->
          <div class="incident-card anim-pulse fade-in fade-in-3 p-5 flex flex-col gap-3"
               data-agent="claude-sonnet-8"
               data-silence="22"
               onclick="openModal('claude-sonnet-8')">
            <!-- Card Header -->
            <div class="flex items-start justify-between">
              <div class="flex flex-col gap-1">
                <div class="flex items-center gap-2">
                  <div class="pulse-dot"></div>
                  <span class="font-mono text-sm font-semibold" style="color: var(--stuck);">claude-sonnet-8</span>
                  <span class="tag-chip-stuck">STUCK</span>
                </div>
                <span class="text-xs" style="color: var(--text-dim);">Claimed 30m ago</span>
              </div>
              <div class="text-right">
                <div class="silent-counter">22m</div>
                <div class="text-xs mt-0.5" style="color: var(--text-dim);">silent</div>
              </div>
            </div>

            <!-- Task Info -->
            <div>
              <div class="text-sm font-medium mb-1" style="color: var(--text);">Fix pagination bug</div>
              <span class="tag-chip">web</span>
            </div>

            <!-- Progress -->
            <div>
              <div class="flex items-center justify-between mb-1.5">
                <span class="text-xs" style="color: var(--text-dim);">Progress</span>
                <span class="font-mono text-xs font-medium" style="color: var(--stuck);">20%</span>
              </div>
              <div class="progress-bar-track">
                <div class="progress-bar-fill-stuck" style="width: 20%;"></div>
              </div>
            </div>

            <!-- Session Preview -->
            <div class="session-preview">
              <div class="text-xs mb-2" style="color: var(--text-dim);">Last events</div>
              <div class="flex flex-col gap-1.5">
                <div class="flex items-center gap-2 text-xs">
                  <span class="font-mono" style="color: var(--text-dim);">22m</span>
                  <span style="color: var(--text);">Investigating offset calculation</span>
                </div>
                <div class="flex items-center gap-2 text-xs">
                  <span class="font-mono" style="color: var(--text-dim);">25m</span>
                  <span style="color: var(--text);">Reading cursor implementation</span>
                </div>
                <div class="flex items-center gap-2 text-xs">
                  <span class="font-mono" style="color: var(--text-dim);">30m</span>
                  <span style="color: var(--text-dim);">Task claimed</span>
                </div>
              </div>
            </div>

            <!-- Click hint -->
            <div class="flex items-center justify-end mt-auto">
              <span class="text-xs" style="color: color-mix(in srgb, var(--stuck) 60%, transparent);">Click to investigate →</span>
            </div>
          </div>

        </div>
      </div>

      <!-- Active Agents Section -->
      <div class="mb-6 fade-in fade-in-4">
        <div class="flex items-center gap-3 mb-4">
          <div class="active-dot"></div>
          <span class="section-label">Active</span>
          <span class="text-xs" style="color: var(--text-dim);">4 agents working</span>
        </div>

        <div class="rounded-[var(--radius)] overflow-hidden border" style="border-color: var(--border); background: var(--panel);">
          <!-- Table Header -->
          <div class="grid text-xs font-medium px-4 py-2.5 border-b" style="grid-template-columns: 1fr 1.6fr 80px 90px 1fr; color: var(--text-dim); border-color: var(--border); background: color-mix(in srgb, var(--border) 30%, var(--panel));">
            <span>Agent</span>
            <span>Task</span>
            <span>Progress</span>
            <span>Project</span>
            <span>Last Event</span>
          </div>

          <!-- claude-sonnet-3 -->
          <div class="roster-row grid items-center px-4 border-b cursor-default"
               style="grid-template-columns: 1fr 1.6fr 80px 90px 1fr; border-color: var(--border);">
            <div class="flex items-center gap-2">
              <span class="w-1.5 h-1.5 rounded-full flex-shrink-0" style="background: var(--active);"></span>
              <span class="font-mono text-xs font-medium" style="color: var(--text);">claude-sonnet-3</span>
            </div>
            <span class="text-sm truncate pr-3" style="color: var(--text);">Add search API endpoint</span>
            <div class="flex items-center gap-2">
              <div class="progress-bar-track flex-1" style="height: 3px;">
                <div class="progress-bar-fill-active" style="width: 60%;"></div>
              </div>
              <span class="font-mono text-xs" style="color: var(--active);">60%</span>
            </div>
            <span class="tag-chip">api-v2</span>
            <span class="text-xs" style="color: var(--text-dim);">1m ago</span>
          </div>

          <!-- claude-haiku-2 -->
          <div class="roster-row grid items-center px-4 border-b cursor-default"
               style="grid-template-columns: 1fr 1.6fr 80px 90px 1fr; border-color: var(--border);">
            <div class="flex items-center gap-2">
              <span class="w-1.5 h-1.5 rounded-full flex-shrink-0" style="background: var(--active);"></span>
              <span class="font-mono text-xs font-medium" style="color: var(--text);">claude-haiku-2</span>
            </div>
            <span class="text-sm truncate pr-3" style="color: var(--text);">Write unit tests for TaskService</span>
            <div class="flex items-center gap-2">
              <div class="progress-bar-track flex-1" style="height: 3px;">
                <div class="progress-bar-fill-active" style="width: 40%;"></div>
              </div>
              <span class="font-mono text-xs" style="color: var(--active);">40%</span>
            </div>
            <span class="tag-chip">core</span>
            <span class="text-xs" style="color: var(--text-dim);">3m ago</span>
          </div>

          <!-- gemini-pro-1 -->
          <div class="roster-row grid items-center px-4 border-b cursor-default"
               style="grid-template-columns: 1fr 1.6fr 80px 90px 1fr; border-color: var(--border);">
            <div class="flex items-center gap-2">
              <span class="w-1.5 h-1.5 rounded-full flex-shrink-0" style="background: var(--healthy);"></span>
              <span class="font-mono text-xs font-medium" style="color: var(--text);">gemini-pro-1</span>
            </div>
            <span class="text-sm truncate pr-3" style="color: var(--text);">Refactor database queries</span>
            <div class="flex items-center gap-2">
              <div class="progress-bar-track flex-1" style="height: 3px;">
                <div class="progress-bar-fill-active" style="width: 75%;"></div>
              </div>
              <span class="font-mono text-xs" style="color: var(--active);">75%</span>
            </div>
            <span class="tag-chip">core</span>
            <span class="text-xs" style="color: var(--healthy);">30s ago</span>
          </div>

          <!-- gpt-4o-agent -->
          <div class="roster-row grid items-center px-4 cursor-default"
               style="grid-template-columns: 1fr 1.6fr 80px 90px 1fr;">
            <div class="flex items-center gap-2">
              <span class="w-1.5 h-1.5 rounded-full flex-shrink-0" style="background: var(--active);"></span>
              <span class="font-mono text-xs font-medium" style="color: var(--text);">gpt-4o-agent</span>
            </div>
            <span class="text-sm truncate pr-3" style="color: var(--text);">Update API documentation</span>
            <div class="flex items-center gap-2">
              <div class="progress-bar-track flex-1" style="height: 3px;">
                <div class="progress-bar-fill-active" style="width: 25%;"></div>
              </div>
              <span class="font-mono text-xs" style="color: var(--active);">25%</span>
            </div>
            <span class="tag-chip">docs</span>
            <span class="text-xs" style="color: var(--text-dim);">2m ago</span>
          </div>

        </div>
      </div>

      <!-- Idle Agents Section -->
      <div id="idle-section" class="fade-in fade-in-5">
        <div class="flex items-center gap-3 mb-3">
          <span class="w-2 h-2 rounded-full" style="background: var(--idle);"></span>
          <span class="section-label">Idle</span>
          <span id="idle-count-label" class="text-xs" style="color: var(--text-dim);">2 agents available</span>
        </div>

        <div id="idle-chips-container" class="flex flex-wrap gap-2">
          <div class="idle-chip" data-idle-chip>
            <span class="w-1.5 h-1.5 rounded-full flex-shrink-0" style="background: var(--idle);"></span>
            <span>claude-opus-5</span>
            <span style="color: color-mix(in srgb, var(--text-dim) 60%, transparent);">·</span>
            <span style="color: color-mix(in srgb, var(--text-dim) 70%, transparent);">8m idle</span>
          </div>
          <div class="idle-chip" data-idle-chip>
            <span class="w-1.5 h-1.5 rounded-full flex-shrink-0" style="background: var(--idle);"></span>
            <span>claude-haiku-9</span>
            <span style="color: color-mix(in srgb, var(--text-dim) 60%, transparent);">·</span>
            <span style="color: color-mix(in srgb, var(--text-dim) 70%, transparent);">3m idle</span>
          </div>
        </div>

        <div id="idle-count-only" class="hidden">
          <span class="idle-chip">
            <span class="w-1.5 h-1.5 rounded-full" style="background: var(--idle);"></span>
            <span>2 idle agents</span>
          </span>
        </div>
      </div>

    </div><!-- end main content -->

  </div><!-- end app -->

  <!-- Modal Overlay -->
  <div id="modal-backdrop" class="modal-backdrop" onclick="handleBackdropClick(event)">
    <div class="modal-panel" id="modal-panel" onclick="event.stopPropagation()">

      <!-- Modal Header -->
      <div class="flex items-start justify-between p-6 border-b" style="border-color: var(--border);">
        <div>
          <div class="flex items-center gap-3 mb-2">
            <div class="pulse-dot"></div>
            <span class="font-mono text-base font-semibold" id="modal-agent-name" style="color: var(--stuck);">claude-opus-7</span>
            <span class="tag-chip-stuck text-xs">STUCK</span>
          </div>
          <div class="text-sm font-medium" id="modal-task-title" style="color: var(--text);">Implement auth middleware</div>
          <div class="flex items-center gap-2 mt-1">
            <span class="tag-chip" id="modal-project">api-v2</span>
            <span class="text-xs" id="modal-claimed" style="color: var(--text-dim);">Claimed 18m ago</span>
          </div>
        </div>
        <button class="close-btn rounded-[var(--radius)] p-2 text-xs" style="color: var(--text-dim);" onclick="closeModal()">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M12 4L4 12M4 4l8 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <!-- Metrics Row -->
      <div class="grid grid-cols-4 gap-px border-b" style="border-color: var(--border); background: var(--border);">
        <div class="p-4" style="background: var(--panel);">
          <div class="text-xs mb-1" style="color: var(--text-dim);">Silent for</div>
          <div class="font-mono text-xl font-semibold" id="modal-silence" style="color: var(--stuck);">12m</div>
        </div>
        <div class="p-4" style="background: var(--panel);">
          <div class="text-xs mb-1" style="color: var(--text-dim);">Progress</div>
          <div class="font-mono text-xl font-semibold" id="modal-progress" style="color: var(--text);">35%</div>
        </div>
        <div class="p-4" style="background: var(--panel);">
          <div class="text-xs mb-1" style="color: var(--text-dim);">Events</div>
          <div class="font-mono text-xl font-semibold" style="color: var(--text);">5</div>
        </div>
        <div class="p-4" style="background: var(--panel);">
          <div class="text-xs mb-1" style="color: var(--text-dim);">Status</div>
          <div class="font-mono text-sm font-semibold pt-1" style="color: var(--stuck);">STUCK</div>
        </div>
      </div>

      <!-- Progress bar in modal -->
      <div class="px-6 pt-4">
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs" style="color: var(--text-dim);">Task completion</span>
          <span class="font-mono text-xs" id="modal-progress-label" style="color: var(--stuck);">35%</span>
        </div>
        <div class="progress-bar-track" style="height: 6px;">
          <div class="progress-bar-fill-stuck" id="modal-progress-bar" style="width: 35%;"></div>
        </div>
      </div>

      <!-- Session Timeline -->
      <div class="p-6">
        <div class="section-label mb-4">Session Timeline</div>
        <div class="relative pl-8" id="modal-timeline">
          <div class="timeline-line"></div>

          <!-- Timeline events populated by JS -->
        </div>
      </div>

    </div>
  </div>

  <script>
    // Agent data
    const agents = [
      { id: 'claude-opus-7', status: 'STUCK', task: 'Implement auth middleware', project: 'api-v2', progress: 35, claimedAgo: 18, silence: 12 },
      { id: 'claude-sonnet-3', status: 'ACTIVE', task: 'Add search API endpoint', project: 'api-v2', progress: 60, claimedAgo: 8, lastEvent: 1 },
      { id: 'claude-haiku-2', status: 'ACTIVE', task: 'Write unit tests for TaskService', project: 'core', progress: 40, claimedAgo: 12, lastEvent: 3 },
      { id: 'gemini-pro-1', status: 'ACTIVE', task: 'Refactor database queries', project: 'core', progress: 75, claimedAgo: 15, lastEvent: 0.5 },
      { id: 'claude-opus-5', status: 'IDLE', lastCompleted: 'Set up CI pipeline', project: 'infra', idleMin: 8 },
      { id: 'claude-sonnet-8', status: 'STUCK', task: 'Fix pagination bug', project: 'web', progress: 20, claimedAgo: 30, silence: 22 },
      { id: 'gpt-4o-agent', status: 'ACTIVE', task: 'Update API documentation', project: 'docs', progress: 25, claimedAgo: 5, lastEvent: 2 },
      { id: 'claude-haiku-9', status: 'IDLE', lastCompleted: 'Add input validation', project: 'api-v2', idleMin: 3 }
    ];

    const sessionHistories = {
      'claude-opus-7': [
        { time: '12m ago', label: 'checkpoint', text: 'Analyzing JWT library options', type: 'stuck' },
        { time: '15m ago', label: 'checkpoint', text: 'Reading existing auth code', type: 'neutral' },
        { time: '18m ago', label: 'claimed', text: 'Task claimed', type: 'neutral' },
        { time: '20m ago', label: 'completed', text: 'Completed: Set up project scaffolding', type: 'done' },
        { time: '25m ago', label: 'checkpoint', text: 'Generated folder structure', type: 'neutral' }
      ],
      'claude-sonnet-8': [
        { time: '22m ago', label: 'checkpoint', text: 'Investigating offset calculation', type: 'stuck' },
        { time: '25m ago', label: 'checkpoint', text: 'Reading cursor implementation', type: 'neutral' },
        { time: '30m ago', label: 'claimed', text: 'Task claimed', type: 'neutral' }
      ],
      'claude-sonnet-3': [
        { time: '1m ago', label: 'checkpoint', text: 'Implementing full-text search', type: 'active' },
        { time: '3m ago', label: 'checkpoint', text: 'Added search route handler', type: 'active' },
        { time: '5m ago', label: 'checkpoint', text: 'Designing search schema', type: 'neutral' },
        { time: '8m ago', label: 'claimed', text: 'Task claimed', type: 'neutral' },
        { time: '10m ago', label: 'completed', text: 'Completed: Design search schema', type: 'done' },
        { time: '12m ago', label: 'checkpoint', text: 'Finalized FTS5 index design', type: 'neutral' }
      ]
    };

    const modalAgentData = {
      'claude-opus-7': { title: 'Implement auth middleware', project: 'api-v2', silence: '12m', progress: 35, claimed: 'Claimed 18m ago', status: 'STUCK', events: 5 },
      'claude-sonnet-8': { title: 'Fix pagination bug', project: 'web', silence: '22m', progress: 20, claimed: 'Claimed 30m ago', status: 'STUCK', events: 3 }
    };

    function openModal(agentId) {
      const data = modalAgentData[agentId];
      if (!data) return;

      document.getElementById('modal-agent-name').textContent = agentId;
      document.getElementById('modal-task-title').textContent = data.title;
      document.getElementById('modal-project').textContent = data.project;
      document.getElementById('modal-claimed').textContent = data.claimed;
      document.getElementById('modal-silence').textContent = data.silence;
      document.getElementById('modal-progress').textContent = data.progress + '%';
      document.getElementById('modal-progress-label').textContent = data.progress + '%';
      document.getElementById('modal-progress-bar').style.width = data.progress + '%';

      // Rebuild timeline
      const timeline = document.getElementById('modal-timeline');
      const history = sessionHistories[agentId] || [];
      timeline.innerHTML = '<div class="timeline-line"></div>';

      history.forEach((event, i) => {
        const dotClass = event.type === 'stuck' ? 'timeline-dot-stuck' : event.type === 'active' ? 'timeline-dot-active' : 'timeline-dot-neutral';
        const eventEl = document.createElement('div');
        eventEl.className = 'flex items-start gap-3 mb-4 relative';
        eventEl.style.animation = `fadeIn 0.3s ease forwards ${i * 0.06}s`;
        eventEl.style.opacity = '0';

        const labelColor = event.label === 'completed' ? 'var(--healthy)' : event.label === 'claimed' ? 'var(--active)' : 'var(--text-dim)';

        eventEl.innerHTML = `
          <div class="${dotClass}" style="margin-top: 2px; flex-shrink: 0;"></div>
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-0.5">
              <span class="font-mono text-xs" style="color: ${labelColor};">${event.label}</span>
              <span class="text-xs" style="color: var(--text-dim);">${event.time}</span>
            </div>
            <div class="text-sm" style="color: var(--text);">${event.text}</div>
          </div>
        `;
        timeline.appendChild(eventEl);
      });

      document.getElementById('modal-backdrop').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('modal-backdrop').style.display = 'none';
    }

    function handleBackdropClick(event) {
      if (event.target === document.getElementById('modal-backdrop')) {
        closeModal();
      }
    }

    // Stuck threshold logic
    function applyStuckThreshold(thresholdMin) {
      const cards = document.querySelectorAll('#incident-cards .incident-card');
      let stuckCount = 0;
      cards.forEach(card => {
        const silence = parseInt(card.dataset.silence);
        const isStuck = silence >= thresholdMin;
        card.style.display = isStuck ? '' : 'none';
        if (isStuck) stuckCount++;
      });

      document.getElementById('stuck-count').textContent = stuckCount + ' stuck';
      document.getElementById('incident-count-badge').textContent = stuckCount + ' agent' + (stuckCount !== 1 ? 's' : '') + ' stuck';
      document.getElementById('threshold-label').textContent = thresholdMin + ' min';
    }

    // Alert animation logic
    function applyAlertAnimation(animType) {
      const cards = document.querySelectorAll('.incident-card');
      cards.forEach(card => {
        card.classList.remove('anim-pulse', 'anim-glow', 'anim-static');
        if (animType === 'pulse') card.classList.add('anim-pulse');
        else if (animType === 'glow') card.classList.add('anim-glow');
        else card.classList.add('anim-static');
      });
    }

    // Idle display logic
    function applyIdleDisplay(mode) {
      const chips = document.getElementById('idle-chips-container');
      const countOnly = document.getElementById('idle-count-only');

      if (mode === 'show') {
        chips.style.display = 'flex';
        countOnly.style.display = 'none';
      } else if (mode === 'count only') {
        chips.style.display = 'none';
        countOnly.style.display = 'block';
      } else {
        chips.style.display = 'none';
        countOnly.style.display = 'none';
      }
    }

    // Event control listener
    document.addEventListener('control-change', (e) => {
      const { id, value } = e.detail;
      if (id === 'stuck-threshold') {
        applyStuckThreshold(parseInt(value));
      } else if (id === 'alert-animation') {
        applyAlertAnimation(value);
      } else if (id === 'idle-agents') {
        applyIdleDisplay(value);
      }
    });

    document.addEventListener('controls-ready', () => {
      const threshold = getComputedStyle(document.documentElement).getPropertyValue('--stuck-threshold').trim();
      if (threshold) applyStuckThreshold(parseInt(threshold));

      const anim = getComputedStyle(document.documentElement).getPropertyValue('--alert-animation').trim();
      if (anim) applyAlertAnimation(anim);

      const idleMode = getComputedStyle(document.documentElement).getPropertyValue('--idle-display').trim();
      // map CSS values back to mode strings
      if (idleMode === 'flex') applyIdleDisplay('show');
      else if (idleMode === 'inline-flex') applyIdleDisplay('count only');
      else if (idleMode === 'none') applyIdleDisplay('hide');
    });

    // Open modal by default for demo (claude-opus-7)
    openModal('claude-opus-7');
  </script>
</body>
</html>

  </template>
  <template id="tpl-a2" data-body-class="min-h-screen">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script type="application/json" id="variation-meta">
  {
    "id": "A2",
    "family": "A",
    "familyName": "Incident Board",
    "name": "Inline Triage",
    "layoutType": "Expandable Incident Rows",
    "aesthetic": "Professional Dark",
    "description": "Single unified list where stuck agents auto-expand inline with timeline and diagnostics. Triage happens in-place with no modals or panels.",
    "controls": [
      {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["5 min", "10 min", "15 min", "30 min"],
        "cssValues": { "5 min": "5", "10 min": "10", "15 min": "15", "30 min": "30" },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
      },
      {
        "id": "auto-expand",
        "label": "Auto-Expand Stuck",
        "type": "toggle",
        "min": null, "max": null, "step": null,
        "options": null,
        "cssValues": { "true": "1", "false": "0" },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--auto-expand",
        "event": true
      },
      {
        "id": "row-height",
        "label": "Row Height",
        "type": "range",
        "min": 44, "max": 72, "step": 4,
        "options": null,
        "cssValues": null,
        "value": 52,
        "defaultValue": 52,
        "unit": "px",
        "cssVar": "--row-height"
      },
      {
        "id": "highlight-style",
        "label": "Incident Highlight",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["left border", "full background", "top banner"],
        "cssValues": { "left border": "border", "full background": "background", "top banner": "banner" },
        "value": "left border",
        "defaultValue": "left border",
        "unit": "",
        "cssVar": "--highlight-style",
        "event": true
      },
      {
        "id": "timeline-events",
        "label": "Timeline Events",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["3 events", "5 events", "10 events"],
        "cssValues": { "3 events": "3", "5 events": "5", "10 events": "10" },
        "value": "5 events",
        "defaultValue": "5 events",
        "unit": "",
        "cssVar": "--timeline-events",
        "event": true
      },
      {
        "id": "zebra",
        "label": "Zebra Striping",
        "type": "toggle",
        "min": null, "max": null, "step": null,
        "options": null,
        "cssValues": { "true": "0.04", "false": "0" },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--stripe-opacity"
      }
    ]
  }
  </script>
  <style>
    :root {
      --bg: #0f1117;
      --panel: #1a1d27;
      --border: #2a2d3a;
      --text: #e2e4e9;
      --text-dim: #8b8fa3;
      --status-stuck: #ef4444;
      --status-active: #3b82f6;
      --status-idle: #6b7280;
      --status-healthy: #22c55e;
      --font-sans: 'Inter', system-ui, sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --radius: 8px;
      --row-height: 52px;
      --stripe-opacity: 0.04;
      --stuck-threshold: 5;
      --auto-expand: 1;
      --highlight-style: border;
      --timeline-events: 5;
    }

    :root * {
      transition: color 0.3s ease, background-color 0.3s ease,
                  border-color 0.3s ease, padding 0.3s ease,
                  gap 0.3s ease, font-size 0.3s ease,
                  border-radius 0.3s ease, box-shadow 0.3s ease,
                  max-width 0.3s ease, width 0.3s ease,
                  height 0.3s ease, min-height 0.3s ease,
                  opacity 0.3s ease;
    }

    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      margin: 0;
    }

    .mono { font-family: var(--font-mono); }

    /* Agent rows */
    .agent-row {
      min-height: var(--row-height);
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      outline: none;
    }

    .agent-row:nth-child(even) {
      background-color: rgba(255, 255, 255, var(--stripe-opacity));
    }

    .agent-row:hover .row-summary {
      background-color: rgba(255, 255, 255, 0.03);
    }

    .agent-row:focus-visible {
      outline: 2px solid var(--status-active);
      outline-offset: -2px;
    }

    /* Row summary — the always-visible single line */
    .row-summary {
      display: flex;
      align-items: center;
      min-height: var(--row-height);
      padding: 0 16px;
      gap: 12px;
    }

    /* Stuck row highlight variants — driven by --highlight-style via JS */
    .agent-row.stuck-highlight-border {
      border-left: 3px solid var(--status-stuck);
    }

    .agent-row.stuck-highlight-background {
      background-color: rgba(239, 68, 68, 0.06) !important;
      border-left: none;
    }

    .agent-row.stuck-highlight-banner::before {
      content: '';
      display: block;
      height: 2px;
      background: var(--status-stuck);
      margin-bottom: 0;
    }

    /* Expanded content */
    .row-expanded {
      display: none;
      padding: 0 16px 16px 16px;
      border-top: 1px solid var(--border);
    }

    .agent-row.expanded .row-expanded {
      display: block;
    }

    /* Progress bar */
    .progress-bar-track {
      height: 4px;
      background: rgba(255,255,255,0.08);
      border-radius: 2px;
      overflow: hidden;
      flex: 1;
      min-width: 60px;
      max-width: 100px;
    }

    .progress-bar-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.4s ease;
    }

    /* Status dot */
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .status-dot.stuck {
      background: var(--status-stuck);
      box-shadow: 0 0 6px var(--status-stuck);
      animation: pulse-stuck 2s infinite;
    }

    .status-dot.active {
      background: var(--status-active);
      box-shadow: 0 0 4px var(--status-active);
    }

    .status-dot.idle {
      background: var(--status-idle);
    }

    @keyframes pulse-stuck {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.3); }
    }

    /* Silence timer badge */
    .silence-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(239, 68, 68, 0.15);
      color: var(--status-stuck);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 11px;
      font-family: var(--font-mono);
      font-weight: 500;
      flex-shrink: 0;
    }

    /* Timeline */
    .timeline {
      position: relative;
      padding-left: 20px;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 6px;
      top: 8px;
      bottom: 8px;
      width: 1px;
      background: var(--border);
    }

    .timeline-item {
      position: relative;
      padding: 6px 0;
    }

    .timeline-dot {
      position: absolute;
      left: -17px;
      top: 10px;
      width: 7px;
      height: 7px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--panel);
    }

    .timeline-dot.checkpoint { border-color: var(--text-dim); background: var(--text-dim); }
    .timeline-dot.claimed { border-color: var(--status-active); background: var(--status-active); }
    .timeline-dot.completed { border-color: var(--status-healthy); background: var(--status-healthy); }

    /* Expand chevron */
    .chevron {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      color: var(--text-dim);
      transition: transform 0.25s ease;
    }

    .agent-row.expanded .chevron {
      transform: rotate(90deg);
    }

    /* Idle summary row */
    .idle-summary-row {
      min-height: var(--row-height);
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      outline: none;
    }

    .idle-summary-row:focus-visible {
      outline: 2px solid var(--status-active);
      outline-offset: -2px;
    }

    .idle-summary-row:hover .row-summary {
      background-color: rgba(255, 255, 255, 0.03);
    }

    /* Entrance animation */
    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .agent-row, .idle-summary-row {
      animation: fadeSlideIn 0.35s ease both;
    }

    .agent-row:nth-child(1) { animation-delay: 0.05s; }
    .agent-row:nth-child(2) { animation-delay: 0.10s; }
    .agent-row:nth-child(3) { animation-delay: 0.15s; }
    .agent-row:nth-child(4) { animation-delay: 0.20s; }
    .agent-row:nth-child(5) { animation-delay: 0.25s; }
    .agent-row:nth-child(6) { animation-delay: 0.30s; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #3a3d4a; }
  </style>
</head>
<body class="min-h-screen" style="background: var(--bg); color: var(--text);">

  <div class="flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <div class="flex-shrink-0 px-6 py-4 border-b" style="border-color: var(--border); background: var(--panel);">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--status-active);">
              <rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>
            </svg>
            <span class="font-semibold text-sm" style="color: var(--text);">Agent Operations Center</span>
          </div>
          <span class="text-xs px-2 py-0.5 rounded" style="background: rgba(59,130,246,0.15); color: var(--status-active); border: 1px solid rgba(59,130,246,0.25);">Inline Triage</span>
        </div>

        <!-- Fleet summary -->
        <div class="flex items-center gap-1 text-sm mono">
          <span class="font-medium" style="color: var(--status-active);">4 active</span>
          <span style="color: var(--border);">·</span>
          <span class="font-medium" style="color: var(--status-stuck);">2 stuck</span>
          <span style="color: var(--border);">·</span>
          <span class="font-medium" style="color: var(--status-idle);">2 idle</span>
        </div>
      </div>

      <!-- Sub-header: keyboard hint + sort label -->
      <div class="flex items-center justify-between mt-2">
        <p class="text-xs" style="color: var(--text-dim);">Arrow keys navigate · Enter expands/collapses · Stuck agents auto-expanded</p>
        <p class="text-xs mono" style="color: var(--text-dim);">sorted: stuck → active → idle</p>
      </div>
    </div>

    <!-- Column headers -->
    <div class="flex-shrink-0 flex items-center px-4 py-2 text-xs font-medium uppercase tracking-wide border-b" style="color: var(--text-dim); border-color: var(--border); background: var(--bg); min-height: 32px;">
      <div style="width: 20px; flex-shrink: 0;"></div>
      <div style="width: 10px; flex-shrink: 0; margin-right: 12px;"></div>
      <div class="flex-1 min-w-0" style="max-width: 180px;">Agent</div>
      <div class="flex-1 min-w-0 hidden md:block">Task</div>
      <div style="width: 120px; flex-shrink: 0;" class="hidden lg:block">Progress</div>
      <div style="width: 90px; flex-shrink: 0;" class="hidden md:block">Claimed</div>
      <div style="width: 110px; flex-shrink: 0;">Last Event</div>
    </div>

    <!-- Agent list -->
    <div id="agent-list" class="flex-1 overflow-auto" style="background: var(--bg);">

      <!-- ============================================================ -->
      <!-- STUCK: claude-opus-7 — auto-expanded -->
      <!-- ============================================================ -->
      <div class="agent-row expanded stuck-highlight-border" data-status="stuck" data-agent="claude-opus-7" tabindex="0" role="row" aria-expanded="true">
        <!-- Banner slot (only visible when banner mode) -->
        <div class="stuck-banner hidden px-4 py-1 text-xs font-semibold" style="background: var(--status-stuck); color: #fff; letter-spacing: 0.05em;">INCIDENT — SILENT 12m</div>

        <!-- Summary row -->
        <div class="row-summary">
          <svg class="chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 4 10 8 6 12"/>
          </svg>
          <div class="status-dot stuck"></div>
          <div class="flex-1 min-w-0" style="max-width: 180px;">
            <span class="mono text-sm font-medium" style="color: var(--text);">claude-opus-7</span>
          </div>
          <div class="flex-1 min-w-0 hidden md:block truncate text-sm" style="color: var(--text-dim);">
            Implement auth middleware
            <span class="ml-1 text-xs px-1.5 py-0.5 rounded mono" style="background: rgba(255,255,255,0.06); color: var(--text-dim);">api-v2</span>
          </div>
          <div style="width: 120px; flex-shrink: 0;" class="hidden lg:flex items-center gap-2">
            <div class="progress-bar-track">
              <div class="progress-bar-fill" style="width: 35%; background: var(--status-stuck);"></div>
            </div>
            <span class="mono text-xs" style="color: var(--status-stuck);">35%</span>
          </div>
          <div style="width: 90px; flex-shrink: 0;" class="hidden md:block">
            <span class="mono text-xs" style="color: var(--text-dim);">18m ago</span>
          </div>
          <div style="width: 110px; flex-shrink: 0;">
            <span class="silence-badge">
              <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6 6 18M6 6l12 12"/></svg>
              silent 12m
            </span>
          </div>
        </div>

        <!-- Expanded inline triage panel -->
        <div class="row-expanded">
          <div class="rounded-lg p-4 mt-1" style="background: rgba(239,68,68,0.06); border: 1px solid rgba(239,68,68,0.2);">
            <div class="flex items-start gap-6 flex-wrap">

              <!-- Diagnostic info -->
              <div class="flex-1 min-w-0" style="min-width: 180px;">
                <p class="text-xs font-semibold uppercase tracking-wide mb-2" style="color: var(--status-stuck);">Diagnostics</p>
                <div class="space-y-1">
                  <div class="flex items-center gap-2 text-xs">
                    <span style="color: var(--text-dim); width: 70px; flex-shrink: 0;">Status</span>
                    <span class="mono font-medium" style="color: var(--status-stuck);">STUCK · 12m silent</span>
                  </div>
                  <div class="flex items-center gap-2 text-xs">
                    <span style="color: var(--text-dim); width: 70px; flex-shrink: 0;">Task</span>
                    <span class="mono" style="color: var(--text);">Implement auth middleware</span>
                  </div>
                  <div class="flex items-center gap-2 text-xs">
                    <span style="color: var(--text-dim); width: 70px; flex-shrink: 0;">Project</span>
                    <span class="mono" style="color: var(--text);">api-v2</span>
                  </div>
                  <div class="flex items-center gap-2 text-xs">
                    <span style="color: var(--text-dim); width: 70px; flex-shrink: 0;">Progress</span>
                    <div class="flex items-center gap-2">
                      <div class="progress-bar-track" style="max-width: 80px;">
                        <div class="progress-bar-fill" style="width: 35%; background: var(--status-stuck);"></div>
                      </div>
                      <span class="mono" style="color: var(--status-stuck);">35%</span>
                    </div>
                  </div>
                  <div class="flex items-center gap-2 text-xs">
                    <span style="color: var(--text-dim); width: 70px; flex-shrink: 0;">Claimed</span>
                    <span class="mono" style="color: var(--text);">18m ago</span>
                  </div>
                </div>
              </div>

              <!-- Mini timeline -->
              <div class="flex-1 min-w-0" style="min-width: 220px;">
                <p class="text-xs font-semibold uppercase tracking-wide mb-3" style="color: var(--text-dim);">Last Events</p>
                <div class="timeline timeline-claude-opus-7">
                  <div class="timeline-item" data-event-idx="0">
                    <div class="timeline-dot checkpoint"></div>
                    <div class="flex items-start gap-3">
                      <span class="mono text-xs flex-shrink-0" style="color: var(--text-dim); width: 40px;">12m</span>
                      <div>
                        <span class="text-xs" style="color: var(--text);">Analyzing JWT library options</span>
                        <span class="ml-1 text-xs px-1 rounded" style="background: rgba(255,255,255,0.06); color: var(--text-dim);">checkpoint</span>
                      </div>
                    </div>
                  </div>
                  <div class="timeline-item" data-event-idx="1">
                    <div class="timeline-dot checkpoint"></div>
                    <div class="flex items-start gap-3">
                      <span class="mono text-xs flex-shrink-0" style="color: var(--text-dim); width: 40px;">15m</span>
                      <div>
                        <span class="text-xs" style="color: var(--text);">Reading existing auth code</span>
                        <span class="ml-1 text-xs px-1 rounded" style="background: rgba(255,255,255,0.06); color: var(--text-dim);">checkpoint</span>
                      </div>
                    </div>
                  </div>
                  <div class="timeline-item" data-event-idx="2">
                    <div class="timeline-dot claimed"></div>
                    <div class="flex items-start gap-3">
                      <span class="mono text-xs flex-shrink-0" style="color: var(--text-dim); width: 40px;">18m</span>
                      <div>
                        <span class="text-xs" style="color: var(--status-active);">Task claimed</span>
                      </div>
                    </div>
                  </div>
                  <div class="timeline-item" data-event-idx="3">
                    <div class="timeline-dot completed"></div>
                    <div class="flex items-start gap-3">
                      <span class="mono text-xs flex-shrink-0" style="color: var(--text-dim); width: 40px;">20m</span>
                      <div>
                        <span class="text-xs" style="color: var(--status-healthy);">Completed: Set up project scaffolding</span>
                      </div>
                    </div>
                  </div>
                  <div class="timeline-item" data-event-idx="4">
                    <div class="timeline-dot checkpoint"></div>
                    <div class="flex items-start gap-3">
                      <span class="mono text-xs flex-shrink-0" style="color: var(--text-dim); width: 40px;">25m</span>
                      <div>
                        <span class="text-xs" style="color: var(--text);">Generated folder structure</span>
                        <span class="ml-1 text-xs px-1 rounded" style="background: rgba(255,255,255,0.06); color: var(--text-dim);">checkpoint</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Action buttons -->
              <div class="flex flex-col gap-2 flex-shrink-0">
                <p class="text-xs font-semibold uppercase tracking-wide" style="color: var(--text-dim);">Actions</p>
                <button class="flex items-center gap-2 px-3 py-1.5 rounded text-xs font-medium transition-colors" style="background: rgba(239,68,68,0.15); color: var(--status-stuck); border: 1px solid rgba(239,68,68,0.3);" onmouseover="this.style.background='rgba(239,68,68,0.25)'" onmouseout="this.style.background='rgba(239,68,68,0.15)'">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                  Re-assign
                </button>
                <button class="flex items-center gap-2 px-3 py-1.5 rounded text-xs font-medium transition-colors" style="background: rgba(255,255,255,0.06); color: var(--text-dim); border: 1px solid var(--border);" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.06)'">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="9" x2="15" y2="15"/><line x1="15" y1="9" x2="9" y2="15"/></svg>
                  Cancel task
                </button>
                <button class="flex items-center gap-2 px-3 py-1.5 rounded text-xs font-medium transition-colors" style="background: rgba(255,255,255,0.06); color: var(--text-dim); border: 1px solid var(--border);" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.06)'">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                  View logs
                </button>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- ============================================================ -->
      <!-- STUCK: claude-sonnet-8 — auto-expanded -->
      <!-- ============================================================ -->
      <div class="agent-row expanded stuck-highlight-border" data-status="stuck" data-agent="claude-sonnet-8" tabindex="0" role="row" aria-expanded="true">
        <div class="stuck-banner hidden px-4 py-1 text-xs font-semibold" style="background: var(--status-stuck); color: #fff; letter-spacing: 0.05em;">INCIDENT — SILENT 22m</div>

        <div class="row-summary">
          <svg class="chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 4 10 8 6 12"/>
          </svg>
          <div class="status-dot stuck"></div>
          <div class="flex-1 min-w-0" style="max-width: 180px;">
            <span class="mono text-sm font-medium" style="color: var(--text);">claude-sonnet-8</span>
          </div>
          <div class="flex-1 min-w-0 hidden md:block truncate text-sm" style="color: var(--text-dim);">
            Fix pagination bug
            <span class="ml-1 text-xs px-1.5 py-0.5 rounded mono" style="background: rgba(255,255,255,0.06); color: var(--text-dim);">web</span>
          </div>
          <div style="width: 120px; flex-shrink: 0;" class="hidden lg:flex items-center gap-2">
            <div class="progress-bar-track">
              <div class="progress-bar-fill" style="width: 20%; background: var(--status-stuck);"></div>
            </div>
            <span class="mono text-xs" style="color: var(--status-stuck);">20%</span>
          </div>
          <div style="width: 90px; flex-shrink: 0;" class="hidden md:block">
            <span class="mono text-xs" style="color: var(--text-dim);">30m ago</span>
          </div>
          <div style="width: 110px; flex-shrink: 0;">
            <span class="silence-badge">
              <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6 6 18M6 6l12 12"/></svg>
              silent 22m
            </span>
          </div>
        </div>

        <div class="row-expanded">
          <div class="rounded-lg p-4 mt-1" style="background: rgba(239,68,68,0.06); border: 1px solid rgba(239,68,68,0.2);">
            <div class="flex items-start gap-6 flex-wrap">

              <div class="flex-1 min-w-0" style="min-width: 180px;">
                <p class="text-xs font-semibold uppercase tracking-wide mb-2" style="color: var(--status-stuck);">Diagnostics</p>
                <div class="space-y-1">
                  <div class="flex items-center gap-2 text-xs">
                    <span style="color: var(--text-dim); width: 70px; flex-shrink: 0;">Status</span>
                    <span class="mono font-medium" style="color: var(--status-stuck);">STUCK · 22m silent</span>
                  </div>
                  <div class="flex items-center gap-2 text-xs">
                    <span style="color: var(--text-dim); width: 70px; flex-shrink: 0;">Task</span>
                    <span class="mono" style="color: var(--text);">Fix pagination bug</span>
                  </div>
                  <div class="flex items-center gap-2 text-xs">
                    <span style="color: var(--text-dim); width: 70px; flex-shrink: 0;">Project</span>
                    <span class="mono" style="color: var(--text);">web</span>
                  </div>
                  <div class="flex items-center gap-2 text-xs">
                    <span style="color: var(--text-dim); width: 70px; flex-shrink: 0;">Progress</span>
                    <div class="flex items-center gap-2">
                      <div class="progress-bar-track" style="max-width: 80px;">
                        <div class="progress-bar-fill" style="width: 20%; background: var(--status-stuck);"></div>
                      </div>
                      <span class="mono" style="color: var(--status-stuck);">20%</span>
                    </div>
                  </div>
                  <div class="flex items-center gap-2 text-xs">
                    <span style="color: var(--text-dim); width: 70px; flex-shrink: 0;">Claimed</span>
                    <span class="mono" style="color: var(--text);">30m ago</span>
                  </div>
                </div>
              </div>

              <div class="flex-1 min-w-0" style="min-width: 220px;">
                <p class="text-xs font-semibold uppercase tracking-wide mb-3" style="color: var(--text-dim);">Last Events</p>
                <div class="timeline timeline-claude-sonnet-8">
                  <div class="timeline-item" data-event-idx="0">
                    <div class="timeline-dot checkpoint"></div>
                    <div class="flex items-start gap-3">
                      <span class="mono text-xs flex-shrink-0" style="color: var(--text-dim); width: 40px;">22m</span>
                      <div>
                        <span class="text-xs" style="color: var(--text);">Investigating offset calculation</span>
                        <span class="ml-1 text-xs px-1 rounded" style="background: rgba(255,255,255,0.06); color: var(--text-dim);">checkpoint</span>
                      </div>
                    </div>
                  </div>
                  <div class="timeline-item" data-event-idx="1">
                    <div class="timeline-dot checkpoint"></div>
                    <div class="flex items-start gap-3">
                      <span class="mono text-xs flex-shrink-0" style="color: var(--text-dim); width: 40px;">25m</span>
                      <div>
                        <span class="text-xs" style="color: var(--text);">Reading cursor implementation</span>
                        <span class="ml-1 text-xs px-1 rounded" style="background: rgba(255,255,255,0.06); color: var(--text-dim);">checkpoint</span>
                      </div>
                    </div>
                  </div>
                  <div class="timeline-item" data-event-idx="2">
                    <div class="timeline-dot claimed"></div>
                    <div class="flex items-start gap-3">
                      <span class="mono text-xs flex-shrink-0" style="color: var(--text-dim); width: 40px;">30m</span>
                      <div>
                        <span class="text-xs" style="color: var(--status-active);">Task claimed</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="flex flex-col gap-2 flex-shrink-0">
                <p class="text-xs font-semibold uppercase tracking-wide" style="color: var(--text-dim);">Actions</p>
                <button class="flex items-center gap-2 px-3 py-1.5 rounded text-xs font-medium transition-colors" style="background: rgba(239,68,68,0.15); color: var(--status-stuck); border: 1px solid rgba(239,68,68,0.3);" onmouseover="this.style.background='rgba(239,68,68,0.25)'" onmouseout="this.style.background='rgba(239,68,68,0.15)'">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                  Re-assign
                </button>
                <button class="flex items-center gap-2 px-3 py-1.5 rounded text-xs font-medium transition-colors" style="background: rgba(255,255,255,0.06); color: var(--text-dim); border: 1px solid var(--border);" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.06)'">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="9" x2="15" y2="15"/><line x1="15" y1="9" x2="9" y2="15"/></svg>
                  Cancel task
                </button>
                <button class="flex items-center gap-2 px-3 py-1.5 rounded text-xs font-medium transition-colors" style="background: rgba(255,255,255,0.06); color: var(--text-dim); border: 1px solid var(--border);" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.06)'">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                  View logs
                </button>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- ============================================================ -->
      <!-- ACTIVE: gemini-pro-1 (most recent: 30s ago) -->
      <!-- ============================================================ -->
      <div class="agent-row" data-status="active" data-agent="gemini-pro-1" tabindex="0" role="row" aria-expanded="false">
        <div class="row-summary">
          <svg class="chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 4 10 8 6 12"/>
          </svg>
          <div class="status-dot active"></div>
          <div class="flex-1 min-w-0" style="max-width: 180px;">
            <span class="mono text-sm font-medium" style="color: var(--text);">gemini-pro-1</span>
          </div>
          <div class="flex-1 min-w-0 hidden md:block truncate text-sm" style="color: var(--text-dim);">
            Refactor database queries
            <span class="ml-1 text-xs px-1.5 py-0.5 rounded mono" style="background: rgba(255,255,255,0.06); color: var(--text-dim);">core</span>
          </div>
          <div style="width: 120px; flex-shrink: 0;" class="hidden lg:flex items-center gap-2">
            <div class="progress-bar-track">
              <div class="progress-bar-fill" style="width: 75%; background: var(--status-active);"></div>
            </div>
            <span class="mono text-xs" style="color: var(--status-active);">75%</span>
          </div>
          <div style="width: 90px; flex-shrink: 0;" class="hidden md:block">
            <span class="mono text-xs" style="color: var(--text-dim);">15m ago</span>
          </div>
          <div style="width: 110px; flex-shrink: 0;">
            <span class="mono text-xs" style="color: var(--status-healthy);">30s ago</span>
          </div>
        </div>
        <div class="row-expanded">
          <div class="rounded-lg p-3 mt-1 text-xs" style="background: rgba(59,130,246,0.05); border: 1px solid rgba(59,130,246,0.15);">
            <p style="color: var(--text-dim);">No session history shown for collapsed view. Expand to see timeline.</p>
          </div>
        </div>
      </div>

      <!-- ============================================================ -->
      <!-- ACTIVE: claude-sonnet-3 (1m ago) — manually expanded for demo -->
      <!-- ============================================================ -->
      <div class="agent-row expanded" data-status="active" data-agent="claude-sonnet-3" tabindex="0" role="row" aria-expanded="true">
        <div class="row-summary">
          <svg class="chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 4 10 8 6 12"/>
          </svg>
          <div class="status-dot active"></div>
          <div class="flex-1 min-w-0" style="max-width: 180px;">
            <span class="mono text-sm font-medium" style="color: var(--text);">claude-sonnet-3</span>
          </div>
          <div class="flex-1 min-w-0 hidden md:block truncate text-sm" style="color: var(--text-dim);">
            Add search API endpoint
            <span class="ml-1 text-xs px-1.5 py-0.5 rounded mono" style="background: rgba(255,255,255,0.06); color: var(--text-dim);">api-v2</span>
          </div>
          <div style="width: 120px; flex-shrink: 0;" class="hidden lg:flex items-center gap-2">
            <div class="progress-bar-track">
              <div class="progress-bar-fill" style="width: 60%; background: var(--status-active);"></div>
            </div>
            <span class="mono text-xs" style="color: var(--status-active);">60%</span>
          </div>
          <div style="width: 90px; flex-shrink: 0;" class="hidden md:block">
            <span class="mono text-xs" style="color: var(--text-dim);">8m ago</span>
          </div>
          <div style="width: 110px; flex-shrink: 0;">
            <span class="mono text-xs" style="color: var(--status-healthy);">1m ago</span>
          </div>
        </div>
        <div class="row-expanded">
          <div class="rounded-lg p-4 mt-1" style="background: rgba(59,130,246,0.05); border: 1px solid rgba(59,130,246,0.15);">
            <div class="flex items-start gap-6 flex-wrap">
              <div class="flex-1 min-w-0" style="min-width: 180px;">
                <p class="text-xs font-semibold uppercase tracking-wide mb-2" style="color: var(--status-active);">Status</p>
                <div class="space-y-1">
                  <div class="flex items-center gap-2 text-xs">
                    <span style="color: var(--text-dim); width: 70px; flex-shrink: 0;">Status</span>
                    <span class="mono font-medium" style="color: var(--status-active);">ACTIVE · healthy</span>
                  </div>
                  <div class="flex items-center gap-2 text-xs">
                    <span style="color: var(--text-dim); width: 70px; flex-shrink: 0;">Progress</span>
                    <div class="flex items-center gap-2">
                      <div class="progress-bar-track" style="max-width: 80px;">
                        <div class="progress-bar-fill" style="width: 60%; background: var(--status-active);"></div>
                      </div>
                      <span class="mono" style="color: var(--status-active);">60%</span>
                    </div>
                  </div>
                  <div class="flex items-center gap-2 text-xs">
                    <span style="color: var(--text-dim); width: 70px; flex-shrink: 0;">Last event</span>
                    <span class="mono" style="color: var(--status-healthy);">1 minute ago</span>
                  </div>
                </div>
              </div>
              <div class="flex-1 min-w-0" style="min-width: 220px;">
                <p class="text-xs font-semibold uppercase tracking-wide mb-3" style="color: var(--text-dim);">Last Events</p>
                <div class="timeline timeline-claude-sonnet-3">
                  <div class="timeline-item" data-event-idx="0">
                    <div class="timeline-dot checkpoint"></div>
                    <div class="flex items-start gap-3">
                      <span class="mono text-xs flex-shrink-0" style="color: var(--text-dim); width: 40px;">1m</span>
                      <div>
                        <span class="text-xs" style="color: var(--text);">Implementing full-text search</span>
                        <span class="ml-1 text-xs px-1 rounded" style="background: rgba(255,255,255,0.06); color: var(--text-dim);">checkpoint</span>
                      </div>
                    </div>
                  </div>
                  <div class="timeline-item" data-event-idx="1">
                    <div class="timeline-dot checkpoint"></div>
                    <div class="flex items-start gap-3">
                      <span class="mono text-xs flex-shrink-0" style="color: var(--text-dim); width: 40px;">3m</span>
                      <div>
                        <span class="text-xs" style="color: var(--text);">Added search route handler</span>
                        <span class="ml-1 text-xs px-1 rounded" style="background: rgba(255,255,255,0.06); color: var(--text-dim);">checkpoint</span>
                      </div>
                    </div>
                  </div>
                  <div class="timeline-item" data-event-idx="2">
                    <div class="timeline-dot checkpoint"></div>
                    <div class="flex items-start gap-3">
                      <span class="mono text-xs flex-shrink-0" style="color: var(--text-dim); width: 40px;">5m</span>
                      <div>
                        <span class="text-xs" style="color: var(--text);">Designing search schema</span>
                        <span class="ml-1 text-xs px-1 rounded" style="background: rgba(255,255,255,0.06); color: var(--text-dim);">checkpoint</span>
                      </div>
                    </div>
                  </div>
                  <div class="timeline-item" data-event-idx="3">
                    <div class="timeline-dot claimed"></div>
                    <div class="flex items-start gap-3">
                      <span class="mono text-xs flex-shrink-0" style="color: var(--text-dim); width: 40px;">8m</span>
                      <div>
                        <span class="text-xs" style="color: var(--status-active);">Task claimed</span>
                      </div>
                    </div>
                  </div>
                  <div class="timeline-item" data-event-idx="4">
                    <div class="timeline-dot completed"></div>
                    <div class="flex items-start gap-3">
                      <span class="mono text-xs flex-shrink-0" style="color: var(--text-dim); width: 40px;">10m</span>
                      <div>
                        <span class="text-xs" style="color: var(--status-healthy);">Completed: Design search schema</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ============================================================ -->
      <!-- ACTIVE: claude-haiku-2 (3m ago) -->
      <!-- ============================================================ -->
      <div class="agent-row" data-status="active" data-agent="claude-haiku-2" tabindex="0" role="row" aria-expanded="false">
        <div class="row-summary">
          <svg class="chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 4 10 8 6 12"/>
          </svg>
          <div class="status-dot active"></div>
          <div class="flex-1 min-w-0" style="max-width: 180px;">
            <span class="mono text-sm font-medium" style="color: var(--text);">claude-haiku-2</span>
          </div>
          <div class="flex-1 min-w-0 hidden md:block truncate text-sm" style="color: var(--text-dim);">
            Write unit tests for TaskService
            <span class="ml-1 text-xs px-1.5 py-0.5 rounded mono" style="background: rgba(255,255,255,0.06); color: var(--text-dim);">core</span>
          </div>
          <div style="width: 120px; flex-shrink: 0;" class="hidden lg:flex items-center gap-2">
            <div class="progress-bar-track">
              <div class="progress-bar-fill" style="width: 40%; background: var(--status-active);"></div>
            </div>
            <span class="mono text-xs" style="color: var(--status-active);">40%</span>
          </div>
          <div style="width: 90px; flex-shrink: 0;" class="hidden md:block">
            <span class="mono text-xs" style="color: var(--text-dim);">12m ago</span>
          </div>
          <div style="width: 110px; flex-shrink: 0;">
            <span class="mono text-xs" style="color: var(--status-healthy);">3m ago</span>
          </div>
        </div>
        <div class="row-expanded">
          <div class="rounded-lg p-3 mt-1 text-xs" style="background: rgba(59,130,246,0.05); border: 1px solid rgba(59,130,246,0.15);">
            <p style="color: var(--text-dim);">Click to expand timeline.</p>
          </div>
        </div>
      </div>

      <!-- ============================================================ -->
      <!-- ACTIVE: gpt-4o-agent (2m ago) -->
      <!-- ============================================================ -->
      <div class="agent-row" data-status="active" data-agent="gpt-4o-agent" tabindex="0" role="row" aria-expanded="false">
        <div class="row-summary">
          <svg class="chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 4 10 8 6 12"/>
          </svg>
          <div class="status-dot active"></div>
          <div class="flex-1 min-w-0" style="max-width: 180px;">
            <span class="mono text-sm font-medium" style="color: var(--text);">gpt-4o-agent</span>
          </div>
          <div class="flex-1 min-w-0 hidden md:block truncate text-sm" style="color: var(--text-dim);">
            Update API documentation
            <span class="ml-1 text-xs px-1.5 py-0.5 rounded mono" style="background: rgba(255,255,255,0.06); color: var(--text-dim);">docs</span>
          </div>
          <div style="width: 120px; flex-shrink: 0;" class="hidden lg:flex items-center gap-2">
            <div class="progress-bar-track">
              <div class="progress-bar-fill" style="width: 25%; background: var(--status-active);"></div>
            </div>
            <span class="mono text-xs" style="color: var(--status-active);">25%</span>
          </div>
          <div style="width: 90px; flex-shrink: 0;" class="hidden md:block">
            <span class="mono text-xs" style="color: var(--text-dim);">5m ago</span>
          </div>
          <div style="width: 110px; flex-shrink: 0;">
            <span class="mono text-xs" style="color: var(--status-healthy);">2m ago</span>
          </div>
        </div>
        <div class="row-expanded">
          <div class="rounded-lg p-3 mt-1 text-xs" style="background: rgba(59,130,246,0.05); border: 1px solid rgba(59,130,246,0.15);">
            <p style="color: var(--text-dim);">Click to expand timeline.</p>
          </div>
        </div>
      </div>

      <!-- ============================================================ -->
      <!-- IDLE: summary row (expandable) -->
      <!-- ============================================================ -->
      <div id="idle-summary" class="idle-summary-row" tabindex="0" role="row" aria-expanded="false">
        <div class="row-summary" style="min-height: var(--row-height);">
          <svg id="idle-chevron" class="chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 4 10 8 6 12"/>
          </svg>
          <div class="status-dot idle"></div>
          <div class="flex items-center gap-2 flex-1 min-w-0">
            <span class="text-sm font-medium" style="color: var(--text-dim);">2 idle agents</span>
            <span class="text-xs px-2 py-0.5 rounded" style="background: rgba(107,114,128,0.15); color: var(--status-idle); border: 1px solid rgba(107,114,128,0.25);">available</span>
          </div>
          <div class="hidden md:block" style="flex: 1; min-width: 0;">
            <span class="text-xs" style="color: var(--text-dim);">Last tasks completed 3–8m ago</span>
          </div>
          <div style="width: 120px; flex-shrink: 0;" class="hidden lg:block"></div>
          <div style="width: 90px; flex-shrink: 0;" class="hidden md:block"></div>
          <div style="width: 110px; flex-shrink: 0;"></div>
        </div>
        <div id="idle-expanded" class="hidden px-4 pb-3" style="border-top: 1px solid var(--border);">
          <div class="space-y-px pt-1">
            <!-- claude-opus-5 -->
            <div class="flex items-center gap-3 py-2 px-2 rounded" style="min-height: 36px;">
              <div style="width: 20px; flex-shrink: 0;"></div>
              <div class="status-dot idle"></div>
              <div class="flex-1 min-w-0" style="max-width: 180px;">
                <span class="mono text-sm" style="color: var(--text-dim);">claude-opus-5</span>
              </div>
              <div class="flex-1 min-w-0 hidden md:block text-xs" style="color: var(--text-dim);">
                Last: Set up CI pipeline
                <span class="ml-1 px-1.5 py-0.5 rounded mono" style="background: rgba(255,255,255,0.06);">infra</span>
              </div>
              <div style="width: 120px;" class="hidden lg:block"></div>
              <div style="width: 90px;" class="hidden md:block"></div>
              <div style="width: 110px; flex-shrink: 0;">
                <span class="mono text-xs" style="color: var(--text-dim);">8m ago</span>
              </div>
            </div>
            <!-- claude-haiku-9 -->
            <div class="flex items-center gap-3 py-2 px-2 rounded" style="min-height: 36px;">
              <div style="width: 20px; flex-shrink: 0;"></div>
              <div class="status-dot idle"></div>
              <div class="flex-1 min-w-0" style="max-width: 180px;">
                <span class="mono text-sm" style="color: var(--text-dim);">claude-haiku-9</span>
              </div>
              <div class="flex-1 min-w-0 hidden md:block text-xs" style="color: var(--text-dim);">
                Last: Add input validation
                <span class="ml-1 px-1.5 py-0.5 rounded mono" style="background: rgba(255,255,255,0.06);">api-v2</span>
              </div>
              <div style="width: 120px;" class="hidden lg:block"></div>
              <div style="width: 90px;" class="hidden md:block"></div>
              <div style="width: 110px; flex-shrink: 0;">
                <span class="mono text-xs" style="color: var(--text-dim);">3m ago</span>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Footer status bar -->
    <div class="flex-shrink-0 flex items-center justify-between px-6 py-2 border-t text-xs" style="border-color: var(--border); background: var(--panel); color: var(--text-dim);">
      <div class="flex items-center gap-4">
        <span>8 agents total</span>
        <span id="threshold-display" class="mono" style="color: var(--text-dim);">stuck threshold: 5m</span>
      </div>
      <div class="flex items-center gap-3">
        <span>arrow keys navigate</span>
        <span class="mono px-1.5 py-0.5 rounded" style="background: rgba(255,255,255,0.06);">enter</span>
        <span>expand/collapse</span>
      </div>
    </div>

  </div>

  <script>
    // ----------------------------------------------------------------
    // Row expand/collapse
    // ----------------------------------------------------------------
    function toggleRow(row) {
      const expanded = row.classList.contains('expanded');
      row.classList.toggle('expanded', !expanded);
      row.setAttribute('aria-expanded', String(!expanded));
    }

    document.querySelectorAll('.agent-row').forEach(row => {
      row.addEventListener('click', () => toggleRow(row));
      row.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleRow(row); }
      });
    });

    // Idle summary row
    const idleSummary = document.getElementById('idle-summary');
    const idleExpanded = document.getElementById('idle-expanded');
    const idleChevron = document.getElementById('idle-chevron');

    idleSummary.addEventListener('click', () => {
      const open = idleExpanded.classList.contains('hidden');
      idleExpanded.classList.toggle('hidden', !open);
      idleChevron.style.transform = open ? 'rotate(90deg)' : '';
      idleSummary.setAttribute('aria-expanded', String(open));
    });
    idleSummary.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); idleSummary.click(); }
    });

    // ----------------------------------------------------------------
    // Keyboard navigation between rows
    // ----------------------------------------------------------------
    const allRows = () => [
      ...document.querySelectorAll('.agent-row, .idle-summary-row')
    ];

    document.addEventListener('keydown', e => {
      const rows = allRows();
      const focused = document.activeElement;
      const idx = rows.indexOf(focused);
      if (idx === -1) return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        const next = rows[idx + 1];
        if (next) next.focus();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        const prev = rows[idx - 1];
        if (prev) prev.focus();
      }
    });

    // ----------------------------------------------------------------
    // Highlight style application
    // ----------------------------------------------------------------
    function applyHighlightStyle(style) {
      const stuckRows = document.querySelectorAll('.agent-row[data-status="stuck"]');
      const banners = document.querySelectorAll('.stuck-banner');

      stuckRows.forEach(row => {
        row.classList.remove('stuck-highlight-border', 'stuck-highlight-background', 'stuck-highlight-banner');
        row.classList.add('stuck-highlight-' + style);
      });

      banners.forEach(b => {
        b.classList.toggle('hidden', style !== 'banner');
      });
    }

    // ----------------------------------------------------------------
    // Timeline events count
    // ----------------------------------------------------------------
    function applyTimelineEvents(count) {
      const n = parseInt(count, 10);
      document.querySelectorAll('.timeline-item').forEach(item => {
        const idx = parseInt(item.dataset.eventIdx, 10);
        item.style.display = idx < n ? '' : 'none';
      });
    }

    // ----------------------------------------------------------------
    // Auto-expand stuck
    // ----------------------------------------------------------------
    function applyAutoExpand(enabled) {
      const stuckRows = document.querySelectorAll('.agent-row[data-status="stuck"]');
      stuckRows.forEach(row => {
        if (enabled) {
          row.classList.add('expanded');
          row.setAttribute('aria-expanded', 'true');
        } else {
          row.classList.remove('expanded');
          row.setAttribute('aria-expanded', 'false');
        }
      });
    }

    // ----------------------------------------------------------------
    // Stuck threshold display
    // ----------------------------------------------------------------
    function applyStuckThreshold(val) {
      const display = document.getElementById('threshold-display');
      if (display) display.textContent = 'stuck threshold: ' + val + 'm';
    }

    // ----------------------------------------------------------------
    // control-change listener
    // ----------------------------------------------------------------
    document.addEventListener('control-change', e => {
      const { id, value } = e.detail;
      if (id === 'highlight-style') {
        applyHighlightStyle(value);
      } else if (id === 'timeline-events') {
        applyTimelineEvents(value);
      } else if (id === 'auto-expand') {
        applyAutoExpand(value === '1' || value === 1 || value === true);
      } else if (id === 'stuck-threshold') {
        applyStuckThreshold(value);
      }
    });

    document.addEventListener('controls-ready', () => {
      const style = getComputedStyle(document.documentElement)
        .getPropertyValue('--highlight-style').trim();
      if (style) applyHighlightStyle(style);

      const events = getComputedStyle(document.documentElement)
        .getPropertyValue('--timeline-events').trim();
      if (events) applyTimelineEvents(events);

      const autoExpand = getComputedStyle(document.documentElement)
        .getPropertyValue('--auto-expand').trim();
      if (autoExpand) applyAutoExpand(autoExpand === '1');

      const threshold = getComputedStyle(document.documentElement)
        .getPropertyValue('--stuck-threshold').trim();
      if (threshold) applyStuckThreshold(threshold);
    });

    // ----------------------------------------------------------------
    // Initial state (no shell)
    // ----------------------------------------------------------------
    applyHighlightStyle('border');
    applyTimelineEvents(5);
  </script>
</body>
</html>

  </template>
  <template id="tpl-a3">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script type="application/json" id="variation-meta">
  {
    "id": "A3",
    "family": "A",
    "familyName": "Incident Board",
    "name": "Split Focus",
    "layoutType": "List + Detail Split",
    "aesthetic": "Professional Dark",
    "description": "Persistent two-column layout. Left panel scrollable agent list sorted by severity. Right panel shows full session timeline, metrics, and task context for the selected agent.",
    "controls": [
      {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["5 min", "10 min", "15 min", "30 min"],
        "cssValues": { "5 min": "5", "10 min": "10", "15 min": "15", "30 min": "30" },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
      },
      {
        "id": "list-width",
        "label": "List Width",
        "type": "range",
        "min": 260, "max": 480, "step": 20,
        "options": null,
        "value": 320,
        "defaultValue": 320,
        "unit": "px",
        "cssVar": "--list-width"
      },
      {
        "id": "detail-tab",
        "label": "Detail Default Tab",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["timeline", "metrics", "task context"],
        "cssValues": { "timeline": "timeline", "metrics": "metrics", "task context": "task" },
        "value": "timeline",
        "defaultValue": "timeline",
        "unit": "",
        "cssVar": "--detail-tab",
        "event": true
      },
      {
        "id": "list-sort",
        "label": "List Sort",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["by severity", "by silence duration", "by recency"],
        "cssValues": { "by severity": "severity", "by silence duration": "silence", "by recency": "recency" },
        "value": "by severity",
        "defaultValue": "by severity",
        "unit": "",
        "cssVar": "--list-sort",
        "event": true
      },
      {
        "id": "sparklines",
        "label": "Show Sparklines",
        "type": "toggle",
        "min": null, "max": null, "step": null,
        "options": null,
        "cssValues": { "true": "inline-flex", "false": "none" },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--sparkline-display"
      },
      {
        "id": "summary-pos",
        "label": "Summary Position",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["bottom bar", "top bar", "hidden"],
        "cssValues": { "bottom bar": "bottom", "top bar": "top", "hidden": "none" },
        "value": "bottom bar",
        "defaultValue": "bottom bar",
        "unit": "",
        "cssVar": "--summary-pos",
        "event": true
      }
    ]
  }
  </script>
  <style>
    :root {
      --bg: #0f1117;
      --panel: #1a1d27;
      --border: #2a2d3a;
      --text: #e2e4e9;
      --text-dim: #8b8fa3;
      --status-stuck: #ef4444;
      --status-active: #3b82f6;
      --status-idle: #6b7280;
      --status-healthy: #22c55e;
      --font-sans: 'Inter', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --radius: 8px;
      --list-width: 320px;
      --sparkline-display: inline-flex;
      --stuck-threshold: 5;
      --detail-tab: timeline;
      --list-sort: severity;
      --summary-pos: bottom;
    }

    :root * {
      transition: color 0.3s ease, background-color 0.3s ease,
                  border-color 0.3s ease, padding 0.3s ease,
                  gap 0.3s ease, font-size 0.3s ease,
                  border-radius 0.3s ease, box-shadow 0.3s ease,
                  max-width 0.3s ease, width 0.3s ease;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-sans);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .mono { font-family: var(--font-mono); }

    /* Summary bar positioning */
    #summary-bar-top { display: none; }
    #summary-bar-bottom { display: flex; }

    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

    /* Agent list panel */
    #agent-list-panel {
      width: var(--list-width);
      min-width: var(--list-width);
      max-width: var(--list-width);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      flex-shrink: 0;
    }

    /* Agent row */
    .agent-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background-color 0.15s ease;
    }
    .agent-row:hover { background: rgba(255,255,255,0.03); }
    .agent-row.selected { background: rgba(59, 130, 246, 0.08); border-left: 2px solid var(--status-active); }
    .agent-row.selected.stuck { border-left-color: var(--status-stuck); background: rgba(239, 68, 68, 0.06); }

    /* Status dot */
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .status-dot.stuck { background: var(--status-stuck); box-shadow: 0 0 6px rgba(239,68,68,0.5); }
    .status-dot.active { background: var(--status-active); box-shadow: 0 0 6px rgba(59,130,246,0.4); animation: pulse-active 2s ease-in-out infinite; }
    .status-dot.idle { background: var(--status-idle); }

    @keyframes pulse-active {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* Sparklines */
    .sparkline {
      display: var(--sparkline-display);
      gap: 2px;
      align-items: flex-end;
      height: 16px;
      flex-shrink: 0;
    }
    .sparkline-bar {
      width: 3px;
      background: var(--text-dim);
      border-radius: 1px;
      opacity: 0.5;
    }
    .sparkline-bar.recent { background: var(--status-active); opacity: 0.8; }

    /* Timeline */
    .timeline-item {
      display: flex;
      gap: 12px;
      padding: 8px 0;
      animation: fadeInUp 0.3s ease forwards;
      opacity: 0;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .timeline-line {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex-shrink: 0;
      width: 20px;
    }
    .timeline-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      border: 1.5px solid var(--border);
      background: var(--panel);
      flex-shrink: 0;
      margin-top: 4px;
    }
    .timeline-connector {
      flex: 1;
      width: 1px;
      background: var(--border);
      margin-top: 2px;
    }

    /* Tab system */
    .tab-btn {
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-dim);
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
      white-space: nowrap;
    }
    .tab-btn:hover { color: var(--text); }
    .tab-btn.active { color: var(--text); border-bottom-color: var(--status-active); }
    .tab-btn.active.stuck { border-bottom-color: var(--status-stuck); }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* Metric card */
    .metric-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 16px;
    }

    /* Progress bar */
    .progress-track {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.5s ease;
    }

    /* Entrance animation stagger */
    .agent-row:nth-child(1) { animation: fadeInLeft 0.3s ease 0.05s both; }
    .agent-row:nth-child(2) { animation: fadeInLeft 0.3s ease 0.10s both; }
    .agent-row:nth-child(3) { animation: fadeInLeft 0.3s ease 0.15s both; }
    .agent-row:nth-child(4) { animation: fadeInLeft 0.3s ease 0.20s both; }
    .agent-row:nth-child(5) { animation: fadeInLeft 0.3s ease 0.25s both; }
    .agent-row:nth-child(6) { animation: fadeInLeft 0.3s ease 0.30s both; }
    .agent-row:nth-child(7) { animation: fadeInLeft 0.3s ease 0.35s both; }
    .agent-row:nth-child(8) { animation: fadeInLeft 0.3s ease 0.40s both; }

    @keyframes fadeInLeft {
      from { opacity: 0; transform: translateX(-12px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* Detail panel entrance */
    #detail-panel {
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .detail-content-animate {
      animation: fadeInUp 0.25s ease both;
    }

    /* Stuck badge pulse */
    .stuck-badge {
      animation: stuckPulse 2s ease-in-out infinite;
    }
    @keyframes stuckPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Summary bar */
    #summary-bar-top,
    #summary-bar-bottom {
      background: var(--panel);
      border-color: var(--border);
      padding: 8px 16px;
      align-items: center;
      gap: 24px;
      font-size: 12px;
      flex-shrink: 0;
    }

    /* Context code block */
    .code-block {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-dim);
      line-height: 1.6;
    }
  </style>
</head>
<body>

  <!-- Top summary bar (conditionally shown) -->
  <div id="summary-bar-top" class="border-b">
    <span style="color: var(--text-dim)">Fleet</span>
    <span class="mono" style="color: var(--status-stuck)">&#9679; 2 stuck</span>
    <span class="mono" style="color: var(--status-active)">&#9679; 4 active</span>
    <span class="mono" style="color: var(--status-idle)">&#9679; 2 idle</span>
    <span style="color: var(--text-dim); margin-left: auto">8 agents total</span>
    <span id="top-stuck-alert" style="color: var(--status-stuck); font-weight: 600">&#9888; 2 need attention</span>
  </div>

  <!-- Header -->
  <div class="flex items-center justify-between px-4 py-3 flex-shrink-0" style="background: var(--panel); border-bottom: 1px solid var(--border);">
    <div class="flex items-center gap-3">
      <div class="mono text-sm font-semibold" style="color: var(--text)">Agent Operations Center</div>
      <div class="text-xs px-2 py-0.5 rounded" style="background: rgba(239,68,68,0.12); color: var(--status-stuck); font-weight: 600; border: 1px solid rgba(239,68,68,0.2)">2 STUCK</div>
    </div>
    <div class="text-xs mono" style="color: var(--text-dim)">Live · Updated just now</div>
  </div>

  <!-- Main layout -->
  <div class="flex flex-1 overflow-hidden">

    <!-- Left: Agent List Panel -->
    <div id="agent-list-panel">
      <!-- List header -->
      <div class="px-3 py-2 flex items-center justify-between flex-shrink-0 sticky top-0 z-10" style="background: var(--panel); border-bottom: 1px solid var(--border);">
        <span class="text-xs font-semibold uppercase tracking-wider" style="color: var(--text-dim)">Agents</span>
        <span class="text-xs mono" style="color: var(--text-dim)" id="sort-label">by severity</span>
      </div>

      <!-- Agent rows (injected by JS) -->
      <div id="agent-list-container"></div>
    </div>

    <!-- Right: Detail Panel -->
    <div id="detail-panel" class="flex-1 flex flex-col overflow-hidden">

      <!-- Detail header -->
      <div class="px-5 py-3 flex-shrink-0" style="border-bottom: 1px solid var(--border); background: var(--panel);">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <span id="detail-agent-name" class="mono text-sm font-semibold" style="color: var(--text)">claude-sonnet-8</span>
            <span id="detail-status-badge" class="text-xs px-2 py-0.5 rounded font-semibold stuck-badge" style="background: rgba(239,68,68,0.12); color: var(--status-stuck); border: 1px solid rgba(239,68,68,0.2)">STUCK</span>
          </div>
          <div id="detail-silence-timer" class="mono text-xs" style="color: var(--status-stuck)">Silent 22m</div>
        </div>
        <div class="mt-1 text-xs" style="color: var(--text-dim)">
          <span id="detail-task-title">Fix pagination bug</span>
          <span class="mx-2 opacity-40">·</span>
          <span id="detail-project" class="mono" style="color: var(--text-dim)">web</span>
        </div>
      </div>

      <!-- Tab navigation -->
      <div class="flex items-center flex-shrink-0" style="border-bottom: 1px solid var(--border); background: var(--panel); padding: 0 12px;">
        <button class="tab-btn active stuck" data-tab="timeline" onclick="switchTab('timeline')">Timeline</button>
        <button class="tab-btn" data-tab="metrics" onclick="switchTab('metrics')">Metrics</button>
        <button class="tab-btn" data-tab="task" onclick="switchTab('task')">Task Context</button>
      </div>

      <!-- Detail scrollable body -->
      <div class="flex-1 overflow-y-auto p-5">

        <!-- TIMELINE TAB -->
        <div id="tab-timeline" class="tab-panel active">
          <div id="timeline-container"></div>
        </div>

        <!-- METRICS TAB -->
        <div id="tab-metrics" class="tab-panel">
          <div class="grid gap-3" style="grid-template-columns: repeat(3, 1fr);">
            <div class="metric-card detail-content-animate">
              <div class="text-xs mb-2" style="color: var(--text-dim)">Elapsed Time</div>
              <div id="metric-elapsed" class="mono text-2xl font-semibold" style="color: var(--text)">30m</div>
              <div class="text-xs mt-1" style="color: var(--text-dim)">since claimed</div>
            </div>
            <div class="metric-card detail-content-animate" style="animation-delay: 0.05s">
              <div class="text-xs mb-2" style="color: var(--text-dim)">Silence Duration</div>
              <div id="metric-silence" class="mono text-2xl font-semibold" style="color: var(--status-stuck)">22m</div>
              <div class="text-xs mt-1" style="color: var(--status-stuck)">no activity</div>
            </div>
            <div class="metric-card detail-content-animate" style="animation-delay: 0.1s">
              <div class="text-xs mb-2" style="color: var(--text-dim)">Progress</div>
              <div id="metric-progress" class="mono text-2xl font-semibold" style="color: var(--text)">20%</div>
              <div class="progress-track mt-2">
                <div id="metric-progress-bar" class="progress-fill" style="width: 20%; background: var(--status-stuck);"></div>
              </div>
            </div>
          </div>
          <div class="mt-4 grid gap-3" style="grid-template-columns: 1fr 1fr;">
            <div class="metric-card detail-content-animate" style="animation-delay: 0.15s">
              <div class="text-xs mb-2" style="color: var(--text-dim)">Claimed At</div>
              <div id="metric-claimed" class="mono text-sm font-medium" style="color: var(--text)">30m ago</div>
            </div>
            <div class="metric-card detail-content-animate" style="animation-delay: 0.2s">
              <div class="text-xs mb-2" style="color: var(--text-dim)">Last Event</div>
              <div id="metric-last-event" class="mono text-sm font-medium" style="color: var(--status-stuck)">22m ago</div>
            </div>
          </div>
        </div>

        <!-- TASK CONTEXT TAB -->
        <div id="tab-task" class="tab-panel">
          <div class="detail-content-animate">
            <div class="text-xs font-semibold uppercase tracking-wider mb-3" style="color: var(--text-dim)">Current Task</div>
            <div class="metric-card mb-4">
              <div class="flex items-start justify-between gap-4">
                <div>
                  <div id="ctx-task-title" class="text-sm font-semibold mb-1" style="color: var(--text)">Fix pagination bug</div>
                  <div class="flex items-center gap-2 text-xs" style="color: var(--text-dim)">
                    <span class="mono" id="ctx-project">web</span>
                    <span>·</span>
                    <span id="ctx-status-text">STUCK</span>
                  </div>
                </div>
                <div class="text-right flex-shrink-0">
                  <div id="ctx-progress-val" class="mono text-lg font-semibold" style="color: var(--text)">20%</div>
                  <div class="progress-track mt-1" style="width: 80px;">
                    <div id="ctx-progress-bar" class="progress-fill" style="width: 20%; background: var(--status-stuck);"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="text-xs font-semibold uppercase tracking-wider mb-3" style="color: var(--text-dim)">Investigation State</div>
            <div class="code-block mb-4">
              <div id="ctx-state-lines"></div>
            </div>

            <div class="text-xs font-semibold uppercase tracking-wider mb-3" style="color: var(--text-dim)">Agent Details</div>
            <div class="grid gap-2" style="grid-template-columns: 1fr 1fr;">
              <div class="metric-card">
                <div class="text-xs mb-1" style="color: var(--text-dim)">Agent ID</div>
                <div id="ctx-agent-id" class="mono text-xs" style="color: var(--text)">claude-sonnet-8</div>
              </div>
              <div class="metric-card">
                <div class="text-xs mb-1" style="color: var(--text-dim)">Silence</div>
                <div id="ctx-silence" class="mono text-xs" style="color: var(--status-stuck)">22 minutes</div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Bottom summary bar (conditionally shown) -->
  <div id="summary-bar-bottom" class="border-t">
    <span style="color: var(--text-dim)">Fleet</span>
    <span class="mono flex items-center gap-1.5" style="color: var(--status-stuck)">
      <span style="width:7px;height:7px;border-radius:50%;background:var(--status-stuck);display:inline-block;"></span>
      2 stuck
    </span>
    <span class="mono flex items-center gap-1.5" style="color: var(--status-active)">
      <span style="width:7px;height:7px;border-radius:50%;background:var(--status-active);display:inline-block;"></span>
      4 active
    </span>
    <span class="mono flex items-center gap-1.5" style="color: var(--status-idle)">
      <span style="width:7px;height:7px;border-radius:50%;background:var(--status-idle);display:inline-block;"></span>
      2 idle
    </span>
    <div style="flex:1"></div>
    <span class="text-xs" style="color: var(--text-dim)">8 agents · worst silence: <span class="mono" style="color:var(--status-stuck)">22m</span></span>
  </div>

<script>
  // ─── Agent Data ───────────────────────────────────────────────────────────
  const agents = [
    {
      id: 'claude-sonnet-8',
      status: 'stuck',
      task: 'Fix pagination bug',
      project: 'web',
      progress: 20,
      claimedAgo: 30,
      silenceMin: 22,
      lastEventMin: 22,
      timeline: [
        { time: '22m ago', type: 'checkpoint', icon: '&#9679;', desc: 'Investigating offset calculation', detail: 'Traced bug to off-by-one in cursor logic' },
        { time: '25m ago', type: 'checkpoint', icon: '&#9679;', desc: 'Reading cursor implementation', detail: 'Reviewed existing pagination helpers' },
        { time: '30m ago', type: 'claimed', icon: '&#8627;', desc: 'Task claimed', detail: 'Agent assigned Fix pagination bug' },
      ],
      stateLines: ['Last checkpoint: "Investigating offset calculation"', 'Suspect: off-by-one in cursor math', 'Files read: src/api/pagination.ts, src/db/queries.ts', 'No writes yet · 0 tool calls since last checkpoint'],
    },
    {
      id: 'claude-opus-7',
      status: 'stuck',
      task: 'Implement auth middleware',
      project: 'api-v2',
      progress: 35,
      claimedAgo: 18,
      silenceMin: 12,
      lastEventMin: 12,
      timeline: [
        { time: '12m ago', type: 'checkpoint', icon: '&#9679;', desc: 'Analyzing JWT library options', detail: 'Comparing jsonwebtoken vs jose vs fast-jwt' },
        { time: '15m ago', type: 'checkpoint', icon: '&#9679;', desc: 'Reading existing auth code', detail: 'Reviewed legacy session middleware' },
        { time: '18m ago', type: 'claimed', icon: '&#8627;', desc: 'Task claimed', detail: 'Agent assigned Implement auth middleware' },
        { time: '20m ago', type: 'completed', icon: '&#10003;', desc: 'Completed: Set up project scaffolding', detail: 'Prior task finished cleanly' },
        { time: '25m ago', type: 'checkpoint', icon: '&#9679;', desc: 'Generated folder structure', detail: 'Created src/auth/ directory layout' },
      ],
      stateLines: ['Last checkpoint: "Analyzing JWT library options"', 'Leaning toward: jose (ESM-native, zero deps)', 'Files read: src/middleware/session.ts, docs/auth.md', 'Silent 12m · awaiting decision?'],
    },
    {
      id: 'claude-sonnet-3',
      status: 'active',
      task: 'Add search API endpoint',
      project: 'api-v2',
      progress: 60,
      claimedAgo: 8,
      silenceMin: 1,
      lastEventMin: 1,
      timeline: [
        { time: '1m ago', type: 'checkpoint', icon: '&#9679;', desc: 'Implementing full-text search', detail: 'Wiring FTS5 virtual table queries' },
        { time: '3m ago', type: 'checkpoint', icon: '&#9679;', desc: 'Added search route handler', detail: 'POST /api/search with pagination support' },
        { time: '5m ago', type: 'checkpoint', icon: '&#9679;', desc: 'Designing search schema', detail: 'Defined FTS5 table schema and triggers' },
        { time: '8m ago', type: 'claimed', icon: '&#8627;', desc: 'Task claimed', detail: 'Agent assigned Add search API endpoint' },
        { time: '10m ago', type: 'completed', icon: '&#10003;', desc: 'Completed: Design search schema', detail: 'Prior task finished' },
      ],
      stateLines: ['Last checkpoint: "Implementing full-text search"', 'Progress: FTS5 table created, triggers pending', 'Active writes to: src/api/search.ts', 'Last event: 1m ago · healthy'],
    },
    {
      id: 'claude-haiku-2',
      status: 'active',
      task: 'Write unit tests for TaskService',
      project: 'core',
      progress: 40,
      claimedAgo: 12,
      silenceMin: 3,
      lastEventMin: 3,
      timeline: [
        { time: '3m ago', type: 'checkpoint', icon: '&#9679;', desc: 'Writing claimTask test cases', detail: 'Covering race condition scenarios' },
        { time: '7m ago', type: 'checkpoint', icon: '&#9679;', desc: 'Set up test fixtures', detail: 'In-memory SQLite with seed data' },
        { time: '12m ago', type: 'claimed', icon: '&#8627;', desc: 'Task claimed', detail: 'Agent assigned Write unit tests for TaskService' },
      ],
      stateLines: ['Last checkpoint: "Writing claimTask test cases"', 'Coverage target: 85% for TaskService', 'Framework: vitest · 12 tests written so far', 'Last event: 3m ago · on track'],
    },
    {
      id: 'gemini-pro-1',
      status: 'active',
      task: 'Refactor database queries',
      project: 'core',
      progress: 75,
      claimedAgo: 15,
      silenceMin: 0,
      lastEventMin: 0,
      timeline: [
        { time: '30s ago', type: 'checkpoint', icon: '&#9679;', desc: 'Optimizing JOIN query in projections', detail: 'Using covering index on task_id, status' },
        { time: '5m ago', type: 'checkpoint', icon: '&#9679;', desc: 'Extracted query builder helpers', detail: 'Created src/db/query-helpers.ts' },
        { time: '10m ago', type: 'checkpoint', icon: '&#9679;', desc: 'Audited slow query log', detail: 'Identified 3 N+1 patterns' },
        { time: '15m ago', type: 'claimed', icon: '&#8627;', desc: 'Task claimed', detail: 'Agent assigned Refactor database queries' },
      ],
      stateLines: ['Last checkpoint: "Optimizing JOIN query in projections"', 'Queries refactored: 8/11 complete', 'Perf gain: ~40% on list queries', 'Last event: 30s ago · excellent'],
    },
    {
      id: 'gpt-4o-agent',
      status: 'active',
      task: 'Update API documentation',
      project: 'docs',
      progress: 25,
      claimedAgo: 5,
      silenceMin: 2,
      lastEventMin: 2,
      timeline: [
        { time: '2m ago', type: 'checkpoint', icon: '&#9679;', desc: 'Documenting search endpoint', detail: 'OpenAPI schema for POST /api/search' },
        { time: '5m ago', type: 'claimed', icon: '&#8627;', desc: 'Task claimed', detail: 'Agent assigned Update API documentation' },
      ],
      stateLines: ['Last checkpoint: "Documenting search endpoint"', 'Files updated: docs/api/search.md', 'Endpoints remaining: 7 of 9', 'Last event: 2m ago · early progress'],
    },
    {
      id: 'claude-opus-5',
      status: 'idle',
      task: null,
      project: null,
      progress: null,
      claimedAgo: null,
      silenceMin: null,
      lastEventMin: null,
      lastCompleted: 'Set up CI pipeline',
      lastCompletedProject: 'infra',
      lastCompletedAgo: 8,
      timeline: [
        { time: '8m ago', type: 'completed', icon: '&#10003;', desc: 'Completed: Set up CI pipeline', detail: 'GitHub Actions workflow deployed' },
        { time: '35m ago', type: 'checkpoint', icon: '&#9679;', desc: 'Configuring artifact caching', detail: 'pnpm store cache on workflow runners' },
        { time: '45m ago', type: 'claimed', icon: '&#8627;', desc: 'Task claimed', detail: 'Agent assigned Set up CI pipeline' },
      ],
      stateLines: ['Status: IDLE · awaiting next task', 'Last completed: Set up CI pipeline (infra)', 'Completed 8m ago · ready to claim'],
    },
    {
      id: 'claude-haiku-9',
      status: 'idle',
      task: null,
      project: null,
      progress: null,
      claimedAgo: null,
      silenceMin: null,
      lastEventMin: null,
      lastCompleted: 'Add input validation',
      lastCompletedProject: 'api-v2',
      lastCompletedAgo: 3,
      timeline: [
        { time: '3m ago', type: 'completed', icon: '&#10003;', desc: 'Completed: Add input validation', detail: 'Zod schemas for all request bodies' },
        { time: '20m ago', type: 'checkpoint', icon: '&#9679;', desc: 'Validating nested objects', detail: 'Recursive schema for task tree input' },
        { time: '30m ago', type: 'claimed', icon: '&#8627;', desc: 'Task claimed', detail: 'Agent assigned Add input validation' },
      ],
      stateLines: ['Status: IDLE · awaiting next task', 'Last completed: Add input validation (api-v2)', 'Completed 3m ago · ready to claim'],
    },
  ];

  // ─── State ────────────────────────────────────────────────────────────────
  let selectedAgentId = 'claude-sonnet-8';
  let currentTab = 'timeline';
  let currentSort = 'severity';
  let stuckThreshold = 5;

  // ─── Sorting ──────────────────────────────────────────────────────────────
  function sortAgents(agents, mode, threshold) {
    const statusOrder = { stuck: 0, active: 1, idle: 2 };
    const copy = [...agents];

    // Recompute stuck status based on threshold
    const withStuck = copy.map(a => ({
      ...a,
      effectiveStatus: (a.status === 'stuck' || (a.silenceMin != null && a.silenceMin >= threshold)) ? 'stuck' : a.status,
    }));

    if (mode === 'severity') {
      return withStuck.sort((a, b) => {
        const so = statusOrder[a.effectiveStatus] - statusOrder[b.effectiveStatus];
        if (so !== 0) return so;
        return (b.silenceMin || 0) - (a.silenceMin || 0);
      });
    } else if (mode === 'silence') {
      return withStuck.sort((a, b) => (b.silenceMin || 0) - (a.silenceMin || 0));
    } else if (mode === 'recency') {
      return withStuck.sort((a, b) => (a.lastEventMin || 999) - (b.lastEventMin || 999));
    }
    return withStuck;
  }

  // ─── Sparkline dots ───────────────────────────────────────────────────────
  function buildSparkline(agent) {
    // Build 8 bars representing activity: recent bars taller/brighter
    const bars = [];
    for (let i = 0; i < 8; i++) {
      const isRecent = agent.status === 'active' && i >= 5;
      const height = isRecent ? Math.floor(Math.random() * 8 + 8) : Math.floor(Math.random() * 6 + 2);
      bars.push(`<span class="sparkline-bar ${isRecent ? 'recent' : ''}" style="height:${height}px"></span>`);
    }
    return bars.join('');
  }

  // ─── Render agent list ────────────────────────────────────────────────────
  function renderList() {
    const sorted = sortAgents(agents, currentSort, stuckThreshold);
    const container = document.getElementById('agent-list-container');
    container.innerHTML = '';

    sorted.forEach(agent => {
      const effectiveStatus = (agent.status === 'stuck' || (agent.silenceMin != null && agent.silenceMin >= stuckThreshold)) ? 'stuck' : agent.status;
      const isSelected = agent.id === selectedAgentId;

      const taskLabel = agent.task
        ? `<span style="color:var(--text);font-size:11px;" class="truncate">${agent.task}</span>`
        : `<span style="color:var(--text-dim);font-size:11px;">idle · ${agent.lastCompleted}</span>`;

      const timerLabel = effectiveStatus === 'stuck'
        ? `<span class="mono" style="color:var(--status-stuck);font-size:10px;flex-shrink:0;">${agent.silenceMin}m</span>`
        : effectiveStatus === 'active'
        ? `<span class="mono" style="color:var(--text-dim);font-size:10px;flex-shrink:0;">${agent.lastEventMin}m</span>`
        : `<span class="mono" style="color:var(--text-dim);font-size:10px;flex-shrink:0;">done</span>`;

      const sparklineHtml = `<span class="sparkline" style="display:var(--sparkline-display)">${buildSparkline(agent)}</span>`;

      const row = document.createElement('div');
      row.className = `agent-row ${isSelected ? 'selected' : ''} ${isSelected && effectiveStatus === 'stuck' ? 'stuck' : ''}`;
      row.dataset.agentId = agent.id;
      row.innerHTML = `
        <span class="status-dot ${effectiveStatus}"></span>
        <div class="flex flex-col flex-1 min-w-0 gap-0.5">
          <div class="flex items-center justify-between gap-2">
            <span class="mono text-xs font-medium truncate" style="color:var(--text)">${agent.id}</span>
            ${timerLabel}
          </div>
          <div class="flex items-center justify-between gap-2">
            <div class="truncate flex-1">${taskLabel}</div>
            ${sparklineHtml}
          </div>
        </div>
      `;
      row.addEventListener('click', () => selectAgent(agent.id));
      container.appendChild(row);
    });

    document.getElementById('sort-label').textContent = currentSort === 'severity' ? 'by severity' : currentSort === 'silence' ? 'by silence' : 'by recency';
  }

  // ─── Timeline rendering ───────────────────────────────────────────────────
  function renderTimeline(agent) {
    const container = document.getElementById('timeline-container');
    const events = agent.timeline || [];
    container.innerHTML = '';
    events.forEach((ev, i) => {
      const isLast = i === events.length - 1;
      const typeColor = ev.type === 'completed' ? 'var(--status-healthy)' : ev.type === 'claimed' ? 'var(--status-active)' : agent.status === 'stuck' ? 'var(--status-stuck)' : 'var(--text-dim)';
      const dot = document.createElement('div');
      dot.className = 'timeline-item';
      dot.style.animationDelay = `${i * 0.06}s`;
      dot.innerHTML = `
        <div class="timeline-line">
          <div class="timeline-dot" style="border-color:${typeColor};background:${i === 0 ? typeColor : 'var(--panel)'}"></div>
          ${!isLast ? '<div class="timeline-connector"></div>' : ''}
        </div>
        <div class="flex-1 pb-4">
          <div class="flex items-center gap-2 mb-0.5">
            <span class="mono text-xs" style="color:${typeColor}">${ev.type.toUpperCase()}</span>
            <span class="text-xs" style="color:var(--text-dim)">${ev.time}</span>
          </div>
          <div class="text-sm font-medium mb-0.5" style="color:var(--text)">${ev.desc}</div>
          <div class="text-xs" style="color:var(--text-dim)">${ev.detail}</div>
        </div>
      `;
      container.appendChild(dot);
    });
  }

  // ─── Select agent → update detail panel ──────────────────────────────────
  function selectAgent(agentId) {
    selectedAgentId = agentId;
    const agent = agents.find(a => a.id === agentId);
    if (!agent) return;

    const effectiveStatus = (agent.status === 'stuck' || (agent.silenceMin != null && agent.silenceMin >= stuckThreshold)) ? 'stuck' : agent.status;
    const statusColor = effectiveStatus === 'stuck' ? 'var(--status-stuck)' : effectiveStatus === 'active' ? 'var(--status-active)' : 'var(--status-idle)';
    const statusBg = effectiveStatus === 'stuck' ? 'rgba(239,68,68,0.12)' : effectiveStatus === 'active' ? 'rgba(59,130,246,0.12)' : 'rgba(107,114,128,0.12)';
    const statusBorder = effectiveStatus === 'stuck' ? 'rgba(239,68,68,0.2)' : effectiveStatus === 'active' ? 'rgba(59,130,246,0.2)' : 'rgba(107,114,128,0.2)';

    // Header
    document.getElementById('detail-agent-name').textContent = agent.id;
    const badge = document.getElementById('detail-status-badge');
    badge.textContent = effectiveStatus.toUpperCase();
    badge.style.color = statusColor;
    badge.style.background = statusBg;
    badge.style.borderColor = statusBorder;
    badge.className = 'text-xs px-2 py-0.5 rounded font-semibold' + (effectiveStatus === 'stuck' ? ' stuck-badge' : '');

    const silenceEl = document.getElementById('detail-silence-timer');
    if (effectiveStatus === 'stuck') {
      silenceEl.textContent = `Silent ${agent.silenceMin}m`;
      silenceEl.style.color = 'var(--status-stuck)';
    } else if (effectiveStatus === 'active') {
      silenceEl.textContent = `Active · ${agent.lastEventMin}m ago`;
      silenceEl.style.color = 'var(--status-active)';
    } else {
      silenceEl.textContent = 'Idle';
      silenceEl.style.color = 'var(--status-idle)';
    }

    document.getElementById('detail-task-title').textContent = agent.task || (agent.lastCompleted ? `Last: ${agent.lastCompleted}` : '—');
    document.getElementById('detail-project').textContent = agent.project || agent.lastCompletedProject || '—';

    // Tab buttons color
    document.querySelectorAll('.tab-btn.active').forEach(b => {
      b.style.borderBottomColor = '';
    });
    const activeTabBtn = document.querySelector(`.tab-btn[data-tab="${currentTab}"]`);
    if (activeTabBtn) {
      activeTabBtn.style.borderBottomColor = statusColor;
    }

    // Metrics
    document.getElementById('metric-elapsed').textContent = agent.claimedAgo ? `${agent.claimedAgo}m` : '—';
    const silenceVal = document.getElementById('metric-silence');
    silenceVal.textContent = agent.silenceMin != null ? `${agent.silenceMin}m` : '—';
    silenceVal.style.color = effectiveStatus === 'stuck' ? 'var(--status-stuck)' : 'var(--text)';
    document.getElementById('metric-progress').textContent = agent.progress != null ? `${agent.progress}%` : '—';
    const progBar = document.getElementById('metric-progress-bar');
    progBar.style.width = agent.progress != null ? `${agent.progress}%` : '0%';
    progBar.style.background = statusColor;
    document.getElementById('metric-claimed').textContent = agent.claimedAgo ? `${agent.claimedAgo}m ago` : '—';
    const lastEventEl = document.getElementById('metric-last-event');
    lastEventEl.textContent = agent.lastEventMin != null ? `${agent.lastEventMin}m ago` : agent.lastCompletedAgo ? `${agent.lastCompletedAgo}m ago` : '—';
    lastEventEl.style.color = effectiveStatus === 'stuck' ? 'var(--status-stuck)' : 'var(--text)';

    // Task context
    document.getElementById('ctx-task-title').textContent = agent.task || (agent.lastCompleted || '—');
    document.getElementById('ctx-project').textContent = agent.project || agent.lastCompletedProject || '—';
    document.getElementById('ctx-status-text').textContent = effectiveStatus.toUpperCase();
    document.getElementById('ctx-status-text').style.color = statusColor;
    document.getElementById('ctx-progress-val').textContent = agent.progress != null ? `${agent.progress}%` : '—';
    const ctxBar = document.getElementById('ctx-progress-bar');
    ctxBar.style.width = agent.progress != null ? `${agent.progress}%` : '0%';
    ctxBar.style.background = statusColor;
    document.getElementById('ctx-agent-id').textContent = agent.id;
    const ctxSilence = document.getElementById('ctx-silence');
    ctxSilence.textContent = agent.silenceMin != null ? `${agent.silenceMin} minutes` : 'N/A';
    ctxSilence.style.color = effectiveStatus === 'stuck' ? 'var(--status-stuck)' : 'var(--text-dim)';
    const stateLines = document.getElementById('ctx-state-lines');
    stateLines.innerHTML = (agent.stateLines || []).map(l => `<div>${l}</div>`).join('');

    // Timeline
    renderTimeline(agent);

    // Update list selection
    renderList();
  }

  // ─── Tab switching ────────────────────────────────────────────────────────
  function switchTab(tabId) {
    currentTab = tabId;
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => {
      b.classList.remove('active', 'stuck');
      b.style.borderBottomColor = '';
    });
    const panel = document.getElementById(`tab-${tabId}`);
    if (panel) panel.classList.add('active');
    const btn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
    if (btn) {
      btn.classList.add('active');
      const agent = agents.find(a => a.id === selectedAgentId);
      if (agent) {
        const effectiveStatus = (agent.status === 'stuck' || (agent.silenceMin != null && agent.silenceMin >= stuckThreshold)) ? 'stuck' : agent.status;
        const statusColor = effectiveStatus === 'stuck' ? 'var(--status-stuck)' : effectiveStatus === 'active' ? 'var(--status-active)' : 'var(--status-idle)';
        btn.style.borderBottomColor = statusColor;
      }
    }
  }

  // ─── Summary bar positioning ──────────────────────────────────────────────
  function updateSummaryPos(pos) {
    const top = document.getElementById('summary-bar-top');
    const bottom = document.getElementById('summary-bar-bottom');
    if (pos === 'bottom') {
      top.style.display = 'none';
      bottom.style.display = 'flex';
    } else if (pos === 'top') {
      top.style.display = 'flex';
      bottom.style.display = 'none';
    } else {
      top.style.display = 'none';
      bottom.style.display = 'none';
    }
  }

  // ─── Control event listeners ──────────────────────────────────────────────
  document.addEventListener('control-change', (e) => {
    const { id, value } = e.detail;
    if (id === 'stuck-threshold') {
      stuckThreshold = parseInt(value, 10) || 5;
      renderList();
    } else if (id === 'list-sort') {
      currentSort = value;
      renderList();
    } else if (id === 'detail-tab') {
      switchTab(value);
    } else if (id === 'summary-pos') {
      updateSummaryPos(value);
    }
  });

  document.addEventListener('controls-ready', () => {
    const styles = getComputedStyle(document.documentElement);
    const sortVal = styles.getPropertyValue('--list-sort').trim();
    const threshVal = styles.getPropertyValue('--stuck-threshold').trim();
    const tabVal = styles.getPropertyValue('--detail-tab').trim();
    const posVal = styles.getPropertyValue('--summary-pos').trim();

    if (sortVal) currentSort = sortVal;
    if (threshVal) stuckThreshold = parseInt(threshVal, 10) || 5;
    if (tabVal) switchTab(tabVal);
    if (posVal) updateSummaryPos(posVal);

    renderList();
  });

  // ─── Initial render ───────────────────────────────────────────────────────
  renderList();
  selectAgent('claude-sonnet-8');
  switchTab('timeline');
</script>
</body>
</html>

  </template>
  <template id="tpl-b1">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script type="application/json" id="variation-meta">
  {
    "id": "B1",
    "family": "B",
    "familyName": "Live Feed",
    "name": "Chronicle",
    "layoutType": "Full-Width Feed + Floating Sidebar",
    "aesthetic": "Professional Dark",
    "description": "Reverse-chronological interleaved agent event feed with silence gap markers and floating agent status sidebar.",
    "controls": [
      {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["5 min", "10 min", "15 min", "30 min"],
        "cssValues": { "5 min": "5", "10 min": "10", "15 min": "15", "30 min": "30" },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
      },
      {
        "id": "feed-group",
        "label": "Feed Grouping",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["chronological", "by agent", "by task"],
        "cssValues": { "chronological": "chrono", "by agent": "agent", "by task": "task" },
        "value": "chronological",
        "defaultValue": "chronological",
        "unit": "",
        "cssVar": "--feed-group",
        "event": true
      },
      {
        "id": "sidebar-width",
        "label": "Sidebar Width",
        "type": "range",
        "min": 180, "max": 320, "step": 20,
        "options": null,
        "value": 240,
        "defaultValue": 240,
        "unit": "px",
        "cssVar": "--sidebar-width"
      },
      {
        "id": "event-detail",
        "label": "Event Detail",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["compact", "normal", "verbose"],
        "cssValues": {
          "compact": { "--event-padding": "8px", "--event-desc-display": "none" },
          "normal":  { "--event-padding": "12px", "--event-desc-display": "block" },
          "verbose": { "--event-padding": "16px", "--event-desc-display": "block" }
        },
        "value": "normal",
        "defaultValue": "normal",
        "unit": "",
        "cssVar": null
      },
      {
        "id": "gap-style",
        "label": "Silence Gap Style",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["red bar", "dotted line", "time label"],
        "cssValues": { "red bar": "bar", "dotted line": "dotted", "time label": "label" },
        "value": "red bar",
        "defaultValue": "red bar",
        "unit": "",
        "cssVar": "--gap-style",
        "event": true
      },
      {
        "id": "auto-scroll",
        "label": "Auto-Scroll",
        "type": "toggle",
        "min": null, "max": null, "step": null,
        "options": null,
        "cssValues": { "true": "1", "false": "0" },
        "value": false,
        "defaultValue": false,
        "unit": "",
        "cssVar": "--auto-scroll",
        "event": true
      }
    ]
  }
  </script>
  <style>
    :root {
      --bg: #0f1117;
      --panel: #1a1d27;
      --border: #2a2d3a;
      --text: #e2e4e9;
      --text-dim: #8b8fa3;
      --stuck: #ef4444;
      --active: #3b82f6;
      --idle: #6b7280;
      --healthy: #22c55e;
      --font-body: 'Inter', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --radius: 8px;
      --sidebar-width: 240px;
      --event-padding: 12px;
      --event-desc-display: block;
      --stuck-threshold: 5;
      --feed-group: chrono;
      --gap-style: bar;
      --auto-scroll: 0;

      /* agent colors */
      --color-claude-opus-7: #8b5cf6;
      --color-claude-sonnet-3: #3b82f6;
      --color-claude-sonnet-8: #f59e0b;
      --color-claude-haiku-2: #22c55e;
      --color-gemini-pro-1: #06b6d4;
      --color-gpt-4o-agent: #f97316;
      --color-claude-opus-5: #a855f7;
      --color-claude-haiku-9: #10b981;
    }

    :root * {
      transition: color 0.3s ease, background-color 0.3s ease,
                  border-color 0.3s ease, padding 0.3s ease,
                  gap 0.3s ease, font-size 0.3s ease,
                  border-radius 0.3s ease, box-shadow 0.3s ease,
                  max-width 0.3s ease, width 0.3s ease;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-body);
      font-size: 14px;
      height: 100vh;
      overflow: hidden;
    }

    .layout-root {
      display: flex;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    /* Feed area */
    .feed-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }

    .feed-header {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 14px 20px;
      flex-shrink: 0;
    }

    .feed-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
      padding-right: calc(20px + var(--sidebar-width) + 16px);
    }

    .feed-scroll::-webkit-scrollbar { width: 6px; }
    .feed-scroll::-webkit-scrollbar-track { background: transparent; }
    .feed-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* Event cards */
    .event-card {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: var(--event-padding);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      border-left-width: 3px;
      margin-bottom: 6px;
      cursor: pointer;
      position: relative;
      animation: fadeSlideIn 0.4s ease both;
    }

    .event-card:hover {
      border-color: color-mix(in srgb, var(--border) 50%, var(--text) 15%);
      background: color-mix(in srgb, var(--panel) 80%, var(--text) 5%);
    }

    .event-card.highlighted {
      border-color: color-mix(in srgb, var(--border) 20%, var(--active) 80%);
      background: color-mix(in srgb, var(--panel) 85%, var(--active) 15%);
    }

    .event-card.dimmed {
      opacity: 0.35;
    }

    .event-desc {
      display: var(--event-desc-display);
    }

    /* Silence gap markers */
    .silence-gap {
      margin: 10px 0;
      animation: fadeSlideIn 0.4s ease both;
    }

    .silence-gap.style-bar {
      background: color-mix(in srgb, var(--stuck) 12%, transparent);
      border: 1px solid color-mix(in srgb, var(--stuck) 35%, transparent);
      border-left: 3px solid var(--stuck);
      border-radius: var(--radius);
      padding: 8px 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .silence-gap.style-dotted {
      border-top: 2px dashed color-mix(in srgb, var(--stuck) 50%, transparent);
      padding: 4px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .silence-gap.style-dotted::before,
    .silence-gap.style-dotted::after {
      content: '';
      flex: 1;
      height: 1px;
    }

    .silence-gap.style-label {
      padding: 4px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    /* Floating sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: var(--sidebar-width);
      height: 100vh;
      background: var(--panel);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      z-index: 10;
    }

    .sidebar-header {
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-dim);
      flex-shrink: 0;
    }

    .sidebar-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .sidebar-scroll::-webkit-scrollbar { width: 4px; }
    .sidebar-scroll::-webkit-scrollbar-track { background: transparent; }
    .sidebar-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .agent-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 6px;
      margin-bottom: 4px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s ease;
    }

    .agent-chip:hover {
      background: color-mix(in srgb, var(--bg) 60%, var(--border) 40%);
    }

    .agent-chip.selected {
      border-color: var(--active);
      background: color-mix(in srgb, var(--active) 15%, transparent);
    }

    .agent-chip.status-stuck {
      background: color-mix(in srgb, var(--stuck) 10%, transparent);
      border-color: color-mix(in srgb, var(--stuck) 30%, transparent);
    }

    .agent-chip.status-stuck:hover {
      background: color-mix(in srgb, var(--stuck) 18%, transparent);
    }

    .agent-chip.status-stuck.selected {
      border-color: var(--stuck);
      background: color-mix(in srgb, var(--stuck) 20%, transparent);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .status-dot.stuck { background: var(--stuck); box-shadow: 0 0 6px var(--stuck); }
    .status-dot.active { background: var(--healthy); box-shadow: 0 0 6px var(--healthy); animation: pulse 2s infinite; }
    .status-dot.idle { background: var(--idle); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .agent-name-mono {
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 500;
      color: var(--text);
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .agent-timer {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-dim);
      white-space: nowrap;
    }

    .agent-timer.stuck { color: var(--stuck); font-weight: 600; }

    /* Event type badges */
    .badge {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 7px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .badge-claimed { background: color-mix(in srgb, var(--active) 20%, transparent); color: var(--active); border: 1px solid color-mix(in srgb, var(--active) 40%, transparent); }
    .badge-checkpoint { background: color-mix(in srgb, var(--healthy) 15%, transparent); color: var(--healthy); border: 1px solid color-mix(in srgb, var(--healthy) 35%, transparent); }
    .badge-completed { background: color-mix(in srgb, #a855f7 20%, transparent); color: #a855f7; border: 1px solid color-mix(in srgb, #a855f7 40%, transparent); }

    /* Time display */
    .event-time {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-dim);
      white-space: nowrap;
      flex-shrink: 0;
      min-width: 52px;
      text-align: right;
    }

    .event-agent {
      font-family: var(--font-mono);
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .event-task {
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
    }

    .event-description {
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 3px;
      font-style: italic;
    }

    /* Group headers */
    .group-header {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-dim);
      padding: 12px 4px 6px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 8px;
    }

    .group-block {
      margin-bottom: 16px;
    }

    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(-8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Fleet summary */
    .fleet-stat {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-right: 6px;
    }
  </style>
</head>
<body>

<div class="layout-root">
  <!-- Feed Area -->
  <div class="feed-area">
    <!-- Header -->
    <div class="feed-header">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
        <div style="display:flex; align-items:center; gap:10px;">
          <div style="width:8px; height:8px; border-radius:50%; background:var(--healthy); box-shadow:0 0 8px var(--healthy); animation:pulse 2s infinite;"></div>
          <span style="font-weight:700; font-size:15px; letter-spacing:-0.01em;">Agent Operations Chronicle</span>
          <span style="font-size:11px; color:var(--text-dim); font-family:var(--font-mono);">live</span>
        </div>
        <div style="display:flex; align-items:center; gap:4px; flex-wrap:wrap;">
          <span class="fleet-stat" style="background:color-mix(in srgb, var(--healthy) 15%, transparent); color:var(--healthy); border:1px solid color-mix(in srgb, var(--healthy) 30%, transparent);">
            <span style="width:6px;height:6px;border-radius:50%;background:var(--healthy);display:inline-block;"></span>
            4 active
          </span>
          <span class="fleet-stat" style="background:color-mix(in srgb, var(--stuck) 15%, transparent); color:var(--stuck); border:1px solid color-mix(in srgb, var(--stuck) 30%, transparent);">
            <span style="width:6px;height:6px;border-radius:50%;background:var(--stuck);display:inline-block;"></span>
            2 stuck
          </span>
          <span class="fleet-stat" style="background:color-mix(in srgb, var(--idle) 15%, transparent); color:var(--idle); border:1px solid color-mix(in srgb, var(--idle) 30%, transparent);">
            <span style="width:6px;height:6px;border-radius:50%;background:var(--idle);display:inline-block;"></span>
            2 idle
          </span>
          <span style="font-size:11px; color:var(--text-dim); margin-left:4px;">8 agents total</span>
        </div>
      </div>
    </div>

    <!-- Feed -->
    <div class="feed-scroll" id="feed-scroll">
      <div id="feed-container">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>

  <!-- Floating Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">Agent Status</div>
    <div class="sidebar-scroll" id="sidebar-agents">
      <!-- Populated by JS -->
    </div>
  </div>
</div>

<script>
// ============================================================
// DATA
// ============================================================

const AGENTS = {
  'claude-opus-7':  { color: '#8b5cf6', status: 'stuck',  silentMin: 12, lastSec: 720 },
  'claude-sonnet-3':{ color: '#3b82f6', status: 'active', silentMin: 1,  lastSec: 60  },
  'claude-sonnet-8':{ color: '#f59e0b', status: 'stuck',  silentMin: 22, lastSec: 1320 },
  'claude-haiku-2': { color: '#22c55e', status: 'active', silentMin: 3,  lastSec: 180 },
  'gemini-pro-1':   { color: '#06b6d4', status: 'active', silentMin: 0,  lastSec: 30  },
  'gpt-4o-agent':   { color: '#f97316', status: 'active', silentMin: 2,  lastSec: 120 },
  'claude-opus-5':  { color: '#a855f7', status: 'idle',   silentMin: 8,  lastSec: 480 },
  'claude-haiku-9': { color: '#10b981', status: 'idle',   silentMin: 3,  lastSec: 180 },
};

const SIDEBAR_ORDER = [
  'claude-opus-7',
  'claude-sonnet-8',
  'claude-sonnet-3',
  'claude-haiku-2',
  'gemini-pro-1',
  'gpt-4o-agent',
  'claude-opus-5',
  'claude-haiku-9',
];

const RAW_EVENTS = [
  { id: 'e1',  agent: 'gemini-pro-1',    type: 'checkpoint', task: 'Refactor database queries',    desc: 'Optimizing JOIN queries',            agoSec: 30,   agoLabel: '30s ago' },
  { id: 'e2',  agent: 'claude-sonnet-3', type: 'checkpoint', task: 'Add search API endpoint',      desc: 'Implementing full-text search',      agoSec: 60,   agoLabel: '1m ago'  },
  { id: 'e3',  agent: 'gpt-4o-agent',    type: 'checkpoint', task: 'Update API documentation',     desc: 'Writing endpoint descriptions',      agoSec: 120,  agoLabel: '2m ago'  },
  { id: 'e4',  agent: 'claude-haiku-2',  type: 'checkpoint', task: 'Write unit tests for TaskService', desc: 'Testing claim concurrency',      agoSec: 180,  agoLabel: '3m ago'  },
  { id: 'e5',  agent: 'claude-sonnet-3', type: 'checkpoint', task: 'Add search API endpoint',      desc: 'Added search route handler',         agoSec: 180,  agoLabel: '3m ago'  },
  { id: 'e6',  agent: 'claude-sonnet-3', type: 'checkpoint', task: 'Add search API endpoint',      desc: 'Designing search schema',            agoSec: 300,  agoLabel: '5m ago'  },
  { id: 'e7',  agent: 'gpt-4o-agent',    type: 'claimed',    task: 'Update API documentation',     desc: null,                                 agoSec: 300,  agoLabel: '5m ago'  },
  { id: 'e8',  agent: 'claude-sonnet-3', type: 'claimed',    task: 'Add search API endpoint',      desc: null,                                 agoSec: 480,  agoLabel: '8m ago'  },

  // GAP for claude-opus-7 at ~8m mark
  { id: 'gap1', type: 'gap', agent: 'claude-opus-7', silentMin: 12, agoSec: 480 },

  { id: 'e9',  agent: 'claude-opus-7',   type: 'checkpoint', task: 'Implement auth middleware',    desc: 'Analyzing JWT library options',      agoSec: 720,  agoLabel: '12m ago' },
  { id: 'e10', agent: 'claude-opus-7',   type: 'checkpoint', task: 'Implement auth middleware',    desc: 'Reading existing auth code',         agoSec: 900,  agoLabel: '15m ago' },
  { id: 'e11', agent: 'claude-opus-7',   type: 'claimed',    task: 'Implement auth middleware',    desc: null,                                 agoSec: 1080, agoLabel: '18m ago' },

  // GAP for claude-sonnet-8 at ~18m mark
  { id: 'gap2', type: 'gap', agent: 'claude-sonnet-8', silentMin: 22, agoSec: 1080 },

  { id: 'e12', agent: 'claude-sonnet-8', type: 'checkpoint', task: 'Fix pagination bug',           desc: 'Investigating offset calculation',    agoSec: 1320, agoLabel: '22m ago' },
  { id: 'e13', agent: 'claude-sonnet-8', type: 'checkpoint', task: 'Fix pagination bug',           desc: 'Reading cursor implementation',       agoSec: 1500, agoLabel: '25m ago' },
  { id: 'e14', agent: 'claude-sonnet-8', type: 'claimed',    task: 'Fix pagination bug',           desc: null,                                 agoSec: 1800, agoLabel: '30m ago' },
];

// ============================================================
// STATE
// ============================================================
let selectedAgent = null;
let currentGrouping = 'chrono';
let currentGapStyle = 'bar';
let stuckThresholdMin = 5;
let autoScroll = false;
let timerInterval = null;

// Live elapsed seconds per agent (since last event)
const agentElapsed = {};
for (const [name, info] of Object.entries(AGENTS)) {
  agentElapsed[name] = info.lastSec;
}

// ============================================================
// RENDER SIDEBAR
// ============================================================
function renderSidebar() {
  const container = document.getElementById('sidebar-agents');
  container.innerHTML = '';

  SIDEBAR_ORDER.forEach((name, i) => {
    const info = AGENTS[name];
    const chip = document.createElement('div');
    chip.className = `agent-chip status-${info.status}${selectedAgent === name ? ' selected' : ''}`;
    chip.dataset.agent = name;
    chip.style.animationDelay = `${i * 40}ms`;

    const dot = document.createElement('div');
    dot.className = `status-dot ${info.status}`;

    const nameEl = document.createElement('div');
    nameEl.className = 'agent-name-mono';
    nameEl.textContent = name;

    const timer = document.createElement('div');
    timer.className = `agent-timer${info.status === 'stuck' ? ' stuck' : ''}`;
    timer.dataset.timerAgent = name;
    timer.textContent = formatElapsed(agentElapsed[name]);

    chip.appendChild(dot);
    chip.appendChild(nameEl);
    chip.appendChild(timer);

    chip.addEventListener('click', () => {
      if (selectedAgent === name) {
        selectedAgent = null;
      } else {
        selectedAgent = name;
      }
      updateFeedHighlight();
      renderSidebar();
    });

    container.appendChild(chip);
  });
}

// ============================================================
// FORMAT HELPERS
// ============================================================
function formatElapsed(sec) {
  if (sec < 60) return `${sec}s`;
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return s > 0 ? `${m}m ${s}s` : `${m}m`;
}

// ============================================================
// RENDER FEED
// ============================================================
function renderFeed() {
  const container = document.getElementById('feed-container');
  container.innerHTML = '';

  if (currentGrouping === 'chrono') {
    renderChronological(container);
  } else if (currentGrouping === 'agent') {
    renderByAgent(container);
  } else if (currentGrouping === 'task') {
    renderByTask(container);
  }

  updateFeedHighlight();
}

function renderChronological(container) {
  RAW_EVENTS.forEach((item, i) => {
    const el = createFeedItem(item, i);
    container.appendChild(el);
  });
}

function renderByAgent(container) {
  const agentGroups = {};
  const agentOrder = [];

  RAW_EVENTS.forEach(item => {
    if (item.type === 'gap') return;
    const a = item.agent;
    if (!agentGroups[a]) {
      agentGroups[a] = [];
      agentOrder.push(a);
    }
    agentGroups[a].push(item);
  });

  agentOrder.forEach((agentName, gi) => {
    const block = document.createElement('div');
    block.className = 'group-block';

    const hdr = document.createElement('div');
    hdr.className = 'group-header';
    const info = AGENTS[agentName];
    hdr.innerHTML = `<span style="color:${info.color}; font-family:var(--font-mono);">${agentName}</span>`;
    block.appendChild(hdr);

    agentGroups[agentName].forEach((item, i) => {
      block.appendChild(createFeedItem(item, gi * 20 + i));
    });

    container.appendChild(block);
  });
}

function renderByTask(container) {
  const taskGroups = {};
  const taskOrder = [];

  RAW_EVENTS.forEach(item => {
    if (item.type === 'gap') return;
    const t = item.task;
    if (!taskGroups[t]) {
      taskGroups[t] = [];
      taskOrder.push(t);
    }
    taskGroups[t].push(item);
  });

  taskOrder.forEach((taskName, gi) => {
    const block = document.createElement('div');
    block.className = 'group-block';

    const hdr = document.createElement('div');
    hdr.className = 'group-header';
    hdr.textContent = taskName;
    block.appendChild(hdr);

    taskGroups[taskName].forEach((item, i) => {
      block.appendChild(createFeedItem(item, gi * 20 + i));
    });

    container.appendChild(block);
  });
}

function createFeedItem(item, idx) {
  if (item.type === 'gap') {
    return createGapMarker(item, idx);
  }

  const agentInfo = AGENTS[item.agent] || { color: '#8b8fa3', status: 'idle' };

  const card = document.createElement('div');
  card.className = 'event-card';
  card.dataset.agent = item.agent;
  card.style.borderLeftColor = agentInfo.color;
  card.style.animationDelay = `${Math.min(idx * 30, 400)}ms`;

  // Time
  const time = document.createElement('div');
  time.className = 'event-time';
  time.textContent = item.agoLabel;

  // Dot
  const dot = document.createElement('div');
  dot.style.cssText = `width:8px;height:8px;border-radius:50%;background:${agentInfo.color};flex-shrink:0;margin-top:4px;`;

  // Middle content
  const mid = document.createElement('div');
  mid.style.flex = '1';
  mid.style.minWidth = '0';

  const topRow = document.createElement('div');
  topRow.style.cssText = 'display:flex;align-items:center;gap:8px;flex-wrap:wrap;';

  const agentSpan = document.createElement('span');
  agentSpan.className = 'event-agent';
  agentSpan.style.color = agentInfo.color;
  agentSpan.textContent = item.agent;

  const badge = document.createElement('span');
  badge.className = `badge badge-${item.type}`;
  badge.textContent = item.type;

  const taskSpan = document.createElement('span');
  taskSpan.className = 'event-task';
  taskSpan.style.cssText = 'font-size:12px;color:var(--text-dim);';
  taskSpan.textContent = '· ' + item.task;

  topRow.appendChild(agentSpan);
  topRow.appendChild(badge);
  topRow.appendChild(taskSpan);
  mid.appendChild(topRow);

  if (item.desc) {
    const descEl = document.createElement('div');
    descEl.className = 'event-desc event-description';
    descEl.textContent = `"${item.desc}"`;
    mid.appendChild(descEl);
  }

  card.appendChild(time);
  card.appendChild(dot);
  card.appendChild(mid);

  return card;
}

function createGapMarker(item, idx) {
  const el = document.createElement('div');
  el.className = `silence-gap style-${currentGapStyle}`;
  el.dataset.gapAgent = item.agent;
  el.style.animationDelay = `${Math.min(idx * 30, 400)}ms`;

  const icon = document.createElement('span');
  icon.textContent = '⚠';
  icon.style.color = 'var(--stuck)';
  icon.style.fontSize = '13px';

  const label = document.createElement('span');
  label.style.cssText = `font-family:var(--font-mono);font-size:12px;font-weight:600;color:var(--stuck);`;
  label.textContent = `${item.agent}`;

  const sep = document.createElement('span');
  sep.style.cssText = 'font-size:12px;color:var(--text-dim);';
  sep.textContent = '—';

  const duration = document.createElement('span');
  duration.style.cssText = `font-size:12px;font-weight:600;color:var(--stuck);font-family:var(--font-mono);`;
  duration.textContent = `${item.silentMin}m silence`;

  if (currentGapStyle === 'bar') {
    const inner = document.createElement('div');
    inner.style.cssText = 'display:flex;align-items:center;gap:8px;';
    inner.appendChild(icon);
    inner.appendChild(label);
    inner.appendChild(sep);
    inner.appendChild(duration);

    const spacer = document.createElement('div');
    spacer.style.flex = '1';

    const pill = document.createElement('div');
    pill.style.cssText = `font-size:10px;font-weight:700;background:var(--stuck);color:white;padding:2px 8px;border-radius:10px;`;
    pill.textContent = 'STUCK';

    inner.appendChild(spacer);
    inner.appendChild(pill);
    el.appendChild(inner);

  } else if (currentGapStyle === 'dotted') {
    el.appendChild(icon);
    el.appendChild(label);
    el.appendChild(sep);
    el.appendChild(duration);

  } else if (currentGapStyle === 'label') {
    el.appendChild(icon);
    el.appendChild(label);
    el.appendChild(sep);
    el.appendChild(duration);
  }

  return el;
}

// ============================================================
// HIGHLIGHT LOGIC
// ============================================================
function updateFeedHighlight() {
  const cards = document.querySelectorAll('.event-card');
  cards.forEach(card => {
    if (!selectedAgent) {
      card.classList.remove('highlighted', 'dimmed');
    } else {
      if (card.dataset.agent === selectedAgent) {
        card.classList.add('highlighted');
        card.classList.remove('dimmed');
      } else {
        card.classList.add('dimmed');
        card.classList.remove('highlighted');
      }
    }
  });

  // gap markers: dim if not related to selected
  const gaps = document.querySelectorAll('.silence-gap');
  gaps.forEach(gap => {
    if (!selectedAgent) {
      gap.style.opacity = '1';
    } else {
      gap.style.opacity = gap.dataset.gapAgent === selectedAgent ? '1' : '0.25';
    }
  });
}

// ============================================================
// LIVE TIMERS
// ============================================================
function startTimers() {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    for (const name of Object.keys(agentElapsed)) {
      agentElapsed[name]++;
    }

    // Update sidebar timer labels
    document.querySelectorAll('[data-timer-agent]').forEach(el => {
      const name = el.dataset.timerAgent;
      if (agentElapsed[name] !== undefined) {
        el.textContent = formatElapsed(agentElapsed[name]);
      }
    });

    // Auto-scroll
    if (autoScroll) {
      const feed = document.getElementById('feed-scroll');
      feed.scrollTop = 0;
    }
  }, 1000);
}

// ============================================================
// CONTROL WIRING
// ============================================================
document.addEventListener('control-change', (e) => {
  const { id, value } = e.detail;

  if (id === 'stuck-threshold') {
    stuckThresholdMin = parseInt(value, 10) || 5;
    updateStuckHighlighting();
  }

  if (id === 'feed-group') {
    currentGrouping = value;
    renderFeed();
  }

  if (id === 'gap-style') {
    currentGapStyle = value;
    renderFeed();
  }

  if (id === 'auto-scroll') {
    autoScroll = value === '1' || value === 'true' || value === true;
  }
});

document.addEventListener('controls-ready', () => {
  const cs = getComputedStyle(document.documentElement);

  const fg = cs.getPropertyValue('--feed-group').trim();
  if (fg) currentGrouping = fg;

  const gs = cs.getPropertyValue('--gap-style').trim();
  if (gs) currentGapStyle = gs;

  const st = cs.getPropertyValue('--stuck-threshold').trim();
  if (st) stuckThresholdMin = parseInt(st, 10) || 5;

  const as = cs.getPropertyValue('--auto-scroll').trim();
  autoScroll = as === '1';

  renderFeed();
  renderSidebar();
  updateStuckHighlighting();
});

function updateStuckHighlighting() {
  // Re-evaluate which agents appear "stuck" based on threshold
  for (const [name, info] of Object.entries(AGENTS)) {
    const silentMin = info.silentMin;
    const chip = document.querySelector(`.agent-chip[data-agent="${name}"]`);
    if (!chip) continue;

    if (info.status === 'idle') continue;

    // If silence exceeds threshold, mark as stuck visually
    if (silentMin >= stuckThresholdMin && info.status !== 'idle') {
      chip.classList.add('status-stuck');
      chip.classList.remove('status-active');
      const dot = chip.querySelector('.status-dot');
      if (dot) {
        dot.className = 'status-dot stuck';
      }
      const timer = chip.querySelector('.agent-timer');
      if (timer) timer.classList.add('stuck');
    } else {
      // restore original
      if (info.status === 'active') {
        chip.classList.remove('status-stuck');
        chip.classList.add('status-active');
        const dot = chip.querySelector('.status-dot');
        if (dot) { dot.className = 'status-dot active'; }
        const timer = chip.querySelector('.agent-timer');
        if (timer) timer.classList.remove('stuck');
      }
    }
  }
}

// ============================================================
// INIT
// ============================================================
renderFeed();
renderSidebar();
startTimers();
</script>
</body>
</html>

  </template>
  <template id="tpl-b2">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script type="application/json" id="variation-meta">
  {
    "id": "B2",
    "family": "B",
    "familyName": "Live Feed",
    "name": "Lane View",
    "layoutType": "Parallel Agent Columns",
    "aesthetic": "Professional Dark",
    "description": "Each agent gets a vertical lane. Events flow down chronologically. Silence gaps are visible as empty space. Stuck lanes have red tint. Temporal comparison is instant by scanning across columns.",
    "controls": [
      {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["5 min", "10 min", "15 min", "30 min"],
        "cssValues": { "5 min": "5", "10 min": "10", "15 min": "15", "30 min": "30" },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
      },
      {
        "id": "lane-width",
        "label": "Lane Width",
        "type": "range",
        "min": 160, "max": 320, "step": 20,
        "options": null,
        "value": 220,
        "defaultValue": 220,
        "unit": "px",
        "cssVar": "--lane-width"
      },
      {
        "id": "lane-sort",
        "label": "Lane Sort",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["by status", "alphabetical", "by activity"],
        "cssValues": { "by status": "status", "alphabetical": "alpha", "by activity": "activity" },
        "value": "by status",
        "defaultValue": "by status",
        "unit": "",
        "cssVar": "--lane-sort",
        "event": true
      },
      {
        "id": "time-scale",
        "label": "Time Scale",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["5 min", "15 min", "30 min", "1 hour"],
        "cssValues": { "5 min": "5", "15 min": "15", "30 min": "30", "1 hour": "60" },
        "value": "30 min",
        "defaultValue": "30 min",
        "unit": "",
        "cssVar": "--time-scale",
        "event": true
      },
      {
        "id": "task-bounds",
        "label": "Task Boundaries",
        "type": "toggle",
        "min": null, "max": null, "step": null,
        "options": null,
        "cssValues": { "true": "1px solid var(--border)", "false": "none" },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--task-boundary"
      },
      {
        "id": "gap-style",
        "label": "Gap Style",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["red zone", "fade out", "hash marks"],
        "cssValues": { "red zone": "red", "fade out": "fade", "hash marks": "hash" },
        "value": "red zone",
        "defaultValue": "red zone",
        "unit": "",
        "cssVar": "--gap-style",
        "event": true
      }
    ]
  }
  </script>
  <style>
    :root {
      --bg: #0f1117;
      --panel: #1a1d27;
      --border: #2a2d3a;
      --text: #e2e4e9;
      --text-dim: #8b8fa3;
      --status-stuck: #ef4444;
      --status-active: #3b82f6;
      --status-idle: #6b7280;
      --status-healthy: #22c55e;
      --font-sans: 'Inter', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --radius: 8px;
      --lane-width: 220px;
      --task-boundary: 1px solid #2a2d3a;
      --stuck-threshold: 5;
      --time-scale: 30;
      --gap-style: red;
      --lane-sort: status;
    }
    :root * {
      transition: color 0.3s ease, background-color 0.3s ease,
                  border-color 0.3s ease, padding 0.3s ease,
                  gap 0.3s ease, font-size 0.3s ease,
                  border-radius 0.3s ease, box-shadow 0.3s ease,
                  max-width 0.3s ease, width 0.3s ease;
    }
    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      margin: 0;
      overflow: hidden;
    }
    .mono { font-family: var(--font-mono); }

    /* Fleet summary */
    #fleet-bar {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
    }

    /* Lane container */
    #lanes-container {
      display: flex;
      flex-direction: row;
      gap: 0;
      overflow-x: auto;
      overflow-y: hidden;
      height: calc(100vh - 80px);
    }
    #lanes-container::-webkit-scrollbar { height: 6px; }
    #lanes-container::-webkit-scrollbar-track { background: var(--bg); }
    #lanes-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* Individual lane */
    .lane {
      flex: 0 0 var(--lane-width);
      width: var(--lane-width);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      height: 100%;
      animation: laneSlideIn 0.4s ease both;
    }
    .lane:last-child { border-right: none; }

    @keyframes laneSlideIn {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .lane:nth-child(1) { animation-delay: 0.05s; }
    .lane:nth-child(2) { animation-delay: 0.10s; }
    .lane:nth-child(3) { animation-delay: 0.15s; }
    .lane:nth-child(4) { animation-delay: 0.20s; }
    .lane:nth-child(5) { animation-delay: 0.25s; }
    .lane:nth-child(6) { animation-delay: 0.30s; }
    .lane:nth-child(7) { animation-delay: 0.35s; }
    .lane:nth-child(8) { animation-delay: 0.40s; }

    /* Stuck lane */
    .lane.stuck {
      border-left: 2px solid var(--status-stuck);
    }

    /* Lane header */
    .lane-header {
      padding: 10px 10px 8px;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      flex-shrink: 0;
    }

    /* Lane body — scrollable */
    .lane-body {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      position: relative;
      padding: 0;
    }
    .lane-body::-webkit-scrollbar { width: 3px; }
    .lane-body::-webkit-scrollbar-track { background: transparent; }
    .lane-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* Stuck lane body tint */
    .lane.stuck .lane-body {
      background: rgba(239, 68, 68, 0.02);
    }

    /* Timeline track */
    .timeline-track {
      padding: 8px 8px 16px;
      display: flex;
      flex-direction: column;
      min-height: 100%;
    }

    /* Event card */
    .event-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 8px;
      margin-bottom: 4px;
      font-size: 11px;
      position: relative;
    }
    .event-card:hover {
      border-color: color-mix(in srgb, var(--text-dim) 40%, transparent);
      background: color-mix(in srgb, var(--panel) 80%, var(--text) 5%);
    }

    /* Task boundary marker */
    .task-boundary-line {
      border-bottom: var(--task-boundary);
      margin: 6px 0 10px;
    }

    /* Gap zone */
    .gap-zone {
      flex-shrink: 0;
      position: relative;
      margin: 2px 0;
      border-radius: 4px;
    }

    /* Gap style: red zone */
    .gap-style-red.stuck-gap {
      background: rgba(239, 68, 68, 0.08);
      border: 1px dashed rgba(239, 68, 68, 0.3);
    }
    /* Gap style: fade out */
    .gap-style-fade.stuck-gap {
      background: linear-gradient(to bottom, rgba(239,68,68,0.06), transparent);
    }
    /* Gap style: hash marks */
    .gap-style-hash.stuck-gap {
      background-image: repeating-linear-gradient(
        -45deg,
        rgba(239,68,68,0.08),
        rgba(239,68,68,0.08) 2px,
        transparent 2px,
        transparent 8px
      );
    }
    /* Normal (non-stuck) gaps */
    .gap-zone:not(.stuck-gap) {
      background: transparent;
    }

    /* Status badges */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .badge-stuck    { background: rgba(239,68,68,0.15);  color: #ef4444; }
    .badge-active   { background: rgba(59,130,246,0.15); color: #3b82f6; }
    .badge-idle     { background: rgba(107,114,128,0.15);color: #9ca3af; }
    .badge-healthy  { background: rgba(34,197,94,0.15);  color: #22c55e; }

    .dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      display: inline-block;
      flex-shrink: 0;
    }
    .dot-stuck   { background: #ef4444; box-shadow: 0 0 6px rgba(239,68,68,0.6); }
    .dot-active  { background: #3b82f6; box-shadow: 0 0 6px rgba(59,130,246,0.6); animation: pulse 2s ease-in-out infinite; }
    .dot-idle    { background: #6b7280; }
    .dot-healthy { background: #22c55e; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* Event type icons (via Unicode) */
    .ev-icon {
      width: 16px; height: 16px;
      border-radius: 3px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      flex-shrink: 0;
    }
    .ev-checkpoint { background: rgba(59,130,246,0.2);  color: #3b82f6; }
    .ev-claimed    { background: rgba(34,197,94,0.2);   color: #22c55e; }
    .ev-completed  { background: rgba(168,85,247,0.2);  color: #a855f7; }

    /* Scrollbar track line in lane */
    .time-axis {
      position: absolute;
      left: 18px;
      top: 0;
      bottom: 0;
      width: 1px;
      background: linear-gradient(to bottom, var(--border), transparent);
      pointer-events: none;
    }

    /* Fleet stat cards */
    .fleet-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 16px;
      border-right: 1px solid var(--border);
    }
    .fleet-stat:last-child { border-right: none; }
  </style>
</head>
<body>

<!-- Fleet summary bar -->
<div id="fleet-bar" style="height:80px; display:flex; align-items:center; padding:0 20px; gap:0;">
  <!-- Title -->
  <div style="padding-right:20px; border-right:1px solid var(--border);">
    <div style="font-size:13px; font-weight:600; color:var(--text); letter-spacing:0.02em;">Agent Operations</div>
    <div class="mono" style="font-size:10px; color:var(--text-dim); margin-top:2px;">Lane View · Live</div>
  </div>

  <!-- Stats -->
  <div style="display:flex; align-items:stretch; flex:1; padding:0 16px;">
    <div class="fleet-stat">
      <span style="font-size:22px; font-weight:700; color:var(--text); font-family:var(--font-mono);">8</span>
      <span style="font-size:10px; color:var(--text-dim); margin-top:1px;">total</span>
    </div>
    <div class="fleet-stat">
      <span style="font-size:22px; font-weight:700; color:var(--status-active); font-family:var(--font-mono);">4</span>
      <span style="font-size:10px; color:var(--text-dim); margin-top:1px;">active</span>
    </div>
    <div class="fleet-stat">
      <span style="font-size:22px; font-weight:700; color:var(--status-stuck); font-family:var(--font-mono);">2</span>
      <span style="font-size:10px; color:var(--text-dim); margin-top:1px;">stuck</span>
    </div>
    <div class="fleet-stat">
      <span style="font-size:22px; font-weight:700; color:var(--status-idle); font-family:var(--font-mono);">2</span>
      <span style="font-size:10px; color:var(--text-dim); margin-top:1px;">idle</span>
    </div>
  </div>

  <!-- Time scale indicator -->
  <div style="padding-left:16px; border-left:1px solid var(--border); text-align:right;">
    <div style="font-size:10px; color:var(--text-dim);">Time window</div>
    <div class="mono" style="font-size:12px; font-weight:600; color:var(--text); margin-top:2px;" id="time-label">30 min</div>
  </div>

  <!-- Stuck alert badge -->
  <div id="stuck-alert" style="margin-left:16px; padding:6px 12px; background:rgba(239,68,68,0.12); border:1px solid rgba(239,68,68,0.3); border-radius:6px;">
    <div style="font-size:10px; color:#ef4444; font-weight:600; display:flex; align-items:center; gap:6px;">
      <svg width="10" height="10" viewBox="0 0 10 10" fill="none"><circle cx="5" cy="5" r="4" stroke="#ef4444" stroke-width="1.5"/><rect x="4.25" y="2.5" width="1.5" height="3" rx="0.5" fill="#ef4444"/><circle cx="5" cy="7.25" r="0.75" fill="#ef4444"/></svg>
      2 agents stuck
    </div>
    <div style="font-size:9px; color:var(--text-dim); margin-top:1px;" id="alert-threshold">no activity &gt; 5 min</div>
  </div>
</div>

<!-- Lanes -->
<div id="lanes-container">
  <!-- Lanes rendered by JS -->
</div>

<script>
// ─── Agent data ───────────────────────────────────────────────────────────────
// minutesAgo: how many minutes ago the event occurred (0 = now)
// gapBefore: minutes of silence BEFORE this event (going upward in time)
const AGENTS = [
  {
    id: 'claude-opus-7',
    status: 'stuck',
    currentTask: 'Add JWT auth middleware',
    lastActivityMinutes: 12,
    events: [
      { type: 'checkpoint', label: 'Analyzing JWT library options', minutesAgo: 12 },
      { type: 'checkpoint', label: 'Reading existing auth code',    minutesAgo: 15 },
      { type: 'claimed',    label: 'Claimed task',                  minutesAgo: 18 },
    ]
  },
  {
    id: 'claude-sonnet-8',
    status: 'stuck',
    currentTask: 'Implement cursor pagination',
    lastActivityMinutes: 22,
    events: [
      { type: 'checkpoint', label: 'Investigating offset calculation', minutesAgo: 22 },
      { type: 'checkpoint', label: 'Reading cursor implementation',    minutesAgo: 25 },
      { type: 'claimed',    label: 'Claimed task',                     minutesAgo: 30 },
    ]
  },
  {
    id: 'claude-sonnet-3',
    status: 'active',
    currentTask: 'Implement full-text search',
    lastActivityMinutes: 1,
    events: [
      { type: 'checkpoint', label: 'Implementing full-text search', minutesAgo: 1 },
      { type: 'checkpoint', label: 'Added search route handler',    minutesAgo: 3 },
      { type: 'checkpoint', label: 'Designing search schema',       minutesAgo: 5 },
      { type: 'claimed',    label: 'Claimed task',                  minutesAgo: 8 },
      { type: 'completed',  label: 'Design search schema',          minutesAgo: 10 },
    ]
  },
  {
    id: 'gemini-pro-1',
    status: 'active',
    currentTask: 'Optimize DB query performance',
    lastActivityMinutes: 0.5,
    events: [
      { type: 'checkpoint', label: 'Optimizing JOIN queries',       minutesAgo: 0.5 },
      { type: 'checkpoint', label: 'Profiling slow queries',        minutesAgo: 2 },
      { type: 'checkpoint', label: 'Analyzing query plans',         minutesAgo: 4 },
      { type: 'checkpoint', label: 'Mapping table relationships',   minutesAgo: 7 },
      { type: 'checkpoint', label: 'Reading schema',                minutesAgo: 10 },
      { type: 'claimed',    label: 'Claimed task',                  minutesAgo: 15 },
    ]
  },
  {
    id: 'claude-haiku-2',
    status: 'active',
    currentTask: 'Test claim concurrency',
    lastActivityMinutes: 3,
    events: [
      { type: 'checkpoint', label: 'Testing claim concurrency', minutesAgo: 3 },
      { type: 'checkpoint', label: 'Writing test fixtures',     minutesAgo: 6 },
      { type: 'checkpoint', label: 'Setting up test harness',   minutesAgo: 9 },
      { type: 'claimed',    label: 'Claimed task',              minutesAgo: 12 },
    ]
  },
  {
    id: 'gpt-4o-agent',
    status: 'active',
    currentTask: 'Write API documentation',
    lastActivityMinutes: 2,
    events: [
      { type: 'checkpoint', label: 'Writing endpoint descriptions', minutesAgo: 2 },
      { type: 'checkpoint', label: 'Reading existing docs',         minutesAgo: 4 },
      { type: 'claimed',    label: 'Claimed task',                  minutesAgo: 5 },
    ]
  },
  {
    id: 'claude-opus-5',
    status: 'idle',
    currentTask: null,
    lastActivityMinutes: 8,
    events: [
      { type: 'completed',  label: 'Set up CI pipeline',      minutesAgo: 8 },
      { type: 'checkpoint', label: 'Configuring workflows',   minutesAgo: 12 },
      { type: 'claimed',    label: 'Claimed task',             minutesAgo: 15 },
    ]
  },
  {
    id: 'claude-haiku-9',
    status: 'idle',
    currentTask: null,
    lastActivityMinutes: 3,
    events: [
      { type: 'completed',  label: 'Add input validation', minutesAgo: 3 },
      { type: 'checkpoint', label: 'Testing edge cases',   minutesAgo: 5 },
      { type: 'claimed',    label: 'Claimed task',          minutesAgo: 8 },
    ]
  },
];

// ─── State ────────────────────────────────────────────────────────────────────
let currentTimeScale = 30;   // minutes visible
let currentGapStyle  = 'red';
let currentSort      = 'status';
let currentThreshold = 5;    // stuck threshold in minutes
let taskBoundaryOn   = true;

// ─── Helpers ─────────────────────────────────────────────────────────────────
function statusBadgeClass(s) {
  return { stuck: 'badge-stuck', active: 'badge-active', idle: 'badge-idle', healthy: 'badge-healthy' }[s] || 'badge-idle';
}
function dotClass(s) {
  return { stuck: 'dot-stuck', active: 'dot-active', idle: 'dot-idle', healthy: 'dot-healthy' }[s] || 'dot-idle';
}
function eventIconClass(t) {
  return { checkpoint: 'ev-checkpoint', claimed: 'ev-claimed', completed: 'ev-completed' }[t] || 'ev-checkpoint';
}
function eventIcon(t) {
  return { checkpoint: '●', claimed: '▶', completed: '✓' }[t] || '●';
}
function formatTime(m) {
  if (m < 1) return '30s ago';
  if (m < 60) return `${Math.round(m)}m ago`;
  return `${(m/60).toFixed(1)}h ago`;
}

// Determine if an agent is stuck based on current threshold
function isStuckByThreshold(agent) {
  return agent.lastActivityMinutes >= currentThreshold;
}

// ─── Lane rendering ───────────────────────────────────────────────────────────
function buildLane(agent) {
  const stuck = isStuckByThreshold(agent);
  const laneEl = document.createElement('div');
  laneEl.className = `lane${stuck ? ' stuck' : ''}`;
  laneEl.dataset.agentId = agent.id;
  laneEl.dataset.status = agent.status;
  laneEl.dataset.lastActivity = agent.lastActivityMinutes;

  // ── Header
  const shortId = agent.id.length > 16 ? agent.id.slice(0, 16) + '…' : agent.id;
  laneEl.innerHTML = `
    <div class="lane-header">
      <div style="display:flex;align-items:center;gap:5px;margin-bottom:5px;">
        <span class="dot ${dotClass(stuck ? 'stuck' : agent.status)}"></span>
        <span class="mono" style="font-size:11px;font-weight:500;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%;">${agent.id}</span>
      </div>
      <span class="badge ${statusBadgeClass(stuck ? 'stuck' : agent.status)}">${stuck ? 'STUCK' : agent.status.toUpperCase()}</span>
      ${agent.currentTask
        ? `<div style="font-size:10px;color:var(--text-dim);margin-top:5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${agent.currentTask}">${agent.currentTask}</div>`
        : `<div style="font-size:10px;color:var(--text-dim);margin-top:5px;font-style:italic;">waiting for task</div>`}
    </div>
  `;

  // ── Body / timeline
  const body = document.createElement('div');
  body.className = 'lane-body';

  const track = document.createElement('div');
  track.className = 'timeline-track';
  track.style.position = 'relative';

  // Time axis line
  const axisEl = document.createElement('div');
  axisEl.className = 'time-axis';
  track.appendChild(axisEl);

  const timeWindow = currentTimeScale; // minutes
  const PX_PER_MIN = 28; // base pixels per minute of time

  // Sort events: most recent first (smallest minutesAgo first)
  const events = [...agent.events].sort((a, b) => a.minutesAgo - b.minutesAgo);

  // "now" spacer — space from top (now) to first event
  const firstEvent = events[0];
  if (firstEvent) {
    const nowGapMinutes = firstEvent.minutesAgo; // time since last activity
    const nowGapPx = Math.max(nowGapMinutes * PX_PER_MIN, 8);

    if (nowGapMinutes > 0) {
      const nowGap = document.createElement('div');
      nowGap.className = `gap-zone ${stuck ? `stuck-gap gap-style-${currentGapStyle}` : ''}`;
      nowGap.style.height = `${nowGapPx}px`;

      if (stuck && nowGapMinutes >= currentThreshold) {
        nowGap.innerHTML = `<span style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:9px;color:rgba(239,68,68,0.6);white-space:nowrap;">${Math.round(nowGapMinutes)}m silent</span>`;
        nowGap.style.position = 'relative';
      }
      track.appendChild(nowGap);
    }
  }

  // Render events with gaps between them
  events.forEach((ev, i) => {
    // Event card
    const card = document.createElement('div');
    card.className = 'event-card';
    card.innerHTML = `
      <div style="display:flex;align-items:flex-start;gap:6px;">
        <span class="ev-icon ${eventIconClass(ev.type)}">${eventIcon(ev.type)}</span>
        <div style="flex:1;min-width:0;">
          <div style="font-size:10px;color:var(--text);font-weight:500;line-height:1.3;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;">${ev.label}</div>
          <div class="mono" style="font-size:9px;color:var(--text-dim);margin-top:2px;">${formatTime(ev.minutesAgo)}</div>
        </div>
      </div>
    `;
    track.appendChild(card);

    // Gap to next event
    const nextEv = events[i + 1];
    if (nextEv) {
      const gapMin = nextEv.minutesAgo - ev.minutesAgo;
      const gapPx = Math.max(gapMin * PX_PER_MIN, 6);

      const gapEl = document.createElement('div');
      gapEl.className = 'gap-zone';
      gapEl.style.height = `${gapPx}px`;

      // Only apply stuck styling if this agent is actually stuck and gap is substantial
      // (Stuck agents have the large silent gap at the top — between-event gaps use normal style)
      track.appendChild(gapEl);

      // Task boundary: show divider between claimed and previous completed event
      if (ev.type === 'completed' || nextEv.type === 'claimed') {
        // boundary after completed / before claimed of next task
      }
    }
  });

  body.appendChild(track);
  laneEl.appendChild(body);
  return laneEl;
}

// ─── Sort agents ──────────────────────────────────────────────────────────────
function sortAgents(agents, sortMode, threshold) {
  const statusOrder = { stuck: 0, active: 1, idle: 2, healthy: 3 };
  const arr = [...agents];

  // Determine effective stuck status based on threshold
  const getEffectiveStatus = (a) => {
    if (a.lastActivityMinutes >= threshold) return 'stuck';
    return a.status;
  };

  if (sortMode === 'status') {
    arr.sort((a, b) => {
      const sa = statusOrder[getEffectiveStatus(a)] ?? 9;
      const sb = statusOrder[getEffectiveStatus(b)] ?? 9;
      if (sa !== sb) return sa - sb;
      return a.id.localeCompare(b.id);
    });
  } else if (sortMode === 'alpha') {
    arr.sort((a, b) => a.id.localeCompare(b.id));
  } else if (sortMode === 'activity') {
    arr.sort((a, b) => a.lastActivityMinutes - b.lastActivityMinutes);
  }

  return arr;
}

// ─── Render all lanes ─────────────────────────────────────────────────────────
function renderLanes() {
  const container = document.getElementById('lanes-container');
  container.innerHTML = '';
  const sorted = sortAgents(AGENTS, currentSort, currentThreshold);
  sorted.forEach(agent => {
    container.appendChild(buildLane(agent));
  });
  updateTaskBoundaries();
}

// ─── Task boundaries ─────────────────────────────────────────────────────────
function updateTaskBoundaries() {
  // task-boundary CSS var is set by the shell — already flows via --task-boundary
  // We also show visual markers inside lanes
  const boundaries = document.querySelectorAll('.task-boundary-line');
  boundaries.forEach(b => b.remove());
  // boundaries are handled via CSS var(--task-boundary) on .task-boundary-line elements
}

// ─── Update stuck alert text ──────────────────────────────────────────────────
function updateStuckAlert(threshold) {
  const alertEl = document.getElementById('alert-threshold');
  if (alertEl) alertEl.textContent = `no activity > ${threshold} min`;

  // Count stuck agents by threshold
  const stuckCount = AGENTS.filter(a => a.lastActivityMinutes >= threshold).length;
  const alertBadge = document.getElementById('stuck-alert');
  const alertText = alertBadge?.querySelector('div:first-child');
  if (alertText) alertText.innerHTML = `
    <svg width="10" height="10" viewBox="0 0 10 10" fill="none"><circle cx="5" cy="5" r="4" stroke="#ef4444" stroke-width="1.5"/><rect x="4.25" y="2.5" width="1.5" height="3" rx="0.5" fill="#ef4444"/><circle cx="5" cy="7.25" r="0.75" fill="#ef4444"/></svg>
    ${stuckCount} agent${stuckCount !== 1 ? 's' : ''} stuck
  `;
}

// ─── Update time label ────────────────────────────────────────────────────────
function updateTimeLabel(minutes) {
  const el = document.getElementById('time-label');
  if (!el) return;
  if (minutes < 60) el.textContent = `${minutes} min`;
  else el.textContent = `${minutes / 60}h`;
}

// ─── Control listeners ────────────────────────────────────────────────────────
document.addEventListener('control-change', (e) => {
  const { id, value } = e.detail;

  if (id === 'stuck-threshold') {
    currentThreshold = parseInt(value, 10);
    updateStuckAlert(currentThreshold);
    renderLanes();
  }

  if (id === 'lane-sort') {
    currentSort = value;
    renderLanes();
  }

  if (id === 'time-scale') {
    currentTimeScale = parseInt(value, 10);
    updateTimeLabel(currentTimeScale);
    renderLanes();
  }

  if (id === 'gap-style') {
    currentGapStyle = value;
    renderLanes();
  }
});

// ─── Initial state from CSS vars ──────────────────────────────────────────────
document.addEventListener('controls-ready', () => {
  const cs = getComputedStyle(document.documentElement);

  const thresholdVal = cs.getPropertyValue('--stuck-threshold').trim();
  if (thresholdVal) currentThreshold = parseInt(thresholdVal, 10);

  const sortVal = cs.getPropertyValue('--lane-sort').trim();
  if (sortVal) currentSort = sortVal;

  const scaleVal = cs.getPropertyValue('--time-scale').trim();
  if (scaleVal) {
    currentTimeScale = parseInt(scaleVal, 10);
    updateTimeLabel(currentTimeScale);
  }

  const gapVal = cs.getPropertyValue('--gap-style').trim();
  if (gapVal) currentGapStyle = gapVal;

  updateStuckAlert(currentThreshold);
  renderLanes();
});

// ─── Boot ─────────────────────────────────────────────────────────────────────
// Render immediately on load (controls-ready may fire after)
renderLanes();
</script>

</body>
</html>

  </template>
  <template id="tpl-b3">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script type="application/json" id="variation-meta">
  {
    "id": "B3",
    "family": "B",
    "familyName": "Live Feed",
    "name": "Filtered Stream",
    "layoutType": "Tabbed Feed + Inline Detail",
    "aesthetic": "Professional Dark",
    "description": "Horizontal tab bar with filter tabs that control a single unified event feed. Selecting a status tab filters agents; selecting an individual agent tab shows their full detail header above filtered events.",
    "controls": [
      {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["5 min", "10 min", "15 min", "30 min"],
        "cssValues": { "5 min": "5", "10 min": "10", "15 min": "15", "30 min": "30" },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
      },
      {
        "id": "tab-style",
        "label": "Tab Style",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["pills", "underline", "cards"],
        "cssValues": { "pills": "pills", "underline": "underline", "cards": "cards" },
        "value": "pills",
        "defaultValue": "pills",
        "unit": "",
        "cssVar": "--tab-style",
        "event": true
      },
      {
        "id": "feed-density",
        "label": "Feed Density",
        "type": "range",
        "min": 36, "max": 72, "step": 4,
        "options": null,
        "value": 52,
        "defaultValue": 52,
        "unit": "px",
        "cssVar": "--event-height"
      },
      {
        "id": "inline-detail",
        "label": "Inline Detail",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["summary", "full timeline"],
        "cssValues": { "summary": "summary", "full timeline": "full" },
        "value": "summary",
        "defaultValue": "summary",
        "unit": "",
        "cssVar": "--inline-detail",
        "event": true
      },
      {
        "id": "timestamps",
        "label": "Timestamps",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["relative", "absolute"],
        "cssValues": { "relative": "relative", "absolute": "absolute" },
        "value": "relative",
        "defaultValue": "relative",
        "unit": "",
        "cssVar": "--timestamps",
        "event": true
      },
      {
        "id": "stuck-highlight",
        "label": "Stuck Highlight",
        "type": "toggle",
        "min": null, "max": null, "step": null,
        "options": null,
        "cssValues": { "true": "0.15", "false": "0" },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--stuck-event-bg-opacity"
      }
    ]
  }
  </script>
  <style>
    :root {
      --bg: #0f1117;
      --panel: #1a1d27;
      --border: #2a2d3a;
      --text: #e2e4e9;
      --text-dim: #8b8fa3;
      --status-stuck: #ef4444;
      --status-active: #3b82f6;
      --status-idle: #6b7280;
      --status-healthy: #22c55e;
      --font-sans: 'Inter', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --radius: 8px;
      --event-height: 52px;
      --stuck-event-bg-opacity: 0.15;
      --stuck-threshold: 5;
      --tab-style: pills;
      --inline-detail: summary;
      --timestamps: relative;
    }

    :root * {
      transition: color 0.3s ease, background-color 0.3s ease,
                  border-color 0.3s ease, padding 0.3s ease,
                  gap 0.3s ease, font-size 0.3s ease,
                  border-radius 0.3s ease, box-shadow 0.3s ease,
                  max-width 0.3s ease, width 0.3s ease,
                  min-height 0.3s ease, opacity 0.3s ease;
    }

    body {
      font-family: var(--font-sans);
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
    }

    .font-mono {
      font-family: var(--font-mono);
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #3a3d4a; }

    /* Tab styles — pills */
    .tab-pills .tab-item {
      border-radius: 9999px;
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-dim);
      cursor: pointer;
      background: transparent;
      border: none;
      white-space: nowrap;
      transition: background 0.2s ease, color 0.2s ease;
    }
    .tab-pills .tab-item:hover {
      background: rgba(255,255,255,0.05);
      color: var(--text);
    }
    .tab-pills .tab-item.active {
      background: rgba(255,255,255,0.1);
      color: var(--text);
    }
    .tab-pills .tab-item.stuck-tab.active {
      background: rgba(239,68,68,0.15);
      color: var(--status-stuck);
    }

    /* Tab styles — underline */
    .tab-underline .tab-item {
      border-radius: 0;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-dim);
      cursor: pointer;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      white-space: nowrap;
      transition: color 0.2s ease, border-color 0.2s ease;
    }
    .tab-underline .tab-item:hover {
      color: var(--text);
    }
    .tab-underline .tab-item.active {
      color: var(--text);
      border-bottom-color: var(--status-active);
    }
    .tab-underline .tab-item.stuck-tab.active {
      color: var(--status-stuck);
      border-bottom-color: var(--status-stuck);
    }

    /* Tab styles — cards */
    .tab-cards .tab-item {
      border-radius: var(--radius);
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-dim);
      cursor: pointer;
      background: transparent;
      border: 1px solid transparent;
      white-space: nowrap;
      transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }
    .tab-cards .tab-item:hover {
      background: var(--panel);
      border-color: var(--border);
      color: var(--text);
    }
    .tab-cards .tab-item.active {
      background: var(--panel);
      border-color: var(--border);
      color: var(--text);
    }
    .tab-cards .tab-item.stuck-tab.active {
      background: rgba(239,68,68,0.1);
      border-color: rgba(239,68,68,0.3);
      color: var(--status-stuck);
    }

    /* Stuck tab pulse animation */
    @keyframes stuck-pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
      50% { box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.25); }
    }
    .stuck-tab {
      animation: stuck-pulse 2.5s ease-in-out infinite;
    }

    /* Status dot */
    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      flex-shrink: 0;
      display: inline-block;
    }

    /* Event row */
    .event-row {
      min-height: var(--event-height);
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 20px;
      border-bottom: 1px solid var(--border);
      transition: background 0.15s ease, min-height 0.3s ease;
    }
    .event-row:hover {
      background: rgba(255,255,255,0.03);
    }
    .event-row.stuck-event {
      background: rgba(239, 68, 68, var(--stuck-event-bg-opacity));
    }
    .event-row.stuck-event:hover {
      background: rgba(239, 68, 68, calc(var(--stuck-event-bg-opacity) + 0.05));
    }

    /* Agent avatar */
    .agent-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      flex-shrink: 0;
      text-transform: uppercase;
    }

    /* Progress bar */
    .progress-bar {
      height: 4px;
      border-radius: 2px;
      background: var(--border);
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.5s ease;
    }

    /* Entrance animation */
    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .event-row {
      animation: fadeSlideIn 0.3s ease both;
    }

    /* Agent detail header */
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-6px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .agent-detail-header {
      animation: slideDown 0.25s ease both;
    }

    /* Badge */
    .badge {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      padding: 2px 7px;
      border-radius: 9999px;
    }

    /* Event type tag */
    .event-type {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 500;
      padding: 2px 8px;
      border-radius: 4px;
      flex-shrink: 0;
    }

    /* Timeline items for full detail mode */
    .timeline-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 6px 0;
      opacity: 0;
      transform: translateY(4px);
      animation: fadeSlideIn 0.25s ease forwards;
    }
    .timeline-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      margin-top: 5px;
      flex-shrink: 0;
    }
    .timeline-line {
      width: 1px;
      background: var(--border);
      flex-shrink: 0;
      align-self: stretch;
      margin: 4px 0 0 0;
    }
  </style>
</head>
<body>
<div class="flex flex-col h-screen overflow-hidden" style="background:var(--bg);">

  <!-- Top bar -->
  <div class="flex items-center justify-between px-5 py-3" style="border-bottom:1px solid var(--border);background:var(--panel);">
    <div class="flex items-center gap-3">
      <div style="font-family:var(--font-mono);font-size:13px;font-weight:600;color:var(--text);">
        hzl<span style="color:var(--status-active);">.</span>ops
      </div>
      <div style="width:1px;height:16px;background:var(--border);"></div>
      <div style="font-size:12px;color:var(--text-dim);">Agent Operations Center</div>
    </div>
    <!-- Fleet summary -->
    <div class="flex items-center gap-4">
      <div class="flex items-center gap-1.5">
        <div class="status-dot" style="background:var(--status-active);"></div>
        <span style="font-size:12px;color:var(--text-dim);">4 active</span>
      </div>
      <div class="flex items-center gap-1.5">
        <div class="status-dot" style="background:var(--status-stuck);"></div>
        <span style="font-size:12px;color:var(--text-dim);">2 stuck</span>
      </div>
      <div class="flex items-center gap-1.5">
        <div class="status-dot" style="background:var(--status-idle);"></div>
        <span style="font-size:12px;color:var(--text-dim);">2 idle</span>
      </div>
      <div style="font-size:11px;font-family:var(--font-mono);color:var(--text-dim);padding:2px 8px;border-radius:4px;background:rgba(255,255,255,0.04);border:1px solid var(--border);">
        8 agents
      </div>
    </div>
  </div>

  <!-- Tab bar -->
  <div class="flex-shrink-0 px-4 py-2 flex items-center gap-1 overflow-x-auto" id="tab-bar"
       style="border-bottom:1px solid var(--border);background:var(--panel);"
       data-tab-style="pills">
    <!-- Group tabs -->
    <button class="tab-item active" data-tab="all" onclick="selectTab('all', this)">
      All <span class="badge" style="background:rgba(255,255,255,0.08);color:var(--text-dim);margin-left:4px;">8</span>
    </button>
    <button class="tab-item stuck-tab" data-tab="stuck" onclick="selectTab('stuck', this)">
      Stuck <span class="badge" style="background:rgba(239,68,68,0.15);color:var(--status-stuck);margin-left:4px;">2</span>
    </button>
    <button class="tab-item" data-tab="active" onclick="selectTab('active', this)">
      Active <span class="badge" style="background:rgba(59,130,246,0.15);color:var(--status-active);margin-left:4px;">4</span>
    </button>
    <button class="tab-item" data-tab="idle" onclick="selectTab('idle', this)">
      Idle <span class="badge" style="background:rgba(107,114,128,0.15);color:var(--status-idle);margin-left:4px;">2</span>
    </button>

    <!-- Divider -->
    <div style="width:1px;height:20px;background:var(--border);margin:0 6px;flex-shrink:0;"></div>

    <!-- Individual agent tabs -->
    <button class="tab-item" data-tab="agent-claude-opus-7" data-agent="claude-opus-7" data-status="stuck" onclick="selectTab('agent-claude-opus-7', this)">
      <span class="status-dot" style="background:var(--status-stuck);margin-right:5px;display:inline-block;vertical-align:middle;"></span>claude-opus-7
    </button>
    <button class="tab-item" data-tab="agent-claude-sonnet-8" data-agent="claude-sonnet-8" data-status="stuck" onclick="selectTab('agent-claude-sonnet-8', this)">
      <span class="status-dot" style="background:var(--status-stuck);margin-right:5px;display:inline-block;vertical-align:middle;"></span>claude-sonnet-8
    </button>
    <button class="tab-item" data-tab="agent-claude-sonnet-3" data-agent="claude-sonnet-3" data-status="active" onclick="selectTab('agent-claude-sonnet-3', this)">
      <span class="status-dot" style="background:var(--status-active);margin-right:5px;display:inline-block;vertical-align:middle;"></span>claude-sonnet-3
    </button>
    <button class="tab-item" data-tab="agent-claude-haiku-2" data-agent="claude-haiku-2" data-status="active" onclick="selectTab('agent-claude-haiku-2', this)">
      <span class="status-dot" style="background:var(--status-active);margin-right:5px;display:inline-block;vertical-align:middle;"></span>claude-haiku-2
    </button>
    <button class="tab-item" data-tab="agent-gemini-pro-1" data-agent="gemini-pro-1" data-status="active" onclick="selectTab('agent-gemini-pro-1', this)">
      <span class="status-dot" style="background:var(--status-active);margin-right:5px;display:inline-block;vertical-align:middle;"></span>gemini-pro-1
    </button>
    <button class="tab-item" data-tab="agent-gpt-4o-agent" data-agent="gpt-4o-agent" data-status="active" onclick="selectTab('agent-gpt-4o-agent', this)">
      <span class="status-dot" style="background:var(--status-active);margin-right:5px;display:inline-block;vertical-align:middle;"></span>gpt-4o-agent
    </button>
    <button class="tab-item" data-tab="agent-claude-opus-5" data-agent="claude-opus-5" data-status="idle" onclick="selectTab('agent-claude-opus-5', this)">
      <span class="status-dot" style="background:var(--status-idle);margin-right:5px;display:inline-block;vertical-align:middle;"></span>claude-opus-5
    </button>
    <button class="tab-item" data-tab="agent-claude-haiku-9" data-agent="claude-haiku-9" data-status="idle" onclick="selectTab('agent-claude-haiku-9', this)">
      <span class="status-dot" style="background:var(--status-idle);margin-right:5px;display:inline-block;vertical-align:middle;"></span>claude-haiku-9
    </button>
  </div>

  <!-- Main content area -->
  <div class="flex-1 overflow-hidden flex flex-col" style="min-height:0;">

    <!-- Agent detail header (shown when individual agent tab selected) -->
    <div id="agent-detail-header" class="flex-shrink-0" style="display:none;border-bottom:1px solid var(--border);background:var(--panel);">
    </div>

    <!-- Event feed -->
    <div class="flex-1 overflow-y-auto" id="event-feed">
      <!-- Events rendered by JS -->
    </div>

  </div>

</div>

<script>
// ============================================================
// Data
// ============================================================

const agents = {
  'claude-opus-7': {
    name: 'claude-opus-7',
    status: 'stuck',
    task: 'Implement auth middleware',
    project: 'api-v2',
    progress: 35,
    claimedAgo: '18m ago',
    lastEvent: null,
    silent: '12m',
    color: '#a78bfa'
  },
  'claude-sonnet-8': {
    name: 'claude-sonnet-8',
    status: 'stuck',
    task: 'Fix pagination bug',
    project: 'web',
    progress: 20,
    claimedAgo: '30m ago',
    lastEvent: null,
    silent: '22m',
    color: '#f472b6'
  },
  'claude-sonnet-3': {
    name: 'claude-sonnet-3',
    status: 'active',
    task: 'Add search API endpoint',
    project: 'api-v2',
    progress: 60,
    claimedAgo: '8m ago',
    lastEvent: '1m ago',
    silent: null,
    color: '#38bdf8'
  },
  'claude-haiku-2': {
    name: 'claude-haiku-2',
    status: 'active',
    task: 'Write unit tests for TaskService',
    project: 'core',
    progress: 40,
    claimedAgo: '12m ago',
    lastEvent: '3m ago',
    silent: null,
    color: '#34d399'
  },
  'gemini-pro-1': {
    name: 'gemini-pro-1',
    status: 'active',
    task: 'Refactor database queries',
    project: 'core',
    progress: 75,
    claimedAgo: '15m ago',
    lastEvent: '30s ago',
    silent: null,
    color: '#fb923c'
  },
  'gpt-4o-agent': {
    name: 'gpt-4o-agent',
    status: 'active',
    task: 'Update API documentation',
    project: 'docs',
    progress: 25,
    claimedAgo: '5m ago',
    lastEvent: '2m ago',
    silent: null,
    color: '#facc15'
  },
  'claude-opus-5': {
    name: 'claude-opus-5',
    status: 'idle',
    task: null,
    project: null,
    progress: null,
    claimedAgo: null,
    lastEvent: '8m ago',
    lastTask: 'Set up CI pipeline',
    lastProject: 'infra',
    silent: null,
    color: '#94a3b8'
  },
  'claude-haiku-9': {
    name: 'claude-haiku-9',
    status: 'idle',
    task: null,
    project: null,
    progress: null,
    claimedAgo: null,
    lastEvent: '3m ago',
    lastTask: 'Add input validation',
    lastProject: 'api-v2',
    silent: null,
    color: '#a3e635'
  }
};

// All events in chronological order (most recent first)
const allEvents = [
  { id: 1, agent: 'gemini-pro-1', type: 'checkpoint', tsRel: '30s ago', tsAbs: '14:59:30', note: 'Optimizing JOIN queries', task: 'Refactor database queries', project: 'core' },
  { id: 2, agent: 'claude-sonnet-3', type: 'checkpoint', tsRel: '1m ago', tsAbs: '14:59:00', note: 'Implementing full-text search', task: 'Add search API endpoint', project: 'api-v2' },
  { id: 3, agent: 'gpt-4o-agent', type: 'checkpoint', tsRel: '2m ago', tsAbs: '14:58:00', note: 'Writing endpoint descriptions', task: 'Update API documentation', project: 'docs' },
  { id: 4, agent: 'claude-haiku-2', type: 'checkpoint', tsRel: '3m ago', tsAbs: '14:57:00', note: 'Testing claim concurrency', task: 'Write unit tests for TaskService', project: 'core' },
  { id: 5, agent: 'claude-sonnet-3', type: 'checkpoint', tsRel: '3m ago', tsAbs: '14:57:00', note: 'Added search route handler', task: 'Add search API endpoint', project: 'api-v2' },
  { id: 6, agent: 'claude-sonnet-3', type: 'checkpoint', tsRel: '5m ago', tsAbs: '14:55:00', note: 'Designing search schema', task: 'Add search API endpoint', project: 'api-v2' },
  { id: 7, agent: 'gpt-4o-agent', type: 'claimed', tsRel: '5m ago', tsAbs: '14:55:00', note: null, task: 'Update API documentation', project: 'docs' },
  { id: 8, agent: 'claude-sonnet-3', type: 'claimed', tsRel: '8m ago', tsAbs: '14:52:00', note: null, task: 'Add search API endpoint', project: 'api-v2' },
  { id: 9, agent: 'claude-opus-7', type: 'checkpoint', tsRel: '12m ago', tsAbs: '14:48:00', note: 'Analyzing JWT library options', task: 'Implement auth middleware', project: 'api-v2' },
  { id: 10, agent: 'claude-opus-7', type: 'checkpoint', tsRel: '15m ago', tsAbs: '14:45:00', note: 'Reading existing auth code', task: 'Implement auth middleware', project: 'api-v2' },
  { id: 11, agent: 'claude-opus-7', type: 'claimed', tsRel: '18m ago', tsAbs: '14:42:00', note: null, task: 'Implement auth middleware', project: 'api-v2' },
  { id: 12, agent: 'claude-sonnet-8', type: 'checkpoint', tsRel: '22m ago', tsAbs: '14:38:00', note: 'Investigating offset calculation', task: 'Fix pagination bug', project: 'web' },
  { id: 13, agent: 'claude-sonnet-8', type: 'checkpoint', tsRel: '25m ago', tsAbs: '14:35:00', note: 'Reading cursor implementation', task: 'Fix pagination bug', project: 'web' },
  { id: 14, agent: 'claude-sonnet-8', type: 'claimed', tsRel: '30m ago', tsAbs: '14:30:00', note: null, task: 'Fix pagination bug', project: 'web' },
];

// State
let currentTab = 'stuck';
let currentDetailMode = 'summary';
let currentTimestamps = 'relative';
let currentTabStyle = 'pills';

// ============================================================
// Tab style application
// ============================================================

function applyTabStyle(style) {
  const bar = document.getElementById('tab-bar');
  bar.className = bar.className
    .replace(/tab-pills|tab-underline|tab-cards/g, '')
    .trim();
  bar.classList.add('tab-' + style);
}

// ============================================================
// Tab selection
// ============================================================

function selectTab(tabId, el) {
  currentTab = tabId;

  // Update active state on all tabs
  document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
  el.classList.add('active');

  // Render
  renderContent();
}

// ============================================================
// Render agent detail header
// ============================================================

function renderAgentHeader(agentKey) {
  const agent = agents[agentKey];
  if (!agent) return;

  const detailHeader = document.getElementById('agent-detail-header');
  detailHeader.style.display = 'block';

  const statusColor = {
    stuck: 'var(--status-stuck)',
    active: 'var(--status-active)',
    idle: 'var(--status-idle)'
  }[agent.status] || 'var(--text-dim)';

  const statusLabel = agent.status.toUpperCase();
  const initials = agentKey.split('-').slice(0, 2).map(p => p[0]).join('').toUpperCase();

  let summaryHTML = '';
  let fullHTML = '';

  if (agent.status === 'idle') {
    summaryHTML = `
      <div style="font-size:12px;color:var(--text-dim);">
        Last completed:
        <span style="font-family:var(--font-mono);color:var(--text);">${agent.lastTask}</span>
        <span style="color:var(--border);">·</span>
        <span style="font-family:var(--font-mono);font-size:11px;background:rgba(107,114,128,0.1);color:var(--status-idle);padding:1px 6px;border-radius:3px;">${agent.lastProject}</span>
        <span style="color:var(--border);">·</span>
        ${agent.lastEvent}
      </div>
    `;
  } else if (agent.status !== 'idle') {
    summaryHTML = `
      <div class="flex items-center gap-5">
        <div>
          <div style="font-size:10px;color:var(--text-dim);margin-bottom:3px;text-transform:uppercase;letter-spacing:0.05em;">Current Task</div>
          <div style="font-size:13px;color:var(--text);font-weight:500;">${agent.task}</div>
          <div style="font-family:var(--font-mono);font-size:10px;color:var(--text-dim);margin-top:2px;">
            <span style="background:rgba(255,255,255,0.06);padding:1px 6px;border-radius:3px;">${agent.project}</span>
          </div>
        </div>
        <div style="min-width:120px;">
          <div style="font-size:10px;color:var(--text-dim);margin-bottom:5px;text-transform:uppercase;letter-spacing:0.05em;">Progress</div>
          <div class="progress-bar" style="width:120px;">
            <div class="progress-fill" style="width:${agent.progress}%;background:${statusColor};"></div>
          </div>
          <div style="font-family:var(--font-mono);font-size:11px;color:var(--text-dim);margin-top:3px;">${agent.progress}%</div>
        </div>
        <div>
          <div style="font-size:10px;color:var(--text-dim);margin-bottom:3px;text-transform:uppercase;letter-spacing:0.05em;">Claimed</div>
          <div style="font-family:var(--font-mono);font-size:12px;color:var(--text);">${agent.claimedAgo}</div>
        </div>
        ${agent.status === 'stuck' ? `
        <div>
          <div style="font-size:10px;color:var(--status-stuck);margin-bottom:3px;text-transform:uppercase;letter-spacing:0.05em;">Silent</div>
          <div style="font-family:var(--font-mono);font-size:12px;color:var(--status-stuck);font-weight:600;">${agent.silent}</div>
        </div>
        ` : `
        <div>
          <div style="font-size:10px;color:var(--text-dim);margin-bottom:3px;text-transform:uppercase;letter-spacing:0.05em;">Last Event</div>
          <div style="font-family:var(--font-mono);font-size:12px;color:var(--text);">${agent.lastEvent}</div>
        </div>
        `}
      </div>
    `;

    // Full timeline mode: show event mini-timeline
    const agentEvents = allEvents.filter(e => e.agent === agentKey);
    fullHTML = `
      <div style="margin-top:14px;border-top:1px solid var(--border);padding-top:12px;">
        <div style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px;">Activity Timeline</div>
        <div style="display:flex;flex-direction:column;gap:0;">
          ${agentEvents.map((ev, i) => `
            <div class="timeline-item" style="animation-delay:${i * 50}ms;">
              <div style="display:flex;flex-direction:column;align-items:center;gap:0;margin-top:4px;">
                <div class="timeline-dot" style="background:${ev.type === 'claimed' ? 'var(--status-active)' : agent.status === 'stuck' ? 'var(--status-stuck)' : 'var(--text-dim)'};"></div>
                ${i < agentEvents.length - 1 ? `<div style="width:1px;height:16px;background:var(--border);flex-shrink:0;"></div>` : ''}
              </div>
              <div style="padding-bottom:${i < agentEvents.length - 1 ? '0' : '0'};">
                <div style="font-size:11px;color:var(--text-dim);font-family:var(--font-mono);">${currentTimestamps === 'relative' ? ev.tsRel : ev.tsAbs}</div>
                <div style="font-size:12px;color:var(--text);">
                  <span style="font-size:10px;padding:1px 6px;border-radius:3px;margin-right:5px;${ev.type === 'claimed' ? 'background:rgba(59,130,246,0.12);color:var(--status-active);' : 'background:rgba(255,255,255,0.06);color:var(--text-dim);'}">${ev.type}</span>
                  ${ev.note ? `"${ev.note}"` : ev.task}
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  detailHeader.innerHTML = `
    <div class="agent-detail-header" style="padding:16px 20px;">
      <div class="flex items-start gap-4">
        <div class="agent-avatar" style="background:${agent.color}22;color:${agent.color};width:40px;height:40px;font-size:13px;">
          ${initials}
        </div>
        <div class="flex-1">
          <div class="flex items-center gap-3 mb-2">
            <span style="font-family:var(--font-mono);font-size:14px;font-weight:600;color:var(--text);">${agentKey}</span>
            <span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:9999px;letter-spacing:0.08em;
              background:${agent.status === 'stuck' ? 'rgba(239,68,68,0.15)' : agent.status === 'active' ? 'rgba(59,130,246,0.15)' : 'rgba(107,114,128,0.15)'};
              color:${statusColor};">
              ${statusLabel}
            </span>
          </div>
          ${summaryHTML}
          <div id="agent-full-detail" style="display:${currentDetailMode === 'full' ? 'block' : 'none'};">
            ${fullHTML}
          </div>
        </div>
      </div>
    </div>
  `;
}

// ============================================================
// Render event feed
// ============================================================

function renderContent() {
  const feed = document.getElementById('event-feed');
  const detailHeader = document.getElementById('agent-detail-header');

  let filteredEvents = [];
  let isAgentTab = currentTab.startsWith('agent-');
  let agentKey = isAgentTab ? currentTab.replace('agent-', '') : null;

  // Determine which events to show
  if (currentTab === 'all') {
    filteredEvents = allEvents;
  } else if (currentTab === 'stuck') {
    filteredEvents = allEvents.filter(e => agents[e.agent]?.status === 'stuck');
  } else if (currentTab === 'active') {
    filteredEvents = allEvents.filter(e => agents[e.agent]?.status === 'active');
  } else if (currentTab === 'idle') {
    filteredEvents = [];
    // Idle agents have no events in the feed since they completed tasks
    // Show a special idle state
  } else if (isAgentTab) {
    filteredEvents = allEvents.filter(e => e.agent === agentKey);
  }

  // Show/hide agent detail header
  if (isAgentTab && agentKey) {
    renderAgentHeader(agentKey);
  } else {
    detailHeader.style.display = 'none';
    detailHeader.innerHTML = '';
  }

  // Render events
  if (currentTab === 'idle') {
    feed.innerHTML = renderIdleState();
    return;
  }

  if (filteredEvents.length === 0 && isAgentTab) {
    feed.innerHTML = `
      <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:200px;color:var(--text-dim);">
        <div style="font-size:13px;">No events recorded</div>
      </div>
    `;
    return;
  }

  feed.innerHTML = filteredEvents.map((ev, i) => renderEventRow(ev, i, currentTab === 'all' || currentTab === 'stuck' || currentTab === 'active')).join('');
}

function renderIdleState() {
  const idleAgents = ['claude-opus-5', 'claude-haiku-9'];
  return `
    <div style="padding:20px;">
      <div style="font-size:12px;color:var(--text-dim);margin-bottom:16px;text-transform:uppercase;letter-spacing:0.06em;">Idle Agents — Awaiting Tasks</div>
      <div style="display:flex;flex-direction:column;gap:10px;">
        ${idleAgents.map((key, i) => {
          const agent = agents[key];
          const initials = key.split('-').slice(0, 2).map(p => p[0]).join('').toUpperCase();
          return `
            <div class="agent-detail-header" style="
              background:var(--panel);
              border:1px solid var(--border);
              border-radius:var(--radius);
              padding:14px 16px;
              display:flex;
              align-items:center;
              gap:14px;
              animation-delay:${i * 80}ms;
            ">
              <div class="agent-avatar" style="background:${agent.color}22;color:${agent.color};">
                ${initials}
              </div>
              <div class="flex-1">
                <div style="font-family:var(--font-mono);font-size:13px;font-weight:600;color:var(--text);margin-bottom:4px;">${key}</div>
                <div style="font-size:12px;color:var(--text-dim);">
                  Last completed: <span style="color:var(--text);">${agent.lastTask}</span>
                  <span style="margin:0 6px;color:var(--border);">·</span>
                  <span style="font-family:var(--font-mono);font-size:10px;background:rgba(107,114,128,0.1);color:var(--status-idle);padding:1px 6px;border-radius:3px;">${agent.lastProject}</span>
                  <span style="margin:0 6px;color:var(--border);">·</span>
                  ${agent.lastEvent}
                </div>
              </div>
              <div style="font-size:11px;font-weight:600;padding:3px 10px;border-radius:9999px;background:rgba(107,114,128,0.12);color:var(--status-idle);letter-spacing:0.06em;">IDLE</div>
            </div>
          `;
        }).join('')}
      </div>
    </div>
  `;
}

function renderEventRow(ev, index, showAgentLabel) {
  const agent = agents[ev.agent];
  if (!agent) return '';

  const isStuck = agent.status === 'stuck';
  const statusColor = {
    stuck: 'var(--status-stuck)',
    active: 'var(--status-active)',
    idle: 'var(--status-idle)'
  }[agent.status] || 'var(--text-dim)';

  const initials = ev.agent.split('-').slice(0, 2).map(p => p[0]).join('').toUpperCase();

  const typeStyle = ev.type === 'claimed'
    ? 'background:rgba(59,130,246,0.12);color:var(--status-active);'
    : isStuck
      ? 'background:rgba(239,68,68,0.1);color:var(--status-stuck);'
      : 'background:rgba(255,255,255,0.06);color:var(--text-dim);';

  const timestamp = currentTimestamps === 'relative' ? ev.tsRel : ev.tsAbs;

  const agentLabelHTML = showAgentLabel ? `
    <span style="font-family:var(--font-mono);font-size:10px;font-weight:600;color:${agent.color};margin-right:2px;white-space:nowrap;">${ev.agent}</span>
  ` : '';

  return `
    <div class="event-row ${isStuck ? 'stuck-event' : ''}"
         style="animation-delay:${index * 40}ms;">
      <!-- Avatar -->
      <div class="agent-avatar" style="background:${agent.color}22;color:${agent.color};flex-shrink:0;">
        ${initials}
      </div>
      <!-- Timestamp -->
      <div style="font-family:var(--font-mono);font-size:11px;color:var(--text-dim);min-width:58px;flex-shrink:0;">${timestamp}</div>
      <!-- Agent label (in "all" or status-group views) -->
      ${showAgentLabel ? `<div style="min-width:120px;flex-shrink:0;">${agentLabelHTML}</div>` : ''}
      <!-- Event type badge -->
      <div class="event-type flex-shrink-0" style="${typeStyle}">${ev.type}</div>
      <!-- Content -->
      <div class="flex-1 min-w-0">
        ${ev.note ? `
          <span style="font-size:13px;color:var(--text);">"${ev.note}"</span>
          <span style="font-size:12px;color:var(--text-dim);margin-left:6px;">— ${ev.task}</span>
        ` : `
          <span style="font-size:13px;color:var(--text);">${ev.task}</span>
        `}
      </div>
      <!-- Project tag -->
      <div style="font-family:var(--font-mono);font-size:10px;background:rgba(255,255,255,0.04);color:var(--text-dim);padding:2px 8px;border-radius:4px;border:1px solid var(--border);flex-shrink:0;">${ev.project}</div>
    </div>
  `;
}

// ============================================================
// Control change handlers
// ============================================================

document.addEventListener('control-change', (e) => {
  const { id, value } = e.detail;

  if (id === 'tab-style') {
    currentTabStyle = value;
    applyTabStyle(value);
  }
  if (id === 'inline-detail') {
    currentDetailMode = value;
    // Re-render if agent tab is active
    if (currentTab.startsWith('agent-')) {
      renderContent();
    }
  }
  if (id === 'timestamps') {
    currentTimestamps = value;
    renderContent();
  }
  if (id === 'stuck-threshold') {
    // Update which agents are considered "stuck" based on silence threshold
    // (for demo, this updates the visual label — data is pre-set)
    renderContent();
  }
  // stuck-highlight is handled purely by CSS var --stuck-event-bg-opacity
});

document.addEventListener('controls-ready', () => {
  const style = getComputedStyle(document.documentElement);
  const ts = style.getPropertyValue('--timestamps').trim();
  if (ts) currentTimestamps = ts;

  const tabStyle = style.getPropertyValue('--tab-style').trim();
  if (tabStyle) {
    currentTabStyle = tabStyle;
    applyTabStyle(tabStyle);
  }

  const detailMode = style.getPropertyValue('--inline-detail').trim();
  if (detailMode) currentDetailMode = detailMode;

  // Set initial active tab to "stuck"
  const stuckBtn = document.querySelector('[data-tab="stuck"]');
  if (stuckBtn) {
    document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
    stuckBtn.classList.add('active');
  }

  renderContent();
});

// ============================================================
// Initial render (fallback if controls-ready doesn't fire)
// ============================================================
(function init() {
  applyTabStyle('pills');

  // Set stuck tab as active
  document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
  const stuckBtn = document.querySelector('[data-tab="stuck"]');
  if (stuckBtn) stuckBtn.classList.add('active');

  renderContent();
})();
</script>
</body>
</html>

  </template>
  <template id="tpl-c1" data-body-class="min-h-screen">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script type="application/json" id="variation-meta">
  {
    "id": "C1",
    "family": "C",
    "familyName": "Switchboard",
    "name": "Panel Grid",
    "layoutType": "Fixed Agent Grid",
    "aesthetic": "Professional Dark",
    "description": "Responsive grid of self-contained agent panels, all visible simultaneously. Stuck panels pulse red. Groups: stuck first, then active, then idle.",
    "controls": [
      {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["5 min", "10 min", "15 min", "30 min"],
        "cssValues": { "5 min": "5", "10 min": "10", "15 min": "15", "30 min": "30" },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
      },
      {
        "id": "grid-cols",
        "label": "Grid Columns",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["2", "3", "4"],
        "cssValues": { "2": "2", "3": "3", "4": "4" },
        "value": "3",
        "defaultValue": "3",
        "unit": "",
        "cssVar": "--grid-cols"
      },
      {
        "id": "panel-detail",
        "label": "Panel Detail",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["compact", "standard", "full"],
        "cssValues": {
          "compact": { "--panel-padding": "12px", "--timeline-display": "none", "--metric-font": "11px" },
          "standard": { "--panel-padding": "16px", "--timeline-display": "flex", "--metric-font": "12px" },
          "full": { "--panel-padding": "20px", "--timeline-display": "flex", "--metric-font": "13px" }
        },
        "value": "standard",
        "defaultValue": "standard",
        "unit": "",
        "cssVar": null
      },
      {
        "id": "pulse-intensity",
        "label": "Pulse Intensity",
        "type": "range",
        "min": 30, "max": 100, "step": 10,
        "options": null,
        "value": 70,
        "defaultValue": 70,
        "unit": "",
        "cssVar": "--stuck-pulse-intensity"
      },
      {
        "id": "show-timeline",
        "label": "Show Timeline",
        "type": "toggle",
        "min": null, "max": null, "step": null,
        "options": null,
        "cssValues": { "true": "flex", "false": "none" },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--timeline-display"
      },
      {
        "id": "panel-gap",
        "label": "Panel Gap",
        "type": "range",
        "min": 8, "max": 24, "step": 4,
        "options": null,
        "value": 16,
        "defaultValue": 16,
        "unit": "px",
        "cssVar": "--panel-gap"
      }
    ]
  }
  </script>
  <style>
    :root {
      --bg: #0f1117;
      --panel-bg: #1a1d27;
      --border: #2a2d3a;
      --text: #e2e4e9;
      --text-dim: #8b8fa3;
      --status-stuck: #ef4444;
      --status-active: #3b82f6;
      --status-idle: #6b7280;
      --status-healthy: #22c55e;
      --font-sans: 'Inter', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --radius: 8px;
      --grid-cols: 3;
      --panel-padding: 16px;
      --panel-gap: 16px;
      --timeline-display: flex;
      --metric-font: 12px;
      --stuck-pulse-intensity: 70;
      --stuck-threshold: 5;
    }

    :root * {
      transition: color 0.3s ease, background-color 0.3s ease,
                  border-color 0.3s ease, padding 0.3s ease,
                  gap 0.3s ease, font-size 0.3s ease,
                  border-radius 0.3s ease, box-shadow 0.3s ease,
                  max-width 0.3s ease, width 0.3s ease;
    }

    body {
      font-family: var(--font-sans);
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
    }

    .mono { font-family: var(--font-mono); }

    /* Agent grid */
    .agent-grid {
      display: grid;
      grid-template-columns: repeat(var(--grid-cols), minmax(280px, 1fr));
      gap: var(--panel-gap);
    }

    /* Panel base */
    .agent-panel {
      background: var(--panel-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: var(--panel-padding);
      display: flex;
      flex-direction: column;
      gap: 10px;
      animation: fadeSlideIn 0.4s ease both;
    }

    /* Stuck panel */
    .agent-panel.stuck {
      border-color: var(--status-stuck);
      box-shadow: 0 0 0 1px var(--status-stuck);
      animation: fadeSlideIn 0.4s ease both, stuckPulse 2s ease-in-out infinite;
    }

    @keyframes stuckPulse {
      0%, 100% {
        box-shadow: 0 0 0 1px rgba(239, 68, 68, calc(var(--stuck-pulse-intensity) / 100)),
                    0 0 12px 2px rgba(239, 68, 68, calc(var(--stuck-pulse-intensity) / 200));
      }
      50% {
        box-shadow: 0 0 0 2px rgba(239, 68, 68, calc(var(--stuck-pulse-intensity) / 100)),
                    0 0 24px 6px rgba(239, 68, 68, calc(var(--stuck-pulse-intensity) / 120));
      }
    }

    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Staggered entrance */
    .agent-panel:nth-child(1) { animation-delay: 0.05s; }
    .agent-panel:nth-child(2) { animation-delay: 0.10s; }
    .agent-panel:nth-child(3) { animation-delay: 0.15s; }
    .agent-panel:nth-child(4) { animation-delay: 0.20s; }
    .agent-panel:nth-child(5) { animation-delay: 0.25s; }
    .agent-panel:nth-child(6) { animation-delay: 0.30s; }
    .agent-panel:nth-child(7) { animation-delay: 0.35s; }
    .agent-panel:nth-child(8) { animation-delay: 0.40s; }

    /* Idle panel muted */
    .agent-panel.idle {
      opacity: 0.75;
    }

    /* Status dot */
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .status-dot.stuck  { background: var(--status-stuck); animation: dotPulse 1.5s ease-in-out infinite; }
    .status-dot.active { background: var(--status-active); }
    .status-dot.idle   { background: var(--status-idle); }

    @keyframes dotPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: calc(var(--stuck-pulse-intensity) / 100); }
    }

    /* Progress bar */
    .progress-track {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.6s ease;
    }
    .progress-fill.active { background: var(--status-active); }
    .progress-fill.stuck  { background: var(--status-stuck); }

    /* Metric rows */
    .metric-row {
      display: flex;
      justify-content: space-between;
      font-size: var(--metric-font);
      color: var(--text-dim);
    }

    /* Silence timer — large when stuck */
    .silence-timer-large {
      font-family: var(--font-mono);
      font-size: 22px;
      font-weight: 600;
      color: var(--status-stuck);
      line-height: 1;
    }

    /* Timeline strip */
    .timeline-strip {
      display: var(--timeline-display);
      align-items: center;
      gap: 0;
      height: 20px;
      position: relative;
    }

    .timeline-track {
      position: relative;
      flex: 1;
      height: 2px;
      background: var(--border);
      border-radius: 1px;
    }

    .timeline-dot {
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    /* Section label */
    .section-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-dim);
      padding: 0 2px 6px;
      border-bottom: 1px solid var(--border);
    }
    .section-label.stuck-label { color: var(--status-stuck); border-color: rgba(239,68,68,0.3); }

    /* Fleet summary bar */
    .fleet-bar {
      background: var(--panel-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }

    /* Project tag */
    .project-tag {
      font-size: 10px;
      font-family: var(--font-mono);
      background: rgba(139,143,163,0.12);
      color: var(--text-dim);
      border-radius: 4px;
      padding: 1px 6px;
      display: inline-block;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  </style>
</head>
<body class="min-h-screen" style="background:var(--bg);">
  <div class="overflow-auto min-h-screen" style="background:var(--bg);">
    <!-- Fleet Summary Bar -->
    <div class="fleet-bar mx-4 mt-4 mb-0 px-5 py-3 flex items-center gap-6 flex-wrap">
      <div class="flex items-center gap-2">
        <span style="font-family:var(--font-mono);font-size:13px;font-weight:600;color:var(--text);">HZL Switchboard</span>
        <span style="font-size:11px;color:var(--text-dim);">Fleet Overview</span>
      </div>
      <div class="flex items-center gap-4 ml-auto flex-wrap" style="font-size:12px;">
        <div class="flex items-center gap-1.5">
          <span class="status-dot" style="background:var(--status-stuck);width:8px;height:8px;border-radius:50%;display:inline-block;"></span>
          <span style="color:var(--status-stuck);font-weight:600;">2 stuck</span>
        </div>
        <div class="flex items-center gap-1.5">
          <span class="status-dot" style="background:var(--status-active);width:8px;height:8px;border-radius:50%;display:inline-block;"></span>
          <span style="color:var(--status-active);font-weight:600;">4 active</span>
        </div>
        <div class="flex items-center gap-1.5">
          <span class="status-dot" style="background:var(--status-idle);width:8px;height:8px;border-radius:50%;display:inline-block;"></span>
          <span style="color:var(--text-dim);">2 idle</span>
        </div>
        <div style="width:1px;height:16px;background:var(--border);"></div>
        <span style="color:var(--text-dim);">8 agents total</span>
        <div style="width:1px;height:16px;background:var(--border);"></div>
        <!-- Fleet health bar -->
        <div class="flex items-center gap-2">
          <span style="color:var(--text-dim);">Health</span>
          <div style="width:80px;height:6px;background:var(--border);border-radius:3px;overflow:hidden;display:flex;">
            <div style="width:25%;background:var(--status-stuck);"></div>
            <div style="width:50%;background:var(--status-active);"></div>
            <div style="width:25%;background:var(--status-idle);"></div>
          </div>
        </div>
        <div style="font-family:var(--font-mono);font-size:11px;color:var(--text-dim);" id="clock">--:--:--</div>
      </div>
    </div>

    <!-- Main grid area -->
    <div class="p-4 flex flex-col gap-4">

      <!-- STUCK GROUP -->
      <div>
        <div class="section-label stuck-label mb-3">Stuck &mdash; Requires Attention</div>
        <div class="agent-grid">

          <!-- claude-opus-7 | STUCK | silent 12m -->
          <div class="agent-panel stuck">
            <!-- Header -->
            <div class="flex items-center justify-between gap-2">
              <div class="flex items-center gap-2 min-w-0">
                <div class="status-dot stuck"></div>
                <span class="mono" style="font-size:13px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">claude-opus-7</span>
              </div>
              <span style="font-size:10px;font-weight:600;letter-spacing:0.06em;color:var(--status-stuck);background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:4px;padding:1px 6px;white-space:nowrap;">STUCK</span>
            </div>

            <!-- Task -->
            <div>
              <div style="font-size:13px;font-weight:500;color:var(--text);line-height:1.3;margin-bottom:4px;">Implement auth middleware</div>
              <span class="project-tag">api-v2</span>
            </div>

            <!-- Progress -->
            <div>
              <div class="flex justify-between mb-1" style="font-size:var(--metric-font);color:var(--text-dim);">
                <span>Progress</span><span style="color:var(--status-stuck);font-weight:600;">35%</span>
              </div>
              <div class="progress-track"><div class="progress-fill stuck" style="width:35%;"></div></div>
            </div>

            <!-- Silence timer -->
            <div style="background:rgba(239,68,68,0.06);border:1px solid rgba(239,68,68,0.2);border-radius:6px;padding:8px 10px;">
              <div style="font-size:10px;color:var(--status-stuck);margin-bottom:2px;font-weight:600;letter-spacing:0.05em;text-transform:uppercase;">Silent for</div>
              <div class="silence-timer-large">12m 00s</div>
            </div>

            <!-- Metrics -->
            <div class="metric-row">
              <span>Claimed</span><span class="mono">18m ago</span>
            </div>

            <!-- Timeline -->
            <div class="timeline-strip">
              <div class="timeline-track">
                <!-- Events at 18m, 15m, 12m ago then silence; window=30min; positions inverted (recent=right) -->
                <!-- 18m ago = pos 40%, 15m ago = pos 50%, 12m ago = pos 60% -->
                <div class="timeline-dot" style="left:40%;background:var(--status-stuck);opacity:0.5;"></div>
                <div class="timeline-dot" style="left:50%;background:var(--status-stuck);opacity:0.7;"></div>
                <div class="timeline-dot" style="left:60%;background:var(--status-stuck);opacity:0.9;"></div>
                <!-- Silence indicator: faded stripe from 60% to 100% -->
                <div style="position:absolute;left:63%;right:0;top:0;height:2px;background:rgba(239,68,68,0.15);border-radius:1px;"></div>
              </div>
              <span style="font-size:10px;color:var(--text-dim);margin-left:6px;white-space:nowrap;">30m</span>
            </div>
          </div>

          <!-- claude-sonnet-8 | STUCK | silent 22m -->
          <div class="agent-panel stuck">
            <!-- Header -->
            <div class="flex items-center justify-between gap-2">
              <div class="flex items-center gap-2 min-w-0">
                <div class="status-dot stuck"></div>
                <span class="mono" style="font-size:13px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">claude-sonnet-8</span>
              </div>
              <span style="font-size:10px;font-weight:600;letter-spacing:0.06em;color:var(--status-stuck);background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:4px;padding:1px 6px;white-space:nowrap;">STUCK</span>
            </div>

            <!-- Task -->
            <div>
              <div style="font-size:13px;font-weight:500;color:var(--text);line-height:1.3;margin-bottom:4px;">Fix pagination bug</div>
              <span class="project-tag">web</span>
            </div>

            <!-- Progress -->
            <div>
              <div class="flex justify-between mb-1" style="font-size:var(--metric-font);color:var(--text-dim);">
                <span>Progress</span><span style="color:var(--status-stuck);font-weight:600;">20%</span>
              </div>
              <div class="progress-track"><div class="progress-fill stuck" style="width:20%;"></div></div>
            </div>

            <!-- Silence timer -->
            <div style="background:rgba(239,68,68,0.06);border:1px solid rgba(239,68,68,0.2);border-radius:6px;padding:8px 10px;">
              <div style="font-size:10px;color:var(--status-stuck);margin-bottom:2px;font-weight:600;letter-spacing:0.05em;text-transform:uppercase;">Silent for</div>
              <div class="silence-timer-large">22m 00s</div>
            </div>

            <!-- Metrics -->
            <div class="metric-row">
              <span>Claimed</span><span class="mono">30m ago</span>
            </div>

            <!-- Timeline -->
            <div class="timeline-strip">
              <div class="timeline-track">
                <!-- Events at 30m, 25m, 22m ago; window=30min; positions -->
                <div class="timeline-dot" style="left:0%;background:var(--status-stuck);opacity:0.4;"></div>
                <div class="timeline-dot" style="left:17%;background:var(--status-stuck);opacity:0.6;"></div>
                <div class="timeline-dot" style="left:27%;background:var(--status-stuck);opacity:0.8;"></div>
                <!-- Long silence stripe -->
                <div style="position:absolute;left:30%;right:0;top:0;height:2px;background:rgba(239,68,68,0.15);border-radius:1px;"></div>
              </div>
              <span style="font-size:10px;color:var(--text-dim);margin-left:6px;white-space:nowrap;">30m</span>
            </div>
          </div>

        </div>
      </div>

      <!-- ACTIVE GROUP -->
      <div>
        <div class="section-label mb-3">Active</div>
        <div class="agent-grid">

          <!-- claude-sonnet-3 | ACTIVE | 60% | last event 1m ago -->
          <div class="agent-panel">
            <div class="flex items-center justify-between gap-2">
              <div class="flex items-center gap-2 min-w-0">
                <div class="status-dot active"></div>
                <span class="mono" style="font-size:13px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">claude-sonnet-3</span>
              </div>
              <span style="font-size:10px;font-weight:600;letter-spacing:0.06em;color:var(--status-active);background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:4px;padding:1px 6px;white-space:nowrap;">ACTIVE</span>
            </div>

            <div>
              <div style="font-size:13px;font-weight:500;color:var(--text);line-height:1.3;margin-bottom:4px;">Add search API endpoint</div>
              <span class="project-tag">api-v2</span>
            </div>

            <div>
              <div class="flex justify-between mb-1" style="font-size:var(--metric-font);color:var(--text-dim);">
                <span>Progress</span><span style="color:var(--status-active);font-weight:600;">60%</span>
              </div>
              <div class="progress-track"><div class="progress-fill active" style="width:60%;"></div></div>
            </div>

            <div class="metric-row">
              <span>Claimed</span><span class="mono">8m ago</span>
            </div>
            <div class="metric-row">
              <span>Last event</span><span class="mono" style="color:var(--status-healthy);">1m ago</span>
            </div>

            <!-- Timeline: 1m, 3m, 5m, 8m, 10m ago — dense, window 10m -->
            <div class="timeline-strip">
              <div class="timeline-track">
                <div class="timeline-dot" style="left:90%;background:var(--status-active);"></div>
                <div class="timeline-dot" style="left:70%;background:var(--status-active);opacity:0.85;"></div>
                <div class="timeline-dot" style="left:50%;background:var(--status-active);opacity:0.7;"></div>
                <div class="timeline-dot" style="left:20%;background:var(--status-active);opacity:0.55;"></div>
                <div class="timeline-dot" style="left:0%;background:var(--status-active);opacity:0.4;"></div>
              </div>
              <span style="font-size:10px;color:var(--text-dim);margin-left:6px;white-space:nowrap;">10m</span>
            </div>
          </div>

          <!-- claude-haiku-2 | ACTIVE | 40% | last event 3m ago -->
          <div class="agent-panel">
            <div class="flex items-center justify-between gap-2">
              <div class="flex items-center gap-2 min-w-0">
                <div class="status-dot active"></div>
                <span class="mono" style="font-size:13px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">claude-haiku-2</span>
              </div>
              <span style="font-size:10px;font-weight:600;letter-spacing:0.06em;color:var(--status-active);background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:4px;padding:1px 6px;white-space:nowrap;">ACTIVE</span>
            </div>

            <div>
              <div style="font-size:13px;font-weight:500;color:var(--text);line-height:1.3;margin-bottom:4px;">Write unit tests for TaskService</div>
              <span class="project-tag">core</span>
            </div>

            <div>
              <div class="flex justify-between mb-1" style="font-size:var(--metric-font);color:var(--text-dim);">
                <span>Progress</span><span style="color:var(--status-active);font-weight:600;">40%</span>
              </div>
              <div class="progress-track"><div class="progress-fill active" style="width:40%;"></div></div>
            </div>

            <div class="metric-row">
              <span>Claimed</span><span class="mono">12m ago</span>
            </div>
            <div class="metric-row">
              <span>Last event</span><span class="mono" style="color:var(--status-healthy);">3m ago</span>
            </div>

            <!-- Timeline: 3m, 6m, 9m, 12m ago; window=12m -->
            <div class="timeline-strip">
              <div class="timeline-track">
                <div class="timeline-dot" style="left:75%;background:var(--status-active);"></div>
                <div class="timeline-dot" style="left:50%;background:var(--status-active);opacity:0.8;"></div>
                <div class="timeline-dot" style="left:25%;background:var(--status-active);opacity:0.65;"></div>
                <div class="timeline-dot" style="left:0%;background:var(--status-active);opacity:0.5;"></div>
              </div>
              <span style="font-size:10px;color:var(--text-dim);margin-left:6px;white-space:nowrap;">12m</span>
            </div>
          </div>

          <!-- gemini-pro-1 | ACTIVE | 75% | last event 30s ago -->
          <div class="agent-panel">
            <div class="flex items-center justify-between gap-2">
              <div class="flex items-center gap-2 min-w-0">
                <div class="status-dot active"></div>
                <span class="mono" style="font-size:13px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">gemini-pro-1</span>
              </div>
              <span style="font-size:10px;font-weight:600;letter-spacing:0.06em;color:var(--status-active);background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:4px;padding:1px 6px;white-space:nowrap;">ACTIVE</span>
            </div>

            <div>
              <div style="font-size:13px;font-weight:500;color:var(--text);line-height:1.3;margin-bottom:4px;">Refactor database queries</div>
              <span class="project-tag">core</span>
            </div>

            <div>
              <div class="flex justify-between mb-1" style="font-size:var(--metric-font);color:var(--text-dim);">
                <span>Progress</span><span style="color:var(--status-active);font-weight:600;">75%</span>
              </div>
              <div class="progress-track"><div class="progress-fill active" style="width:75%;"></div></div>
            </div>

            <div class="metric-row">
              <span>Claimed</span><span class="mono">15m ago</span>
            </div>
            <div class="metric-row">
              <span>Last event</span><span class="mono" style="color:var(--status-healthy);">30s ago</span>
            </div>

            <!-- Timeline: 30s, 2m, 4m, 7m, 10m ago — very dense; window=10m -->
            <div class="timeline-strip">
              <div class="timeline-track">
                <div class="timeline-dot" style="left:95%;background:var(--status-healthy);"></div>
                <div class="timeline-dot" style="left:80%;background:var(--status-active);opacity:0.9;"></div>
                <div class="timeline-dot" style="left:60%;background:var(--status-active);opacity:0.75;"></div>
                <div class="timeline-dot" style="left:30%;background:var(--status-active);opacity:0.6;"></div>
                <div class="timeline-dot" style="left:0%;background:var(--status-active);opacity:0.45;"></div>
              </div>
              <span style="font-size:10px;color:var(--text-dim);margin-left:6px;white-space:nowrap;">10m</span>
            </div>
          </div>

          <!-- gpt-4o-agent | ACTIVE | 25% | last event 2m ago -->
          <div class="agent-panel">
            <div class="flex items-center justify-between gap-2">
              <div class="flex items-center gap-2 min-w-0">
                <div class="status-dot active"></div>
                <span class="mono" style="font-size:13px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">gpt-4o-agent</span>
              </div>
              <span style="font-size:10px;font-weight:600;letter-spacing:0.06em;color:var(--status-active);background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:4px;padding:1px 6px;white-space:nowrap;">ACTIVE</span>
            </div>

            <div>
              <div style="font-size:13px;font-weight:500;color:var(--text);line-height:1.3;margin-bottom:4px;">Update API documentation</div>
              <span class="project-tag">docs</span>
            </div>

            <div>
              <div class="flex justify-between mb-1" style="font-size:var(--metric-font);color:var(--text-dim);">
                <span>Progress</span><span style="color:var(--status-active);font-weight:600;">25%</span>
              </div>
              <div class="progress-track"><div class="progress-fill active" style="width:25%;"></div></div>
            </div>

            <div class="metric-row">
              <span>Claimed</span><span class="mono">5m ago</span>
            </div>
            <div class="metric-row">
              <span>Last event</span><span class="mono" style="color:var(--status-healthy);">2m ago</span>
            </div>

            <!-- Timeline: 2m, 4m, 5m ago; window=5m -->
            <div class="timeline-strip">
              <div class="timeline-track">
                <div class="timeline-dot" style="left:60%;background:var(--status-active);"></div>
                <div class="timeline-dot" style="left:20%;background:var(--status-active);opacity:0.7;"></div>
                <div class="timeline-dot" style="left:0%;background:var(--status-active);opacity:0.55;"></div>
              </div>
              <span style="font-size:10px;color:var(--text-dim);margin-left:6px;white-space:nowrap;">5m</span>
            </div>
          </div>

        </div>
      </div>

      <!-- IDLE GROUP -->
      <div>
        <div class="section-label mb-3">Idle</div>
        <div class="agent-grid">

          <!-- claude-opus-5 | IDLE | completed 8m ago -->
          <div class="agent-panel idle">
            <div class="flex items-center justify-between gap-2">
              <div class="flex items-center gap-2 min-w-0">
                <div class="status-dot idle"></div>
                <span class="mono" style="font-size:13px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">claude-opus-5</span>
              </div>
              <span style="font-size:10px;font-weight:600;letter-spacing:0.06em;color:var(--text-dim);background:rgba(107,114,128,0.1);border:1px solid rgba(107,114,128,0.3);border-radius:4px;padding:1px 6px;white-space:nowrap;">IDLE</span>
            </div>

            <div style="font-size:12px;color:var(--text-dim);">
              Idle since <span class="mono" style="color:var(--text);">8m ago</span>
            </div>

            <div style="background:rgba(107,114,128,0.06);border:1px solid rgba(107,114,128,0.15);border-radius:6px;padding:8px 10px;">
              <div style="font-size:10px;color:var(--text-dim);margin-bottom:3px;letter-spacing:0.04em;text-transform:uppercase;">Last completed</div>
              <div style="font-size:12px;color:var(--text);">Set up CI pipeline</div>
              <span class="project-tag" style="margin-top:3px;">infra</span>
            </div>

            <div class="metric-row">
              <span>Completed</span><span class="mono">8m ago</span>
            </div>

            <!-- Timeline: just 1 event 8m ago -->
            <div class="timeline-strip">
              <div class="timeline-track">
                <div class="timeline-dot" style="left:0%;background:var(--status-idle);opacity:0.6;"></div>
              </div>
              <span style="font-size:10px;color:var(--text-dim);margin-left:6px;white-space:nowrap;">8m</span>
            </div>
          </div>

          <!-- claude-haiku-9 | IDLE | completed 3m ago -->
          <div class="agent-panel idle">
            <div class="flex items-center justify-between gap-2">
              <div class="flex items-center gap-2 min-w-0">
                <div class="status-dot idle"></div>
                <span class="mono" style="font-size:13px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">claude-haiku-9</span>
              </div>
              <span style="font-size:10px;font-weight:600;letter-spacing:0.06em;color:var(--text-dim);background:rgba(107,114,128,0.1);border:1px solid rgba(107,114,128,0.3);border-radius:4px;padding:1px 6px;white-space:nowrap;">IDLE</span>
            </div>

            <div style="font-size:12px;color:var(--text-dim);">
              Idle since <span class="mono" style="color:var(--text);">3m ago</span>
            </div>

            <div style="background:rgba(107,114,128,0.06);border:1px solid rgba(107,114,128,0.15);border-radius:6px;padding:8px 10px;">
              <div style="font-size:10px;color:var(--text-dim);margin-bottom:3px;letter-spacing:0.04em;text-transform:uppercase;">Last completed</div>
              <div style="font-size:12px;color:var(--text);">Add input validation</div>
              <span class="project-tag" style="margin-top:3px;">api-v2</span>
            </div>

            <div class="metric-row">
              <span>Completed</span><span class="mono">3m ago</span>
            </div>

            <!-- Timeline: 1 event 3m ago -->
            <div class="timeline-strip">
              <div class="timeline-track">
                <div class="timeline-dot" style="left:0%;background:var(--status-idle);opacity:0.6;"></div>
              </div>
              <span style="font-size:10px;color:var(--text-dim);margin-left:6px;white-space:nowrap;">3m</span>
            </div>
          </div>

        </div>
      </div>

    </div><!-- /main grid area -->
  </div><!-- /overflow container -->

  <script>
    // Live clock
    function updateClock() {
      const now = new Date();
      const h = String(now.getHours()).padStart(2,'0');
      const m = String(now.getMinutes()).padStart(2,'0');
      const s = String(now.getSeconds()).padStart(2,'0');
      const el = document.getElementById('clock');
      if (el) el.textContent = h + ':' + m + ':' + s;
    }
    updateClock();
    setInterval(updateClock, 1000);

    // Stuck threshold event control
    // Agent silence durations: claude-opus-7=12m, claude-sonnet-8=22m
    // Active agents: last events at 1m, 3m, 30s, 2m
    const agentSilence = {
      'claude-opus-7': 12,
      'claude-sonnet-3': 1,
      'claude-haiku-2': 3,
      'gemini-pro-1': 0.5,
      'claude-opus-5': null,  // idle
      'claude-sonnet-8': 22,
      'gpt-4o-agent': 2,
      'claude-haiku-9': null  // idle
    };

    function applyStuckThreshold(thresholdMin) {
      // Re-evaluate which stuck panels should show the stuck alert
      // For this static prototype, we show a visual indicator on panels
      // where silence >= threshold
      document.querySelectorAll('.agent-panel.stuck').forEach(panel => {
        const nameEl = panel.querySelector('.mono');
        if (!nameEl) return;
        const name = nameEl.textContent.trim();
        const silence = agentSilence[name];
        if (silence !== null && silence < thresholdMin) {
          // Below threshold — dim the stuck styling slightly
          panel.style.opacity = '0.6';
        } else {
          panel.style.opacity = '1';
        }
      });
    }

    document.addEventListener('control-change', (e) => {
      const { id, value } = e.detail;
      if (id === 'stuck-threshold') {
        applyStuckThreshold(Number(value));
      }
    });

    document.addEventListener('controls-ready', () => {
      const threshold = getComputedStyle(document.documentElement)
        .getPropertyValue('--stuck-threshold').trim();
      if (threshold) applyStuckThreshold(Number(threshold));
    });
  </script>
</body>
</html>

  </template>
  <template id="tpl-c2" data-body-class="min-h-screen">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script type="application/json" id="variation-meta">
  {
    "id": "C2",
    "family": "C",
    "familyName": "Switchboard",
    "name": "Status Strips",
    "layoutType": "Horizontal Strip Rows",
    "aesthetic": "Professional Dark",
    "description": "Agent monitoring as dense horizontal rows with inline sparklines showing event cadence — stuck agents show conspicuous flat lines, healthy agents show dense tick marks.",
    "controls": [
      {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["5 min", "10 min", "15 min", "30 min"],
        "cssValues": { "5 min": "5", "10 min": "10", "15 min": "15", "30 min": "30" },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
      },
      {
        "id": "strip-height",
        "label": "Strip Height",
        "type": "range",
        "min": 40, "max": 72, "step": 4,
        "options": null,
        "cssValues": null,
        "value": 52,
        "defaultValue": 52,
        "unit": "px",
        "cssVar": "--strip-height"
      },
      {
        "id": "columns",
        "label": "Columns",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["essential", "standard", "full"],
        "cssValues": { "essential": "essential", "standard": "standard", "full": "full" },
        "value": "standard",
        "defaultValue": "standard",
        "unit": "",
        "cssVar": "--columns-mode",
        "event": true
      },
      {
        "id": "sort-by",
        "label": "Sort By",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["status", "last activity", "agent name"],
        "cssValues": { "status": "status", "last activity": "activity", "agent name": "name" },
        "value": "status",
        "defaultValue": "status",
        "unit": "",
        "cssVar": "--sort-by",
        "event": true
      },
      {
        "id": "sparkline-width",
        "label": "Sparkline Width",
        "type": "range",
        "min": 60, "max": 200, "step": 20,
        "options": null,
        "cssValues": null,
        "value": 140,
        "defaultValue": 140,
        "unit": "px",
        "cssVar": "--sparkline-width"
      },
      {
        "id": "row-hover",
        "label": "Row Hover",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["highlight", "expand preview", "tooltip"],
        "cssValues": { "highlight": "highlight", "expand preview": "preview", "tooltip": "tooltip" },
        "value": "highlight",
        "defaultValue": "highlight",
        "unit": "",
        "cssVar": "--row-hover",
        "event": true
      }
    ]
  }
  </script>
  <style>
    :root {
      --bg: #0f1117;
      --panel: #1a1d27;
      --border: #2a2d3a;
      --text: #e2e4e9;
      --text-dim: #8b8fa3;
      --status-stuck: #ef4444;
      --status-active: #3b82f6;
      --status-idle: #6b7280;
      --status-healthy: #22c55e;
      --font-mono: 'JetBrains Mono', monospace;
      --font-sans: 'Inter', sans-serif;
      --radius: 8px;
      --strip-height: 52px;
      --sparkline-width: 140px;
      --stuck-threshold: 5;
      --sort-by: status;
      --columns-mode: standard;
      --row-hover: highlight;
    }
    :root * {
      transition: color 0.3s ease, background-color 0.3s ease,
                  border-color 0.3s ease, padding 0.3s ease,
                  gap 0.3s ease, font-size 0.3s ease,
                  border-radius 0.3s ease, box-shadow 0.3s ease,
                  max-width 0.3s ease, width 0.3s ease,
                  height 0.3s ease, opacity 0.3s ease;
    }
    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      margin: 0;
    }
    .mono { font-family: var(--font-mono); }

    /* Agent row */
    .agent-row {
      height: var(--strip-height);
      min-height: var(--strip-height);
      border-left: 3px solid transparent;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      cursor: pointer;
      position: relative;
      transition: background-color 0.15s ease, border-left-color 0.15s ease;
    }
    .agent-row.stuck {
      border-left-color: var(--status-stuck);
    }
    .agent-row.active {
      border-left-color: transparent;
    }
    .agent-row.idle {
      border-left-color: transparent;
    }
    .agent-row:hover {
      background: color-mix(in srgb, var(--text) 4%, transparent);
    }
    .agent-row.focused {
      background: color-mix(in srgb, var(--status-active) 8%, transparent);
      outline: 1px solid color-mix(in srgb, var(--status-active) 40%, transparent);
      outline-offset: -1px;
    }
    .agent-row.selected {
      background: color-mix(in srgb, var(--status-active) 6%, transparent);
    }

    /* Sparkline container */
    .sparkline-col {
      width: var(--sparkline-width);
      flex-shrink: 0;
    }
    .sparkline-svg {
      width: var(--sparkline-width);
      height: 28px;
      display: block;
    }

    /* Progress bar */
    .progress-bar-track {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
      width: 80px;
    }
    .progress-bar-fill {
      height: 100%;
      border-radius: 2px;
    }

    /* Status dot */
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .status-dot.stuck { background: var(--status-stuck); box-shadow: 0 0 0 2px color-mix(in srgb, var(--status-stuck) 30%, transparent); }
    .status-dot.active { background: var(--status-active); animation: pulse-dot 2s ease-in-out infinite; }
    .status-dot.idle { background: var(--status-idle); }

    @keyframes pulse-dot {
      0%, 100% { box-shadow: 0 0 0 0px color-mix(in srgb, var(--status-active) 40%, transparent); }
      50% { box-shadow: 0 0 0 3px color-mix(in srgb, var(--status-active) 0%, transparent); }
    }

    /* Expand detail row */
    .detail-row {
      background: color-mix(in srgb, var(--panel) 80%, var(--bg));
      border-left: 3px solid var(--status-stuck);
      border-bottom: 1px solid var(--border);
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
    }
    .detail-row.hidden {
      max-height: 0;
      opacity: 0;
    }
    .detail-row.visible {
      max-height: 200px;
      opacity: 1;
    }

    /* Timeline item */
    .timeline-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 6px 0;
      position: relative;
    }
    .timeline-item:not(:last-child)::after {
      content: '';
      position: absolute;
      left: 6px;
      top: 20px;
      bottom: -6px;
      width: 1px;
      background: var(--border);
    }
    .timeline-dot {
      width: 13px;
      height: 13px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: var(--panel);
      flex-shrink: 0;
      margin-top: 2px;
    }

    /* Column visibility */
    .col-elapsed, .col-project { display: none; }
    .col-progress, .col-silence { display: flex; }

    /* Tooltip */
    .row-tooltip {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 11px;
      color: var(--text-dim);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 10;
      white-space: nowrap;
    }
    .agent-row:hover .row-tooltip.mode-tooltip {
      opacity: 1;
    }

    /* Header sort */
    .col-header {
      cursor: pointer;
      user-select: none;
      transition: color 0.15s;
    }
    .col-header:hover { color: var(--text); }
    .col-header.sorted { color: var(--status-active); }
    .sort-arrow { font-size: 10px; margin-left: 2px; }

    /* Animations */
    @keyframes row-in {
      from { opacity: 0; transform: translateX(-8px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .agent-row-wrap {
      animation: row-in 0.3s ease both;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }
  </style>
</head>
<body class="min-h-screen" style="background: var(--bg);">

<div class="flex flex-col overflow-auto" style="min-height: 100vh; max-height: 100vh;">

  <!-- Header -->
  <div class="flex items-center justify-between px-5 py-3 border-b" style="border-color: var(--border); background: var(--panel);">
    <div class="flex items-center gap-3">
      <span class="text-sm font-semibold tracking-wide" style="color: var(--text);">Agent Operations</span>
      <span class="mono text-xs px-2 py-0.5 rounded" style="background: var(--bg); color: var(--text-dim); border: 1px solid var(--border);">8 agents</span>
    </div>
    <!-- Fleet summary pills -->
    <div class="flex items-center gap-2">
      <span class="flex items-center gap-1.5 text-xs px-2.5 py-1 rounded-full" style="background: color-mix(in srgb, var(--status-active) 12%, transparent); color: var(--status-active); border: 1px solid color-mix(in srgb, var(--status-active) 25%, transparent);">
        <span class="w-1.5 h-1.5 rounded-full inline-block" style="background: var(--status-active);"></span>
        4 active
      </span>
      <span class="flex items-center gap-1.5 text-xs px-2.5 py-1 rounded-full" style="background: color-mix(in srgb, var(--status-stuck) 12%, transparent); color: var(--status-stuck); border: 1px solid color-mix(in srgb, var(--status-stuck) 25%, transparent);">
        <span class="w-1.5 h-1.5 rounded-full inline-block" style="background: var(--status-stuck);"></span>
        2 stuck
      </span>
      <span class="flex items-center gap-1.5 text-xs px-2.5 py-1 rounded-full" style="background: color-mix(in srgb, var(--status-idle) 12%, transparent); color: var(--status-idle); border: 1px solid color-mix(in srgb, var(--status-idle) 25%, transparent);">
        <span class="w-1.5 h-1.5 rounded-full inline-block" style="background: var(--status-idle);"></span>
        2 idle
      </span>
      <span class="text-xs ml-3" style="color: var(--text-dim);">Threshold: <span id="threshold-label" class="mono" style="color: var(--text);">5m</span> silence = stuck</span>
    </div>
  </div>

  <!-- Column headers -->
  <div id="col-headers" class="flex items-center px-3 py-1.5 border-b sticky top-0 z-10" style="background: var(--bg); border-color: var(--border);">
    <!-- Status dot spacer -->
    <div style="width: 36px; flex-shrink: 0;"></div>
    <!-- Agent -->
    <div class="col-header text-xs font-medium flex-1 min-w-0" style="color: var(--text-dim); min-width: 160px; max-width: 200px;" data-sort="name">
      AGENT <span class="sort-arrow" id="sort-arrow-name"></span>
    </div>
    <!-- Task -->
    <div class="col-header text-xs font-medium" style="color: var(--text-dim); flex: 1 1 0%; min-width: 160px;" data-sort="task">
      TASK
    </div>
    <!-- Project (full only) -->
    <div class="col-elapsed col-project text-xs font-medium" style="color: var(--text-dim); width: 72px; flex-shrink: 0;">
      PROJECT
    </div>
    <!-- Progress (standard+) -->
    <div class="col-progress text-xs font-medium" style="color: var(--text-dim); width: 96px; flex-shrink: 0; display: flex; justify-content: flex-start; padding-left: 0;">
      PROGRESS
    </div>
    <!-- Silence (standard+) -->
    <div class="col-silence text-xs font-medium" style="color: var(--text-dim); width: 72px; flex-shrink: 0;">
      SILENCE
    </div>
    <!-- Elapsed (full only) -->
    <div class="col-elapsed text-xs font-medium" style="color: var(--text-dim); width: 64px; flex-shrink: 0;">
      ELAPSED
    </div>
    <!-- Activity sparkline header -->
    <div class="text-xs font-medium sparkline-col" style="color: var(--text-dim);">
      ACTIVITY <span class="font-normal" style="color: color-mix(in srgb, var(--text-dim) 60%, transparent);">(30m)</span>
    </div>
  </div>

  <!-- Agent table -->
  <div id="agent-table" class="flex flex-col overflow-auto flex-1">
    <!-- Rows rendered by JS -->
  </div>

  <!-- Footer -->
  <div class="px-5 py-2 border-t flex items-center gap-4" style="border-color: var(--border); background: var(--panel);">
    <span class="text-xs" style="color: var(--text-dim);">
      <span class="mono" style="color: color-mix(in srgb, var(--text-dim) 70%, transparent);">↑↓</span> navigate
      <span class="mono ml-2" style="color: color-mix(in srgb, var(--text-dim) 70%, transparent);">Enter</span> expand
      <span class="mono ml-2" style="color: color-mix(in srgb, var(--text-dim) 70%, transparent);">Esc</span> collapse
    </span>
    <span class="text-xs ml-auto" style="color: var(--text-dim);">Last refresh: <span class="mono" style="color: var(--text);">just now</span></span>
  </div>
</div>

<script>
// ─── Data ───────────────────────────────────────────────────────────────────
const AGENTS = [
  {
    id: 'claude-sonnet-8',
    status: 'stuck',
    task: 'Fix pagination bug',
    project: 'web',
    progress: 20,
    elapsed: '30m',
    elapsedMin: 30,
    silence: '22m',
    silenceMin: 22,
    lastActivityMin: 22,
    // Events: minutes ago when each event happened (0 = now)
    events: [30, 25, 22], // then silence
    expandedByDefault: true
  },
  {
    id: 'claude-opus-7',
    status: 'stuck',
    task: 'Implement auth middleware',
    project: 'api-v2',
    progress: 35,
    elapsed: '18m',
    elapsedMin: 18,
    silence: '12m',
    silenceMin: 12,
    lastActivityMin: 12,
    events: [18, 15, 12],
    expandedByDefault: false
  },
  {
    id: 'gemini-pro-1',
    status: 'active',
    task: 'Refactor database queries',
    project: 'core',
    progress: 75,
    elapsed: '15m',
    elapsedMin: 15,
    silence: '30s',
    silenceMin: 0.5,
    lastActivityMin: 0.5,
    events: [15, 10, 7, 4, 2, 0.5],
    expandedByDefault: false
  },
  {
    id: 'claude-sonnet-3',
    status: 'active',
    task: 'Add search API endpoint',
    project: 'api-v2',
    progress: 60,
    elapsed: '8m',
    elapsedMin: 8,
    silence: '1m',
    silenceMin: 1,
    lastActivityMin: 1,
    events: [12, 10, 8, 5, 3, 1],
    expandedByDefault: false
  },
  {
    id: 'gpt-4o-agent',
    status: 'active',
    task: 'Update API documentation',
    project: 'docs',
    progress: 25,
    elapsed: '5m',
    elapsedMin: 5,
    silence: '2m',
    silenceMin: 2,
    lastActivityMin: 2,
    events: [5, 4, 2],
    expandedByDefault: false
  },
  {
    id: 'claude-haiku-2',
    status: 'active',
    task: 'Write unit tests for TaskService',
    project: 'core',
    progress: 40,
    elapsed: '12m',
    elapsedMin: 12,
    silence: '3m',
    silenceMin: 3,
    lastActivityMin: 3,
    events: [12, 9, 6, 3],
    expandedByDefault: false
  },
  {
    id: 'claude-opus-5',
    status: 'idle',
    task: null,
    project: null,
    progress: null,
    elapsed: null,
    elapsedMin: null,
    silence: '8m',
    silenceMin: 8,
    lastActivityMin: 8,
    events: [15, 12, 8],
    expandedByDefault: false
  },
  {
    id: 'claude-haiku-9',
    status: 'idle',
    task: null,
    project: null,
    progress: null,
    elapsed: null,
    elapsedMin: null,
    silence: '3m',
    silenceMin: 3,
    lastActivityMin: 3,
    events: [8, 5, 3],
    expandedByDefault: false
  }
];

// Expanded detail timeline for claude-sonnet-8
const DETAIL_TIMELINE = {
  'claude-sonnet-8': [
    { timeAgo: '22m ago', type: 'checkpoint', label: 'checkpoint', detail: 'Investigating offset calculation', task: 'Fix pagination bug' },
    { timeAgo: '25m ago', type: 'checkpoint', label: 'checkpoint', detail: 'Reading cursor implementation', task: 'Fix pagination bug' },
    { timeAgo: '30m ago', type: 'claim', label: 'claimed', detail: null, task: 'Fix pagination bug' }
  ]
};

// ─── State ───────────────────────────────────────────────────────────────────
let currentSort = 'status';
let columnsMode = 'standard';
let hoverMode = 'highlight';
let stuckThreshold = 5;
let expandedRows = new Set(['claude-sonnet-8']);
let focusedIndex = 0;
let sortedAgents = [];

// ─── Sort logic ──────────────────────────────────────────────────────────────
function sortAgents(agents, sortKey) {
  const statusOrder = { stuck: 0, active: 1, idle: 2 };
  return [...agents].sort((a, b) => {
    if (sortKey === 'status') {
      const sd = statusOrder[a.status] - statusOrder[b.status];
      if (sd !== 0) return sd;
      return a.lastActivityMin - b.lastActivityMin;
    } else if (sortKey === 'activity') {
      return a.lastActivityMin - b.lastActivityMin;
    } else if (sortKey === 'name') {
      return a.id.localeCompare(b.id);
    }
    return 0;
  });
}

// ─── Sparkline SVG ───────────────────────────────────────────────────────────
function buildSparkline(agent) {
  const W = 120; // internal SVG width; scaled by CSS
  const H = 28;
  const PAD = 4;
  const innerW = W - PAD * 2;

  // Map minutes-ago to x position (0 min ago = right, 30 min ago = left)
  const timeToX = (minAgo) => PAD + innerW * (1 - minAgo / 30);

  // Background grid lines (subtle)
  let gridLines = '';
  for (let i = 0; i <= 6; i++) {
    const x = PAD + (innerW / 6) * i;
    gridLines += `<line x1="${x}" y1="4" x2="${x}" y2="${H - 4}" stroke="#2a2d3a" stroke-width="0.5" />`;
  }

  // Determine if stuck based on threshold
  const isStuck = agent.silenceMin >= stuckThreshold;

  // Build tick marks
  let ticks = '';
  const tickColor = agent.status === 'stuck' ? '#ef4444' :
                    agent.status === 'idle' ? '#6b7280' : '#22c55e';

  agent.events.forEach(minAgo => {
    const x = timeToX(minAgo);
    if (x < PAD || x > W - PAD) return;
    ticks += `<line x1="${x}" y1="5" x2="${x}" y2="${H - 5}"
      stroke="${tickColor}" stroke-width="1.5" stroke-linecap="round"
      opacity="${agent.status === 'idle' ? '0.5' : '0.85'}" />`;
  });

  // Silence gap overlay for stuck agents
  let gapOverlay = '';
  if (agent.status === 'stuck' && agent.events.length > 0) {
    const lastEventMin = Math.min(...agent.events);
    const gapStart = timeToX(lastEventMin);
    const gapEnd = timeToX(0);
    if (gapEnd > gapStart + 4) {
      gapOverlay = `<rect x="${gapStart + 2}" y="3" width="${gapEnd - gapStart - 2}" height="${H - 6}"
        fill="url(#gap-${agent.id})" rx="1" opacity="0.15" />
        <defs>
          <linearGradient id="gap-${agent.id}" x1="0" x2="1" y1="0" y2="0">
            <stop offset="0%" stop-color="#ef4444" stop-opacity="0" />
            <stop offset="100%" stop-color="#ef4444" stop-opacity="1" />
          </linearGradient>
        </defs>`;
    }
  }

  // Baseline
  const baseline = `<line x1="${PAD}" y1="${H / 2}" x2="${W - PAD}" y2="${H / 2}"
    stroke="#2a2d3a" stroke-width="0.5" stroke-dasharray="2,3" />`;

  return `<svg class="sparkline-svg" viewBox="0 0 ${W} ${H}" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
    ${gridLines}
    ${baseline}
    ${gapOverlay}
    ${ticks}
  </svg>`;
}

// ─── Progress bar HTML ────────────────────────────────────────────────────────
function buildProgressBar(agent) {
  if (agent.progress === null) {
    return `<span style="color: var(--text-dim);" class="text-xs mono">—</span>`;
  }
  const color = agent.status === 'stuck' ? 'var(--status-stuck)' :
                agent.status === 'active' ? 'var(--status-active)' : 'var(--status-idle)';
  return `<div style="display: flex; align-items: center; gap: 6px;">
    <div class="progress-bar-track">
      <div class="progress-bar-fill" style="width: ${agent.progress}%; background: ${color};"></div>
    </div>
    <span class="mono" style="font-size: 11px; color: var(--text-dim); min-width: 28px;">${agent.progress}%</span>
  </div>`;
}

// ─── Status dot ──────────────────────────────────────────────────────────────
function buildDot(agent) {
  return `<span class="status-dot ${agent.status}"></span>`;
}

// ─── Project tag ─────────────────────────────────────────────────────────────
function buildProjectTag(project) {
  if (!project) return `<span style="color: var(--text-dim);" class="mono text-xs">—</span>`;
  const colors = {
    web: '#8b5cf6',
    'api-v2': '#3b82f6',
    core: '#22c55e',
    docs: '#f59e0b'
  };
  const c = colors[project] || '#8b8fa3';
  return `<span class="mono" style="font-size: 10px; color: ${c}; background: color-mix(in srgb, ${c} 15%, transparent); border: 1px solid color-mix(in srgb, ${c} 30%, transparent); border-radius: 4px; padding: 1px 6px;">${project}</span>`;
}

// ─── Detail row HTML ──────────────────────────────────────────────────────────
function buildDetailRow(agent) {
  const timeline = DETAIL_TIMELINE[agent.id];
  if (!timeline) return '';

  const items = timeline.map((item, i) => {
    const dotColor = item.type === 'claim' ? 'var(--status-active)' : 'var(--text-dim)';
    return `<div class="timeline-item">
      <div class="timeline-dot" style="border-color: ${dotColor}; background: color-mix(in srgb, ${dotColor} 20%, var(--panel));"></div>
      <div style="flex: 1; min-width: 0;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <span class="mono" style="font-size: 10px; color: var(--text-dim); flex-shrink: 0;">${item.timeAgo}</span>
          <span style="font-size: 11px; color: var(--text-dim); background: var(--bg); border: 1px solid var(--border); border-radius: 3px; padding: 0 5px; flex-shrink: 0;">${item.label}</span>
          ${item.detail ? `<span style="font-size: 11px; color: var(--text);">"${item.detail}"</span>` : ''}
        </div>
        <div style="font-size: 10px; color: var(--text-dim); margin-top: 2px;" class="mono">${item.task}</div>
      </div>
    </div>`;
  }).join('');

  return `<div class="detail-row ${expandedRows.has(agent.id) ? 'visible' : 'hidden'}" id="detail-${agent.id}" style="border-left-color: ${agent.status === 'stuck' ? 'var(--status-stuck)' : 'var(--border)'};">
    <div style="padding: 12px 36px 12px 48px;">
      <div style="font-size: 10px; font-weight: 600; letter-spacing: 0.08em; color: var(--text-dim); margin-bottom: 10px;">SESSION TIMELINE</div>
      ${items}
    </div>
  </div>`;
}

// ─── Tooltip ──────────────────────────────────────────────────────────────────
function buildTooltip(agent) {
  if (hoverMode !== 'tooltip') return '';
  const lines = [
    `Status: ${agent.status.toUpperCase()}`,
    agent.silence ? `Silence: ${agent.silence}` : '',
    agent.elapsed ? `Running: ${agent.elapsed}` : '',
    agent.progress !== null ? `Progress: ${agent.progress}%` : ''
  ].filter(Boolean).join(' · ');
  return `<div class="row-tooltip mode-tooltip">${lines}</div>`;
}

// ─── Row HTML ─────────────────────────────────────────────────────────────────
function buildRow(agent, index) {
  const isExpanded = expandedRows.has(agent.id);
  const hasDetail = !!DETAIL_TIMELINE[agent.id];

  const silenceColor = agent.silenceMin >= stuckThreshold && agent.status !== 'idle'
    ? 'var(--status-stuck)' : 'var(--text-dim)';

  // Column visibility helpers
  const showProgress = columnsMode === 'standard' || columnsMode === 'full';
  const showSilence = columnsMode === 'standard' || columnsMode === 'full';
  const showElapsed = columnsMode === 'full';
  const showProject = columnsMode === 'full';

  const progressCol = showProgress ? `
    <div style="width: 96px; flex-shrink: 0; display: flex; align-items: center;" class="col-progress">
      ${buildProgressBar(agent)}
    </div>` : '';

  const silenceCol = showSilence ? `
    <div style="width: 72px; flex-shrink: 0; display: flex; align-items: center;" class="col-silence">
      <span class="mono" style="font-size: 11px; color: ${silenceColor};">${agent.silence || '—'}</span>
    </div>` : '';

  const elapsedCol = showElapsed ? `
    <div style="width: 64px; flex-shrink: 0; display: flex; align-items: center;" class="col-elapsed">
      <span class="mono" style="font-size: 11px; color: var(--text-dim);">${agent.elapsed || '—'}</span>
    </div>` : '';

  const projectCol = showProject ? `
    <div style="width: 72px; flex-shrink: 0; display: flex; align-items: center;" class="col-project col-elapsed">
      ${buildProjectTag(agent.project)}
    </div>` : '';

  const expandIcon = hasDetail ? `<span style="font-size: 9px; color: var(--text-dim); margin-left: 4px; transition: transform 0.2s ease; display: inline-block; transform: ${isExpanded ? 'rotate(90deg)' : 'rotate(0deg)'};" class="expand-icon">▶</span>` : '';

  const taskText = agent.task
    ? `<span style="font-size: 12px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${agent.task}</span>`
    : `<span style="font-size: 12px; color: var(--text-dim);">—</span>`;

  const hoverPreview = hoverMode === 'preview' && hasDetail
    ? `style="cursor: pointer;"` : '';

  return `<div class="agent-row-wrap" style="animation-delay: ${index * 40}ms;">
    <div class="agent-row ${agent.status}${isExpanded ? ' selected' : ''}"
      id="row-${agent.id}"
      data-agent="${agent.id}"
      data-index="${index}"
      tabindex="0"
      role="row"
      aria-expanded="${isExpanded}"
      style="padding: 0 12px 0 6px; gap: 0;">

      <!-- Status dot -->
      <div style="width: 36px; flex-shrink: 0; display: flex; align-items: center; justify-content: center;">
        ${buildDot(agent)}
      </div>

      <!-- Agent name -->
      <div style="min-width: 160px; max-width: 200px; flex: 1; overflow: hidden; padding-right: 12px; display: flex; align-items: center;">
        <span class="mono" style="font-size: 11px; font-weight: 500; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${agent.id}</span>
        ${expandIcon}
      </div>

      <!-- Task -->
      <div style="flex: 1 1 0%; min-width: 160px; overflow: hidden; padding-right: 12px; display: flex; align-items: center; gap: 6px;">
        ${taskText}
        ${columnsMode === 'essential' ? buildProjectTag(agent.project) : ''}
      </div>

      ${projectCol}
      ${progressCol}
      ${silenceCol}
      ${elapsedCol}

      <!-- Sparkline -->
      <div class="sparkline-col" style="display: flex; align-items: center;">
        ${buildSparkline(agent)}
      </div>

      ${buildTooltip(agent)}
    </div>
    ${hasDetail ? buildDetailRow(agent) : ''}
  </div>`;
}

// ─── Render table ─────────────────────────────────────────────────────────────
function renderTable() {
  sortedAgents = sortAgents(AGENTS, currentSort);
  const table = document.getElementById('agent-table');
  if (!table) return;
  table.innerHTML = sortedAgents.map((agent, i) => buildRow(agent, i)).join('');
  attachRowListeners();
  updateColumnHeaders();
  updateSortArrows();
  updateDetailVisibility();
}

function updateColumnHeaders() {
  const showProgress = columnsMode === 'standard' || columnsMode === 'full';
  const showSilence = columnsMode === 'standard' || columnsMode === 'full';
  const showElapsed = columnsMode === 'full';
  const showProject = columnsMode === 'full';

  const headers = document.getElementById('col-headers');
  if (!headers) return;

  // Progress header
  const pHeader = headers.querySelector('.col-progress');
  if (pHeader) pHeader.style.display = showProgress ? 'flex' : 'none';

  // Silence header
  const sHeader = headers.querySelector('.col-silence');
  if (sHeader) sHeader.style.display = showSilence ? 'flex' : 'none';

  // Elapsed + project headers
  headers.querySelectorAll('.col-elapsed').forEach(el => {
    el.style.display = showElapsed ? 'flex' : 'none';
  });
}

function updateSortArrows() {
  document.querySelectorAll('.col-header').forEach(el => {
    const s = el.dataset.sort;
    el.classList.toggle('sorted', s === currentSort);
    const arrow = el.querySelector('.sort-arrow');
    if (arrow) arrow.textContent = s === currentSort ? ' ▾' : '';
  });
}

function updateDetailVisibility() {
  AGENTS.forEach(agent => {
    const detailEl = document.getElementById(`detail-${agent.id}`);
    if (!detailEl) return;
    const isExpanded = expandedRows.has(agent.id);
    detailEl.classList.toggle('visible', isExpanded);
    detailEl.classList.toggle('hidden', !isExpanded);
    const row = document.getElementById(`row-${agent.id}`);
    if (row) {
      row.setAttribute('aria-expanded', isExpanded);
      row.classList.toggle('selected', isExpanded);
      const icon = row.querySelector('.expand-icon');
      if (icon) icon.style.transform = isExpanded ? 'rotate(90deg)' : 'rotate(0deg)';
    }
  });
}

// ─── Row interaction ──────────────────────────────────────────────────────────
function toggleExpand(agentId) {
  const hasDetail = !!DETAIL_TIMELINE[agentId];
  if (!hasDetail) return;
  if (expandedRows.has(agentId)) {
    expandedRows.delete(agentId);
  } else {
    expandedRows.add(agentId);
  }
  updateDetailVisibility();
}

function attachRowListeners() {
  document.querySelectorAll('.agent-row').forEach(row => {
    const agentId = row.dataset.agent;
    const idx = parseInt(row.dataset.index, 10);

    row.addEventListener('click', () => {
      focusedIndex = idx;
      toggleExpand(agentId);
      if (hoverMode === 'preview') {
        expandedRows.add(agentId);
        updateDetailVisibility();
      }
    });

    row.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        toggleExpand(agentId);
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        const next = document.querySelector(`[data-index="${idx + 1}"] .agent-row`);
        if (next) { next.focus(); focusedIndex = idx + 1; }
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        const prev = document.querySelector(`[data-index="${idx - 1}"] .agent-row`);
        if (prev) { prev.focus(); focusedIndex = idx - 1; }
      } else if (e.key === 'Escape') {
        expandedRows.delete(agentId);
        updateDetailVisibility();
      }
    });

    row.addEventListener('focus', () => {
      row.classList.add('focused');
    });
    row.addEventListener('blur', () => {
      row.classList.remove('focused');
    });

    // Hover expand preview
    if (hoverMode === 'preview') {
      row.addEventListener('mouseenter', () => {
        if (DETAIL_TIMELINE[agentId]) {
          expandedRows.add(agentId);
          updateDetailVisibility();
        }
      });
      row.addEventListener('mouseleave', () => {
        if (!document.getElementById(`row-${agentId}`)?.classList.contains('selected')) {
          expandedRows.delete(agentId);
          updateDetailVisibility();
        }
      });
    }
  });

  // Column header sort
  document.querySelectorAll('.col-header').forEach(hdr => {
    hdr.addEventListener('click', () => {
      const s = hdr.dataset.sort;
      if (s) { currentSort = s; renderTable(); }
    });
  });
}

// ─── Control change handler ───────────────────────────────────────────────────
document.addEventListener('control-change', (e) => {
  const { id, value } = e.detail;

  if (id === 'stuck-threshold') {
    stuckThreshold = parseInt(value, 10);
    document.getElementById('threshold-label').textContent = value + 'm';
    renderTable();
  } else if (id === 'columns') {
    columnsMode = value;
    renderTable();
  } else if (id === 'sort-by') {
    currentSort = value;
    renderTable();
  } else if (id === 'row-hover') {
    hoverMode = value;
    renderTable();
  }
});

document.addEventListener('controls-ready', () => {
  // Read initial CSS vars
  const style = getComputedStyle(document.documentElement);
  const threshold = style.getPropertyValue('--stuck-threshold').trim();
  if (threshold) stuckThreshold = parseInt(threshold, 10) || 5;
  const cols = style.getPropertyValue('--columns-mode').trim();
  if (cols) columnsMode = cols.replace(/"/g, '').trim();
  const sort = style.getPropertyValue('--sort-by').trim();
  if (sort) currentSort = sort.replace(/"/g, '').trim();
  const hover = style.getPropertyValue('--row-hover').trim();
  if (hover) hoverMode = hover.replace(/"/g, '').trim();
  renderTable();
});

// Initial render
renderTable();
</script>
</body>
</html>

  </template>
  <template id="tpl-c3" data-body-class="bg-[var(--bg)] text-[var(--text)]">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script type="application/json" id="variation-meta">
  {
    "id": "C3",
    "family": "C",
    "familyName": "Switchboard",
    "name": "Mission Dashboard",
    "layoutType": "Metrics Header + Agent Tiles",
    "aesthetic": "Professional Dark",
    "description": "Fleet metrics dashboard with per-agent micro-charts showing event cadence over 30 minutes. Grafana-style monitoring for agent operations.",
    "controls": [
      {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["5 min", "10 min", "15 min", "30 min"],
        "cssValues": { "5 min": "5", "10 min": "10", "15 min": "15", "30 min": "30" },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
      },
      {
        "id": "metrics-height",
        "label": "Metrics Height",
        "type": "range",
        "min": 80, "max": 180, "step": 10,
        "options": null,
        "value": 120,
        "defaultValue": 120,
        "unit": "px",
        "cssVar": "--metrics-height"
      },
      {
        "id": "tile-size",
        "label": "Tile Size",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["compact", "standard", "large"],
        "cssValues": {
          "compact":  { "--tile-padding": "12px", "--chart-height": "60px", "--tile-min-width": "280px" },
          "standard": { "--tile-padding": "16px", "--chart-height": "80px", "--tile-min-width": "340px" },
          "large":    { "--tile-padding": "20px", "--chart-height": "100px", "--tile-min-width": "400px" }
        },
        "value": "standard",
        "defaultValue": "standard",
        "unit": "",
        "cssVar": null
      },
      {
        "id": "chart-type",
        "label": "Chart Type",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["area", "bar", "dot"],
        "cssValues": { "area": "area", "bar": "bar", "dot": "dot" },
        "value": "area",
        "defaultValue": "area",
        "unit": "",
        "cssVar": "--chart-type",
        "event": true
      },
      {
        "id": "fleet-trend",
        "label": "Fleet Trend",
        "type": "toggle",
        "min": null, "max": null, "step": null,
        "options": null,
        "cssValues": { "true": "block", "false": "none" },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--fleet-trend-display"
      },
      {
        "id": "tile-border",
        "label": "Tile Border",
        "type": "select",
        "min": null, "max": null, "step": null,
        "options": ["none", "subtle", "outlined"],
        "cssValues": {
          "none":     { "--tile-border": "none", "--tile-shadow": "none" },
          "subtle":   { "--tile-border": "1px solid var(--border)", "--tile-shadow": "0 1px 3px rgba(0,0,0,0.2)" },
          "outlined": { "--tile-border": "2px solid var(--border)", "--tile-shadow": "none" }
        },
        "value": "subtle",
        "defaultValue": "subtle",
        "unit": "",
        "cssVar": null
      }
    ]
  }
  </script>
  <style>
    :root {
      --bg: #0f1117;
      --panel: #1a1d27;
      --border: #2a2d3a;
      --text: #e2e4e9;
      --text-dim: #8b8fa3;
      --stuck: #ef4444;
      --active: #3b82f6;
      --idle: #6b7280;
      --healthy: #22c55e;
      --font-sans: 'Inter', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --radius: 8px;

      /* Control-driven */
      --metrics-height: 120px;
      --tile-padding: 16px;
      --chart-height: 80px;
      --tile-min-width: 340px;
      --fleet-trend-display: block;
      --tile-border: 1px solid var(--border);
      --tile-shadow: 0 1px 3px rgba(0,0,0,0.2);
      --stuck-threshold: 5;
      --chart-type: area;
    }

    :root * {
      transition: color 0.3s ease, background-color 0.3s ease,
                  border-color 0.3s ease, padding 0.3s ease,
                  gap 0.3s ease, font-size 0.3s ease,
                  border-radius 0.3s ease, box-shadow 0.3s ease,
                  max-width 0.3s ease, width 0.3s ease,
                  height 0.3s ease, min-height 0.3s ease;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* Metric cards */
    .metric-card {
      background: var(--panel);
      border: var(--tile-border);
      border-radius: var(--radius);
      box-shadow: var(--tile-shadow);
      padding: 0 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      height: var(--metrics-height);
      flex: 1;
      min-width: 140px;
      transition: height 0.3s ease, border 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .metric-card:hover {
      border-color: color-mix(in srgb, var(--border) 60%, white 40%);
    }

    .metric-trend {
      display: var(--fleet-trend-display);
    }

    /* Agent tiles */
    .agent-tile {
      background: var(--panel);
      border-radius: var(--radius);
      border: var(--tile-border);
      box-shadow: var(--tile-shadow);
      padding: var(--tile-padding);
      min-width: var(--tile-min-width);
      flex: 1;
      transition: border 0.3s ease, box-shadow 0.3s ease, padding 0.3s ease;
      animation: tileEntrance 0.4s ease both;
    }

    .agent-tile:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    .agent-tile.stuck-tile {
      border-color: color-mix(in srgb, var(--stuck) 60%, transparent 40%) !important;
      background: color-mix(in srgb, var(--stuck) 4%, var(--panel) 96%);
    }

    .agent-tile.idle-tile {
      opacity: 0.75;
    }

    .micro-chart-container {
      height: var(--chart-height);
      transition: height 0.3s ease;
      position: relative;
    }

    .micro-chart-container svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* Stuck badge pulse */
    @keyframes stuckPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .badge-stuck {
      animation: stuckPulse 2s ease-in-out infinite;
    }

    /* Metric stuck pulse */
    .metric-stuck-num {
      animation: stuckPulse 2s ease-in-out infinite;
    }

    @keyframes tileEntrance {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .tile-delay-0 { animation-delay: 0.05s; }
    .tile-delay-1 { animation-delay: 0.10s; }
    .tile-delay-2 { animation-delay: 0.15s; }
    .tile-delay-3 { animation-delay: 0.20s; }
    .tile-delay-4 { animation-delay: 0.25s; }
    .tile-delay-5 { animation-delay: 0.30s; }
    .tile-delay-6 { animation-delay: 0.35s; }
    .tile-delay-7 { animation-delay: 0.40s; }

    @keyframes metricEntrance {
      from { opacity: 0; transform: translateY(-8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .metric-card {
      animation: metricEntrance 0.35s ease both;
    }

    .metric-delay-0 { animation-delay: 0.0s; }
    .metric-delay-1 { animation-delay: 0.05s; }
    .metric-delay-2 { animation-delay: 0.10s; }
    .metric-delay-3 { animation-delay: 0.15s; }
    .metric-delay-4 { animation-delay: 0.20s; }

    .mono { font-family: var(--font-mono); }

    /* Chart areas */
    .chart-stuck-tint {
      fill: color-mix(in srgb, var(--stuck) 15%, transparent 85%);
    }

    /* Flatline label */
    .flatline-label {
      font-family: var(--font-mono);
      font-size: 9px;
      fill: var(--text-dim);
      opacity: 0.7;
    }

    /* Progress bar */
    .progress-track {
      background: color-mix(in srgb, var(--border) 100%, transparent 0%);
      border-radius: 2px;
      height: 3px;
      overflow: hidden;
    }

    /* Header top bar */
    .top-bar {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
    }
  </style>
</head>
<body class="bg-[var(--bg)] text-[var(--text)]">

  <div class="flex flex-col h-screen overflow-auto">

    <!-- Top bar / header -->
    <div class="top-bar px-6 py-3 flex items-center justify-between shrink-0">
      <div class="flex items-center gap-3">
        <div class="w-2 h-2 rounded-full bg-[var(--healthy)]" style="box-shadow: 0 0 6px var(--healthy);"></div>
        <span class="text-sm font-semibold tracking-wide text-[var(--text)]">Agent Operations Center</span>
        <span class="text-xs text-[var(--text-dim)] mono">Mission Dashboard</span>
      </div>
      <div class="flex items-center gap-4 text-xs text-[var(--text-dim)] mono">
        <span id="live-clock">--:--:--</span>
        <span class="px-2 py-0.5 rounded text-[10px] font-medium" style="background: color-mix(in srgb, var(--active) 15%, transparent); color: var(--active);">LIVE</span>
      </div>
    </div>

    <!-- Fleet Metrics Section -->
    <div class="px-6 py-4 shrink-0">
      <div class="flex items-center gap-2 mb-3">
        <span class="text-[10px] font-semibold tracking-widest text-[var(--text-dim)] uppercase">Fleet Overview</span>
        <div class="flex-1 h-px" style="background: var(--border);"></div>
      </div>
      <div class="flex gap-3" style="flex-wrap: wrap;">

        <!-- Active -->
        <div class="metric-card metric-delay-0">
          <div class="text-[10px] font-semibold tracking-widest uppercase mb-1" style="color: var(--active);">Active</div>
          <div class="text-4xl font-bold mono leading-none" style="color: var(--active);">4</div>
          <div class="text-xs text-[var(--text-dim)] mt-1">agents running</div>
          <div class="metric-trend mt-2">
            <svg viewBox="0 0 80 20" width="80" height="20" style="display:block;">
              <polyline points="0,16 15,14 30,10 45,8 60,6 80,4"
                stroke="var(--active)" stroke-width="1.5" fill="none" opacity="0.6"/>
              <circle cx="80" cy="4" r="2" fill="var(--active)" opacity="0.9"/>
            </svg>
          </div>
        </div>

        <!-- Stuck -->
        <div class="metric-card metric-delay-1" style="border-color: color-mix(in srgb, var(--stuck) 40%, var(--border) 60%);">
          <div class="text-[10px] font-semibold tracking-widest uppercase mb-1" style="color: var(--stuck);">Stuck</div>
          <div class="text-4xl font-bold mono leading-none metric-stuck-num" style="color: var(--stuck);">2</div>
          <div class="text-xs text-[var(--text-dim)] mt-1">need attention</div>
          <div class="metric-trend mt-2">
            <svg viewBox="0 0 80 20" width="80" height="20" style="display:block;">
              <polyline points="0,8 20,6 35,5 50,5 65,5 80,5"
                stroke="var(--stuck)" stroke-width="1.5" fill="none" opacity="0.6"/>
              <circle cx="80" cy="5" r="2" fill="var(--stuck)" opacity="0.9"/>
            </svg>
          </div>
        </div>

        <!-- Idle -->
        <div class="metric-card metric-delay-2">
          <div class="text-[10px] font-semibold tracking-widest uppercase mb-1" style="color: var(--idle);">Idle</div>
          <div class="text-4xl font-bold mono leading-none" style="color: var(--idle);">2</div>
          <div class="text-xs text-[var(--text-dim)] mt-1">awaiting tasks</div>
          <div class="metric-trend mt-2">
            <svg viewBox="0 0 80 20" width="80" height="20" style="display:block;">
              <polyline points="0,8 20,9 40,9 60,10 80,10"
                stroke="var(--idle)" stroke-width="1.5" fill="none" opacity="0.6"/>
              <circle cx="80" cy="10" r="2" fill="var(--idle)" opacity="0.9"/>
            </svg>
          </div>
        </div>

        <!-- Avg Silence -->
        <div class="metric-card metric-delay-3">
          <div class="text-[10px] font-semibold tracking-widest uppercase mb-1 text-[var(--text-dim)]">Avg Silence</div>
          <div class="flex items-baseline gap-1">
            <span class="text-4xl font-bold mono leading-none">6.2</span>
            <span class="text-base font-medium text-[var(--text-dim)]">min</span>
          </div>
          <div class="text-xs text-[var(--text-dim)] mt-1">across fleet</div>
          <div class="metric-trend mt-2">
            <svg viewBox="0 0 80 20" width="80" height="20" style="display:block;">
              <polyline points="0,10 15,8 30,12 45,7 60,9 80,11"
                stroke="var(--text-dim)" stroke-width="1.5" fill="none" opacity="0.5"/>
              <circle cx="80" cy="11" r="2" fill="var(--text-dim)" opacity="0.7"/>
            </svg>
          </div>
        </div>

        <!-- Events/Min -->
        <div class="metric-card metric-delay-4">
          <div class="text-[10px] font-semibold tracking-widest uppercase mb-1" style="color: var(--healthy);">Events/Min</div>
          <div class="flex items-baseline gap-1">
            <span class="text-4xl font-bold mono leading-none" style="color: var(--healthy);">2.3</span>
            <span class="text-base font-medium text-[var(--text-dim)]">evt/m</span>
          </div>
          <div class="text-xs text-[var(--text-dim)] mt-1">fleet throughput</div>
          <div class="metric-trend mt-2">
            <svg viewBox="0 0 80 20" width="80" height="20" style="display:block;">
              <polyline points="0,14 15,12 30,10 45,8 60,9 80,7"
                stroke="var(--healthy)" stroke-width="1.5" fill="none" opacity="0.6"/>
              <circle cx="80" cy="7" r="2" fill="var(--healthy)" opacity="0.9"/>
            </svg>
          </div>
        </div>

      </div>
    </div>

    <!-- Agent Tiles Section -->
    <div class="px-6 pb-6 flex-1">
      <div class="flex items-center gap-2 mb-3">
        <span class="text-[10px] font-semibold tracking-widest text-[var(--text-dim)] uppercase">Agent Fleet</span>
        <div class="flex-1 h-px" style="background: var(--border);"></div>
        <span class="text-[10px] text-[var(--text-dim)]">8 agents · last 30 min</span>
      </div>

      <div id="agent-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(var(--tile-min-width), 1fr)); gap: 12px;">

        <!-- Tile: claude-opus-7 STUCK -->
        <div class="agent-tile stuck-tile tile-delay-0" data-agent="claude-opus-7" data-status="stuck" data-silence="12">
          <div class="flex items-start justify-between mb-2">
            <div>
              <div class="text-sm font-semibold mono text-[var(--text)]">claude-opus-7</div>
              <div class="text-[10px] text-[var(--text-dim)] mt-0.5">api-v2</div>
            </div>
            <div class="flex items-center gap-1.5">
              <span class="badge-stuck text-[10px] font-bold px-2 py-0.5 rounded" style="background: color-mix(in srgb, var(--stuck) 20%, transparent); color: var(--stuck); border: 1px solid color-mix(in srgb, var(--stuck) 50%, transparent);">STUCK</span>
            </div>
          </div>
          <div class="text-xs text-[var(--text)] mb-1 truncate">Implement auth middleware</div>
          <div class="flex items-center gap-3 mb-2">
            <div class="text-[10px] text-[var(--text-dim)]">35%</div>
            <div class="progress-track flex-1">
              <div style="width: 35%; height: 100%; background: var(--stuck); border-radius: 2px;"></div>
            </div>
            <div class="text-[10px] mono" style="color: var(--stuck);">silent 12m</div>
          </div>
          <div class="micro-chart-container" data-chart="stuck-1">
            <!-- SVG injected by JS -->
          </div>
        </div>

        <!-- Tile: claude-sonnet-3 ACTIVE -->
        <div class="agent-tile tile-delay-1" data-agent="claude-sonnet-3" data-status="active" data-silence="1">
          <div class="flex items-start justify-between mb-2">
            <div>
              <div class="text-sm font-semibold mono text-[var(--text)]">claude-sonnet-3</div>
              <div class="text-[10px] text-[var(--text-dim)] mt-0.5">api-v2</div>
            </div>
            <span class="text-[10px] font-bold px-2 py-0.5 rounded" style="background: color-mix(in srgb, var(--active) 15%, transparent); color: var(--active); border: 1px solid color-mix(in srgb, var(--active) 40%, transparent);">ACTIVE</span>
          </div>
          <div class="text-xs text-[var(--text)] mb-1 truncate">Add search API endpoint</div>
          <div class="flex items-center gap-3 mb-2">
            <div class="text-[10px] text-[var(--text-dim)]">60%</div>
            <div class="progress-track flex-1">
              <div style="width: 60%; height: 100%; background: var(--active); border-radius: 2px;"></div>
            </div>
            <div class="text-[10px] mono" style="color: var(--healthy);">1m ago</div>
          </div>
          <div class="micro-chart-container" data-chart="active-steady">
          </div>
        </div>

        <!-- Tile: claude-haiku-2 ACTIVE -->
        <div class="agent-tile tile-delay-2" data-agent="claude-haiku-2" data-status="active" data-silence="3">
          <div class="flex items-start justify-between mb-2">
            <div>
              <div class="text-sm font-semibold mono text-[var(--text)]">claude-haiku-2</div>
              <div class="text-[10px] text-[var(--text-dim)] mt-0.5">core</div>
            </div>
            <span class="text-[10px] font-bold px-2 py-0.5 rounded" style="background: color-mix(in srgb, var(--active) 15%, transparent); color: var(--active); border: 1px solid color-mix(in srgb, var(--active) 40%, transparent);">ACTIVE</span>
          </div>
          <div class="text-xs text-[var(--text)] mb-1 truncate">Write unit tests for TaskService</div>
          <div class="flex items-center gap-3 mb-2">
            <div class="text-[10px] text-[var(--text-dim)]">40%</div>
            <div class="progress-track flex-1">
              <div style="width: 40%; height: 100%; background: var(--active); border-radius: 2px;"></div>
            </div>
            <div class="text-[10px] mono" style="color: var(--healthy);">3m ago</div>
          </div>
          <div class="micro-chart-container" data-chart="active-regular">
          </div>
        </div>

        <!-- Tile: gemini-pro-1 ACTIVE -->
        <div class="agent-tile tile-delay-3" data-agent="gemini-pro-1" data-status="active" data-silence="0">
          <div class="flex items-start justify-between mb-2">
            <div>
              <div class="text-sm font-semibold mono text-[var(--text)]">gemini-pro-1</div>
              <div class="text-[10px] text-[var(--text-dim)] mt-0.5">core</div>
            </div>
            <span class="text-[10px] font-bold px-2 py-0.5 rounded" style="background: color-mix(in srgb, var(--active) 15%, transparent); color: var(--active); border: 1px solid color-mix(in srgb, var(--active) 40%, transparent);">ACTIVE</span>
          </div>
          <div class="text-xs text-[var(--text)] mb-1 truncate">Refactor database queries</div>
          <div class="flex items-center gap-3 mb-2">
            <div class="text-[10px] text-[var(--text-dim)]">75%</div>
            <div class="progress-track flex-1">
              <div style="width: 75%; height: 100%; background: var(--active); border-radius: 2px;"></div>
            </div>
            <div class="text-[10px] mono" style="color: var(--healthy);">30s ago</div>
          </div>
          <div class="micro-chart-container" data-chart="active-dense">
          </div>
        </div>

        <!-- Tile: claude-opus-5 IDLE -->
        <div class="agent-tile idle-tile tile-delay-4" data-agent="claude-opus-5" data-status="idle" data-silence="8">
          <div class="flex items-start justify-between mb-2">
            <div>
              <div class="text-sm font-semibold mono text-[var(--text)]">claude-opus-5</div>
              <div class="text-[10px] text-[var(--text-dim)] mt-0.5">infra</div>
            </div>
            <span class="text-[10px] font-bold px-2 py-0.5 rounded" style="background: color-mix(in srgb, var(--idle) 15%, transparent); color: var(--idle); border: 1px solid color-mix(in srgb, var(--idle) 40%, transparent);">IDLE</span>
          </div>
          <div class="text-xs text-[var(--text)] mb-1 truncate">Set up CI pipeline</div>
          <div class="flex items-center gap-3 mb-2">
            <div class="text-[10px] text-[var(--text-dim)]">100%</div>
            <div class="progress-track flex-1">
              <div style="width: 100%; height: 100%; background: var(--healthy); border-radius: 2px;"></div>
            </div>
            <div class="text-[10px] mono text-[var(--text-dim)]">done 8m</div>
          </div>
          <div class="micro-chart-container" data-chart="idle-1">
          </div>
        </div>

        <!-- Tile: claude-sonnet-8 STUCK -->
        <div class="agent-tile stuck-tile tile-delay-5" data-agent="claude-sonnet-8" data-status="stuck" data-silence="22">
          <div class="flex items-start justify-between mb-2">
            <div>
              <div class="text-sm font-semibold mono text-[var(--text)]">claude-sonnet-8</div>
              <div class="text-[10px] text-[var(--text-dim)] mt-0.5">web</div>
            </div>
            <span class="badge-stuck text-[10px] font-bold px-2 py-0.5 rounded" style="background: color-mix(in srgb, var(--stuck) 20%, transparent); color: var(--stuck); border: 1px solid color-mix(in srgb, var(--stuck) 50%, transparent);">STUCK</span>
          </div>
          <div class="text-xs text-[var(--text)] mb-1 truncate">Fix pagination bug</div>
          <div class="flex items-center gap-3 mb-2">
            <div class="text-[10px] text-[var(--text-dim)]">20%</div>
            <div class="progress-track flex-1">
              <div style="width: 20%; height: 100%; background: var(--stuck); border-radius: 2px;"></div>
            </div>
            <div class="text-[10px] mono" style="color: var(--stuck);">silent 22m</div>
          </div>
          <div class="micro-chart-container" data-chart="stuck-2">
          </div>
        </div>

        <!-- Tile: gpt-4o-agent ACTIVE -->
        <div class="agent-tile tile-delay-6" data-agent="gpt-4o-agent" data-status="active" data-silence="2">
          <div class="flex items-start justify-between mb-2">
            <div>
              <div class="text-sm font-semibold mono text-[var(--text)]">gpt-4o-agent</div>
              <div class="text-[10px] text-[var(--text-dim)] mt-0.5">docs</div>
            </div>
            <span class="text-[10px] font-bold px-2 py-0.5 rounded" style="background: color-mix(in srgb, var(--active) 15%, transparent); color: var(--active); border: 1px solid color-mix(in srgb, var(--active) 40%, transparent);">ACTIVE</span>
          </div>
          <div class="text-xs text-[var(--text)] mb-1 truncate">Update API documentation</div>
          <div class="flex items-center gap-3 mb-2">
            <div class="text-[10px] text-[var(--text-dim)]">25%</div>
            <div class="progress-track flex-1">
              <div style="width: 25%; height: 100%; background: var(--active); border-radius: 2px;"></div>
            </div>
            <div class="text-[10px] mono" style="color: var(--healthy);">2m ago</div>
          </div>
          <div class="micro-chart-container" data-chart="active-burst">
          </div>
        </div>

        <!-- Tile: claude-haiku-9 IDLE -->
        <div class="agent-tile idle-tile tile-delay-7" data-agent="claude-haiku-9" data-status="idle" data-silence="3">
          <div class="flex items-start justify-between mb-2">
            <div>
              <div class="text-sm font-semibold mono text-[var(--text)]">claude-haiku-9</div>
              <div class="text-[10px] text-[var(--text-dim)] mt-0.5">api-v2</div>
            </div>
            <span class="text-[10px] font-bold px-2 py-0.5 rounded" style="background: color-mix(in srgb, var(--idle) 15%, transparent); color: var(--idle); border: 1px solid color-mix(in srgb, var(--idle) 40%, transparent);">IDLE</span>
          </div>
          <div class="text-xs text-[var(--text)] mb-1 truncate">Add input validation</div>
          <div class="flex items-center gap-3 mb-2">
            <div class="text-[10px] text-[var(--text-dim)]">100%</div>
            <div class="progress-track flex-1">
              <div style="width: 100%; height: 100%; background: var(--healthy); border-radius: 2px;"></div>
            </div>
            <div class="text-[10px] mono text-[var(--text-dim)]">done 3m</div>
          </div>
          <div class="micro-chart-container" data-chart="idle-2">
          </div>
        </div>

      </div><!-- end agent-grid -->
    </div><!-- end agent section -->
  </div><!-- end root flex -->

  <script>
    // ---- Live clock ----
    function updateClock() {
      const now = new Date();
      document.getElementById('live-clock').textContent = now.toTimeString().slice(0,8);
    }
    updateClock();
    setInterval(updateClock, 1000);

    // ---- Chart definitions ----
    // Each chart is defined as an array of [minutesAgo, relativeHeight 0-1]
    // Then optionally a flatline from the last event to now (minutesAgo = 0)
    const CHARTS = {
      'stuck-1': {
        // claude-opus-7: events at 18m, 15m, 12m ago then flatline
        events: [[18, 0.9], [15, 0.85], [12, 0.8]],
        flatlineFrom: 12,
        color: 'stuck',
        label: 'silent 12m'
      },
      'active-steady': {
        // claude-sonnet-3: events at 12m,10m,8m,5m,3m,1m (steady)
        events: [[12, 0.7], [10, 0.75], [8, 0.8], [5, 0.72], [3, 0.78], [1, 0.82]],
        flatlineFrom: null,
        color: 'active',
        label: null
      },
      'active-regular': {
        // claude-haiku-2: events at 12m, 9m, 6m, 3m (~3m cadence)
        events: [[12, 0.8], [9, 0.75], [6, 0.85], [3, 0.78]],
        flatlineFrom: null,
        color: 'active',
        label: null
      },
      'active-dense': {
        // gemini-pro-1: events at 15m,10m,7m,4m,2m,0.5m (accelerating)
        events: [[15, 0.6], [10, 0.65], [7, 0.72], [4, 0.78], [2, 0.85], [0.5, 0.9]],
        flatlineFrom: null,
        color: 'active',
        label: null
      },
      'idle-1': {
        // claude-opus-5: events at 15m,12m,8m then flatline
        events: [[15, 0.8], [12, 0.75], [8, 0.7]],
        flatlineFrom: 8,
        color: 'idle',
        label: 'idle'
      },
      'stuck-2': {
        // claude-sonnet-8: events at 30m,25m,22m then long flatline
        events: [[30, 0.85], [25, 0.8], [22, 0.75]],
        flatlineFrom: 22,
        color: 'stuck',
        label: 'silent 22m'
      },
      'active-burst': {
        // gpt-4o-agent: events at 5m,4m,2m (recent burst)
        events: [[5, 0.7], [4, 0.8], [2, 0.88]],
        flatlineFrom: null,
        color: 'active',
        label: null
      },
      'idle-2': {
        // claude-haiku-9: events at 8m,5m,3m then flatline
        events: [[8, 0.82], [5, 0.78], [3, 0.72]],
        flatlineFrom: 3,
        color: 'idle',
        label: 'idle'
      }
    };

    // ---- Color resolution ----
    const COLOR_MAP = {
      stuck: '#ef4444',
      active: '#3b82f6',
      idle: '#6b7280',
      healthy: '#22c55e'
    };

    // ---- Chart rendering ----
    let currentChartType = 'area';

    function getColorVar(colorKey) {
      return COLOR_MAP[colorKey] || '#8b8fa3';
    }

    function minutesToX(minutesAgo, totalMinutes, w) {
      // 0 min ago = right edge, 30 min ago = left edge
      return w * (1 - minutesAgo / totalMinutes);
    }

    function renderChart(container, chartKey, chartType) {
      const def = CHARTS[chartKey];
      if (!def) return;

      const w = container.clientWidth || 300;
      const h = container.clientHeight || 80;
      const totalMin = 30;
      const color = getColorVar(def.color);
      const isStuck = def.color === 'stuck';
      const isIdle = def.color === 'idle';

      // Convert events to x,y coords
      const pts = def.events.map(([mAgo, relH]) => ({
        x: minutesToX(mAgo, totalMin, w),
        y: h * (1 - relH * 0.75) // leave 25% headroom
      }));

      // Always add now (x=w) as the last reference point if no recent event
      // For flatline: add point at flatlineFrom, then at now with y = baseline
      let allPts = [...pts];
      const baselineY = h * 0.95; // near-bottom
      if (def.flatlineFrom !== null) {
        // The last event x
        const lastX = minutesToX(def.flatlineFrom, totalMin, w);
        const lastY = pts[pts.length - 1]?.y ?? baselineY;
        // Add flatline to now
        allPts.push({ x: lastX, y: lastY });
        allPts.push({ x: w, y: baselineY });
      }

      let svgContent = '';

      if (chartType === 'bar') {
        svgContent = renderBarChart(def, w, h, totalMin, color, isStuck, isIdle);
      } else if (chartType === 'dot') {
        svgContent = renderDotChart(def, w, h, totalMin, color, isStuck, isIdle);
      } else {
        // area (default)
        svgContent = renderAreaChart(def, w, h, totalMin, color, isStuck, isIdle, allPts, pts, baselineY);
      }

      // Time axis labels
      const axisLabels = `
        <text x="2" y="${h - 2}" class="flatline-label">30m</text>
        <text x="${w/2 - 6}" y="${h - 2}" class="flatline-label">15m</text>
        <text x="${w - 12}" y="${h - 2}" class="flatline-label">now</text>
      `;

      container.innerHTML = `<svg viewBox="0 0 ${w} ${h}" width="${w}" height="${h}" xmlns="http://www.w3.org/2000/svg" style="display:block;overflow:hidden;">
        <!-- grid lines -->
        <line x1="0" y1="${h * 0.25}" x2="${w}" y2="${h * 0.25}" stroke="#2a2d3a" stroke-width="0.5" opacity="0.5"/>
        <line x1="0" y1="${h * 0.5}" x2="${w}" y2="${h * 0.5}" stroke="#2a2d3a" stroke-width="0.5" opacity="0.5"/>
        <line x1="0" y1="${h * 0.75}" x2="${w}" y2="${h * 0.75}" stroke="#2a2d3a" stroke-width="0.5" opacity="0.5"/>
        <!-- vertical dividers -->
        <line x1="${w/2}" y1="0" x2="${w/2}" y2="${h - 12}" stroke="#2a2d3a" stroke-width="0.5" stroke-dasharray="2,3" opacity="0.4"/>
        ${svgContent}
        ${axisLabels}
        ${def.label ? `<text x="${w/2}" y="${h * 0.45}" class="flatline-label" text-anchor="middle" opacity="0.8">${def.label}</text>` : ''}
      </svg>`;
    }

    function polylinePoints(pts) {
      return pts.map(p => `${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(' ');
    }

    function renderAreaChart(def, w, h, totalMin, color, isStuck, isIdle, allPts, pts, baselineY) {
      if (allPts.length === 0) return '';

      // Build fill polygon: trace the line, then close at bottom
      const linePoints = polylinePoints(allPts);
      const firstX = allPts[0].x;
      const lastX = allPts[allPts.length - 1].x;

      const polygonPoints = `${firstX},${baselineY} ${linePoints} ${lastX},${baselineY}`;

      const fillOpacity = isStuck ? 0.25 : isIdle ? 0.12 : 0.15;
      const strokeOpacity = isStuck ? 1.0 : isIdle ? 0.5 : 0.9;

      // For stuck: add red tint overlay
      const stuckTint = isStuck ? `<rect x="${minutesToX(def.flatlineFrom, totalMin, w)}" y="0" width="${w - minutesToX(def.flatlineFrom, totalMin, w)}" height="${h - 12}" fill="${color}" opacity="0.06" />` : '';

      return `
        ${stuckTint}
        <polygon points="${polygonPoints}" fill="${color}" opacity="${fillOpacity}"/>
        <polyline points="${linePoints}" stroke="${color}" stroke-width="1.5" fill="none" opacity="${strokeOpacity}" stroke-linejoin="round" stroke-linecap="round"/>
        ${pts.map(p => `<circle cx="${p.x.toFixed(1)}" cy="${p.y.toFixed(1)}" r="2.5" fill="${color}" opacity="0.9"/>`).join('')}
        ${def.flatlineFrom !== null ? `
          <circle cx="${minutesToX(def.flatlineFrom, totalMin, w).toFixed(1)}" cy="${pts[pts.length-1]?.y.toFixed(1)}" r="2.5" fill="${color}" opacity="0.6"/>
          <line x1="${minutesToX(def.flatlineFrom, totalMin, w)}" y1="${pts[pts.length-1]?.y.toFixed(1)}" x2="${w}" y2="${baselineY}" stroke="${color}" stroke-width="1" stroke-dasharray="3,3" opacity="0.4"/>
        ` : ''}
      `;
    }

    function renderBarChart(def, w, h, totalMin, color, isStuck, isIdle) {
      const barW = Math.max(4, w / totalMin * 1.5);
      const baselineY = h - 12;
      const fillOpacity = isIdle ? 0.4 : 0.8;

      let bars = def.events.map(([mAgo, relH]) => {
        const x = minutesToX(mAgo, totalMin, w);
        const barH = (h - 12) * relH * 0.75;
        return `<rect x="${(x - barW/2).toFixed(1)}" y="${(baselineY - barH).toFixed(1)}" width="${barW}" height="${barH.toFixed(1)}" fill="${color}" opacity="${fillOpacity}" rx="1.5"/>`;
      }).join('');

      // Flatline indicator
      const stuckTint = isStuck && def.flatlineFrom !== null
        ? `<rect x="${minutesToX(def.flatlineFrom, totalMin, w)}" y="0" width="${w - minutesToX(def.flatlineFrom, totalMin, w)}" height="${baselineY}" fill="${color}" opacity="0.05" />`
        : '';

      return stuckTint + bars;
    }

    function renderDotChart(def, w, h, totalMin, color, isStuck, isIdle) {
      const baselineY = h - 12;
      const dotOpacity = isIdle ? 0.5 : 0.9;

      let dots = def.events.map(([mAgo, relH]) => {
        const x = minutesToX(mAgo, totalMin, w);
        const y = baselineY * (1 - relH * 0.75);
        const r = 4;
        return `
          <circle cx="${x.toFixed(1)}" cy="${y.toFixed(1)}" r="${r}" fill="${color}" opacity="${dotOpacity}"/>
          <circle cx="${x.toFixed(1)}" cy="${y.toFixed(1)}" r="${r + 2}" fill="none" stroke="${color}" stroke-width="0.5" opacity="${dotOpacity * 0.4}"/>
        `;
      }).join('');

      // Flatline indicator
      const stuckTint = isStuck && def.flatlineFrom !== null
        ? `<rect x="${minutesToX(def.flatlineFrom, totalMin, w)}" y="0" width="${w - minutesToX(def.flatlineFrom, totalMin, w)}" height="${baselineY}" fill="${color}" opacity="0.05" />`
        : '';

      // Connect dots with faint line
      const ptCoords = def.events.map(([mAgo, relH]) => {
        const x = minutesToX(mAgo, totalMin, w);
        const y = baselineY * (1 - relH * 0.75);
        return `${x.toFixed(1)},${y.toFixed(1)}`;
      }).join(' ');

      const connector = def.events.length > 1
        ? `<polyline points="${ptCoords}" stroke="${color}" stroke-width="0.75" fill="none" opacity="0.3" stroke-dasharray="2,2"/>`
        : '';

      return stuckTint + connector + dots;
    }

    // ---- Render all charts ----
    function renderAllCharts(chartType) {
      document.querySelectorAll('.micro-chart-container').forEach(container => {
        const key = container.getAttribute('data-chart');
        if (key) renderChart(container, key, chartType);
      });
    }

    // ---- Stuck threshold logic ----
    // Re-evaluate which tiles show as stuck based on silence duration and threshold
    function applyStuckThreshold(thresholdMin) {
      document.querySelectorAll('.agent-tile').forEach(tile => {
        const status = tile.getAttribute('data-status');
        const silence = parseInt(tile.getAttribute('data-silence') || '0', 10);
        if (status === 'stuck' || status === 'active') {
          const isNowStuck = (status === 'stuck') || (status === 'active' && silence >= thresholdMin);
          if (isNowStuck && status !== 'idle') {
            tile.classList.add('stuck-tile');
            const badge = tile.querySelector('[class*="ACTIVE"], span');
            // update badge only for active-turned-stuck
          }
        }
      });
    }

    // ---- Control-change listener ----
    document.addEventListener('control-change', (e) => {
      const { id, value } = e.detail;
      if (id === 'chart-type') {
        currentChartType = value;
        renderAllCharts(value);
      }
      if (id === 'stuck-threshold') {
        applyStuckThreshold(parseInt(value, 10));
      }
    });

    document.addEventListener('controls-ready', () => {
      const type = getComputedStyle(document.documentElement).getPropertyValue('--chart-type').trim();
      if (type) currentChartType = type;
      const threshold = getComputedStyle(document.documentElement).getPropertyValue('--stuck-threshold').trim();
      if (threshold) applyStuckThreshold(parseInt(threshold, 10));
      renderAllCharts(currentChartType);
    });

    // ---- Initial render (fallback if controls-ready not fired by shell) ----
    window.addEventListener('load', () => {
      // Small delay to allow iframe to settle dimensions
      setTimeout(() => {
        renderAllCharts(currentChartType);
      }, 50);
    });

    // Re-render on resize
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => renderAllCharts(currentChartType), 100);
    });
  </script>

</body>
</html>

  </template>

  <!-- ==================== ALPINE.JS DATA MODEL ==================== -->
  <script>
    function explorer() {
      return {
        // --- State ---
        variations: [{
  id: 'A1',
  family: 'A',
  familyName: 'Incident Board',
  name: 'Alert Queue',
  layoutType: 'Incident Cards + Modal Detail',
  aesthetic: 'Professional Dark',
  description: 'Stuck agents as dominant incident cards with pulsing red borders, active agents in a compact roster table, idle agents as chips. Clicking a card opens a rich diagnostic modal.',
  controls: [
    {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "5 min",
            "10 min",
            "15 min",
            "30 min"
        ],
        "cssValues": {
            "5 min": "5",
            "10 min": "10",
            "15 min": "15",
            "30 min": "30"
        },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
    },
    {
        "id": "card-height",
        "label": "Card Height",
        "type": "range",
        "min": 160,
        "max": 320,
        "step": 20,
        "options": null,
        "value": 220,
        "defaultValue": 220,
        "unit": "px",
        "cssVar": "--incident-card-height"
    },
    {
        "id": "alert-animation",
        "label": "Alert Animation",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "pulse",
            "glow",
            "static"
        ],
        "cssValues": {
            "pulse": "pulse",
            "glow": "glow",
            "static": "none"
        },
        "value": "pulse",
        "defaultValue": "pulse",
        "unit": "",
        "cssVar": "--alert-animation",
        "event": true
    },
    {
        "id": "roster-density",
        "label": "Roster Density",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "compact",
            "comfortable"
        ],
        "cssValues": {
            "compact": "36px",
            "comfortable": "52px"
        },
        "value": "comfortable",
        "defaultValue": "comfortable",
        "unit": "",
        "cssVar": "--roster-row-height"
    },
    {
        "id": "show-session",
        "label": "Show Session Preview",
        "type": "toggle",
        "min": null,
        "max": null,
        "step": null,
        "options": null,
        "cssValues": {
            "true": "block",
            "false": "none"
        },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--session-preview-display"
    },
    {
        "id": "idle-agents",
        "label": "Idle Agents",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "show",
            "count only",
            "hide"
        ],
        "cssValues": {
            "show": "flex",
            "count only": "inline-flex",
            "hide": "none"
        },
        "value": "show",
        "defaultValue": "show",
        "unit": "",
        "cssVar": "--idle-display",
        "event": true
    }
]
},
{
  id: 'A2',
  family: 'A',
  familyName: 'Incident Board',
  name: 'Inline Triage',
  layoutType: 'Expandable Incident Rows',
  aesthetic: 'Professional Dark',
  description: 'Single unified list where stuck agents auto-expand inline with timeline and diagnostics. Triage happens in-place with no modals or panels.',
  controls: [
    {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "5 min",
            "10 min",
            "15 min",
            "30 min"
        ],
        "cssValues": {
            "5 min": "5",
            "10 min": "10",
            "15 min": "15",
            "30 min": "30"
        },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
    },
    {
        "id": "auto-expand",
        "label": "Auto-Expand Stuck",
        "type": "toggle",
        "min": null,
        "max": null,
        "step": null,
        "options": null,
        "cssValues": {
            "true": "1",
            "false": "0"
        },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--auto-expand",
        "event": true
    },
    {
        "id": "row-height",
        "label": "Row Height",
        "type": "range",
        "min": 44,
        "max": 72,
        "step": 4,
        "options": null,
        "cssValues": null,
        "value": 52,
        "defaultValue": 52,
        "unit": "px",
        "cssVar": "--row-height"
    },
    {
        "id": "highlight-style",
        "label": "Incident Highlight",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "left border",
            "full background",
            "top banner"
        ],
        "cssValues": {
            "left border": "border",
            "full background": "background",
            "top banner": "banner"
        },
        "value": "left border",
        "defaultValue": "left border",
        "unit": "",
        "cssVar": "--highlight-style",
        "event": true
    },
    {
        "id": "timeline-events",
        "label": "Timeline Events",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "3 events",
            "5 events",
            "10 events"
        ],
        "cssValues": {
            "3 events": "3",
            "5 events": "5",
            "10 events": "10"
        },
        "value": "5 events",
        "defaultValue": "5 events",
        "unit": "",
        "cssVar": "--timeline-events",
        "event": true
    },
    {
        "id": "zebra",
        "label": "Zebra Striping",
        "type": "toggle",
        "min": null,
        "max": null,
        "step": null,
        "options": null,
        "cssValues": {
            "true": "0.04",
            "false": "0"
        },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--stripe-opacity"
    }
]
},
{
  id: 'A3',
  family: 'A',
  familyName: 'Incident Board',
  name: 'Split Focus',
  layoutType: 'List + Detail Split',
  aesthetic: 'Professional Dark',
  description: 'Persistent two-column layout. Left panel scrollable agent list sorted by severity. Right panel shows full session timeline, metrics, and task context for the selected agent.',
  controls: [
    {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "5 min",
            "10 min",
            "15 min",
            "30 min"
        ],
        "cssValues": {
            "5 min": "5",
            "10 min": "10",
            "15 min": "15",
            "30 min": "30"
        },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
    },
    {
        "id": "list-width",
        "label": "List Width",
        "type": "range",
        "min": 260,
        "max": 480,
        "step": 20,
        "options": null,
        "value": 320,
        "defaultValue": 320,
        "unit": "px",
        "cssVar": "--list-width"
    },
    {
        "id": "detail-tab",
        "label": "Detail Default Tab",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "timeline",
            "metrics",
            "task context"
        ],
        "cssValues": {
            "timeline": "timeline",
            "metrics": "metrics",
            "task context": "task"
        },
        "value": "timeline",
        "defaultValue": "timeline",
        "unit": "",
        "cssVar": "--detail-tab",
        "event": true
    },
    {
        "id": "list-sort",
        "label": "List Sort",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "by severity",
            "by silence duration",
            "by recency"
        ],
        "cssValues": {
            "by severity": "severity",
            "by silence duration": "silence",
            "by recency": "recency"
        },
        "value": "by severity",
        "defaultValue": "by severity",
        "unit": "",
        "cssVar": "--list-sort",
        "event": true
    },
    {
        "id": "sparklines",
        "label": "Show Sparklines",
        "type": "toggle",
        "min": null,
        "max": null,
        "step": null,
        "options": null,
        "cssValues": {
            "true": "inline-flex",
            "false": "none"
        },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--sparkline-display"
    },
    {
        "id": "summary-pos",
        "label": "Summary Position",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "bottom bar",
            "top bar",
            "hidden"
        ],
        "cssValues": {
            "bottom bar": "bottom",
            "top bar": "top",
            "hidden": "none"
        },
        "value": "bottom bar",
        "defaultValue": "bottom bar",
        "unit": "",
        "cssVar": "--summary-pos",
        "event": true
    }
]
},
{
  id: 'B1',
  family: 'B',
  familyName: 'Live Feed',
  name: 'Chronicle',
  layoutType: 'Full-Width Feed + Floating Sidebar',
  aesthetic: 'Professional Dark',
  description: 'Reverse-chronological interleaved agent event feed with silence gap markers and floating agent status sidebar.',
  controls: [
    {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "5 min",
            "10 min",
            "15 min",
            "30 min"
        ],
        "cssValues": {
            "5 min": "5",
            "10 min": "10",
            "15 min": "15",
            "30 min": "30"
        },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
    },
    {
        "id": "feed-group",
        "label": "Feed Grouping",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "chronological",
            "by agent",
            "by task"
        ],
        "cssValues": {
            "chronological": "chrono",
            "by agent": "agent",
            "by task": "task"
        },
        "value": "chronological",
        "defaultValue": "chronological",
        "unit": "",
        "cssVar": "--feed-group",
        "event": true
    },
    {
        "id": "sidebar-width",
        "label": "Sidebar Width",
        "type": "range",
        "min": 180,
        "max": 320,
        "step": 20,
        "options": null,
        "value": 240,
        "defaultValue": 240,
        "unit": "px",
        "cssVar": "--sidebar-width"
    },
    {
        "id": "event-detail",
        "label": "Event Detail",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "compact",
            "normal",
            "verbose"
        ],
        "cssValues": {
            "compact": {
                "--event-padding": "8px",
                "--event-desc-display": "none"
            },
            "normal": {
                "--event-padding": "12px",
                "--event-desc-display": "block"
            },
            "verbose": {
                "--event-padding": "16px",
                "--event-desc-display": "block"
            }
        },
        "value": "normal",
        "defaultValue": "normal",
        "unit": "",
        "cssVar": null
    },
    {
        "id": "gap-style",
        "label": "Silence Gap Style",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "red bar",
            "dotted line",
            "time label"
        ],
        "cssValues": {
            "red bar": "bar",
            "dotted line": "dotted",
            "time label": "label"
        },
        "value": "red bar",
        "defaultValue": "red bar",
        "unit": "",
        "cssVar": "--gap-style",
        "event": true
    },
    {
        "id": "auto-scroll",
        "label": "Auto-Scroll",
        "type": "toggle",
        "min": null,
        "max": null,
        "step": null,
        "options": null,
        "cssValues": {
            "true": "1",
            "false": "0"
        },
        "value": false,
        "defaultValue": false,
        "unit": "",
        "cssVar": "--auto-scroll",
        "event": true
    }
]
},
{
  id: 'B2',
  family: 'B',
  familyName: 'Live Feed',
  name: 'Lane View',
  layoutType: 'Parallel Agent Columns',
  aesthetic: 'Professional Dark',
  description: 'Each agent gets a vertical lane. Events flow down chronologically. Silence gaps are visible as empty space. Stuck lanes have red tint. Temporal comparison is instant by scanning across columns.',
  controls: [
    {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "5 min",
            "10 min",
            "15 min",
            "30 min"
        ],
        "cssValues": {
            "5 min": "5",
            "10 min": "10",
            "15 min": "15",
            "30 min": "30"
        },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
    },
    {
        "id": "lane-width",
        "label": "Lane Width",
        "type": "range",
        "min": 160,
        "max": 320,
        "step": 20,
        "options": null,
        "value": 220,
        "defaultValue": 220,
        "unit": "px",
        "cssVar": "--lane-width"
    },
    {
        "id": "lane-sort",
        "label": "Lane Sort",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "by status",
            "alphabetical",
            "by activity"
        ],
        "cssValues": {
            "by status": "status",
            "alphabetical": "alpha",
            "by activity": "activity"
        },
        "value": "by status",
        "defaultValue": "by status",
        "unit": "",
        "cssVar": "--lane-sort",
        "event": true
    },
    {
        "id": "time-scale",
        "label": "Time Scale",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "5 min",
            "15 min",
            "30 min",
            "1 hour"
        ],
        "cssValues": {
            "5 min": "5",
            "15 min": "15",
            "30 min": "30",
            "1 hour": "60"
        },
        "value": "30 min",
        "defaultValue": "30 min",
        "unit": "",
        "cssVar": "--time-scale",
        "event": true
    },
    {
        "id": "task-bounds",
        "label": "Task Boundaries",
        "type": "toggle",
        "min": null,
        "max": null,
        "step": null,
        "options": null,
        "cssValues": {
            "true": "1px solid var(--border)",
            "false": "none"
        },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--task-boundary"
    },
    {
        "id": "gap-style",
        "label": "Gap Style",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "red zone",
            "fade out",
            "hash marks"
        ],
        "cssValues": {
            "red zone": "red",
            "fade out": "fade",
            "hash marks": "hash"
        },
        "value": "red zone",
        "defaultValue": "red zone",
        "unit": "",
        "cssVar": "--gap-style",
        "event": true
    }
]
},
{
  id: 'B3',
  family: 'B',
  familyName: 'Live Feed',
  name: 'Filtered Stream',
  layoutType: 'Tabbed Feed + Inline Detail',
  aesthetic: 'Professional Dark',
  description: 'Horizontal tab bar with filter tabs that control a single unified event feed. Selecting a status tab filters agents; selecting an individual agent tab shows their full detail header above filtered events.',
  controls: [
    {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "5 min",
            "10 min",
            "15 min",
            "30 min"
        ],
        "cssValues": {
            "5 min": "5",
            "10 min": "10",
            "15 min": "15",
            "30 min": "30"
        },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
    },
    {
        "id": "tab-style",
        "label": "Tab Style",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "pills",
            "underline",
            "cards"
        ],
        "cssValues": {
            "pills": "pills",
            "underline": "underline",
            "cards": "cards"
        },
        "value": "pills",
        "defaultValue": "pills",
        "unit": "",
        "cssVar": "--tab-style",
        "event": true
    },
    {
        "id": "feed-density",
        "label": "Feed Density",
        "type": "range",
        "min": 36,
        "max": 72,
        "step": 4,
        "options": null,
        "value": 52,
        "defaultValue": 52,
        "unit": "px",
        "cssVar": "--event-height"
    },
    {
        "id": "inline-detail",
        "label": "Inline Detail",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "summary",
            "full timeline"
        ],
        "cssValues": {
            "summary": "summary",
            "full timeline": "full"
        },
        "value": "summary",
        "defaultValue": "summary",
        "unit": "",
        "cssVar": "--inline-detail",
        "event": true
    },
    {
        "id": "timestamps",
        "label": "Timestamps",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "relative",
            "absolute"
        ],
        "cssValues": {
            "relative": "relative",
            "absolute": "absolute"
        },
        "value": "relative",
        "defaultValue": "relative",
        "unit": "",
        "cssVar": "--timestamps",
        "event": true
    },
    {
        "id": "stuck-highlight",
        "label": "Stuck Highlight",
        "type": "toggle",
        "min": null,
        "max": null,
        "step": null,
        "options": null,
        "cssValues": {
            "true": "0.15",
            "false": "0"
        },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--stuck-event-bg-opacity"
    }
]
},
{
  id: 'C1',
  family: 'C',
  familyName: 'Switchboard',
  name: 'Panel Grid',
  layoutType: 'Fixed Agent Grid',
  aesthetic: 'Professional Dark',
  description: 'Responsive grid of self-contained agent panels, all visible simultaneously. Stuck panels pulse red. Groups: stuck first, then active, then idle.',
  controls: [
    {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "5 min",
            "10 min",
            "15 min",
            "30 min"
        ],
        "cssValues": {
            "5 min": "5",
            "10 min": "10",
            "15 min": "15",
            "30 min": "30"
        },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
    },
    {
        "id": "grid-cols",
        "label": "Grid Columns",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "2",
            "3",
            "4"
        ],
        "cssValues": {
            "2": "2",
            "3": "3",
            "4": "4"
        },
        "value": "3",
        "defaultValue": "3",
        "unit": "",
        "cssVar": "--grid-cols"
    },
    {
        "id": "panel-detail",
        "label": "Panel Detail",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "compact",
            "standard",
            "full"
        ],
        "cssValues": {
            "compact": {
                "--panel-padding": "12px",
                "--timeline-display": "none",
                "--metric-font": "11px"
            },
            "standard": {
                "--panel-padding": "16px",
                "--timeline-display": "flex",
                "--metric-font": "12px"
            },
            "full": {
                "--panel-padding": "20px",
                "--timeline-display": "flex",
                "--metric-font": "13px"
            }
        },
        "value": "standard",
        "defaultValue": "standard",
        "unit": "",
        "cssVar": null
    },
    {
        "id": "pulse-intensity",
        "label": "Pulse Intensity",
        "type": "range",
        "min": 30,
        "max": 100,
        "step": 10,
        "options": null,
        "value": 70,
        "defaultValue": 70,
        "unit": "",
        "cssVar": "--stuck-pulse-intensity"
    },
    {
        "id": "show-timeline",
        "label": "Show Timeline",
        "type": "toggle",
        "min": null,
        "max": null,
        "step": null,
        "options": null,
        "cssValues": {
            "true": "flex",
            "false": "none"
        },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--timeline-display"
    },
    {
        "id": "panel-gap",
        "label": "Panel Gap",
        "type": "range",
        "min": 8,
        "max": 24,
        "step": 4,
        "options": null,
        "value": 16,
        "defaultValue": 16,
        "unit": "px",
        "cssVar": "--panel-gap"
    }
]
},
{
  id: 'C2',
  family: 'C',
  familyName: 'Switchboard',
  name: 'Status Strips',
  layoutType: 'Horizontal Strip Rows',
  aesthetic: 'Professional Dark',
  description: 'Agent monitoring as dense horizontal rows with inline sparklines showing event cadence — stuck agents show conspicuous flat lines, healthy agents show dense tick marks.',
  controls: [
    {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "5 min",
            "10 min",
            "15 min",
            "30 min"
        ],
        "cssValues": {
            "5 min": "5",
            "10 min": "10",
            "15 min": "15",
            "30 min": "30"
        },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
    },
    {
        "id": "strip-height",
        "label": "Strip Height",
        "type": "range",
        "min": 40,
        "max": 72,
        "step": 4,
        "options": null,
        "cssValues": null,
        "value": 52,
        "defaultValue": 52,
        "unit": "px",
        "cssVar": "--strip-height"
    },
    {
        "id": "columns",
        "label": "Columns",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "essential",
            "standard",
            "full"
        ],
        "cssValues": {
            "essential": "essential",
            "standard": "standard",
            "full": "full"
        },
        "value": "standard",
        "defaultValue": "standard",
        "unit": "",
        "cssVar": "--columns-mode",
        "event": true
    },
    {
        "id": "sort-by",
        "label": "Sort By",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "status",
            "last activity",
            "agent name"
        ],
        "cssValues": {
            "status": "status",
            "last activity": "activity",
            "agent name": "name"
        },
        "value": "status",
        "defaultValue": "status",
        "unit": "",
        "cssVar": "--sort-by",
        "event": true
    },
    {
        "id": "sparkline-width",
        "label": "Sparkline Width",
        "type": "range",
        "min": 60,
        "max": 200,
        "step": 20,
        "options": null,
        "cssValues": null,
        "value": 140,
        "defaultValue": 140,
        "unit": "px",
        "cssVar": "--sparkline-width"
    },
    {
        "id": "row-hover",
        "label": "Row Hover",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "highlight",
            "expand preview",
            "tooltip"
        ],
        "cssValues": {
            "highlight": "highlight",
            "expand preview": "preview",
            "tooltip": "tooltip"
        },
        "value": "highlight",
        "defaultValue": "highlight",
        "unit": "",
        "cssVar": "--row-hover",
        "event": true
    }
]
},
{
  id: 'C3',
  family: 'C',
  familyName: 'Switchboard',
  name: 'Mission Dashboard',
  layoutType: 'Metrics Header + Agent Tiles',
  aesthetic: 'Professional Dark',
  description: 'Fleet metrics dashboard with per-agent micro-charts showing event cadence over 30 minutes. Grafana-style monitoring for agent operations.',
  controls: [
    {
        "id": "stuck-threshold",
        "label": "Stuck Threshold",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "5 min",
            "10 min",
            "15 min",
            "30 min"
        ],
        "cssValues": {
            "5 min": "5",
            "10 min": "10",
            "15 min": "15",
            "30 min": "30"
        },
        "value": "5 min",
        "defaultValue": "5 min",
        "unit": "",
        "cssVar": "--stuck-threshold",
        "event": true
    },
    {
        "id": "metrics-height",
        "label": "Metrics Height",
        "type": "range",
        "min": 80,
        "max": 180,
        "step": 10,
        "options": null,
        "value": 120,
        "defaultValue": 120,
        "unit": "px",
        "cssVar": "--metrics-height"
    },
    {
        "id": "tile-size",
        "label": "Tile Size",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "compact",
            "standard",
            "large"
        ],
        "cssValues": {
            "compact": {
                "--tile-padding": "12px",
                "--chart-height": "60px",
                "--tile-min-width": "280px"
            },
            "standard": {
                "--tile-padding": "16px",
                "--chart-height": "80px",
                "--tile-min-width": "340px"
            },
            "large": {
                "--tile-padding": "20px",
                "--chart-height": "100px",
                "--tile-min-width": "400px"
            }
        },
        "value": "standard",
        "defaultValue": "standard",
        "unit": "",
        "cssVar": null
    },
    {
        "id": "chart-type",
        "label": "Chart Type",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "area",
            "bar",
            "dot"
        ],
        "cssValues": {
            "area": "area",
            "bar": "bar",
            "dot": "dot"
        },
        "value": "area",
        "defaultValue": "area",
        "unit": "",
        "cssVar": "--chart-type",
        "event": true
    },
    {
        "id": "fleet-trend",
        "label": "Fleet Trend",
        "type": "toggle",
        "min": null,
        "max": null,
        "step": null,
        "options": null,
        "cssValues": {
            "true": "block",
            "false": "none"
        },
        "value": true,
        "defaultValue": true,
        "unit": "",
        "cssVar": "--fleet-trend-display"
    },
    {
        "id": "tile-border",
        "label": "Tile Border",
        "type": "select",
        "min": null,
        "max": null,
        "step": null,
        "options": [
            "none",
            "subtle",
            "outlined"
        ],
        "cssValues": {
            "none": {
                "--tile-border": "none",
                "--tile-shadow": "none"
            },
            "subtle": {
                "--tile-border": "1px solid var(--border)",
                "--tile-shadow": "0 1px 3px rgba(0,0,0,0.2)"
            },
            "outlined": {
                "--tile-border": "2px solid var(--border)",
                "--tile-shadow": "none"
            }
        },
        "value": "subtle",
        "defaultValue": "subtle",
        "unit": "",
        "cssVar": null
    }
]
}],
        currentIndex: 0,
        meta: {},
        showControls: false,
        showExport: false,
        showFinalize: false,
        showShortcuts: false,
        isTransitioning: true,
        copiedFeedback: false,
        copiedDirection: false,
        finalizeNotes: '',
        directionText: '',
        ratings: {},

        // --- Computed ---
        get current() { return this.variations[this.currentIndex]; },
        get families() {
          const map = {};
          this.variations.forEach(v => {
            if (!map[v.family]) map[v.family] = { letter: v.family, name: v.familyName, variations: [] };
            map[v.family].variations.push(v);
          });
          return Object.values(map);
        },
        get currentRating() { return this.ratings[this.current.id] || { stars: null, notes: '' }; },
        get reviewedCount() { return Object.values(this.ratings).filter(r => r.stars != null).length; },

        // --- Init ---
        init() {
          this.meta = JSON.parse(document.getElementById('exploration-metadata').textContent);
          this.variations.forEach(v => { v.controls.forEach((c, i) => this.normalizeControl(c, i)); });
          this.loadState();
          this.directionText = this.defaultDirection();
          this.$nextTick(() => this.loadVariationInIframe());
        },
        // Fix common subagent deviations from the control schema
        normalizeControl(c, index) {
          // Auto-generate id if missing — most common subagent mistake
          if (!c.id && c.label) c.id = c.label.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-$/, '');
          if (!c.id) c.id = 'ctrl-' + index;
          // Normalize type — map alternates and infer from data shape
          const typeMap = { boolean: 'toggle', switch: 'toggle', checkbox: 'toggle', slider: 'range', dropdown: 'select', radio: 'select' };
          if (c.type) c.type = typeMap[c.type.toLowerCase()] || c.type.toLowerCase();
          if (!c.type || !['range', 'select', 'toggle'].includes(c.type)) {
            if (c.min != null || c.max != null) c.type = 'range';
            else if (Array.isArray(c.options) && c.options.length) c.type = 'select';
            else if (typeof c.value === 'boolean' || typeof c.default === 'boolean') c.type = 'toggle';
            else c.type = 'toggle'; // safe fallback
          }
          // cssValues as array → convert to object keyed by option labels
          if (Array.isArray(c.cssValues) && Array.isArray(c.options) && c.cssValues.length === c.options.length) {
            const obj = {};
            c.options.forEach((opt, i) => { obj[typeof opt === 'string' ? opt : (opt.label || String(opt))] = c.cssValues[i]; });
            c.cssValues = obj;
          }
          // Select with cssValues but no options → derive options from cssValues keys
          if (c.cssValues && typeof c.cssValues === 'object' && !Array.isArray(c.cssValues) &&
              (!Array.isArray(c.options) || c.options.length === 0)) {
            c.options = Object.keys(c.cssValues);
            if (!c.type) c.type = 'select';
          }
          // options as objects [{label,value}] → extract labels + build cssValues + valueToLabel map
          let valueToLabel = {};
          if (Array.isArray(c.options) && c.options.length && typeof c.options[0] === 'object') {
            if (!c.cssValues) c.cssValues = {};
            const labels = [];
            c.options.forEach(o => {
              const lbl = o.label || o.name || String(o.value);
              const val = o.value != null ? o.value : o.cssValue || lbl;
              labels.push(lbl);
              valueToLabel[val] = lbl;
              // Per-option cssValues object (multi-var) takes priority over scalar value
              if (!(lbl in c.cssValues)) {
                if (o.cssValues && typeof o.cssValues === 'object') {
                  c.cssValues[lbl] = o.cssValues;
                } else {
                  c.cssValues[lbl] = String(val);
                }
              }
            });
            c.options = labels;
          }
          // "default" → value/defaultValue (resolve via valueToLabel if needed)
          const resolve = v => valueToLabel[v] || v;
          if (c.value == null && c.default != null) c.value = resolve(c.default);
          if (c.value != null) c.value = resolve(c.value);
          if (c.defaultValue == null && c.default != null) c.defaultValue = resolve(c.default);
          if (c.defaultValue == null && c.value != null) c.defaultValue = c.value;
          if (c.value == null && c.defaultValue != null) c.value = c.defaultValue;
          // Range with string value containing unit (e.g. '0.5s') → parse to number
          if (c.type === 'range' && typeof c.value === 'string') {
            const parsed = parseFloat(c.value);
            if (!isNaN(parsed)) { c.value = parsed; c.defaultValue = parsed; }
          }
          // Range with unit '%' — keep unit for display label but strip for CSS
          // generation when it's a 0-100 scale. CSS vars should receive the raw
          // number (e.g., 50 not 50%) so calc() like 'calc(var(--x) / 100)' or
          // 'calc(var(--x) * 1%)' works correctly. Store display unit separately.
          if (c.type === 'range' && c.unit === '%') {
            c._displayUnit = '%';
            c.unit = '';
          }
          // Ensure value is in options for select
          if (c.type === 'select' && Array.isArray(c.options) && c.options.length && !c.options.includes(c.value)) {
            c.value = c.options[0];
            c.defaultValue = c.options[0];
          }
        },

        // --- Iframe ---
        loadVariationInIframe() {
          const tpl = document.getElementById('tpl-' + this.current.id.toLowerCase());
          if (!tpl) return;
          this.$refs.iframe.srcdoc = '<!DOCTYPE html>\n' + tpl.innerHTML;
        },
        onIframeLoad() {
          if (!this.$refs.iframe?.srcdoc) return;
          // Restore body class — <template> parser strips <body> attributes,
          // so assemble.py preserves them as data-body-class on the template element
          const tpl = document.getElementById('tpl-' + this.current.id.toLowerCase());
          if (tpl) {
            const bodyClass = tpl.getAttribute('data-body-class');
            if (bodyClass && this.$refs.iframe.contentDocument?.body) {
              this.$refs.iframe.contentDocument.body.className = bodyClass;
            }
          }
          this.applyControlsToIframe();
          this.isTransitioning = false;
        },
        applyControlsToIframe() {
          const doc = this.$refs.iframe?.contentDocument;
          if (!doc) return;
          this.current.controls.forEach(c => {
            if (c.value == null) return;
            const val = c.value;
            if (c.cssValues) {
              const mapped = c.cssValues[val] ?? c.cssValues[String(val)];
              if (mapped && typeof mapped === 'object') {
                Object.entries(mapped).forEach(([prop, v]) => doc.documentElement.style.setProperty(prop, v));
              } else if (mapped != null && c.cssVar) {
                doc.documentElement.style.setProperty(c.cssVar, mapped);
              }
            } else if (c.cssVar) {
              if (c.type === 'toggle') {
                doc.documentElement.style.setProperty(c.cssVar, val ? '1' : '0');
              } else {
                doc.documentElement.style.setProperty(c.cssVar, String(val) + (c.unit || ''));
              }
            }
            // Dispatch event for behavioral controls (and any variation listening)
            try { doc.dispatchEvent(new CustomEvent('control-change', { detail: { id: c.id, value: val } })); } catch(e) {}
          });
          // Signal that all controls have been applied (useful for initial load)
          try { doc.dispatchEvent(new CustomEvent('controls-ready')); } catch(e) {}
        },

        // --- Navigation ---
        goTo(index) {
          if (index === this.currentIndex) return;
          this.isTransitioning = true;
          setTimeout(() => {
            this.currentIndex = index;
            this.loadVariationInIframe();
          }, 150);
        },
        next() { this.goTo((this.currentIndex + 1) % this.variations.length); },
        prev() { this.goTo((this.currentIndex - 1 + this.variations.length) % this.variations.length); },
        selectVariation(id) {
          const idx = this.variations.findIndex(v => v.id === id);
          if (idx !== -1) this.goTo(idx);
        },

        // --- Controls ---
        updateControl(controlId, value) {
          const control = this.current.controls.find(c => c.id === controlId);
          if (control) { control.value = value; this.saveControlState(); this.applyControlsToIframe(); }
        },
        resetControls() {
          this.current.controls.forEach(c => { c.value = c.defaultValue; });
          this.saveControlState();
          this.applyControlsToIframe();
        },
        replayVariation() {
          this.isTransitioning = true;
          setTimeout(() => this.loadVariationInIframe(), 150);
        },

        // --- Rating ---
        rate(stars) {
          if (!this.ratings[this.current.id]) this.ratings[this.current.id] = { stars: null, notes: '' };
          // Clicking same rating clears it (back to unreviewed); otherwise set the new rating
          this.ratings[this.current.id].stars = this.ratings[this.current.id].stars === stars ? null : stars;
          this.saveState();
        },
        updateNotes(text) {
          if (!this.ratings[this.current.id]) this.ratings[this.current.id] = { stars: null, notes: '' };
          this.ratings[this.current.id].notes = text;
          this.saveState();
        },

        // --- Export ---
        generateFeedback() {
          const m = this.meta;
          const title = m.topic ? m.topic.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : m.project;
          let out = `## Design Exploration Feedback \u2014 ${title} (Round ${m.round})\n`;
          out += `Source: ${m.sourceDirectory}/v${m.round}.html (read exploration-metadata JSON from this file for full context)\n`;
          out += `Reviewed: ${this.reviewedCount}/${this.variations.length} variations\n`;
          const loved = this.variations.filter(v => (this.ratings[v.id]?.stars ?? -1) >= 4);
          const mixed = this.variations.filter(v => { const s = this.ratings[v.id]?.stars; return s != null && s >= 2 && s <= 3; });
          const low = this.variations.filter(v => this.ratings[v.id]?.stars === 1);
          const skipped = this.variations.filter(v => this.ratings[v.id]?.stars === 0);
          const unreviewed = this.variations.filter(v => this.ratings[v.id]?.stars == null);
          const fmtAdjusted = (v) => {
            const adjusted = v.controls.filter(c => {
              if (c.defaultValue == null) return false;
              return JSON.stringify(c.value) !== JSON.stringify(c.defaultValue);
            });
            if (!adjusted.length) return '';
            const parts = adjusted.map(c => {
              const d = c.defaultValue;
              const u = c.unit || '';
              if (c.type === 'toggle') return `${c.label}: ${d ? 'on' : 'off'} \u2192 ${c.value ? 'on' : 'off'}`;
              if (c.type === 'range') return `${c.label}: ${d}${u} \u2192 ${c.value}${u}`;
              return `${c.label}: ${d} \u2192 ${c.value}`;
            });
            return `  Adjusted: ${parts.join(', ')}\n`;
          };
          const famApproach = (v) => {
            const fam = m.families?.find(f => f.letter === v.family);
            return fam?.approach ? `  Approach: ${fam.approach}\n` : '';
          };
          const fmt = (v) => {
            const rt = this.ratings[v.id];
            let line = `- **${v.id} \u201C${v.name}\u201D** (${rt.stars}\u2605) \u2014 Family ${v.family} \u201C${v.familyName}\u201D\n`;
            line += famApproach(v);
            line += `  ${v.layoutType} / ${v.aesthetic}: ${v.description}\n`;
            if (rt.notes) line += `  Note: ${rt.notes}\n`;
            line += fmtAdjusted(v);
            return line;
          };
          if (loved.length) { out += `\n**Loved (4-5\u2605)**\n`; loved.forEach(v => out += fmt(v)); }
          if (mixed.length) { out += `\n**Mixed (2-3\u2605)**\n`; mixed.forEach(v => out += fmt(v)); }
          if (low.length) { out += `\n**Low (1\u2605)**\n`; low.forEach(v => out += fmt(v)); }
          if (skipped.length) {
            out += `\n**Skip (0\u2605)**\n`;
            skipped.forEach(v => {
              let line = `- **${v.id} \u201C${v.name}\u201D** \u2014 Family ${v.family} \u201C${v.familyName}\u201D\n`;
              line += famApproach(v);
              line += `  ${v.layoutType} / ${v.aesthetic}: ${v.description}\n`;
              const rt = this.ratings[v.id];
              if (rt?.notes) line += `  Note: ${rt.notes}\n`;
              line += fmtAdjusted(v);
              out += line;
            });
          }
          if (unreviewed.length) {
            out += `\n**Not reviewed**\n`;
            unreviewed.forEach(v => {
              let line = `- ${v.id} \u201C${v.name}\u201D \u2014 Family ${v.family} \u201C${v.familyName}\u201D\n`;
              line += famApproach(v);
              line += `  ${v.layoutType} / ${v.aesthetic}: ${v.description}\n`;
              out += line;
            });
          }
          return out;
        },
        defaultDirection() {
          const loved = this.variations.filter(v => (this.ratings[v.id]?.stars ?? -1) >= 4);
          const skipped = this.variations.filter(v => this.ratings[v.id]?.stars === 0);
          let d = '';
          if (loved.length) d += `Keep: ${loved.map(v => v.id + ' "' + v.name + '"').join(', ')}. `;
          if (skipped.length) d += `Drop: ${skipped.map(v => v.id + ' "' + v.name + '"').join(', ')}. `;
          return d;
        },
        copyFeedback() {
          const feedback = this.generateFeedback();
          const direction = this.directionText.trim() || '[No direction provided]';
          const full = feedback + '\n### Direction for Next Round\n' + direction;
          navigator.clipboard.writeText(full);
          this.copiedFeedback = true;
          setTimeout(() => { this.copiedFeedback = false; }, 2000);
        },

        // --- Finalize ---
        openFinalize() {
          this.finalizeNotes = this.currentRating.notes || '';
          this.copiedDirection = false;
          this.showFinalize = true;
        },
        generateDirection() {
          const v = this.current;
          const m = this.meta;
          const title = m.topic ? m.topic.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : m.project;
          let out = `## Design Direction — ${title}\n`;
          out += `Source: ${m.sourceDirectory}/v${m.round}.html (read exploration-metadata JSON from this file for full context)\n\n`;
          out += `**Chosen: ${v.id} "${v.name}"** — Family ${v.family} "${v.familyName}"\n`;
          const fam = m.families?.find(f => f.letter === v.family);
          if (fam?.approach) out += `Approach: ${fam.approach}\n`;
          out += `${v.layoutType} / ${v.aesthetic}: ${v.description}\n`;
          // Adjusted controls as absolute design specs
          const tuned = v.controls.filter(c => {
            if (c.defaultValue == null) return false;
            return JSON.stringify(c.value) !== JSON.stringify(c.defaultValue);
          });
          if (tuned.length) {
            out += `\nDesign specs (adjusted from defaults):\n`;
            tuned.forEach(c => {
              const u = c.unit || '';
              if (c.type === 'toggle') out += `- ${c.label}: ${c.value ? 'on' : 'off'}\n`;
              else out += `- ${c.label}: ${c.value}${u}\n`;
            });
          }
          return out;
        },
        copyDirection() {
          let full = this.generateDirection();
          const notes = this.finalizeNotes.trim();
          if (notes) full += `\n### Additional Notes\n${notes}\n`;
          navigator.clipboard.writeText(full);
          this.copiedDirection = true;
          setTimeout(() => { this.copiedDirection = false; }, 2000);
        },

        // --- Keyboard ---
        handleKey(e) {
          if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
          switch(e.key) {
            case 'ArrowRight': case 'ArrowDown': this.next(); break;
            case 'ArrowLeft': case 'ArrowUp': this.prev(); break;
            case '0': this.rate(0); break;
            case '1': case '2': case '3': case '4': case '5': this.rate(+e.key); break;
            case 'l': case 'L': this.showControls = !this.showControls; break;
            case 'e': case 'E': this.showExport = !this.showExport; break;
            case 'r': case 'R': this.replayVariation(); break;
            case '?': this.showShortcuts = !this.showShortcuts; break;
            case 'Escape': this.showControls = false; this.showExport = false; this.showFinalize = false; this.showShortcuts = false; break;
          }
        },

        // --- Persistence ---
        storageKey(suffix) {
          const dir = (this.meta.sourceDirectory || '').split('/').pop() || this.meta.topic;
          return `design-exploration-${dir}-r${this.meta.round}-${suffix}`;
        },
        saveState() {
          localStorage.setItem(this.storageKey('ratings'), JSON.stringify(this.ratings));
        },
        loadState() {
          try { this.ratings = JSON.parse(localStorage.getItem(this.storageKey('ratings')) || '{}'); } catch(e) {}
          try {
            const cs = JSON.parse(localStorage.getItem(this.storageKey('controls')) || 'null');
            if (cs) {
              this.variations.forEach(v => {
                if (cs[v.id]) v.controls.forEach(c => { if (cs[v.id][c.id] !== undefined) c.value = cs[v.id][c.id]; });
              });
            }
          } catch(e) {}
        },
        saveControlState() {
          const state = {};
          this.variations.forEach(v => {
            state[v.id] = {};
            v.controls.forEach(c => { state[v.id][c.id] = c.value; });
          });
          localStorage.setItem(this.storageKey('controls'), JSON.stringify(state));
        },
      }
    }
  </script>
</body>
</html>
