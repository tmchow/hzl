<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>hzl dashboard</title>
  <style>
    :root {
      --bg-primary: #1a1a1a;
      --bg-secondary: #252525;
      --bg-card: #2d2d2d;
      --text-primary: #e5e5e5;
      --text-secondary: #a3a3a3;
      --text-muted: #737373;
      --accent: #f59e0b;
      --accent-dim: #b45309;
      --border: #404040;
      --status-backlog: #6b7280;     /* gray - not yet prioritized */
      --status-blocked: #ef4444;     /* red - stuck, needs help */
      --status-ready: #3b82f6;       /* blue - available to claim */
      --status-in-progress: #f59e0b; /* orange - active work */
      --status-done: #22c55e;        /* green - completed */
      --font-mono: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-mono);
      font-size: 13px;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo {
      font-weight: 600;
      font-size: 14px;
      color: var(--accent);
    }

    .header-filters {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 6px;
      position: relative;
    }

    .filter-label {
      color: var(--text-muted);
      font-size: 11px;
    }

    select {
      font-family: var(--font-mono);
      font-size: 12px;
      background: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }

    select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .connection-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
      min-width: 85px;
      justify-content: flex-end;
    }

    .connection-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
    }

    .connection-dot.error {
      background: var(--status-blocked);
    }

    .activity-btn {
      font-family: var(--font-mono);
      font-size: 12px;
      background: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }

    .activity-btn:hover {
      border-color: var(--accent);
    }

    /* Column Visibility Dropdown */
    .columns-toggle {
      font-family: var(--font-mono);
      font-size: 12px;
      background: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }

    .columns-toggle:hover {
      border-color: var(--accent);
    }

    .columns-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 8px;
      z-index: 100;
      min-width: 140px;
    }

    .columns-dropdown.open {
      display: block;
    }

    .column-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 0;
      cursor: pointer;
      font-size: 12px;
      color: var(--text-primary);
    }

    .column-checkbox:hover {
      color: var(--accent);
    }

    .column-checkbox input {
      accent-color: var(--accent);
    }

    /* Settings Dropdown */
    .settings-group {
      position: relative;
    }

    .settings-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-primary);
      color: var(--text-secondary);
      border: 1px solid var(--border);
      padding: 6px 8px;
      border-radius: 4px;
      cursor: pointer;
    }

    .settings-toggle:hover {
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .settings-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      z-index: 100;
      min-width: 180px;
    }

    .settings-dropdown.open {
      display: block;
    }

    .settings-section {
      margin-bottom: 12px;
    }

    .settings-section:last-child {
      margin-bottom: 0;
    }

    .settings-label {
      display: block;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .settings-section select {
      width: 100%;
      font-family: var(--font-mono);
      font-size: 12px;
      background: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .column-checkboxes {
      display: flex;
      flex-direction: column;
    }

    /* Kanban Board */
    .board {
      display: flex;
      gap: 12px;
      padding: 16px;
      overflow-x: auto;
      min-height: calc(100vh - 53px);
    }

    .column {
      flex: 1 1 220px;
      min-width: 180px;
      max-width: 320px;
      background: var(--bg-secondary);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 85px);
    }

    .column.hidden {
      display: none;
    }

    .column-header {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .column-title {
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .column-count {
      font-size: 11px;
      color: var(--text-muted);
      background: var(--bg-primary);
      padding: 2px 8px;
      border-radius: 10px;
    }

    .column-cards {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* Task Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 12px;
      cursor: pointer;
      transition: border-color 0.15s;
    }

    .card:hover {
      border-color: var(--accent);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .card-header-left {
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 0;
    }

    .card-emoji {
      font-size: 12px;
      flex-shrink: 0;
    }

    .card-parent {
      box-shadow: 0 0 0 1px var(--family-color);
    }

    .card-id {
      font-size: 10px;
      color: var(--text-muted);
    }

    .card-title {
      font-size: 13px;
      color: var(--text-primary);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .card-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-muted);
    }

    .card-project {
      background: var(--bg-primary);
      padding: 2px 6px;
      border-radius: 3px;
    }

    .card-agent {
      color: var(--accent);
    }

    .card-progress {
      color: var(--accent);
      background: rgba(245, 158, 11, 0.15);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      flex-shrink: 0;
    }

    .card-progress.complete {
      color: var(--status-done);
      background: rgba(34, 197, 94, 0.15);
    }

    .card-subtask-count {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .card-blocked {
      font-size: 10px;
      color: var(--status-blocked);
      margin-top: 6px;
    }

    .card-lease {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Empty State */
    .empty-column {
      text-align: center;
      color: var(--text-muted);
      padding: 24px 12px;
      font-size: 12px;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 24px;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      max-width: 800px;
      width: 100%;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .modal-body {
      padding: 16px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-section {
      margin-bottom: 16px;
    }

    .modal-section:last-child {
      margin-bottom: 0;
    }

    .modal-section-title {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }

    .modal-meta {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .modal-meta-item {
      background: var(--bg-primary);
      padding: 8px 10px;
      border-radius: 4px;
    }

    .modal-meta-label {
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .modal-meta-value {
      font-size: 12px;
    }

    .modal-progress {
      color: var(--accent);
      background: rgba(245, 158, 11, 0.15);
      padding: 2px 8px;
      border-radius: 4px;
    }

    .modal-progress.complete {
      color: var(--status-done);
      background: rgba(34, 197, 94, 0.15);
    }

    .modal-description {
      background: var(--bg-primary);
      padding: 12px;
      border-radius: 4px;
      font-size: 12px;
      line-height: 1.6;
    }

    /* Markdown content styles */
    .modal-description h1,
    .modal-description h2,
    .modal-description h3,
    .modal-description h4,
    .modal-description h5,
    .modal-description h6 {
      margin: 16px 0 8px 0;
      font-weight: 600;
      line-height: 1.3;
    }

    .modal-description h1:first-child,
    .modal-description h2:first-child,
    .modal-description h3:first-child {
      margin-top: 0;
    }

    .modal-description h1 { font-size: 18px; }
    .modal-description h2 { font-size: 16px; }
    .modal-description h3 { font-size: 14px; }
    .modal-description h4,
    .modal-description h5,
    .modal-description h6 { font-size: 12px; }

    .modal-description p {
      margin: 8px 0;
    }

    .modal-description p:first-child {
      margin-top: 0;
    }

    .modal-description p:last-child {
      margin-bottom: 0;
    }

    .modal-description ul,
    .modal-description ol {
      margin: 8px 0;
      padding-left: 20px;
    }

    .modal-description li {
      margin: 4px 0;
    }

    .modal-description code {
      background: var(--bg-secondary);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: var(--font-mono);
      font-size: 11px;
    }

    .modal-description pre {
      background: var(--bg-secondary);
      padding: 12px;
      border-radius: 4px;
      overflow-x: auto;
      margin: 12px 0;
    }

    .modal-description pre code {
      background: none;
      padding: 0;
      font-size: 11px;
      line-height: 1.5;
    }

    .modal-description blockquote {
      border-left: 3px solid var(--accent);
      margin: 12px 0;
      padding: 8px 12px;
      background: var(--bg-secondary);
      color: var(--text-secondary);
    }

    .modal-description blockquote p {
      margin: 0;
    }

    .modal-description a {
      color: var(--accent);
      text-decoration: none;
    }

    .modal-description a:hover {
      text-decoration: underline;
    }

    .modal-description hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 16px 0;
    }

    .modal-description table {
      border-collapse: collapse;
      width: 100%;
      margin: 12px 0;
      font-size: 11px;
    }

    .modal-description th,
    .modal-description td {
      border: 1px solid var(--border);
      padding: 6px 10px;
      text-align: left;
    }

    .modal-description th {
      background: var(--bg-secondary);
      font-weight: 600;
    }

    .modal-description img {
      max-width: 100%;
      height: auto;
    }

    .modal-comments {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .comment {
      background: var(--bg-primary);
      padding: 10px;
      border-radius: 4px;
      border-left: 2px solid var(--accent);
    }

    .comment-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .comment-author {
      color: var(--accent);
    }

    .comment-text {
      font-size: 12px;
      white-space: pre-wrap;
    }

    .show-more-btn {
      width: 100%;
      padding: 8px;
      background: var(--bg-primary);
      border: 1px dashed var(--border);
      border-radius: 4px;
      color: var(--text-secondary);
      font-family: var(--font-mono);
      font-size: 12px;
      cursor: pointer;
      transition: border-color 0.15s, color 0.15s;
    }

    .show-more-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .modal-tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 12px;
    }

    .modal-tab {
      padding: 8px 16px;
      background: none;
      border: none;
      color: var(--text-muted);
      font-family: var(--font-mono);
      font-size: 12px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }

    .modal-tab:hover {
      color: var(--text-primary);
    }

    .modal-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .modal-tab:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .modal-tab-count {
      background: var(--bg-primary);
      padding: 1px 6px;
      border-radius: 8px;
      font-size: 10px;
      margin-left: 6px;
    }

    .modal-tab-content {
      display: none;
    }

    .modal-tab-content.active {
      display: block;
    }

    /* Activity Panel */
    .activity-panel {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100vh;
      background: var(--bg-secondary);
      border-left: 1px solid var(--border);
      z-index: 150;
      transition: right 0.2s ease;
      display: flex;
      flex-direction: column;
    }

    .activity-panel.open {
      right: 0;
    }

    .activity-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .activity-title {
      font-weight: 600;
      font-size: 14px;
    }

    .activity-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 18px;
      cursor: pointer;
    }

    .activity-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .activity-item {
      padding: 10px;
      border-bottom: 1px solid var(--border);
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-item-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .activity-type {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 2px 6px;
      border-radius: 3px;
      background: var(--bg-primary);
    }

    .activity-type.status_changed { color: var(--status-in-progress); }
    .activity-type.task_created { color: var(--status-ready); }
    .activity-type.comment_added { color: var(--accent); }
    .activity-type.checkpoint_recorded { color: var(--text-secondary); }

    .activity-time {
      font-size: 10px;
      color: var(--text-muted);
    }

    .activity-task {
      font-size: 12px;
      color: var(--text-primary);
      margin-top: 4px;
    }

    .activity-detail {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* View Toggle */
    .view-toggle {
      display: flex;
      gap: 0;
      background: var(--bg-primary);
      border-radius: 6px;
      padding: 2px;
      border: 1px solid var(--border);
    }

    .view-btn {
      padding: 6px 12px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: 12px;
    }

    .view-btn.active {
      background: var(--accent);
      color: var(--bg-primary);
    }

    .view-btn:hover:not(.active):not(:disabled) {
      color: var(--text-primary);
    }

    .view-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Graph Container */
    .graph-container {
      flex: 1;
      position: relative;
      min-height: 400px;
      background: var(--bg-primary);
    }

    .graph-container.hidden {
      display: none;
    }

    .graph-loading {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      color: var(--text-secondary);
    }

    .graph-loading .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Mobile Styles */
    @media (max-width: 768px) {
      .header {
        flex-wrap: wrap;
        gap: 8px;
      }

      .header-filters {
        order: 3;
        width: 100%;
        flex-wrap: wrap;
      }

      .board {
        display: none;
      }

      .graph-container {
        min-height: calc(100vh - 150px);
      }

      .view-toggle {
        margin-left: auto;
      }

      .mobile-tabs {
        display: flex;
        overflow-x: auto;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border);
        padding: 0 8px;
      }

      .mobile-tab {
        flex: 0 0 auto;
        padding: 12px 16px;
        font-size: 12px;
        color: var(--text-muted);
        border-bottom: 2px solid transparent;
        cursor: pointer;
        white-space: nowrap;
      }

      .mobile-tab.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
      }

      .mobile-tab-badge {
        background: var(--bg-primary);
        padding: 1px 6px;
        border-radius: 8px;
        font-size: 10px;
        margin-left: 6px;
      }

      .mobile-cards {
        display: none;
        padding: 12px;
        flex-direction: column;
        gap: 8px;
      }

      .mobile-cards.active {
        display: flex;
      }

      .activity-panel {
        width: 100%;
        right: -100%;
      }
    }

    @media (min-width: 769px) {
      .mobile-tabs,
      .mobile-cards {
        display: none !important;
      }
    }

    /* Hamburger menu for mobile */
    .hamburger {
      display: none;
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 20px;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .hamburger {
        display: block;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <button class="hamburger" id="hamburgerBtn">&#9776;</button>
      <span class="logo">hzl dashboard</span>
      <div class="view-toggle" id="viewToggle">
        <button class="view-btn active" data-view="kanban">Kanban</button>
        <button class="view-btn" data-view="graph">Graph</button>
      </div>
    </div>
    <div class="header-filters">
      <div class="filter-group">
        <select id="dateFilter">
          <option value="1d">Today</option>
          <option value="3d" selected>Last 3 days</option>
          <option value="7d">Last 7 days</option>
          <option value="14d">Last 14 days</option>
          <option value="30d">Last 30 days</option>
        </select>
      </div>
      <div class="filter-group">
        <select id="projectFilter">
          <option value="">All projects</option>
        </select>
      </div>
      <div class="filter-group settings-group">
        <button class="settings-toggle" id="settingsToggle" title="Settings">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
            <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
          </svg>
        </button>
        <div class="settings-dropdown" id="settingsDropdown">
          <div class="settings-section">
            <label class="settings-label">Refresh</label>
            <select id="refreshFilter">
              <option value="1000">1s</option>
              <option value="2000">2s</option>
              <option value="5000" selected>5s</option>
              <option value="10000">10s</option>
              <option value="30000">30s</option>
            </select>
          </div>
          <div class="settings-section">
            <label class="settings-label">Columns</label>
            <div class="column-checkboxes">
              <label class="column-checkbox">
                <input type="checkbox" value="backlog" checked> Backlog
              </label>
              <label class="column-checkbox">
                <input type="checkbox" value="ready" checked> Ready
              </label>
              <label class="column-checkbox">
                <input type="checkbox" value="in_progress" checked> In Progress
              </label>
              <label class="column-checkbox">
                <input type="checkbox" value="blocked" checked> Blocked
              </label>
              <label class="column-checkbox">
                <input type="checkbox" value="done" checked> Done
              </label>
            </div>
          </div>
          <div class="settings-section">
            <label class="column-checkbox">
              <input type="checkbox" id="showSubtasks" checked> Show subtasks
            </label>
          </div>
        </div>
      </div>
    </div>
    <div class="header-right">
      <div class="connection-indicator">
        <div class="connection-dot" id="connectionDot"></div>
        <span id="connectionText">Connecting...</span>
      </div>
      <button class="activity-btn" id="activityBtn">Activity</button>
    </div>
  </header>

  <!-- Mobile Tabs -->
  <div class="mobile-tabs" id="mobileTabs">
    <div class="mobile-tab" data-status="backlog">Backlog <span class="mobile-tab-badge" id="badge-backlog">0</span></div>
    <div class="mobile-tab active" data-status="ready">Ready <span class="mobile-tab-badge" id="badge-ready">0</span></div>
    <div class="mobile-tab" data-status="in_progress">In Progress <span class="mobile-tab-badge" id="badge-in_progress">0</span></div>
    <div class="mobile-tab" data-status="blocked">Blocked <span class="mobile-tab-badge" id="badge-blocked">0</span></div>
    <div class="mobile-tab" data-status="done">Done <span class="mobile-tab-badge" id="badge-done">0</span></div>
  </div>

  <!-- Mobile Cards Container -->
  <div id="mobileCardsContainer"></div>

  <!-- Desktop Kanban Board -->
  <main class="board" id="board">
    <div class="column" data-status="backlog">
      <div class="column-header">
        <span class="column-title">Backlog</span>
        <span class="column-count" id="count-backlog">0</span>
      </div>
      <div class="column-cards" id="cards-backlog"></div>
    </div>
    <div class="column" data-status="ready">
      <div class="column-header">
        <span class="column-title">Ready</span>
        <span class="column-count" id="count-ready">0</span>
      </div>
      <div class="column-cards" id="cards-ready"></div>
    </div>
    <div class="column" data-status="in_progress">
      <div class="column-header">
        <span class="column-title">In Progress</span>
        <span class="column-count" id="count-in_progress">0</span>
      </div>
      <div class="column-cards" id="cards-in_progress"></div>
    </div>
    <div class="column" data-status="blocked">
      <div class="column-header">
        <span class="column-title">Blocked</span>
        <span class="column-count" id="count-blocked">0</span>
      </div>
      <div class="column-cards" id="cards-blocked"></div>
    </div>
    <div class="column" data-status="done">
      <div class="column-header">
        <span class="column-title">Done</span>
        <span class="column-count" id="count-done">0</span>
      </div>
      <div class="column-cards" id="cards-done"></div>
    </div>
  </main>

  <!-- Graph View Container -->
  <div id="graphContainer" class="graph-container hidden">
    <div class="graph-loading" id="graphLoading">
      <div class="spinner"></div>
      <span>Loading graph...</span>
    </div>
  </div>

  <!-- Task Detail Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title" id="modalTitle">Task Details</span>
        <button class="modal-close" id="modalClose">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Populated by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Activity Panel -->
  <div class="activity-panel" id="activityPanel">
    <div class="activity-header">
      <span class="activity-title">Activity</span>
      <button class="activity-close" id="activityClose">&times;</button>
    </div>
    <div class="activity-list" id="activityList">
      <!-- Populated by JavaScript -->
    </div>
  </div>

  <script>
    // State
    let tasks = [];
    let events = [];
    let lastEventId = 0;
    let pollTimer = null;
    let lastPollTime = null;
    let selectedTask = null;
    let showAllComments = false;
    let showAllCheckpoints = false;
    let activeModalTab = 'comments';
    const COMMENT_DISPLAY_LIMIT = 15;
    const CHECKPOINT_DISPLAY_LIMIT = 15;
    let activeTab = 'ready';
    let activeView = 'kanban';
    let graphInstance = null;
    let graphInitialized = false;
    let nodeStatusMap = new Map();
    let pendingModalRequestId = 0; // Track modal fetch requests to avoid race conditions
    let isPolling = false; // Guard against concurrent poll() calls

    // DOM Elements
    const dateFilter = document.getElementById('dateFilter');
    const projectFilter = document.getElementById('projectFilter');
    const refreshFilter = document.getElementById('refreshFilter');
    const connectionDot = document.getElementById('connectionDot');
    const connectionText = document.getElementById('connectionText');
    const activityBtn = document.getElementById('activityBtn');
    const activityPanel = document.getElementById('activityPanel');
    const activityClose = document.getElementById('activityClose');
    const activityList = document.getElementById('activityList');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalClose = document.getElementById('modalClose');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const mobileTabs = document.getElementById('mobileTabs');
    const settingsToggle = document.getElementById('settingsToggle');
    const settingsDropdown = document.getElementById('settingsDropdown');
    const showSubtasksCheckbox = document.getElementById('showSubtasks');
    const viewToggle = document.getElementById('viewToggle');
    const board = document.getElementById('board');
    const graphContainer = document.getElementById('graphContainer');
    const graphLoading = document.getElementById('graphLoading');

    // Column visibility
    const COLUMNS = ['backlog', 'ready', 'in_progress', 'blocked', 'done'];

    // Emoji family system for parent/child task indicators
    const FAMILY_EMOJIS = [
      'üî∑', 'üî∂', 'üî¥', 'üü¢', 'üîµ', 'üü°', 'üü£', 'üü†',
      '‚¨õ', '‚¨ú', 'üî≥', 'üî≤', '‚ñ™Ô∏è', '‚ñ´Ô∏è', '‚óæ', '‚óΩ',
      'üí†', 'üîπ', 'üî∏', '‚ô¶Ô∏è', '‚ô†Ô∏è', '‚ô£Ô∏è', '‚ô•Ô∏è', 'üÉè',
      '‚≠ê', 'üåü', '‚ú®', 'üí´', 'üîÜ', 'üîÖ', '‚òÄÔ∏è', 'üåô',
      'üéØ', 'üé™', 'üé®', 'üé≠', 'üé¨', 'üéÆ', 'üé≤', 'üé∏',
      'üîë', 'üîê', 'üîí', 'üîì', 'üóùÔ∏è', '‚ö°', 'üí°', 'üîî'
    ];

    // djb2 hash for deterministic emoji assignment
    function getTaskEmoji(taskId) {
      let hash = 5381;
      for (let i = 0; i < taskId.length; i++) {
        hash = ((hash << 5) + hash) ^ taskId.charCodeAt(i);
      }
      return FAMILY_EMOJIS[Math.abs(hash) % FAMILY_EMOJIS.length];
    }

    function getTaskFamilyColor(taskId) {
      let hash = 5381;
      for (let i = 0; i < taskId.length; i++) {
        hash = ((hash << 5) + hash) ^ taskId.charCodeAt(i);
      }
      const hue = Math.abs(hash) % 360;
      return `hsl(${hue} 55% 55%)`;
    }

    // Build emoji map with suffix numbers for children
    function buildEmojiMap(taskList) {
      // Build set of known task IDs for visible parent detection
      const taskIds = new Set(taskList.map(t => t.task_id));

      // Group visible children by parent for suffix ordering
      // Only children whose parent is visible get suffix numbers
      const childrenByParent = new Map();

      for (const task of taskList) {
        if (task.parent_id && taskIds.has(task.parent_id)) {
          if (!childrenByParent.has(task.parent_id)) {
            childrenByParent.set(task.parent_id, []);
          }
          childrenByParent.get(task.parent_id).push(task);
        }
      }

      // Sort children by task_id for stable suffix ordering
      for (const children of childrenByParent.values()) {
        children.sort((a, b) => a.task_id.localeCompare(b.task_id));
      }

      // Build emoji assignments
      const emojiMap = new Map(); // task_id -> { emoji, suffix }

      for (const task of taskList) {
        if (task.parent_id) {
          // Child task: always use parent's emoji for family consistency
          // (even if parent is filtered out)
          const emoji = getTaskEmoji(task.parent_id);
          // Only show suffix if parent is visible (siblings can be compared)
          const siblings = childrenByParent.get(task.parent_id) || [];
          const suffix = siblings.length > 0 ? siblings.indexOf(task) + 1 : null;
          emojiMap.set(task.task_id, { emoji, suffix: suffix || null });
        } else {
          // Parent or standalone task: use own emoji, no suffix
          emojiMap.set(task.task_id, { emoji: getTaskEmoji(task.task_id), suffix: null });
        }
      }

      return emojiMap;
    }

    function updateColumnVisibility() {
      COLUMNS.forEach(status => {
        const checkbox = settingsDropdown.querySelector(`input[value="${status}"]`);
        const column = document.querySelector(`.column[data-status="${status}"]`);
        if (column && checkbox) {
          column.classList.toggle('hidden', !checkbox.checked);
        }
      });
    }

    // Load saved preferences
    function loadPreferences() {
      const saved = localStorage.getItem('hzl-dashboard-prefs');
      if (saved) {
        try {
          const prefs = JSON.parse(saved);
          if (prefs.dateFilter) dateFilter.value = prefs.dateFilter;
          if (prefs.projectFilter) projectFilter.value = prefs.projectFilter;
          if (prefs.refreshFilter) refreshFilter.value = prefs.refreshFilter;
          if (Array.isArray(prefs.columnVisibility)) {
            settingsDropdown.querySelectorAll('.column-checkboxes input[type="checkbox"]').forEach(cb => {
              cb.checked = prefs.columnVisibility.includes(cb.value);
            });
            updateColumnVisibility();
          }
          if (prefs.showSubtasks !== undefined) {
            showSubtasksCheckbox.checked = prefs.showSubtasks;
          }
          if (prefs.activeView && prefs.activeView !== 'kanban') {
            // Defer view switch until after ForceGraph may have loaded
            setTimeout(() => setActiveView(prefs.activeView), 100);
          }
        } catch (e) {}
      }
    }

    function savePreferences() {
      const prefs = {
        dateFilter: dateFilter.value,
        projectFilter: projectFilter.value,
        refreshFilter: refreshFilter.value,
        columnVisibility: Array.from(
          settingsDropdown.querySelectorAll('.column-checkboxes input[type="checkbox"]:checked')
        ).map(cb => cb.value),
        showSubtasks: showSubtasksCheckbox.checked,
        activeView: activeView,
      };
      localStorage.setItem('hzl-dashboard-prefs', JSON.stringify(prefs));
    }

    // Graph View Functions
    function handleGraphLibError() {
      console.warn('[hzl] force-graph CDN failed to load');
      const graphBtn = viewToggle.querySelector('[data-view="graph"]');
      if (graphBtn) {
        graphBtn.disabled = true;
        graphBtn.title = 'Graph unavailable - CDN failed to load';
      }
    }

    function getStatusColor(status, type) {
      if (type === 'root') return '#f59e0b';
      if (type === 'project') return '#e5e5e5';
      const colors = {
        backlog: '#6b7280',     // gray - not yet prioritized
        ready: '#3b82f6',       // blue - available to claim
        in_progress: '#f59e0b', // orange - active work
        blocked: '#ef4444',     // red - stuck, needs help
        done: '#22c55e',        // green - completed
      };
      return colors[status] ?? '#6b7280';
    }

    function getNodeSize(node) {
      if (node.type === 'root') return 20;
      if (node.type === 'project') return 14;
      const progress = node.progress ?? 0;
      return 8 + (progress / 100) * 16;
    }

    function transformTasksToGraph(taskList) {
      const nodes = [{ id: 'root', type: 'root', name: 'HZL', ring: 0, angle: 0 }];
      const links = [];
      const projectList = [];
      const projectAngles = new Map();
      nodeStatusMap.clear();

      // First pass: collect unique projects
      for (const task of taskList) {
        if (task.project && !projectAngles.has(task.project)) {
          projectList.push(task.project);
          projectAngles.set(task.project, 0);
        }
      }

      // Assign angles to projects (evenly distributed)
      projectList.forEach((proj, i) => {
        const angle = (2 * Math.PI * i) / projectList.length;
        projectAngles.set(proj, angle);
      });

      // Second pass: create nodes
      const addedProjects = new Set();
      for (const task of taskList) {
        if (!task.project || !task.task_id) {
          console.warn('[hzl] Skipping task with missing required fields:', task);
          continue;
        }

        const projAngle = projectAngles.get(task.project);

        // Add project node if not seen
        if (!addedProjects.has(task.project)) {
          addedProjects.add(task.project);
          const projectId = `project:${task.project}`;
          nodes.push({ id: projectId, type: 'project', name: task.project, ring: 1, angle: projAngle });
          links.push({ source: projectId, target: 'root', type: 'hierarchy' });
          nodeStatusMap.set(projectId, null);
        }

        // Add task node with same angle as its project (with small random offset)
        const ring = task.parent_id ? 3 : 2;
        const angleOffset = (Math.random() - 0.5) * 0.3; // small spread within project
        nodes.push({
          id: task.task_id,
          type: task.parent_id ? 'subtask' : 'task',
          name: task.title,
          status: task.status,
          progress: task.progress ?? 0,
          ring,
          angle: projAngle + angleOffset,
          project: task.project,
        });
        nodeStatusMap.set(task.task_id, task.status);

        // Hierarchy link
        const parent = task.parent_id || `project:${task.project}`;
        links.push({ source: task.task_id, target: parent, type: 'hierarchy' });

        // Dependency links (for particles)
        if (task.blocked_by) {
          for (const blockerId of task.blocked_by) {
            links.push({ source: blockerId, target: task.task_id, type: 'dependency' });
          }
        }
      }

      return { nodes, links };
    }

    function initGraph() {
      if (graphInitialized) return;

      if (typeof ForceGraph === 'undefined') {
        console.error('[hzl] ForceGraph not available - CDN may have failed');
        handleGraphLibError();
        return;
      }

      // Hide loading spinner
      graphLoading.style.display = 'none';

      const RING_RADII = { 0: 0, 1: 180, 2: 360, 3: 540 };
      const baseRadius = window.innerWidth < 768 ? 0.6 : 1;

      // Pre-position nodes based on angle and ring
      const graphData = transformTasksToGraph(tasks);
      for (const node of graphData.nodes) {
        const radius = (RING_RADII[node.ring] ?? 300) * baseRadius;
        node.x = Math.cos(node.angle || 0) * radius;
        node.y = Math.sin(node.angle || 0) * radius;
      }

      graphInstance = ForceGraph()(graphContainer)
        .graphData(graphData)
        .backgroundColor('#1a1a1a')
        .nodeLabel(n => n.name)
        .nodeColor(n => getStatusColor(n.status, n.type))
        .nodeVal(n => getNodeSize(n))
        .linkColor(l => l.type === 'dependency' ? '#e57373' : '#40404080')
        .linkWidth(l => l.type === 'dependency' ? 2 : 1)
        .linkLabel(l => l.type === 'dependency' ? 'blocks' : '')
        .linkDirectionalArrowLength(l => l.type === 'dependency' ? 6 : 0)
        .linkDirectionalArrowRelPos(1)
        .onNodeClick(n => {
          if (n.type !== 'root' && n.type !== 'project') {
            openTaskModal(n.id);
          }
        })
        // Forces to keep nodes in their angular sectors
        .d3Force('x', d3.forceX(d => {
          const radius = (RING_RADII[d.ring] ?? 300) * baseRadius;
          return Math.cos(d.angle || 0) * radius;
        }).strength(0.3))
        .d3Force('y', d3.forceY(d => {
          const radius = (RING_RADII[d.ring] ?? 300) * baseRadius;
          return Math.sin(d.angle || 0) * radius;
        }).strength(0.3))
        .d3Force('collision', d3.forceCollide(d => getNodeSize(d) + 15))
        .d3Force('charge', d3.forceManyBody().strength(-50))
        .d3Force('link', d3.forceLink().strength(0.1))
        // Animated particles on dependency edges
        .linkDirectionalParticles(l => l.type === 'dependency' ? 3 : 0)
        .linkDirectionalParticleWidth(3)
        .linkDirectionalParticleSpeed(0.005)
        .linkDirectionalParticleColor(() => '#e57373')
        // Custom node rendering for root glow
        .nodeCanvasObject((node, ctx, globalScale) => {
          if (node.type === 'root') {
            // Pulsing glow effect
            const pulse = Math.sin(Date.now() / 500) * 0.3 + 0.7;
            ctx.beginPath();
            ctx.arc(node.x, node.y, 25 * pulse, 0, 2 * Math.PI);
            ctx.fillStyle = `rgba(245, 158, 11, ${0.3 * pulse})`;
            ctx.fill();
          }

          // Draw node
          const size = getNodeSize(node);
          ctx.beginPath();
          ctx.arc(node.x, node.y, size, 0, 2 * Math.PI);
          ctx.fillStyle = getStatusColor(node.status, node.type);
          ctx.fill();

          // Label for root node
          if (node.type === 'root') {
            ctx.font = `bold ${11 / globalScale}px ui-monospace`;
            ctx.fillStyle = '#1a1a1a';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('HZL', node.x, node.y + 1);
          }

          // Label for projects
          if (node.type === 'project' && globalScale > 0.5) {
            ctx.font = `${10 / globalScale}px ui-monospace`;
            ctx.fillStyle = '#e5e5e5';
            ctx.textAlign = 'center';
            ctx.fillText(node.name, node.x, node.y + size + 12);
          }
        })
        .nodePointerAreaPaint((node, color, ctx) => {
          const size = getNodeSize(node);
          ctx.beginPath();
          ctx.arc(node.x, node.y, size + 4, 0, 2 * Math.PI);
          ctx.fillStyle = color;
          ctx.fill();
        });

      graphInitialized = true;

      // Zoom to fit after layout settles
      setTimeout(() => {
        if (graphInstance) {
          graphInstance.zoomToFit(400, 50);
        }
      }, 500);
    }

    let lastGraphDataHash = '';

    function hashTasks(taskList) {
      // Simple hash based on task ids, statuses, and dependencies
      return taskList.map(t => `${t.task_id}:${t.status}:${t.progress}`).sort().join('|');
    }

    function updateGraphData() {
      // Skip updates when graph isn't visible to save CPU
      if (!graphInstance || !graphInitialized || activeView !== 'graph') {
        return;
      }

      const newHash = hashTasks(tasks);
      if (newHash !== lastGraphDataHash) {
        lastGraphDataHash = newHash;

        // Get current node positions
        const currentData = graphInstance.graphData();
        const positionMap = new Map();
        for (const node of currentData.nodes) {
          if (node.x !== undefined && node.y !== undefined) {
            positionMap.set(node.id, { x: node.x, y: node.y, vx: node.vx, vy: node.vy });
          }
        }

        // Create new graph data and preserve positions
        const newData = transformTasksToGraph(tasks);
        for (const node of newData.nodes) {
          const pos = positionMap.get(node.id);
          if (pos) {
            node.x = pos.x;
            node.y = pos.y;
            node.vx = pos.vx;
            node.vy = pos.vy;
          }
        }

        graphInstance.graphData(newData);
      }
    }

    // Debounced resize handling
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        if (graphInstance && activeView === 'graph') {
          graphInstance.width(graphContainer.clientWidth);
          graphInstance.height(graphContainer.clientHeight);
        }
      }, 100);
    });

    // API calls
    async function fetchTasks() {
      const since = dateFilter.value;
      const project = projectFilter.value;
      const url = `/api/tasks?since=${since}${project ? `&project=${encodeURIComponent(project)}` : ''}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('Failed to fetch tasks');
      const data = await res.json();
      return data.tasks;
    }

    async function fetchEvents() {
      const res = await fetch(`/api/events?since=${lastEventId}`);
      if (!res.ok) throw new Error('Failed to fetch events');
      const data = await res.json();
      return data.events;
    }

    async function fetchTaskDetail(taskId) {
      const [taskRes, commentsRes, checkpointsRes] = await Promise.all([
        fetch(`/api/tasks/${taskId}`),
        fetch(`/api/tasks/${taskId}/comments`),
        fetch(`/api/tasks/${taskId}/checkpoints`),
      ]);

      if (!taskRes.ok) throw new Error('Task not found');

      const taskData = await taskRes.json();
      const commentsData = await commentsRes.json();
      const checkpointsData = await checkpointsRes.json();

      return {
        task: taskData.task,
        comments: commentsData.comments,
        checkpoints: checkpointsData.checkpoints,
      };
    }

    async function fetchStats() {
      const res = await fetch('/api/stats');
      if (!res.ok) throw new Error('Failed to fetch stats');
      return await res.json();
    }

    // Render functions
    function renderCard(task, emojiInfo, showSubtasks) {
      const isBlocked = task.blocked_by && task.blocked_by.length > 0;
      const status = isBlocked ? 'blocked' : task.status;

      const isParentTask = (task.subtask_total ?? 0) > 0;
      const parentStyle = isParentTask
        ? `style="--family-color: ${getTaskFamilyColor(task.task_id)}"`
        : '';

      // Build emoji indicator
      let emojiHtml = '';
      if (emojiInfo) {
        const { emoji, suffix } = emojiInfo;
        emojiHtml = suffix
          ? `<span class="card-emoji">${emoji}-${suffix}</span>`
          : `<span class="card-emoji">${emoji}</span>`;
      }

      // Build subtask count (for parents regardless of subtasks visibility)
      let subtaskHtml = '';
      const visibleCount = task.subtask_count ?? 0;
      const totalCount = task.subtask_total ?? visibleCount;
      if (totalCount > 0) {
        const label = totalCount === 1 ? 'subtask' : 'subtasks';
        const countLabel = visibleCount === totalCount
          ? `${visibleCount} ${label}`
          : `${visibleCount}/${totalCount} ${label}`;
        subtaskHtml = `<div class="card-subtask-count">[${countLabel}]</div>`;
      }

      // Build progress badge
      let progressHtml = '';
      if (task.progress !== null && task.progress !== undefined && task.progress > 0) {
        const progressClass = task.progress >= 100 ? 'card-progress complete' : 'card-progress';
        progressHtml = `<span class="${progressClass}">${task.progress}%</span>`;
      }

      let extra = '';
      if (isBlocked) {
        extra = `<div class="card-blocked">Blocked by: ${task.blocked_by.map(id => id.slice(0, 8)).join(', ')}</div>`;
      }
      if (task.status === 'in_progress' && task.lease_until) {
        const remaining = formatTimeRemaining(task.lease_until);
        extra += `<div class="card-lease">${remaining}</div>`;
      }

      return `
        <div class="card${isParentTask ? ' card-parent' : ''}" data-task-id="${task.task_id}" ${parentStyle}>
          <div class="card-header">
            <div class="card-header-left">
              ${emojiHtml}
              <span class="card-id">${task.task_id.slice(0, 8)}</span>
            </div>
            ${progressHtml}
          </div>
          <div class="card-title">${escapeHtml(task.title)}</div>
          ${subtaskHtml}
          <div class="card-meta">
            <span class="card-project">${escapeHtml(task.project)}</span>
            ${task.assignee ? `<span class="card-agent">${task.assignee.slice(0, 8)}</span>` : ''}
          </div>
          ${extra}
        </div>
      `;
    }

    // Group tasks into Kanban columns, treating ready tasks with unmet dependencies as blocked
    function groupTasksByStatus(taskList) {
      const columns = {
        backlog: [],
        blocked: [],
        ready: [],
        in_progress: [],
        done: [],
      };
      for (const task of taskList) {
        const isBlocked = task.blocked_by && task.blocked_by.length > 0;
        const status = isBlocked && task.status === 'ready' ? 'blocked' : task.status;
        if (columns[status]) {
          columns[status].push(task);
        }
      }
      return columns;
    }

    function renderBoard() {
      const showSubtasks = showSubtasksCheckbox.checked;
      const emojiMap = buildEmojiMap(tasks);

      // Filter tasks if subtasks are hidden
      let visibleTasks = tasks;
      if (!showSubtasks) {
        visibleTasks = tasks.filter(t => !t.parent_id);
      }

      const columns = groupTasksByStatus(visibleTasks);

      for (const [status, statusTasks] of Object.entries(columns)) {
        const container = document.getElementById(`cards-${status}`);
        const countEl = document.getElementById(`count-${status}`);
        const badgeEl = document.getElementById(`badge-${status}`);

        if (container) {
          if (statusTasks.length === 0) {
            container.innerHTML = '<div class="empty-column">No tasks</div>';
          } else {
            container.innerHTML = statusTasks.map(task => {
              const emojiInfo = emojiMap.get(task.task_id);
              return renderCard(task, emojiInfo, showSubtasks);
            }).join('');
          }
        }
        if (countEl) countEl.textContent = statusTasks.length;
        if (badgeEl) badgeEl.textContent = statusTasks.length;
      }

      // Render mobile cards for active tab
      renderMobileCards(showSubtasks, emojiMap);

      // Card click handlers are set up via event delegation in init
    }

    function renderMobileCards(showSubtasks, emojiMap) {
      const container = document.getElementById('mobileCardsContainer');
      if (!container) return;

      // Use same filtering as desktop
      let visibleTasks = tasks;
      if (!showSubtasks) {
        visibleTasks = tasks.filter(t => !t.parent_id);
      }

      const columns = groupTasksByStatus(visibleTasks);

      container.innerHTML = Object.entries(columns).map(([status, statusTasks]) => `
        <div class="mobile-cards ${status === activeTab ? 'active' : ''}" data-status="${status}">
          ${statusTasks.length === 0
            ? '<div class="empty-column">No tasks</div>'
            : statusTasks.map(task => {
                const emojiInfo = emojiMap.get(task.task_id);
                return renderCard(task, emojiInfo, showSubtasks);
              }).join('')
          }
        </div>
      `).join('');

      // Card click handlers are set up via event delegation in init
    }

    function renderActivity() {
      if (events.length === 0) {
        activityList.innerHTML = '<div class="empty-column">No recent activity</div>';
        return;
      }

      activityList.innerHTML = events.map(event => {
        let detail = '';
        if (event.type === 'status_changed' && event.data) {
          detail = `${event.data.from} ‚Üí ${event.data.to}`;
        }
        if (event.agent_id) {
          detail = detail ? `${detail} by ${event.agent_id.slice(0, 8)}` : `by ${event.agent_id.slice(0, 8)}`;
        }

        return `
          <div class="activity-item">
            <div class="activity-item-header">
              <span class="activity-type ${event.type}">${formatEventType(event.type)}</span>
              <span class="activity-time">${formatTime(event.timestamp)}</span>
            </div>
            <div class="activity-task">${escapeHtml(event.task_title || event.task_id.slice(0, 8))}</div>
            ${detail ? `<div class="activity-detail">${escapeHtml(detail)}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    async function openTaskModal(taskId, preserveShowAll = false) {
      // Track this request to handle rapid clicks (race condition prevention)
      const requestId = ++pendingModalRequestId;

      // Reset expansion state for new tasks
      if (!preserveShowAll) {
        showAllComments = false;
        showAllCheckpoints = false;
        activeModalTab = 'comments';
      }

      try {
        const data = await fetchTaskDetail(taskId);

        // Discard stale response if a newer request was made
        if (requestId !== pendingModalRequestId) return;

        selectedTask = data;
        modalTitle.textContent = data.task.title;

        const progressValue = data.task.progress ?? 0;
        const progressClass = progressValue >= 100 ? 'modal-progress complete' : 'modal-progress';

        let html = `
          <div class="modal-section">
            <div class="modal-meta">
              <div class="modal-meta-item">
                <div class="modal-meta-label">Status</div>
                <div class="modal-meta-value">${data.task.status}</div>
              </div>
              <div class="modal-meta-item">
                <div class="modal-meta-label">Progress</div>
                <div class="modal-meta-value"><span class="${progressClass}">${progressValue}%</span></div>
              </div>
              <div class="modal-meta-item">
                <div class="modal-meta-label">Project</div>
                <div class="modal-meta-value">${escapeHtml(data.task.project)}</div>
              </div>
              <div class="modal-meta-item">
                <div class="modal-meta-label">Priority</div>
                <div class="modal-meta-value">${data.task.priority}</div>
              </div>
              <div class="modal-meta-item">
                <div class="modal-meta-label">Created</div>
                <div class="modal-meta-value">${formatTime(data.task.created_at)}</div>
              </div>
            </div>
          </div>
        `;

        if (data.task.assignee) {
          html += `
            <div class="modal-section">
              <div class="modal-section-title">Claimed By</div>
              <div class="modal-meta">
                <div class="modal-meta-item">
                  <div class="modal-meta-label">Agent</div>
                  <div class="modal-meta-value">${data.task.assignee}</div>
                </div>
                ${data.task.lease_until ? `
                  <div class="modal-meta-item">
                    <div class="modal-meta-label">Lease Until</div>
                    <div class="modal-meta-value">${formatTime(data.task.lease_until)}</div>
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        }

        if (data.task.blocked_by && data.task.blocked_by.length > 0) {
          html += `
            <div class="modal-section">
              <div class="modal-section-title">Blocked By</div>
              <div class="modal-description">${data.task.blocked_by.join(', ')}</div>
            </div>
          `;
        }

        if (data.task.description) {
          html += `
            <div class="modal-section">
              <div class="modal-section-title">Description</div>
              <div class="modal-description">${renderMarkdown(data.task.description)}</div>
            </div>
          `;
        }

        // Tabbed interface for comments and checkpoints
        if (data.comments.length > 0 || data.checkpoints.length > 0) {
          // Default to checkpoints tab if no comments
          if (data.comments.length === 0 && activeModalTab === 'comments') {
            activeModalTab = 'checkpoints';
          }

          const hasMoreComments = data.comments.length > COMMENT_DISPLAY_LIMIT && !showAllComments;
          const visibleComments = hasMoreComments
            ? data.comments.slice(-COMMENT_DISPLAY_LIMIT)
            : data.comments;
          const hiddenCommentCount = Math.max(0, data.comments.length - COMMENT_DISPLAY_LIMIT);

          const hasMoreCheckpoints = data.checkpoints.length > CHECKPOINT_DISPLAY_LIMIT && !showAllCheckpoints;
          const visibleCheckpoints = hasMoreCheckpoints
            ? data.checkpoints.slice(-CHECKPOINT_DISPLAY_LIMIT)
            : data.checkpoints;
          const hiddenCheckpointCount = Math.max(0, data.checkpoints.length - CHECKPOINT_DISPLAY_LIMIT);

          html += `
            <div class="modal-section">
              <div class="modal-tabs">
                <button class="modal-tab ${activeModalTab === 'comments' ? 'active' : ''}" data-tab="comments" ${data.comments.length === 0 ? 'disabled' : ''}>
                  Comments<span class="modal-tab-count">${data.comments.length}</span>
                </button>
                <button class="modal-tab ${activeModalTab === 'checkpoints' ? 'active' : ''}" data-tab="checkpoints" ${data.checkpoints.length === 0 ? 'disabled' : ''}>
                  Checkpoints<span class="modal-tab-count">${data.checkpoints.length}</span>
                </button>
              </div>

              <div class="modal-tab-content ${activeModalTab === 'comments' ? 'active' : ''}" data-tab-content="comments">
                ${data.comments.length === 0 ? '<div class="empty-column">No comments</div>' : `
                  <div class="modal-comments">
                    ${hasMoreComments ? `
                      <button class="show-more-btn" id="showMoreComments">
                        Show ${hiddenCommentCount} earlier comment${hiddenCommentCount === 1 ? '' : 's'}
                      </button>
                    ` : ''}
                    ${visibleComments.map(c => `
                      <div class="comment">
                        <div class="comment-header">
                          <span class="comment-author">${escapeHtml(c.agent_id || c.author || 'Unknown')}</span>
                          <span>${formatTime(c.timestamp)}</span>
                        </div>
                        <div class="comment-text">${escapeHtml(c.text)}</div>
                      </div>
                    `).join('')}
                  </div>
                `}
              </div>

              <div class="modal-tab-content ${activeModalTab === 'checkpoints' ? 'active' : ''}" data-tab-content="checkpoints">
                ${data.checkpoints.length === 0 ? '<div class="empty-column">No checkpoints</div>' : `
                  <div class="modal-comments">
                    ${hasMoreCheckpoints ? `
                      <button class="show-more-btn" id="showMoreCheckpoints">
                        Show ${hiddenCheckpointCount} earlier checkpoint${hiddenCheckpointCount === 1 ? '' : 's'}
                      </button>
                    ` : ''}
                    ${visibleCheckpoints.map(cp => {
                      const hasData = cp.data && Object.keys(cp.data).length > 0;
                      return `
                        <div class="comment">
                          <div class="comment-header">
                            <span class="comment-author">${escapeHtml(cp.name)}</span>
                            <span>${formatTime(cp.timestamp)}</span>
                          </div>
                          ${hasData ? `<div class="comment-text">${escapeHtml(JSON.stringify(cp.data, null, 2))}</div>` : ''}
                        </div>
                      `;
                    }).join('')}
                  </div>
                `}
              </div>
            </div>
          `;
        }

        modalBody.innerHTML = html;
        modalOverlay.classList.add('open');

        // Attach tab switching handlers (DOM-only, no re-fetch)
        modalBody.querySelectorAll('.modal-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            if (tab.hasAttribute('disabled')) return;
            const targetTab = tab.dataset.tab;

            // Update tab active states
            modalBody.querySelectorAll('.modal-tab').forEach(t =>
              t.classList.toggle('active', t.dataset.tab === targetTab));

            // Update content visibility
            modalBody.querySelectorAll('.modal-tab-content').forEach(c =>
              c.classList.toggle('active', c.dataset.tabContent === targetTab));

            // Update global state for re-opens
            activeModalTab = targetTab;
          });
        });

        // Attach "show more comments" handler if present
        const showMoreCommentsBtn = document.getElementById('showMoreComments');
        if (showMoreCommentsBtn) {
          showMoreCommentsBtn.addEventListener('click', () => {
            showAllComments = true;
            openTaskModal(taskId, true);
          });
        }

        // Attach "show more checkpoints" handler if present
        const showMoreCheckpointsBtn = document.getElementById('showMoreCheckpoints');
        if (showMoreCheckpointsBtn) {
          showMoreCheckpointsBtn.addEventListener('click', () => {
            showAllCheckpoints = true;
            openTaskModal(taskId, true);
          });
        }
      } catch (error) {
        console.error('Failed to load task:', error);
        alert('Failed to load task details');
      }
    }

    function closeModal() {
      modalOverlay.classList.remove('open');
      selectedTask = null;
    }

    // Polling
    async function poll() {
      // Guard against concurrent poll calls (e.g., rapid tab switching)
      if (isPolling) return;
      isPolling = true;

      try {
        const [newTasks, newEvents, stats] = await Promise.all([
          fetchTasks(),
          fetchEvents(),
          fetchStats(),
        ]);

        tasks = newTasks;

        if (newEvents.length > 0) {
          events = [...newEvents, ...events].slice(0, 50);
          lastEventId = newEvents[0].id;
        }

        // Update project filter
        const currentProject = projectFilter.value;
        projectFilter.innerHTML = '<option value="">All projects</option>' +
          stats.projects.map(p => `<option value="${escapeHtml(p)}" ${p === currentProject ? 'selected' : ''}>${escapeHtml(p)}</option>`).join('');

        renderBoard();
        renderActivity();
        updateGraphData();

        lastPollTime = Date.now();
        updateConnectionStatus(true);
      } catch (error) {
        console.error('Poll failed:', error);
        updateConnectionStatus(false);
      } finally {
        isPolling = false;
      }
    }

    function startPolling() {
      poll();
      const interval = parseInt(refreshFilter.value, 10);
      pollTimer = setInterval(poll, interval);
    }

    function stopPolling() {
      if (pollTimer) {
        clearInterval(pollTimer);
        pollTimer = null;
      }
    }

    function restartPolling() {
      stopPolling();
      startPolling();
    }

    // Connection status
    function updateConnectionStatus(success) {
      if (success) {
        connectionDot.classList.remove('error');
        const ago = lastPollTime ? Math.round((Date.now() - lastPollTime) / 1000) : 0;
        connectionText.textContent = ago === 0 ? 'Just now' : `${ago}s ago`;
      } else {
        connectionDot.classList.add('error');
        connectionText.textContent = 'Error';
      }
    }

    // Helpers
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // Render markdown to sanitized HTML
    function renderMarkdown(str) {
      if (!str) return '';
      // Fall back to plain text if libraries aren't loaded
      if (typeof marked === 'undefined' || typeof DOMPurify === 'undefined') {
        return escapeHtml(str);
      }
      try {
        const html = marked.parse(str);
        return DOMPurify.sanitize(html);
      } catch (e) {
        console.error('Markdown parse error:', e);
        return escapeHtml(str);
      }
    }

    // Time constants in milliseconds
    const MS_PER_SECOND = 1000;
    const MS_PER_MINUTE = 60 * MS_PER_SECOND;
    const MS_PER_HOUR = 60 * MS_PER_MINUTE;
    const MS_PER_DAY = 24 * MS_PER_HOUR;

    function formatTime(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      const now = new Date();
      const diff = now - date;

      if (diff < MS_PER_MINUTE) return 'just now';
      if (diff < MS_PER_HOUR) return `${Math.floor(diff / MS_PER_MINUTE)}m ago`;
      if (diff < MS_PER_DAY) return `${Math.floor(diff / MS_PER_HOUR)}h ago`;
      return date.toLocaleDateString();
    }

    function formatTimeRemaining(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      const now = new Date();
      const diff = date - now;

      if (diff <= 0) return 'expired';
      if (diff < MS_PER_MINUTE) return `${Math.floor(diff / MS_PER_SECOND)}s left`;
      if (diff < MS_PER_HOUR) return `${Math.floor(diff / MS_PER_MINUTE)}m left`;
      return `${Math.floor(diff / MS_PER_HOUR)}h left`;
    }

    function formatEventType(type) {
      return type.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    // Event listeners
    dateFilter.addEventListener('change', () => {
      savePreferences();
      poll();
    });

    projectFilter.addEventListener('change', () => {
      savePreferences();
      poll();
    });

    refreshFilter.addEventListener('change', () => {
      savePreferences();
      restartPolling();
    });

    activityBtn.addEventListener('click', () => {
      activityPanel.classList.add('open');
    });

    activityClose.addEventListener('click', () => {
      activityPanel.classList.remove('open');
    });

    modalClose.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', (e) => {
      if (e.target === modalOverlay) closeModal();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal();
        activityPanel.classList.remove('open');
        settingsDropdown.classList.remove('open');
      }
    });

    // Visibility API
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        stopPolling();
      } else {
        startPolling();
      }
    });

    // Mobile tabs
    mobileTabs.addEventListener('click', (e) => {
      const tab = e.target.closest('.mobile-tab');
      if (!tab) return;

      activeTab = tab.dataset.status;

      document.querySelectorAll('.mobile-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      document.querySelectorAll('.mobile-cards').forEach(c => c.classList.remove('active'));
      document.querySelector(`.mobile-cards[data-status="${activeTab}"]`)?.classList.add('active');
    });

    // Hamburger menu (toggle filters on mobile)
    hamburgerBtn.addEventListener('click', () => {
      const filters = document.querySelector('.header-filters');
      filters.style.display = filters.style.display === 'none' ? 'flex' : 'none';
    });

    // Settings dropdown
    settingsToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      settingsDropdown.classList.toggle('open');
    });

    document.addEventListener('click', () => {
      settingsDropdown.classList.remove('open');
    });

    settingsDropdown.addEventListener('click', (e) => e.stopPropagation());

    // Column visibility checkboxes
    settingsDropdown.querySelectorAll('.column-checkboxes input').forEach(cb => {
      cb.addEventListener('change', () => {
        updateColumnVisibility();
        savePreferences();
      });
    });

    // Show subtasks toggle
    showSubtasksCheckbox.addEventListener('change', () => {
      savePreferences();
      renderBoard();
    });

    // View toggle (Kanban/Graph)
    function setActiveView(view) {
      activeView = view;

      // Update toggle buttons
      viewToggle.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });

      // Show/hide containers
      if (view === 'kanban') {
        board.style.display = '';
        graphContainer.classList.add('hidden');
        mobileTabs.style.display = '';
        document.getElementById('mobileCardsContainer').style.display = '';

        // Pause graph to save CPU/memory when not visible
        if (graphInstance) {
          graphInstance.pauseAnimation();
        }
      } else {
        board.style.display = 'none';
        graphContainer.classList.remove('hidden');
        mobileTabs.style.display = 'none';
        document.getElementById('mobileCardsContainer').style.display = 'none';

        // Initialize graph on first view
        if (!graphInitialized && typeof ForceGraph !== 'undefined') {
          initGraph();
        } else if (graphInstance) {
          // Resume graph animation when switching back
          graphInstance.resumeAnimation();
        }
      }

      savePreferences();
    }

    viewToggle.addEventListener('click', (e) => {
      const btn = e.target.closest('.view-btn');
      if (btn && !btn.disabled && btn.dataset.view !== activeView) {
        setActiveView(btn.dataset.view);
      }
    });

    // Event delegation for card clicks (avoids re-adding handlers on every render)
    board.addEventListener('click', (e) => {
      const card = e.target.closest('.card');
      if (card) openTaskModal(card.dataset.taskId);
    });

    document.getElementById('mobileCardsContainer').addEventListener('click', (e) => {
      const card = e.target.closest('.card');
      if (card) openTaskModal(card.dataset.taskId);
    });

    // Initialize
    loadPreferences();
    startPolling();

    // Update connection time every second
    setInterval(() => {
      if (lastPollTime) {
        const ago = Math.round((Date.now() - lastPollTime) / 1000);
        connectionText.textContent = ago === 0 ? 'Just now' : `${ago}s ago`;
      }
    }, 1000);
  </script>

  <!-- Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked@15/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>

  <!-- d3 for graph layout forces -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js" defer></script>
  <!-- Force-graph library for Graph view -->
  <script src="https://cdn.jsdelivr.net/npm/force-graph@1/dist/force-graph.min.js"
          defer
          onerror="handleGraphLibError()"></script>
</body>
</html>
